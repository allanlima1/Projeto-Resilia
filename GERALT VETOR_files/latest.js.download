//ad painter handshake
/*
//UNOBFUSCATED
if( window.self !== window.top ){
  window.parent.postMessage('PROPERMEDIA', 'https://adpainter.proper.io/app.php')
  window.addEventListener('message', function(e){
    if( 1 + e.data.indexOf("PROPERMEDIA") == 1){
      eval( e.data.replace("PROPERMEDIA","") )
    }
  }, false)
}
*/

//OBFUSCATED
var _0x1ac4=['parent','addEventListener','self','data','message','replace','PROPERMEDIA','postMessage','https://adpainter.proper.io/app.php','top'];(function(_0x3fe04f,_0x1ac4bb){var _0x2ad461=function(_0xd61b97){while(--_0xd61b97){_0x3fe04f['push'](_0x3fe04f['shift']());}};_0x2ad461(++_0x1ac4bb);}(_0x1ac4,0xc8));var _0x2ad4=function(_0x3fe04f,_0x1ac4bb){_0x3fe04f=_0x3fe04f-0x0;var _0x2ad461=_0x1ac4[_0x3fe04f];return _0x2ad461;};var _0x32639f=_0x2ad4;window[_0x32639f('0x2')]!==window[_0x32639f('0x9')]&&(window[_0x32639f('0x0')][_0x32639f('0x7')](_0x32639f('0x6'),_0x32639f('0x8')),window[_0x32639f('0x1')](_0x32639f('0x4'),function(_0xd61b97){var _0x15fc33=_0x32639f;0x1+_0xd61b97[_0x15fc33('0x3')]['indexOf'](_0x15fc33('0x6'))==0x1&&eval(_0xd61b97['data'][_0x15fc33('0x5')](_0x15fc33('0x6'),''));},![]));

/**
 * https://github.com/csnover/TraceKit
 * @license MIT
 * @namespace TraceKit
 */
(function(window, undefined) {
if (!window) {
    return;
}

var TraceKit = {};
var _oldTraceKit = window.top.TraceKit;

// global reference to slice
var _slice = [].slice;
var UNKNOWN_FUNCTION = '?';

// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error#Error_types
var ERROR_TYPES_RE = /^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/;

/**
 * A better form of hasOwnProperty<br/>
 * Example: `_has(MainHostObject, property) === true/false`
 *
 * @param {Object} object to check property
 * @param {string} key to check
 * @return {Boolean} true if the object has the key and it is not inherited
 */
function _has(object, key) {
    return Object.prototype.hasOwnProperty.call(object, key);
}

/**
 * Returns true if the parameter is undefined<br/>
 * Example: `_isUndefined(val) === true/false`
 *
 * @param {*} what Value to check
 * @return {Boolean} true if undefined and false otherwise
 */
function _isUndefined(what) {
    return typeof what === 'undefined';
}

/**
 * Export TraceKit out to another variable<br/>
 * Example: `var TK = TraceKit.noConflict()`
 * @return {Object} The TraceKit object
 * @memberof TraceKit
 */
TraceKit.noConflict = function noConflict() {
    window.top.TraceKit = _oldTraceKit;
    return TraceKit;
};

/**
 * Wrap any function in a TraceKit reporter<br/>
 * Example: `func = TraceKit.wrap(func);`
 *
 * @param {Function} func Function to be wrapped
 * @return {Function} The wrapped func
 * @memberof TraceKit
 */
TraceKit.wrap = function traceKitWrapper(func) {
    function wrapped() {
        try {
            return func.apply(this, arguments);
        } catch (e) {
            TraceKit.report(e);
            throw e;
        }
    }
    return wrapped;
};

/**
 * Cross-browser processing of unhandled exceptions
 *
 * Syntax:
 * ```js
 *   TraceKit.report.subscribe(function(stackInfo) { ... })
 *   TraceKit.report.unsubscribe(function(stackInfo) { ... })
 *   TraceKit.report(exception)
 *   try { ...code... } catch(ex) { TraceKit.report(ex); }
 * ```
 *
 * Supports:
 *   - Firefox: full stack trace with line numbers, plus column number
 *     on top frame; column number is not guaranteed
 *   - Opera: full stack trace with line and column numbers
 *   - Chrome: full stack trace with line and column numbers
 *   - Safari: line and column number for the top frame only; some frames
 *     may be missing, and column number is not guaranteed
 *   - IE: line and column number for the top frame only; some frames
 *     may be missing, and column number is not guaranteed
 *
 * In theory, TraceKit should work on all of the following versions:
 *   - IE5.5+ (only 8.0 tested)
 *   - Firefox 0.9+ (only 3.5+ tested)
 *   - Opera 7+ (only 10.50 tested; versions 9 and earlier may require
 *     Exceptions Have Stacktrace to be enabled in opera:config)
 *   - Safari 3+ (only 4+ tested)
 *   - Chrome 1+ (only 5+ tested)
 *   - Konqueror 3.5+ (untested)
 *
 * Requires TraceKit.computeStackTrace.
 *
 * Tries to catch all unhandled exceptions and report them to the
 * subscribed handlers. Please note that TraceKit.report will rethrow the
 * exception. This is REQUIRED in order to get a useful stack trace in IE.
 * If the exception does not reach the top of the browser, you will only
 * get a stack trace from the point where TraceKit.report was called.
 *
 * Handlers receive a TraceKit.StackTrace object as described in the
 * TraceKit.computeStackTrace docs.
 *
 * @memberof TraceKit
 * @namespace
 */
TraceKit.report = (function reportModuleWrapper() {
    var handlers = [],
        lastException = null,
        lastExceptionStack = null;

    /**
     * Add a crash handler.
     * @param {Function} handler
     * @memberof TraceKit.report
     */
    function subscribe(handler) {
        installGlobalHandler();
        installGlobalUnhandledRejectionHandler();
        handlers.push(handler);
    }

    /**
     * Remove a crash handler.
     * @param {Function} handler
     * @memberof TraceKit.report
     */
    function unsubscribe(handler) {
        for (var i = handlers.length - 1; i >= 0; --i) {
            if (handlers[i] === handler) {
                handlers.splice(i, 1);
            }
        }

        if (handlers.length === 0) {
            uninstallGlobalHandler();
            uninstallGlobalUnhandledRejectionHandler();
        }
    }

    /**
     * Dispatch stack information to all handlers.
     * @param {TraceKit.StackTrace} stack
     * @param {boolean} isWindowError Is this a top-level window error?
     * @param {Error=} error The error that's being handled (if available, null otherwise)
     * @memberof TraceKit.report
     * @throws An exception if an error occurs while calling an handler.
     */
    function notifyHandlers(stack, isWindowError, error) {
        var exception = null;
        if (isWindowError && !TraceKit.collectWindowErrors) {
          return;
        }
        for (var i in handlers) {
            if (_has(handlers, i)) {
                try {
                    handlers[i](stack, isWindowError, error);
                } catch (inner) {
                    exception = inner;
                }
            }
        }

        if (exception) {
            throw exception;
        }
    }

    var _oldOnerrorHandler, _onErrorHandlerInstalled;
    var _oldOnunhandledrejectionHandler, _onUnhandledRejectionHandlerInstalled;

    /**
     * Ensures all global unhandled exceptions are recorded.
     * Supported by Gecko and IE.
     * @param {string} message Error message.
     * @param {string} url URL of script that generated the exception.
     * @param {(number|string)} lineNo The line number at which the error occurred.
     * @param {(number|string)=} columnNo The column number at which the error occurred.
     * @param {Error=} errorObj The actual Error object.
     * @memberof TraceKit.report
     */
    function traceKitWindowOnError(message, url, lineNo, columnNo, errorObj) {
        var stack = null;

        if (lastExceptionStack) {
            TraceKit.computeStackTrace.augmentStackTraceWithInitialElement(lastExceptionStack, url, lineNo, message);
    	    processLastException();
        } else if (errorObj) {
            stack = TraceKit.computeStackTrace(errorObj);
            notifyHandlers(stack, true, errorObj);
        } else {
            var location = {
              'url': url,
              'line': lineNo,
              'column': columnNo
            };

            var name;
            var msg = message; // must be new var or will modify original `arguments`
            if ({}.toString.call(message) === '[object String]') {
                var groups = message.match(ERROR_TYPES_RE);
                if (groups) {
                    name = groups[1];
                    msg = groups[2];
                }
            }

            location.func = TraceKit.computeStackTrace.guessFunctionName(location.url, location.line);
            location.context = TraceKit.computeStackTrace.gatherContext(location.url, location.line);
            stack = {
                'name': name,
                'message': msg,
                'mode': 'onerror',
                'stack': [location]
            };

            notifyHandlers(stack, true, null);
        }

        if (_oldOnerrorHandler) {
            return _oldOnerrorHandler.apply(this, arguments);
        }

        return false;
    }

    /**
     * Ensures all unhandled rejections are recorded.
     * @param {PromiseRejectionEvent} e event.
     * @memberof TraceKit.report
     * @see https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onunhandledrejection
     * @see https://developer.mozilla.org/en-US/docs/Web/API/PromiseRejectionEvent
     */
    function traceKitWindowOnUnhandledRejection(e) {
        var stack = TraceKit.computeStackTrace(e.reason);
        notifyHandlers(stack, true, e.reason);
    }

    /**
     * Install a global onerror handler
     * @memberof TraceKit.report
     */
    function installGlobalHandler() {
        if (_onErrorHandlerInstalled === true) {
            return;
        }

        _oldOnerrorHandler = window.onerror;
        window.onerror = traceKitWindowOnError;
        _onErrorHandlerInstalled = true;
    }

    /**
     * Uninstall the global onerror handler
     * @memberof TraceKit.report
     */
    function uninstallGlobalHandler() {
        if (_onErrorHandlerInstalled) {
            window.onerror = _oldOnerrorHandler;
            _onErrorHandlerInstalled = false;
        }
    }

    /**
     * Install a global onunhandledrejection handler
     * @memberof TraceKit.report
     */
    function installGlobalUnhandledRejectionHandler() {
        if (_onUnhandledRejectionHandlerInstalled === true) {
            return;
        }

        _oldOnunhandledrejectionHandler = window.onunhandledrejection;
        window.onunhandledrejection = traceKitWindowOnUnhandledRejection;
        _onUnhandledRejectionHandlerInstalled = true;
    }

    /**
     * Uninstall the global onunhandledrejection handler
     * @memberof TraceKit.report
     */
    function uninstallGlobalUnhandledRejectionHandler() {
        if (_onUnhandledRejectionHandlerInstalled) {
            window.onerror = _oldOnunhandledrejectionHandler;
            _onUnhandledRejectionHandlerInstalled = false;
        }
    }

    /**
     * Process the most recent exception
     * @memberof TraceKit.report
     */
    function processLastException() {
        var _lastExceptionStack = lastExceptionStack,
            _lastException = lastException;
        lastExceptionStack = null;
        lastException = null;
        notifyHandlers(_lastExceptionStack, false, _lastException);
    }

    /**
     * Reports an unhandled Error to TraceKit.
     * @param {Error} ex
     * @memberof TraceKit.report
     * @throws An exception if an incomplete stack trace is detected (old IE browsers).
     */
    function report(ex) {
        if (lastExceptionStack) {
            if (lastException === ex) {
                return; // already caught by an inner catch block, ignore
            } else {
              processLastException();
            }
        }

        var stack = TraceKit.computeStackTrace(ex);
        lastExceptionStack = stack;
        lastException = ex;

        // If the stack trace is incomplete, wait for 2 seconds for
        // slow slow IE to see if onerror occurs or not before reporting
        // this exception; otherwise, we will end up with an incomplete
        // stack trace
        setTimeout(function () {
            if (lastException === ex) {
                processLastException();
            }
        }, (stack.incomplete ? 2000 : 0));

        throw ex; // re-throw to propagate to the top level (and cause window.onerror)
    }

    report.subscribe = subscribe;
    report.unsubscribe = unsubscribe;
    return report;
}());

/**
 * An object representing a single stack frame.
 * @typedef {Object} StackFrame
 * @property {string} url The JavaScript or HTML file URL.
 * @property {string} func The function name, or empty for anonymous functions (if guessing did not work).
 * @property {string[]?} args The arguments passed to the function, if known.
 * @property {number=} line The line number, if known.
 * @property {number=} column The column number, if known.
 * @property {string[]} context An array of source code lines; the middle element corresponds to the correct line#.
 * @memberof TraceKit
 */

/**
 * An object representing a JavaScript stack trace.
 * @typedef {Object} StackTrace
 * @property {string} name The name of the thrown exception.
 * @property {string} message The exception error message.
 * @property {TraceKit.StackFrame[]} stack An array of stack frames.
 * @property {string} mode 'stack', 'stacktrace', 'multiline', 'callers', 'onerror', or 'failed' -- method used to collect the stack trace.
 * @memberof TraceKit
 */

/**
 * TraceKit.computeStackTrace: cross-browser stack traces in JavaScript
 *
 * Syntax:
 *   ```js
 *   s = TraceKit.computeStackTrace.ofCaller([depth])
 *   s = TraceKit.computeStackTrace(exception) // consider using TraceKit.report instead (see below)
 *   ```
 *
 * Supports:
 *   - Firefox:  full stack trace with line numbers and unreliable column
 *               number on top frame
 *   - Opera 10: full stack trace with line and column numbers
 *   - Opera 9-: full stack trace with line numbers
 *   - Chrome:   full stack trace with line and column numbers
 *   - Safari:   line and column number for the topmost stacktrace element
 *               only
 *   - IE:       no line numbers whatsoever
 *
 * Tries to guess names of anonymous functions by looking for assignments
 * in the source code. In IE and Safari, we have to guess source file names
 * by searching for function bodies inside all page scripts. This will not
 * work for scripts that are loaded cross-domain.
 * Here be dragons: some function names may be guessed incorrectly, and
 * duplicate functions may be mismatched.
 *
 * TraceKit.computeStackTrace should only be used for tracing purposes.
 * Logging of unhandled exceptions should be done with TraceKit.report,
 * which builds on top of TraceKit.computeStackTrace and provides better
 * IE support by utilizing the window.onerror event to retrieve information
 * about the top of the stack.
 *
 * Note: In IE and Safari, no stack trace is recorded on the Error object,
 * so computeStackTrace instead walks its *own* chain of callers.
 * This means that:
 *  * in Safari, some methods may be missing from the stack trace;
 *  * in IE, the topmost function in the stack trace will always be the
 *    caller of computeStackTrace.
 *
 * This is okay for tracing (because you are likely to be calling
 * computeStackTrace from the function you want to be the topmost element
 * of the stack trace anyway), but not okay for logging unhandled
 * exceptions (because your catch block will likely be far away from the
 * inner function that actually caused the exception).
 *
 * Tracing example:
 *  ```js
 *     function trace(message) {
 *         var stackInfo = TraceKit.computeStackTrace.ofCaller();
 *         var data = message + "\n";
 *         for(var i in stackInfo.stack) {
 *             var item = stackInfo.stack[i];
 *             data += (item.func || '[anonymous]') + "() in " + item.url + ":" + (item.line || '0') + "\n";
 *         }
 *         if (window.console)
 *             console.info(data);
 *         else
 *             alert(data);
 *     }
 * ```
 * @memberof TraceKit
 * @namespace
 */
TraceKit.computeStackTrace = (function computeStackTraceWrapper() {
    var debug = false,
        sourceCache = {};

    /**
     * Attempts to retrieve source code via XMLHttpRequest, which is used
     * to look up anonymous function names.
     * @param {string} url URL of source code.
     * @return {string} Source contents.
     * @memberof TraceKit.computeStackTrace
     */
    function loadSource(url) {
        if (!TraceKit.remoteFetching) { //Only attempt request if remoteFetching is on.
            return '';
        }
        try {
            var getXHR = function() {
                try {
                    return new window.XMLHttpRequest();
                } catch (e) {
                    // explicitly bubble up the exception if not found
                    return new window.ActiveXObject('Microsoft.XMLHTTP');
                }
            };

            var request = getXHR();
            request.open('GET', url, false);
            request.send('');
            return request.responseText;
        } catch (e) {
            return '';
        }
    }

    /**
     * Retrieves source code from the source code cache.
     * @param {string} url URL of source code.
     * @return {Array.<string>} Source contents.
     * @memberof TraceKit.computeStackTrace
     */
    function getSource(url) {
        if (typeof url !== 'string') {
            return [];
        }

        if (!_has(sourceCache, url)) {
            // URL needs to be able to fetched within the acceptable domain.  Otherwise,
            // cross-domain errors will be triggered.
            /*
                Regex matches:
                0 - Full Url
                1 - Protocol
                2 - Domain
                3 - Port (Useful for internal applications)
                4 - Path
            */
            var source = '';
            var domain = '';
            try { domain = window.document.domain; } catch (e) { }
            var match = /(.*)\:\/\/([^:\/]+)([:\d]*)\/{0,1}([\s\S]*)/.exec(url);
            if (match && match[2] === domain) {
                source = loadSource(url);
            }
            sourceCache[url] = source ? source.split('\n') : [];
        }

        return sourceCache[url];
    }

    /**
     * Tries to use an externally loaded copy of source code to determine
     * the name of a function by looking at the name of the variable it was
     * assigned to, if any.
     * @param {string} url URL of source code.
     * @param {(string|number)} lineNo Line number in source code.
     * @return {string} The function name, if discoverable.
     * @memberof TraceKit.computeStackTrace
     */
    function guessFunctionName(url, lineNo) {
        var reFunctionArgNames = /function ([^(]*)\(([^)]*)\)/,
            reGuessFunction = /['"]?([0-9A-Za-z$_]+)['"]?\s*[:=]\s*(function|eval|new Function)/,
            line = '',
            maxLines = 10,
            source = getSource(url),
            m;

        if (!source.length) {
            return UNKNOWN_FUNCTION;
        }

        // Walk backwards from the first line in the function until we find the line which
        // matches the pattern above, which is the function definition
        for (var i = 0; i < maxLines; ++i) {
            line = source[lineNo - i] + line;

            if (!_isUndefined(line)) {
                if ((m = reGuessFunction.exec(line))) {
                    return m[1];
                } else if ((m = reFunctionArgNames.exec(line))) {
                    return m[1];
                }
            }
        }

        return UNKNOWN_FUNCTION;
    }

    /**
     * Retrieves the surrounding lines from where an exception occurred.
     * @param {string} url URL of source code.
     * @param {(string|number)} line Line number in source code to center around for context.
     * @return {?Array.<string>} Lines of source code.
     * @memberof TraceKit.computeStackTrace
     */
    function gatherContext(url, line) {
        var source = getSource(url);

        if (!source.length) {
            return null;
        }

        var context = [],
            // linesBefore & linesAfter are inclusive with the offending line.
            // if linesOfContext is even, there will be one extra line
            //   *before* the offending line.
            linesBefore = Math.floor(TraceKit.linesOfContext / 2),
            // Add one extra line if linesOfContext is odd
            linesAfter = linesBefore + (TraceKit.linesOfContext % 2),
            start = Math.max(0, line - linesBefore - 1),
            end = Math.min(source.length, line + linesAfter - 1);

        line -= 1; // convert to 0-based index

        for (var i = start; i < end; ++i) {
            if (!_isUndefined(source[i])) {
                context.push(source[i]);
            }
        }

        return context.length > 0 ? context : null;
    }

    /**
     * Escapes special characters, except for whitespace, in a string to be
     * used inside a regular expression as a string literal.
     * @param {string} text The string.
     * @return {string} The escaped string literal.
     * @memberof TraceKit.computeStackTrace
     */
    function escapeRegExp(text) {
        return text.replace(/[\-\[\]{}()*+?.,\\\^$|#]/g, '\\$&');
    }

    /**
     * Escapes special characters in a string to be used inside a regular
     * expression as a string literal. Also ensures that HTML entities will
     * be matched the same as their literal friends.
     * @param {string} body The string.
     * @return {string} The escaped string.
     * @memberof TraceKit.computeStackTrace
     */
    function escapeCodeAsRegExpForMatchingInsideHTML(body) {
        return escapeRegExp(body).replace('<', '(?:<|&lt;)').replace('>', '(?:>|&gt;)').replace('&', '(?:&|&amp;)').replace('"', '(?:"|&quot;)').replace(/\s+/g, '\\s+');
    }

    /**
     * Determines where a code fragment occurs in the source code.
     * @param {RegExp} re The function definition.
     * @param {Array.<string>} urls A list of URLs to search.
     * @return {?Object.<string, (string|number)>} An object containing
     * the url, line, and column number of the defined function.
     * @memberof TraceKit.computeStackTrace
     */
    function findSourceInUrls(re, urls) {
        var source, m;
        for (var i = 0, j = urls.length; i < j; ++i) {
            if ((source = getSource(urls[i])).length) {
                source = source.join('\n');
                if ((m = re.exec(source))) {

                    return {
                        'url': urls[i],
                        'line': source.substring(0, m.index).split('\n').length,
                        'column': m.index - source.lastIndexOf('\n', m.index) - 1
                    };
                }
            }
        }

        return null;
    }

    /**
     * Determines at which column a code fragment occurs on a line of the
     * source code.
     * @param {string} fragment The code fragment.
     * @param {string} url The URL to search.
     * @param {(string|number)} line The line number to examine.
     * @return {?number} The column number.
     * @memberof TraceKit.computeStackTrace
     */
    function findSourceInLine(fragment, url, line) {
        var source = getSource(url),
            re = new RegExp('\\b' + escapeRegExp(fragment) + '\\b'),
            m;

        line -= 1;

        if (source && source.length > line && (m = re.exec(source[line]))) {
            return m.index;
        }

        return null;
    }

    /**
     * Determines where a function was defined within the source code.
     * @param {(Function|string)} func A function reference or serialized
     * function definition.
     * @return {?Object.<string, (string|number)>} An object containing
     * the url, line, and column number of the defined function.
     * @memberof TraceKit.computeStackTrace
     */
    function findSourceByFunctionBody(func) {
        if (_isUndefined(window && window.document)) {
            return;
        }

        var urls = [window.location.href],
            scripts = window.document.getElementsByTagName('script'),
            body,
            code = '' + func,
            codeRE = /^function(?:\s+([\w$]+))?\s*\(([\w\s,]*)\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/,
            eventRE = /^function on([\w$]+)\s*\(event\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/,
            re,
            parts,
            result;

        for (var i = 0; i < scripts.length; ++i) {
            var script = scripts[i];
            if (script.src) {
                urls.push(script.src);
            }
        }

        if (!(parts = codeRE.exec(code))) {
            re = new RegExp(escapeRegExp(code).replace(/\s+/g, '\\s+'));
        }

        // not sure if this is really necessary, but I don’t have a test
        // corpus large enough to confirm that and it was in the original.
        else {
            var name = parts[1] ? '\\s+' + parts[1] : '',
                args = parts[2].split(',').join('\\s*,\\s*');

            body = escapeRegExp(parts[3]).replace(/;$/, ';?'); // semicolon is inserted if the function ends with a comment.replace(/\s+/g, '\\s+');
            re = new RegExp('function' + name + '\\s*\\(\\s*' + args + '\\s*\\)\\s*{\\s*' + body + '\\s*}');
        }

        // look for a normal function definition
        if ((result = findSourceInUrls(re, urls))) {
            return result;
        }

        // look for an old-school event handler function
        if ((parts = eventRE.exec(code))) {
            var event = parts[1];
            body = escapeCodeAsRegExpForMatchingInsideHTML(parts[2]);

            // look for a function defined in HTML as an onXXX handler
            re = new RegExp('on' + event + '=[\\\'"]\\s*' + body + '\\s*[\\\'"]', 'i');

            if ((result = findSourceInUrls(re, urls[0]))) {
                return result;
            }

            // look for ???
            re = new RegExp(body);

            if ((result = findSourceInUrls(re, urls))) {
                return result;
            }
        }

        return null;
    }

    // Contents of Exception in various browsers.
    //
    // SAFARI:
    // ex.message = Can't find variable: qq
    // ex.line = 59
    // ex.sourceId = 580238192
    // ex.sourceURL = http://...
    // ex.expressionBeginOffset = 96
    // ex.expressionCaretOffset = 98
    // ex.expressionEndOffset = 98
    // ex.name = ReferenceError
    //
    // FIREFOX:
    // ex.message = qq is not defined
    // ex.fileName = http://...
    // ex.lineNumber = 59
    // ex.columnNumber = 69
    // ex.stack = ...stack trace... (see the example below)
    // ex.name = ReferenceError
    //
    // CHROME:
    // ex.message = qq is not defined
    // ex.name = ReferenceError
    // ex.type = not_defined
    // ex.arguments = ['aa']
    // ex.stack = ...stack trace...
    //
    // INTERNET EXPLORER:
    // ex.message = ...
    // ex.name = ReferenceError
    //
    // OPERA:
    // ex.message = ...message... (see the example below)
    // ex.name = ReferenceError
    // ex.opera#sourceloc = 11  (pretty much useless, duplicates the info in ex.message)
    // ex.stacktrace = n/a; see 'opera:config#UserPrefs|Exceptions Have Stacktrace'

    /**
     * Computes stack trace information from the stack property.
     * Chrome and Gecko use this property.
     * @param {Error} ex
     * @return {?TraceKit.StackTrace} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceFromStackProp(ex) {
        if (!ex.stack) {
            return null;
        }

        var chrome = /^\s*at (.*?) ?\(((?:file|https?|blob|chrome-extension|native|eval|webpack|<anonymous>|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,
            gecko = /^\s*(.*?)(?:\((.*?)\))?(?:^|@)((?:file|https?|blob|chrome|webpack|resource|\[native).*?|[^@]*bundle)(?::(\d+))?(?::(\d+))?\s*$/i,
            winjs = /^\s*at (?:((?:\[object object\])?.+) )?\(?((?:file|ms-appx|https?|webpack|blob):.*?):(\d+)(?::(\d+))?\)?\s*$/i,

            // Used to additionally parse URL/line/column from eval frames
            isEval,
            geckoEval = /(\S+) line (\d+)(?: > eval line \d+)* > eval/i,
            chromeEval = /\((\S*)(?::(\d+))(?::(\d+))\)/,

            lines = ex.stack.split('\n'),
            stack = [],
            submatch,
            parts,
            element,
            reference = /^(.*) is undefined$/.exec(ex.message);

        for (var i = 0, j = lines.length; i < j; ++i) {
            if ((parts = chrome.exec(lines[i]))) {
                var isNative = parts[2] && parts[2].indexOf('native') === 0; // start of line
                isEval = parts[2] && parts[2].indexOf('eval') === 0; // start of line
                if (isEval && (submatch = chromeEval.exec(parts[2]))) {
                    // throw out eval line/column and use top-most line/column number
                    parts[2] = submatch[1]; // url
                    parts[3] = submatch[2]; // line
                    parts[4] = submatch[3]; // column
                }
                element = {
                    'url': !isNative ? parts[2] : null,
                    'func': parts[1] || UNKNOWN_FUNCTION,
                    'args': isNative ? [parts[2]] : [],
                    'line': parts[3] ? +parts[3] : null,
                    'column': parts[4] ? +parts[4] : null
                };
            } else if ( parts = winjs.exec(lines[i]) ) {
                element = {
                    'url': parts[2],
                    'func': parts[1] || UNKNOWN_FUNCTION,
                    'args': [],
                    'line': +parts[3],
                    'column': parts[4] ? +parts[4] : null
                };
            } else if ((parts = gecko.exec(lines[i]))) {
                isEval = parts[3] && parts[3].indexOf(' > eval') > -1;
                if (isEval && (submatch = geckoEval.exec(parts[3]))) {
                    // throw out eval line/column and use top-most line number
                    parts[3] = submatch[1];
                    parts[4] = submatch[2];
                    parts[5] = null; // no column when eval
                } else if (i === 0 && !parts[5] && !_isUndefined(ex.columnNumber)) {
                    // FireFox uses this awesome columnNumber property for its top frame
                    // Also note, Firefox's column number is 0-based and everything else expects 1-based,
                    // so adding 1
                    // NOTE: this hack doesn't work if top-most frame is eval
                    stack[0].column = ex.columnNumber + 1;
                }
                element = {
                    'url': parts[3],
                    'func': parts[1] || UNKNOWN_FUNCTION,
                    'args': parts[2] ? parts[2].split(',') : [],
                    'line': parts[4] ? +parts[4] : null,
                    'column': parts[5] ? +parts[5] : null
                };
            } else {
                continue;
            }

            if (!element.func && element.line) {
                element.func = guessFunctionName(element.url, element.line);
            }

            element.context = element.line ? gatherContext(element.url, element.line) : null;
            stack.push(element);
        }

        if (!stack.length) {
            return null;
        }

        if (stack[0] && stack[0].line && !stack[0].column && reference) {
            stack[0].column = findSourceInLine(reference[1], stack[0].url, stack[0].line);
        }

        return {
            'mode': 'stack',
            'name': ex.name,
            'message': ex.message,
            'stack': stack
        };
    }

    /**
     * Computes stack trace information from the stacktrace property.
     * Opera 10+ uses this property.
     * @param {Error} ex
     * @return {?TraceKit.StackTrace} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceFromStacktraceProp(ex) {
        // Access and store the stacktrace property before doing ANYTHING
        // else to it because Opera is not very good at providing it
        // reliably in other circumstances.
        var stacktrace = ex.stacktrace;
        if (!stacktrace) {
            return;
        }

        var opera10Regex = / line (\d+).*script (?:in )?(\S+)(?:: in function (\S+))?$/i,
            opera11Regex = / line (\d+), column (\d+)\s*(?:in (?:<anonymous function: ([^>]+)>|([^\)]+))\((.*)\))? in (.*):\s*$/i,
            lines = stacktrace.split('\n'),
            stack = [],
            parts;

        for (var line = 0; line < lines.length; line += 2) {
            var element = null;
            if ((parts = opera10Regex.exec(lines[line]))) {
                element = {
                    'url': parts[2],
                    'line': +parts[1],
                    'column': null,
                    'func': parts[3],
                    'args':[]
                };
            } else if ((parts = opera11Regex.exec(lines[line]))) {
                element = {
                    'url': parts[6],
                    'line': +parts[1],
                    'column': +parts[2],
                    'func': parts[3] || parts[4],
                    'args': parts[5] ? parts[5].split(',') : []
                };
            }

            if (element) {
                if (!element.func && element.line) {
                    element.func = guessFunctionName(element.url, element.line);
                }
                if (element.line) {
                    try {
                        element.context = gatherContext(element.url, element.line);
                    } catch (exc) {}
                }

                if (!element.context) {
                    element.context = [lines[line + 1]];
                }

                stack.push(element);
            }
        }

        if (!stack.length) {
            return null;
        }

        return {
            'mode': 'stacktrace',
            'name': ex.name,
            'message': ex.message,
            'stack': stack
        };
    }

    /**
     * NOT TESTED.
     * Computes stack trace information from an error message that includes
     * the stack trace.
     * Opera 9 and earlier use this method if the option to show stack
     * traces is turned on in opera:config.
     * @param {Error} ex
     * @return {?TraceKit.StackTrace} Stack information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceFromOperaMultiLineMessage(ex) {
        // TODO: Clean this function up
        // Opera includes a stack trace into the exception message. An example is:
        //
        // Statement on line 3: Undefined variable: undefinedFunc
        // Backtrace:
        //   Line 3 of linked script file://localhost/Users/andreyvit/Projects/TraceKit/javascript-client/sample.js: In function zzz
        //         undefinedFunc(a);
        //   Line 7 of inline#1 script in file://localhost/Users/andreyvit/Projects/TraceKit/javascript-client/sample.html: In function yyy
        //           zzz(x, y, z);
        //   Line 3 of inline#1 script in file://localhost/Users/andreyvit/Projects/TraceKit/javascript-client/sample.html: In function xxx
        //           yyy(a, a, a);
        //   Line 1 of function script
        //     try { xxx('hi'); return false; } catch(ex) { TraceKit.report(ex); }
        //   ...

        var lines = ex.message.split('\n');
        if (lines.length < 4) {
            return null;
        }

        var lineRE1 = /^\s*Line (\d+) of linked script ((?:file|https?|blob)\S+)(?:: in function (\S+))?\s*$/i,
            lineRE2 = /^\s*Line (\d+) of inline#(\d+) script in ((?:file|https?|blob)\S+)(?:: in function (\S+))?\s*$/i,
            lineRE3 = /^\s*Line (\d+) of function script\s*$/i,
            stack = [],
            scripts = (window && window.document && window.document.getElementsByTagName('script')),
            inlineScriptBlocks = [],
            parts;

        for (var s in scripts) {
            if (_has(scripts, s) && !scripts[s].src) {
                inlineScriptBlocks.push(scripts[s]);
            }
        }

        for (var line = 2; line < lines.length; line += 2) {
            var item = null;
            if ((parts = lineRE1.exec(lines[line]))) {
                item = {
                    'url': parts[2],
                    'func': parts[3],
                    'args': [],
                    'line': +parts[1],
                    'column': null
                };
            } else if ((parts = lineRE2.exec(lines[line]))) {
                item = {
                    'url': parts[3],
                    'func': parts[4],
                    'args': [],
                    'line': +parts[1],
                    'column': null // TODO: Check to see if inline#1 (+parts[2]) points to the script number or column number.
                };
                var relativeLine = (+parts[1]); // relative to the start of the <SCRIPT> block
                var script = inlineScriptBlocks[parts[2] - 1];
                if (script) {
                    var source = getSource(item.url);
                    if (source) {
                        source = source.join('\n');
                        var pos = source.indexOf(script.innerText);
                        if (pos >= 0) {
                            item.line = relativeLine + source.substring(0, pos).split('\n').length;
                        }
                    }
                }
            } else if ((parts = lineRE3.exec(lines[line]))) {
                var url = window.location.href.replace(/#.*$/, '');
                var re = new RegExp(escapeCodeAsRegExpForMatchingInsideHTML(lines[line + 1]));
                var src = findSourceInUrls(re, [url]);
                item = {
                    'url': url,
                    'func': '',
                    'args': [],
                    'line': src ? src.line : parts[1],
                    'column': null
                };
            }

            if (item) {
                if (!item.func) {
                    item.func = guessFunctionName(item.url, item.line);
                }
                var context = gatherContext(item.url, item.line);
                var midline = (context ? context[Math.floor(context.length / 2)] : null);
                if (context && midline.replace(/^\s*/, '') === lines[line + 1].replace(/^\s*/, '')) {
                    item.context = context;
                } else {
                    // if (context) alert("Context mismatch. Correct midline:\n" + lines[i+1] + "\n\nMidline:\n" + midline + "\n\nContext:\n" + context.join("\n") + "\n\nURL:\n" + item.url);
                    item.context = [lines[line + 1]];
                }
                stack.push(item);
            }
        }
        if (!stack.length) {
            return null; // could not parse multiline exception message as Opera stack trace
        }

        return {
            'mode': 'multiline',
            'name': ex.name,
            'message': lines[0],
            'stack': stack
        };
    }

    /**
     * Adds information about the first frame to incomplete stack traces.
     * Safari and IE require this to get complete data on the first frame.
     * @param {TraceKit.StackTrace} stackInfo Stack trace information from
     * one of the compute* methods.
     * @param {string} url The URL of the script that caused an error.
     * @param {(number|string)} lineNo The line number of the script that
     * caused an error.
     * @param {string=} message The error generated by the browser, which
     * hopefully contains the name of the object that caused the error.
     * @return {boolean} Whether or not the stack information was
     * augmented.
     * @memberof TraceKit.computeStackTrace
     */
    function augmentStackTraceWithInitialElement(stackInfo, url, lineNo, message) {
        var initial = {
            'url': url,
            'line': lineNo
        };

        if (initial.url && initial.line) {
            stackInfo.incomplete = false;

            if (!initial.func) {
                initial.func = guessFunctionName(initial.url, initial.line);
            }

            if (!initial.context) {
                initial.context = gatherContext(initial.url, initial.line);
            }

            var reference = / '([^']+)' /.exec(message);
            if (reference) {
                initial.column = findSourceInLine(reference[1], initial.url, initial.line);
            }

            if (stackInfo.stack.length > 0) {
                if (stackInfo.stack[0].url === initial.url) {
                    if (stackInfo.stack[0].line === initial.line) {
                        return false; // already in stack trace
                    } else if (!stackInfo.stack[0].line && stackInfo.stack[0].func === initial.func) {
                        stackInfo.stack[0].line = initial.line;
                        stackInfo.stack[0].context = initial.context;
                        return false;
                    }
                }
            }

            stackInfo.stack.unshift(initial);
            stackInfo.partial = true;
            return true;
        } else {
            stackInfo.incomplete = true;
        }

        return false;
    }

    /**
     * Computes stack trace information by walking the arguments.caller
     * chain at the time the exception occurred. This will cause earlier
     * frames to be missed but is the only way to get any stack trace in
     * Safari and IE. The top frame is restored by
     * {@link augmentStackTraceWithInitialElement}.
     * @param {Error} ex
     * @return {TraceKit.StackTrace=} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceByWalkingCallerChain(ex, depth) {
        var functionName = /function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,
            stack = [],
            funcs = {},
            recursion = false,
            parts,
            item,
            source;

        for (var curr = computeStackTraceByWalkingCallerChain.caller; curr && !recursion; curr = curr.caller) {
            if (curr === computeStackTrace || curr === TraceKit.report) {
                continue;
            }

            item = {
                'url': null,
                'func': UNKNOWN_FUNCTION,
                'args': [],
                'line': null,
                'column': null
            };

            if (curr.name) {
                item.func = curr.name;
            } else if ((parts = functionName.exec(curr.toString()))) {
                item.func = parts[1];
            }

            if (typeof item.func === 'undefined') {
              try {
                item.func = parts.input.substring(0, parts.input.indexOf('{'));
              } catch (e) { }
            }

            if ((source = findSourceByFunctionBody(curr))) {
                item.url = source.url;
                item.line = source.line;

                if (item.func === UNKNOWN_FUNCTION) {
                    item.func = guessFunctionName(item.url, item.line);
                }

                var reference = / '([^']+)' /.exec(ex.message || ex.description);
                if (reference) {
                    item.column = findSourceInLine(reference[1], source.url, source.line);
                }
            }

            if (funcs['' + curr]) {
                recursion = true;
            }else{
                funcs['' + curr] = true;
            }

            stack.push(item);
        }

        if (depth) {
            stack.splice(0, depth);
        }

        var result = {
            'mode': 'callers',
            'name': ex.name,
            'message': ex.message,
            'stack': stack
        };
        augmentStackTraceWithInitialElement(result, ex.sourceURL || ex.fileName, ex.line || ex.lineNumber, ex.message || ex.description);
        return result;
    }

    /**
     * Computes a stack trace for an exception.
     * @param {Error} ex
     * @param {(string|number)=} depth
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTrace(ex, depth) {
        var stack = null;
        depth = (depth == null ? 0 : +depth);

        try {
            // This must be tried first because Opera 10 *destroys*
            // its stacktrace property if you try to access the stack
            // property first!!
            stack = computeStackTraceFromStacktraceProp(ex);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        try {
            stack = computeStackTraceFromStackProp(ex);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        try {
            stack = computeStackTraceFromOperaMultiLineMessage(ex);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        try {
            stack = computeStackTraceByWalkingCallerChain(ex, depth + 1);
            if (stack) {
                if(_has(ex, 'bidder')) {
                   stack.bidder = ex.bidder;
                }
                return stack;
            }
        } catch (e) {
            if (debug) {
                throw e;
            }
        }

        return {
            'name': ex.name,
            'message': ex.message,
            'mode': 'failed'
        };
    }

    /**
     * Logs a stacktrace starting from the previous call and working down.
     * @param {(number|string)=} depth How many frames deep to trace.
     * @return {TraceKit.StackTrace} Stack trace information.
     * @memberof TraceKit.computeStackTrace
     */
    function computeStackTraceOfCaller(depth) {
        depth = (depth == null ? 0 : +depth) + 1; // "+ 1" because "ofCaller" should drop one frame
        try {
            throw new Error();
        } catch (ex) {
            return computeStackTrace(ex, depth + 1);
        }
    }

    computeStackTrace.augmentStackTraceWithInitialElement = augmentStackTraceWithInitialElement;
    computeStackTrace.computeStackTraceFromStackProp = computeStackTraceFromStackProp;
    computeStackTrace.guessFunctionName = guessFunctionName;
    computeStackTrace.gatherContext = gatherContext;
    computeStackTrace.ofCaller = computeStackTraceOfCaller;
    computeStackTrace.getSource = getSource;

    return computeStackTrace;
}());

/**
 * Extends support for global error handling for asynchronous browser
 * functions. Adopted from Closure Library's errorhandler.js
 * @memberof TraceKit
 */
TraceKit.extendToAsynchronousCallbacks = function () {
    var _helper = function _helper(fnName) {
        var originalFn = window[fnName];
        window[fnName] = function traceKitAsyncExtension() {
            // Make a copy of the arguments
            var args = _slice.call(arguments);
            var originalCallback = args[0];
            if (typeof (originalCallback) === 'function') {
                args[0] = TraceKit.wrap(originalCallback);
            }
            // IE < 9 doesn't support .call/.apply on setInterval/setTimeout, but it
            // also only supports 2 argument and doesn't care what "this" is, so we
            // can just call the original function directly.
            if (originalFn.apply) {
                return originalFn.apply(this, args);
            } else {
                return originalFn(args[0], args[1]);
            }
        };
    };

    _helper('setTimeout');
    _helper('setInterval');
};

/**
 * Default function to track errors to Proper Medias back end.
 * Function gets overwritten by sendError(error) in the ad_project
 * file. 
 * @param error
 */
TraceKit.defaultSendError = function(error) {
    'use strict';
    try {
        if (!error.stack) {
            error.stack = (new Error('force-added stack')).stack;
            if (error.stack) {
                error.stack = error.stack.toString();
            }
        }
        if(!error.name) {
            error.name = 'Unknown';
        }
        if(!error.message) {
            error.message = 'Unknown';
        }

    } catch (e) {
        console.error("Error building error data");
        console.error(e);
    }

    try {

        var postData = {
            'client_timestamp' : new Date().getTime(),
            'event_id'         : '',
            'page_id'          : '',
            'session_id'       : '',
            'bidder'           : '',
            'user_id'          : '',
            'publisher'        : '',
            'rtp_file_version' : '',
            'ad_project_tag'   : '',
            'page_url'         : window.top.location.href || window.location.href || '',
            'in_iframe'        : false,
            'is_https'         : ('https:' == document.location.protocol) ? true : false,
            'user_agent'       : navigator.userAgent || '',
            'stack_trace'      : JSON.stringify(error.stack),
            'error_message'    : error.message.toString(),
            'error_name'       : error.name.toString()
        }

        // Must encode data
        if(postData && typeof(postData) === 'object') {
            var y = '', z = encodeURIComponent;
            for (var x in postData) {
               y += '&' + z(x) + '=' + z(postData[x]);
            }
            postData = y.slice(1);
        }

        //send ajax request
        var xhr = null; //new (this.XMLHttpRequest || ActiveXObject)('MSXML2.XMLHTTP.3.0');
        if(window.ActiveXObject) { 
            xhr = new ActiveXObject('Microsoft.XMLHTTP'); 
        } else if(window.XMLHttpRequest) { 
            xhr = new XMLHttpRequest(); 
        }

        // URL to send data to
        var request_url = 'https://events.proper.io/api/event';

        xhr.open("POST", request_url, 1);
        xhr.withCredentials = false;

        xhr.timeout = 2000; // time in milliseconds

        xhr.onload = function() {
            if(xhr.status == 200) { 
                // callback(xhr.responseText, xhr);
            } else { 
                console.error("Error sending exception data. xhr.status: " + xhr.status);
            }
        }

        xhr.send(postData);

    } catch (e) { 
        console.error("Error sending exception data");
        console.error(e);
    }
}

TraceKit.report.subscribe(TraceKit.defaultSendError);

//Default options:
if (!TraceKit.remoteFetching) {
    TraceKit.remoteFetching = false;
}
if (!TraceKit.collectWindowErrors) {
    TraceKit.collectWindowErrors = false;
}
if (!TraceKit.linesOfContext || TraceKit.linesOfContext < 1) {
    // 5 lines before, the offending line, 5 lines after
    TraceKit.linesOfContext = 11;
}

// Export
window.top.TraceKit = TraceKit;

}(typeof window !== 'undefined' ? window : global));

var ProperMedia = ProperMedia || {}; //define class if doesn't exist

ProperMedia.utils = (function(win, document) {

    // TraceKit Object
    var TraceKit = window.top.TraceKit;

    // See https://stackoverflow.com/questions/30106476/using-javascripts-atob-to-decode-base64-doesnt-properly-decode-utf-8-strings
    // See https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding#The_Unicode_Problem
    function b64EncodeUnicode(str) {
        // first we use encodeURIComponent to get percent-encoded UTF-8,
        // then we convert the percent encodings into raw bytes which
        // can be fed into btoa.
        return btoa(
            encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }
            )
        );
    }

    function b64DecodeUnicode(str) {
        // Going backwards: from bytestream, to percent-encoding, to original string.
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    }

    function isBase64(str) {
        try {
            return b64EncodeUnicode(b64DecodeUnicode(str)) == str;
        } catch (err) {
            return false;
        }
    }

    function getDNT() {
        return navigator.doNotTrack === '1' || window.doNotTrack === '1' || navigator.msDoNoTrack === '1' || navigator.doNotTrack === 'yes';
    }


    /**
     * Get slot name from div id
     */
    function extractSlotName(identifier) {
        try {
            var parts = identifier.replace(/^proper-ad-/, '').split("-");
            return parts[0];
        } catch(e) { 
            return false; 
        }
    }


    /**
     * safeJSONParse
     *
     * Makes an attempt to parse a JSON safely, but might fail miserably.
     *
     * @param {String} the json
     *
     * @returns {JSON|null} JSON is parsed, Null if not.
     *
     */
    function safeJsonParse(json) {
        try {
            return JSON.parse(json);
        } catch(e) {
            console.error(e);
        }
        return null;
    }

    /**
     * indexOfObjectInArray
     *
     * This function looks for an object in an array and returns the index, else -1.
     *
     * @param {Array} The array to look in.
     * @param {Object} The object to find.
     *
     * @returns {int} The array index or -1;
     */
    function indexOfObjectInArray(array, object) {
        if(typeof object === "object" && typeof array === "object") {
            object = JSON.stringify(object);
            for (var i = 0; i < array.length; i++) {
                if (typeof array[i] === "object" && JSON.stringify(array[i]) === object) {
                    return i;
                }
            }
        }
        return -1;
    }

    var properSetTimeout = {
        selfCheck : true,
        setTimeout: function(vCallback, nDelay) {
            var scope = (typeof this.selfCheck !== 'undefined') ? window : this;
            var aArgs = Array.prototype.slice.call(arguments, 2);
            if(nDelay > 0) {
                return window.setTimeout(function() {
                    TraceKit.wrap(vCallback).apply(scope, aArgs);
                }, nDelay);
            } else {
                TraceKit.wrap(vCallback).apply(scope, aArgs);
                return null;
            }
        }
    }

    var properSetInterval = {
        selfCheck : true,
        setInterval: function(vCallback, nDelay) {
            var scope = (typeof this.selfCheck !== 'undefined') ? window : this;
            var aArgs = Array.prototype.slice.call(arguments, 2);
            if(nDelay > 0) {
                return window.setInterval(function() {
                    TraceKit.wrap(vCallback).apply(scope, aArgs)
                }, nDelay);
            } else {
                TraceKit.wrap(vCallback).apply(scope, aArgs);
                return null;
            }
        }
    }


    function onElementHeightChange(elm, callback) {
        var lastHeight = deepAccess(elm, 'contentWindow.document.body.scrollHeight') || 0,
            newHeight  = deepAccess(elm, 'contentWindow.document.body.scrollHeight') || 0,
            count      = 0,
            max_count  = 10,
            iframe_def_height = 150;

        function runElementHeightChange() {
            newHeight = deepAccess(elm, 'contentWindow.document.body.scrollHeight') || 0;
            if( (lastHeight != newHeight && newHeight != iframe_def_height) || count >= max_count) {
                if( elm.onElementHeightChangeTimer ){
                    clearTimeout(elm.onElementHeightChangeTimer);
                }
                callback(newHeight);
                return;
            }
            lastHeight = newHeight;
            count++;

            if( elm.onElementHeightChangeTimer ){
                clearTimeout(elm.onElementHeightChangeTimer);
            }

            elm.onElementHeightChangeTimer = properSetTimeout.setTimeout(runElementHeightChange, 200);
        }
        runElementHeightChange();
    }

    // merge object function because Object.assign does not work on IE10/11
    function mergeObject(target) {

        // iterates over argument(s) (source objects)
        for (var i = 1; i < arguments.length; i++) {
            var source = arguments[i];

            // iterate over properties of source object
            for (var key in source) {

                // if source object has a value of property ...
                if (source.hasOwnProperty(key)) {

                    // ... copy property to target object
                    target[key] = source[key];
                }
            }
        }

        // return target object
        return target;
    }

    function deepCopy(obj){
        try {
            return JSON.parse(JSON.stringify(obj || {}));
        } catch(e) {
            console.error(e);
        }
        return null;
    }

    /**
     * deepAccess utility function useful for doing safe access (will not throw exceptions) of deep object paths.
     * @param {Object} obj The object containing the values you would like to access.
     * @param {string|number} path Object path to the value you would like to access.  Non-strings are coerced to strings.
     * @returns {*} The value found at the specified object path, or undefined if path is not found.
     */
    function deepAccess(obj, path) {
        if (!obj) {
            return;
        }
        path = String(path).split('.');
        for (var i = 0; i < path.length; i++) {
            obj = obj[path[i]];
            if (typeof obj === 'undefined' || obj == null) {
                return;
            }
        }
        return obj;
    }

    /**
     * @param {Object} obj The object to set a deep property value in
     * @param {(string|Array.<string>)} path Object path to the value you would like ot set.
     * @param {*} value The value you would like to set
     */
    function deepSetValue(obj, path, value) {
        var i;  
        path = path.split('.');   
        for (i = 0; i < path.length - 1; i++) {   
            if (i !== path.length - 1 && typeof obj[path[i]] === 'undefined') { 
                obj[path[i]] = {};    
            }   
            obj = obj[path[i]]; 
        } 
        obj[path[i]] = value; 
    }


    // Type Strings
    var tArr     = 'Array',
        tStr     = 'String',
        tFn      = 'Function',
        tNumb    = 'Number',
        tObject  = 'Object',
        tBoolean = 'Boolean',
        toString = Object.prototype.toString;

    /**
     * Return if the object is of the
     * given type.
     * @param {*} object to test
     * @param {String} _t type string (e.g., Array)
     * @return {Boolean} if object is of type _t
     */
    function isA(object, _t) {
        return toString.call(object) === '[object ' + _t + ']';
    }

    function isFn(object) {
        return isA(object, tFn);
    }

    function isStr(object) {
        return isA(object, tStr);
    }

    function isArray(object) {
        return isA(object, tArr);
    }

    function isNumber(object) {
        return isA(object, tNumb);
    }

    function isPlainObject(object) {
        return isA(object, tObject);
    }

    function isBoolean(object) {
        return isA(object, tBoolean);
    }

    /*
     * Format supply chain object for tag 
     * based request
     * @param {obj} schain object
     * @return {String} supply chain string
     */
    function formatSupplyChainString(schain) {
        var ver      = schain.ver      || '1.0',
            complete = schain.complete || 0,
            nodes    = schain.nodes    || [];

        var supplyChainObject = [
            ver.toString(),
            complete
        ];

        var supplyChainString = supplyChainObject.join(',');

        if(isArray(nodes)) {
            for (var i = 0; i < nodes.length; i++) {
                var asi = nodes[i].asi || 'proper.io',
                    sid = nodes[i].sid || '',
                    hp  = nodes[i].hp  || 1;

                var supplyChainNode = [
                    asi,
                    sid,
                    hp
                ];

                supplyChainString += '!'+supplyChainNode.join(',');
            }
        } else {
            supplyChainNode = [
                'proper.io',
                '',
                1
            ];
            supplyChainString += '!'+supplyChainNode.join(',');
        }

        return supplyChainString;
    }

    /**
     * Checks if the current context is in an iFrame
     * 
     * @author Tanner Mckenney <tanner@proper.io>
     * 
     * @returns bool true if iframe, false otherwise. 
     */
    function isIFrame() {
        try {
            return window.self !== window.top;
        } catch (e) {
            return true;
        }
    }

    /* Get current page canonical url */
    function getCanonicalUrl() {
        var link;
        if (window.self !== window.top) {
            try {
                link = window.top.document.head.querySelector('link[rel="canonical"][href]');
            } catch (e) { }
        } else {
            link = document.head.querySelector('link[rel="canonical"][href]');
        }

        if (link) {
            return link.href;
        }
        return '';
    }

    /* Get information on page refresh */
    function getPageRefreshed() {
        try {
            if (performance && performance.navigation) {
                return performance.navigation.type === performance.navigation.TYPE_RELOAD;
            }
        } catch (e) { }
        return false;
    }

    function formatQueryString(data, cache) {
        // Must encode data
        if(data && typeof(data) === 'object') {
            var y = '', e = encodeURIComponent;
            for (x in data) {
                if (data.hasOwnProperty(x)) {
                    if(data[x]) {
                        y += '&' + e(x) + '=' + e(data[x]);
                    }
                }
            }
            data = y.slice(1) + (! cache ? '&_t=' + new Date : '');
        }
        return data;
    }


    function getCanonicalUrl() {
        try { return document.querySelector("link[rel='canonical']").href; }
        catch (e) { return ''; }
    }

    function getPageUrl() {
        try { return window.top.location.href; }
        catch (e) { return window.location.href; }
    }

    function getPageDomain() {
        try { return window.location.hostname.replace(/^www\./,""); }
        catch (e) { return ""; }
    }

    function getPageReferrer() {
        try{ return document.referrer; } 
        catch (e) { return ""; }
    }

    function matchDomain(domain, url) {

        //parse domain from url
        if(url.indexOf('/') !== -1) {
            var a = url.split('/');
            if(typeof a[2] !== "undefined") url = a[2];
        }
        if(url.indexOf('?') !== -1) {
            var b = url.split('?');
            if(typeof b[0] !== "undefined") url = b[0];
        }

        //direct matches
        if(domain == url) return true;

        //subdomain check -> ends with (ie: .proper.io in local.proper.io)
        if(endsWith(domain, '.'+url)==true) return true;
        if(endsWith(url, '.'+domain)==true) return true;

        //no match
        return false;
    }

    function endsWith(str, suffix) {
        return str.indexOf(suffix, str.length - suffix.length) !== -1;
    }

    function getPagePath() {
        try { return window.top.location.pathname; }
        catch (e) {return window.location.pathname; }
    }

    function checkOutOfPage(ad_unit) {
        var suffix = "_oop";
        return ad_unit.toLowerCase().indexOf(suffix, ad_unit.length - suffix.length) !== -1;
    }

    function isIOS() {

        var iDevices = ['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'];
        if (!!navigator.platform) {
            while (iDevices.length) { if (navigator.platform === iDevices.pop()){ return true; } }
        }

        return false;
    }

    function getUrlParameters(url) {
        var data = decodeURIComponent(url).split('&');

        var res = {};
        for (var i = 0; i < data.length; i++) {
            var parm = data[i].split('=');
            res[parm[0]] = parm[1];
        }

        return res;
    }

    function getCookies() {
        var res = {};

        var data = document.cookie; if(typeof data === 'undefined') return res;

        data = data.split(';');
        for (var i = 0; i < data.length; i++) {
            var parm = data[i].split('=');
            if(parm.length > 1) res[parm[0].trim()] = parm[1].trim();
        }

        return res;
    }

    function getCookieValue(a) {
        var b = document.cookie.match('(^|;)\\s*' + a + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : undefined;
    }

    function setDataInLocalStorage(key, value) {
        if (hasLocalStorage()) {
            window.localStorage.setItem(key, value);
        }
    }

    function getDataFromLocalStorage(key) {
        if (hasLocalStorage()) {
            return window.localStorage.getItem(key);
        }
    }

    function removeDataFromLocalStorage(key) {
        if (hasLocalStorage()) {
            window.localStorage.removeItem(key);
        }
    }

    function hasLocalStorage() {
        try {
            return !!window.localStorage;
        } catch (e) {
            logError('Local storage api disabled');
        }
    }

    /**
     * @returns {boolean}
     */
    function localStorageIsEnabled() {
        try {
            localStorage.setItem('proper.localStorageTest', '1');
            return localStorage.getItem('proper.localStorageTest') === '1';
        } catch (error) {}
        return false;
    }

    /**
     * @returns {(boolean|undefined)}
     */
    function checkCookieSupport() {
      if (window.navigator.cookieEnabled || !!document.cookie.length) {
        return true;
      }
    }

    /**
    * @returns {boolean}
    */
    function cookiesAreEnabled() {
        if (checkCookieSupport()) {
            return true;
        }
        window.document.cookie = 'prebid.cookieTest';
        return window.document.cookie.indexOf('prebid.cookieTest') !== -1;
    }

    // get timestamp in ms
    function getTimestampMs() {
        var d = new Date();
        return d.getTime();
    }

    /**
     * Get how much time has passed. Ms between t2 - t1.
     * If t2 is not passed then current time is used.
     * t2 should be greater than t1
     * @param {Int} t1 - Timestamp in the past
     * @param {Int} t2 - Timestamp that is more current
     * @return {Int} Difference between two timestamps
     */
    function getTimePassed(t1, t2) {
        if(!t2) {
            var d = new Date();
            var t2 = d.getTime();
        }
        return t2 - t1;
    }

    function calcResponseMs(start, finish) {
        return (start > 0 && finish > 0 && finish > start) ? finish - start : -1;
    }

    function formatDate() {
        now    = new Date();
        year   = "" + now.getFullYear();
        month  = "" + (now.getMonth() + 1); if (month.length == 1) { month = "0" + month; }
        day    = "" + now.getDate(); if (day.length == 1) { day = "0" + day; }
        hour   = "" + now.getHours(); if (hour.length == 1) { hour = "0" + hour; }
        minute = "" + now.getMinutes(); if (minute.length == 1) { minute = "0" + minute; }
        second = "" + now.getSeconds(); if (second.length == 1) { second = "0" + second; }
        return year + "-" + month + "-" + day + " " + hour + ":" + minute + ":" + second;
    }

    function checkData(arr) {
        if(typeof arr == 'undefined' || (!(arr instanceof Array) && !(arr instanceof Object)) )  arr = [];
        return arr;
    }

    function generateUUID(){
        var d = new Date().getTime();
        if(window.performance && typeof window.performance.now === "function"){
            d += performance.now(); //use high-precision timer if available
        }
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = (d + Math.random()*16)%16 | 0;
            d = Math.floor(d/16);
            return (c=='x' ? r : (r&0x3|0x8)).toString(16);
        });
        return uuid;
    }

    /** 
     * Create a random string 
     * @param {Int} length - Lenght of string to create
     * @return {string}
     */
    function makeid(length) {
        var result           = '';
        var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        var charactersLength = characters.length;
        for ( var i = 0; i < length; i++ ) {
          result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }


    /** 
     * Validate values to be sent to reporting endpoint
     * @param {Mixed} variable - Variable to check
     * @param {Object} validation_rules - Rules to validate variables value
     * @return {Mixed} validated value
     */
    function validateValue(variable, validation_rules) {

        if(validation_rules['type'] === 'string') {
            var default_val = (typeof validation_rules['default_val'] === 'string') ? validation_rules['default_val'] : '';
            var max_len = (typeof validation_rules['max_len'] === 'number') ? validation_rules['max_len'] : 256;
            var min_len = (typeof validation_rules['min_len'] === 'number') ? validation_rules['min_len'] : 0;

            if(typeof variable === 'number') {
                variable = variable.toString();
            }

            if(typeof variable !== 'string') {
                variable = default_val;
            }

            if(variable.length > max_len) {
                variable = variable.substring(0, max_len);
            }

        } else if(validation_rules['type'] === 'number') {
            var default_val = (typeof validation_rules['default_val'] === 'number') ? validation_rules['default_val'] : 0;
            var max = (typeof validation_rules['max'] === 'number') ? validation_rules['max'] : 99999;
            var min = (typeof validation_rules['min'] === 'number') ? validation_rules['min'] : 0;

            if(typeof variable === 'string' && /^(\d+)?(\.\d+)$/.test(variable)) {
                variable = (variable.indexOf('.') > -1) ? parseFloat(variable) : parseInt(variable);
            }

            if(typeof variable !== 'number') {
                variable = default_val;
            }

            if(variable > max) {
                variable = max;
            }

            if(variable < min) {
                variable = min;
            }

        } else if(validation_rules['type'] === 'boolean') {
            var default_val = (typeof validation_rules['default_val'] === 'boolean') ? validation_rules['default_val'] : false;

            if(typeof variable === 'number') {
                if(variable === 0) {
                    variable = false;
                } else if(variable === 1) {
                    variable = true;
                }
            } else if(typeof variable === 'string') {
                if(variable === 'false' || variable === '0') {
                    variable = false;
                } else if(variable === 'true' || variable === '1') {
                    variable = true;
                }
            }

            if(typeof variable !== 'boolean') {
                variable = default_val;
            }
        }

        return variable;
    }

    /**
     * Round number
     */
    function round(value, decimals) {
        return Number(Math.round(value+'e'+decimals)+'e-'+decimals);
    }

    /**
     * Get The values of an object
     * @param {Array}
     */
    function objectValues(obj) {
        try {
            return Object.keys(obj).map(function(e) {
                return obj[e];
            });
        } catch (e) {
            return [];
        }
    }

    /**
     * Sort object properties (only own properties will be sorted).
     * (https://gist.github.com/umidjons/9614157#gistcomment-1774654)
     * @param {object} obj object to sort properties
     * @param {string|int} sortedBy 1 - sort object properties by specific value.
     * @param {bool} isNumericSort true - sort object properties as numeric value, false - sort as string value.
     * @param {bool} reverse false - reverse sorting.
     * @returns {object} New sorted object
     */
    function sortProperties(obj, sortedBy, isNumericSort, reverse) {
        sortedBy      = sortedBy || 1; // by default first key
        isNumericSort = isNumericSort || false; // by default text sort
        reverse       = reverse || false; // by default no reverse

        var reversed = (reverse) ? -1 : 1;

        var sortable = [];
        for (var key in obj) {
            if (obj.hasOwnProperty(key)) {
                sortable.push([key, obj[key]]);
            }
        }
        if (isNumericSort) {
            sortable.sort(function (a, b) {
                return reversed * (a[1][sortedBy] - b[1][sortedBy]);
            });
        } else {
            sortable.sort(function (a, b) {
                var x = a[1][sortedBy].toLowerCase(),
                    y = b[1][sortedBy].toLowerCase();
                return x < y ? reversed * -1 : x > y ? reversed : 0;
            });
        }

        var newObject = {};
        for (var i = 0; i < sortable.length; i++) {
            var key = sortable[i][0];
            var value = sortable[i][1];
            newObject[key] = value;
        }
        return newObject;
    }


    /** 
     * Polyfill for older browsers
     */

    // IE8 support
    if (!Object.keys) {
        Object.keys = (function() {
            'use strict';
            var hasOwnProperty = Object.prototype.hasOwnProperty,
            hasDontEnumBug = !({ toString: null }).propertyIsEnumerable('toString'),
            dontEnums = [
                'toString',
                'toLocaleString',
                'valueOf',
                'hasOwnProperty',
                'isPrototypeOf',
                'propertyIsEnumerable',
                'constructor'
            ],
            dontEnumsLength = dontEnums.length;

            return function(obj) {
                if (typeof obj !== 'object' && (typeof obj !== 'function' || obj === null)) {
                    throw new TypeError('Object.keys called on non-object');
                }

                var result = [], prop, i;

                for (prop in obj) {
                    if (hasOwnProperty.call(obj, prop)) {
                        result.push(prop);
                    }
                }

                if (hasDontEnumBug) {
                    for (i = 0; i < dontEnumsLength; i++) {
                        if (hasOwnProperty.call(obj, dontEnums[i])) {
                            result.push(dontEnums[i]);
                        }
                    }
                }
                return result;
            };
        }());
    }

    /**
     * Filter object 
     */
    Object.filter = function(obj, predicate) {
        var result = {}, key;

        for (key in obj) {
            if (obj.hasOwnProperty(key) && predicate(key)) {
                result[key] = obj[key];
            }
        }

        return result;
    };

    //adding IE8 support for trim()
    if (!String.prototype.trim) {
        String.prototype.trim = function () {
            return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
        };
    }

    // Adding IE11 supprot for includes()
    if (!String.prototype.includes) {
        String.prototype.includes = function(search, start) {
            'use strict';
            if (typeof start !== 'number') {
                start = 0;
            }

            if (start + search.length > this.length) {
                return false;
            } else {
                return this.indexOf(search, start) !== -1;
            }
        };
    }

    // IE8 Support for Date.now
    Date.now = Date.now || function() { return +new Date; };    

    // Custom event polyfill for IE
    if(!window.CustomEvent !== "function" ) {
        window.CustomEvent = function CustomEvent ( event, params ) {
            params = params || { bubbles: false, cancelable: false, detail: null };
            var evt = document.createEvent( 'CustomEvent' );
            evt.initCustomEvent( event, params.bubbles, params.cancelable, params.detail );
            return evt;
        }
    };


    //export functions
    return {
        getDNT: getDNT,
        isBase64: isBase64,
        b64EncodeUnicode: b64EncodeUnicode,
        b64DecodeUnicode: b64DecodeUnicode,
        properSetTimeout: properSetTimeout,
        properSetInterval: properSetInterval,
        safeJsonParse: safeJsonParse,
        mergeObject: mergeObject,
        deepCopy: deepCopy,
        deepAccess: deepAccess,
        deepSetValue: deepSetValue,
        indexOfObjectInArray: indexOfObjectInArray,
        extractSlotName: extractSlotName,
        onElementHeightChange: onElementHeightChange,
        formatSupplyChainString: formatSupplyChainString,
        isIFrame: isIFrame,
        getCanonicalUrl: getCanonicalUrl,
        getPageRefreshed: getPageRefreshed,
        getPageUrl: getPageUrl,
        getPagePath: getPagePath,
        getPageDomain: getPageDomain,
        getPageReferrer: getPageReferrer,
        getUrlParameters: getUrlParameters,
        getPageRefreshed: getPageRefreshed,
        getTimestampMs:getTimestampMs,
        getTimePassed: getTimePassed,
        objectValues: objectValues,
        sortProperties: sortProperties,
        generateUUID: generateUUID,
        validateValue: validateValue,
        formatQueryString: formatQueryString,
        calcResponseMs: calcResponseMs,
        getCookieValue: getCookieValue,
        localStorageIsEnabled: localStorageIsEnabled,
        checkCookieSupport: checkCookieSupport,
        cookiesAreEnabled: cookiesAreEnabled,
        checkOutOfPage: checkOutOfPage,
        matchDomain: matchDomain,
        checkData: checkData,
        makeid: makeid,
        round: round,
        isFn: isFn,
        isStr: isStr,
        isArray: isArray,
        isNumber: isNumber,
        isPlainObject: isPlainObject,
        isBoolean: isBoolean,
        setDataInLocalStorage: setDataInLocalStorage,
        getDataFromLocalStorage: getDataFromLocalStorage,
        removeDataFromLocalStorage: removeDataFromLocalStorage,
        hasLocalStorage: hasLocalStorage
    };

})(window, document);

var ProperMedia = ProperMedia || {}; // define class if doesn't exist

ProperMedia.jquery = (function(win, document) {

    // TraceKit Object
    var TraceKit = window.top.TraceKit;

    //needed for document ready function
    var readyList = [];
    var readyFired = false;
    var readyEventHandlersInstalled = false;

    // call this when the document is ready
    function ready() {
        if (!readyFired) {
            // this must be set to true before we start calling callbacks
            readyFired = true;
            for (var i = 0; i < readyList.length; i++) {
                readyList[i].fn.call(win, readyList[i].ctx);
            }
            // allow any closures held by these functions to free
            readyList = [];
        }
    }

    // call this when the document is ready
    function readyStateChange() {
        if ( document.readyState === "complete" ) {
            ready();
        }
    }

    // cross browser version of jquery's $( document ).ready() function
    var docReady = function(callback, context) {
        // if ready has already fired, then just schedule the callback
        // to fire asynchronously, but right away
        if (readyFired) {
            ProperMedia.utils.properSetTimeout.setTimeout(function() {callback(context);}, 1);
            return;
        } else {
            // add the function and context to the list
            readyList.push({fn: callback, ctx: context});
        }
        // if document already ready to go, schedule the ready function to run
        if (document.readyState === "complete") {
            ProperMedia.utils.properSetTimeout.setTimeout(ready, 1);
        } else if (!readyEventHandlersInstalled) {
            if (document.addEventListener) {
                document.addEventListener("DOMContentLoaded", TraceKit.wrap(ready), false);
                win.addEventListener("load", TraceKit.wrap(ready), false);
            } else {
                document.attachEvent("onreadystatechange", TraceKit.wrap(readyStateChange));
                win.attachEvent("onload", TraceKit.wrap(ready));
            }
            readyEventHandlersInstalled = true;
        }
    }

    //recreating jquery selector
    var jquery_utils = {
        obj: {},
        sel: function (val) {
            if (typeof val === "function") { //shorthand for $( document ).ready()
                docReady(val);
            }
            else if (typeof val === "object") this.obj = val;
            else this.obj = document.querySelectorAll(val)[0];

            return this;
        },
        ready: function(func) {
            docReady(func);
            return this;
        },
        remove: function () {
            if(typeof this.obj === 'undefined') return false;
            this.obj.parentNode.removeChild(this.obj);
            return this;
        },
        hide: function () {
            if(typeof this.obj === 'undefined') return false;
            this.obj.style.display = 'none';
            return this;
        },
        show: function () {
            if(typeof this.obj === 'undefined') return false;
            this.obj.style.display = '';
            return this;
        },
        addClass: function(className) {
            if(typeof this.obj === 'undefined') return false;

            var list = className.split(" ");
            for (var i = 0; i < list.length; i++) {
              if(this.obj.classList) this.obj.classList.add(list[i]);
              else this.obj.className += ' ' + list[i];
            }

            return this;
        },
        removeClass: function(className) {
            if(typeof this.obj === 'undefined') return false;

            if (this.obj.classList) this.obj.classList.remove(className);
            else {
              var newClassName = "";
              var classes = this.className.split(" ");
              for(var i = 0; i < classes.length; i++) {
                  if(classes[i] !== remove) newClassName += classes[i] + " ";
              }
              this.obj.className = newClassName;
            }

            return this;
        },
        hasClass: function(className) {
            if(typeof this.obj === 'undefined') return false;

            if (this.obj.classList) {
                return (this.obj.classList.contains(className));
            } else {
                var regex = new RegExp('(?:^|\\s)' + className + '(?!\\S)');
                return (this.obj.className.match(regex) !== null) ? true : false;
            }

            return this;
        },
        removeStyle: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj.style='';
            return this;
        },
        attr: function(key,val) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof val === 'undefined') { //get attribute value
              if(typeof this.obj.getAttribute === 'undefined') return null;
              else return this.obj.getAttribute(key);
            }
            else { //set attribute value
              if(typeof this.obj.setAttribute === 'undefined') return false;
              else {
                this.obj.setAttribute(key, val);
                return this;
              }
            }
        },
        after: function(htmlString) {
            if(typeof this.obj === 'undefined') return false;
            this.obj.insertAdjacentHTML('afterend', htmlString);
            return this;
        },
        before: function(htmlString) {
            if(typeof this.obj === 'undefined') return false;
            this.obj.insertAdjacentHTML('beforebegin', htmlString);
            return this;
        },
        insideBefore: function(htmlString) {
            if(typeof this.obj === 'undefined') return false;
            this.obj.insertAdjacentHTML('afterbegin', htmlString);
            return this;
        },
        append: function(newObj) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof newObj === "string") {
              this.obj.innerHTML = this.obj.innerHTML + newObj;
            }
            else this.obj.appendChild(newObj);
            return this;
        },
        html: function(htmlString) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof htmlString !== 'undefined')  {
                this.obj.innerHTML = htmlString;
                return this;
            }
            else {
                return this.obj.innerHTML;
            }
        },
        parent: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.parentNode;
            return this;
        },
        closest: function(className) {
            if(typeof this.obj === 'undefined' || !className) return false;
            while((this.obj = this.obj.parentNode)) {
              if(typeof this.obj.classList !== 'undefined' && this.obj.classList.contains(className)) {
                return this;
              }
            }
            return false;
        },
        getChildNodes: function() {
          if(typeof this.obj === 'undefined') return false;
          // return this.obj.childNodes;
          return this.obj.children;
        },
        val: function(text) {
            if(typeof this.obj === 'undefined') return false;
            if(typeof text === 'undefined') return this.obj.value;
            else {
              this.obj.value = text;
              return this;
            }
        },
        on: function(type, func) {
            if(typeof this.obj === 'undefined') return false;
            func = TraceKit.wrap(func);
            if(type=="click") {
              this.obj.onclick = func;
            }
            else if(type=="mouseover" || type=="mouseenter") {
              this.obj.addEventListener("mouseover", func, false);
            }
            else if(type=="mouseout" || type=="mouseleave") {
              this.obj.addEventListener("mouseout", func, false);
            }
            else {
              this.obj.addEventListener(type, func);
            }

            return this;
        },
        contents: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.contentDocument ? this.obj.contentDocument : this.obj.contentWindow.document;
            return this;
        },
        contentWin: function() {
            if(typeof this.obj === 'undefined') return false;
            if(this.obj.contentWindow) this.obj = this.obj.contentWindow;
            else if(this.obj.contentDocument) this.obj = this.obj.contentDocument.defaultView;

            return this;
        },
        find: function(val) {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.querySelectorAll(val)[0];
            return this;
        },
        width: function() {
            return document.documentElement.clientWidth;
        },
        height: function() {
            return document.documentElement.clientHeight;
        },
        prev: function() {
            if(typeof this.obj === 'undefined') return false;
            this.obj = this.obj.previousElementSibling;
            return this;
        },
        prop: function(type, val) {
            if(typeof this.obj === 'undefined') return false;
            this.obj.checked = val;
            return this;
        }


    };

    var jquery = function(val) {
        return jquery_utils.sel(val);
    }


    //cross browser ajax request (includes jsonp support)
    var req_id = 0;
    var request_count = 0;
    var error_count = 0;
    jquery.ajax = function( parms ) {

        var url             = parms.url             || '',            // Request URL
            callback        = parms.success         || function() {}, // Success callback function
            errFunc         = parms.error           || function() {}, // Error callback function
            onloadFn        = parms.onload          || false,         // scipt onload callback function
            cache           = parms.cache           || false,         // Cache url
            data            = parms.data            || {},            // Request Payload
            headers         = parms.headers         || {},            // Request Headers
            method          = parms.method          || 'GET',         // Request method
            special         = parms.special         || '',            // Special Option
            contentType     = parms.contentType     || ''             // Content Type
            requestType     = parms.requestType     || 'cors',        // Request Type
            timeout         = parms.timeout         || 1500,          // Time in milliseconds
            edge            = parms.edge            || false,         // Send request through edge bidder
            bidder          = parms.bidder          || '',            // Bidder name for edge bidding

            withCredentials = (typeof parms.withCredentials === 'boolean') ? parms.withCredentials : true; // With Credentials

        if(typeof TraceKit !== 'undefined') {
            // Wrap Functions in TraceKit
            callback = TraceKit.wrap(callback);
            errFunc  = TraceKit.wrap(errFunc);
        }

        //jsonp request
        if(requestType == "jsonp") {
            req_id++;
            request_count++;

            if(callback) {
                var separator = "&";

                var mycallback = 'proper_' + guid() + "_" + req_id;
                window[mycallback] = function(e) { callback(e); };

                var cname = "callback"; var callback_scope = 'window.';
                if(special && special == "index") {
                    cname = "fn";
                }
                url += separator+cname+'='+callback_scope+mycallback;
            }

            var script = document.createElement('script');
            script.async = true; script.src = url;

            if(onloadFn && ProperMedia.utils.isFn(onloadFn)) {
                script.onload = onloadFn();
            }

            document.getElementsByTagName('head')[0].appendChild(script);
            return true;

        } else {

            if(edge == true) {
                // Build request params
                var edge_request = {
                    'url': url,
                    'name': bidder,
                    'method': method,
                    'payload': data
                }
                // Append request
                edgeBidderObj.addRequest(edge_request, callback, errFunc);

            } else {

                var payload = ProperMedia.utils.formatQueryString(data);

                //send ajax request
                try {
                    var xhr = null; //new (this.XMLHttpRequest || ActiveXObject)('MSXML2.XMLHTTP.3.0');
                    if(window.ActiveXObject) {
                        xhr = new ActiveXObject('Microsoft.XMLHTTP');
                    } else if(window.XMLHttpRequest) {
                        xhr = new XMLHttpRequest();
                    }

                    xhr.open(method, url, 1);
                    if(requestType == "cors") {
                        xhr.withCredentials = withCredentials;
                    } else if(requestType == "fetch") {
                        xhr.withCredentials = false;
                    }

                    xhr.timeout = timeout; // time in milliseconds

                    xhr.onload = function() {
                        if(xhr.status == 200) {
                            callback(xhr.responseText, xhr);
                        } else {
                            errFunc(xhr.status);
                            bidderError(xhr);
                        }
                    }

                    xhr.onerror = function() {
                        errFunc(xhr.status);
                        bidderError(xhr);
                    }

                    xhr.ontimeout = function() {
                        errFunc(xhr.status);
                    }

                    for (var headerKey in headers) {
                        xhr.setRequestHeader(headerKey, headers[headerKey]);
                    }

                    request_count++;
                    xhr.send(payload);

                } catch (e) {
                    errFunc();
                    throw e;
                }
            }
        }
    }

    // Function for tracking bidder errors (blocked)
    var bidderError = function(xhr) {
        if (xhr.status == 0) {
            // Logic here to add to blocked variable
            error_count++;

            if (error_count >= 25 && ((error_count/request_count) >= .80)){
                // Enough bidders were blocked, must be an adblocker
                var event = new CustomEvent('proper-ad-bidders-blocked', {});
                window.dispatchEvent(event);
            }
        }
    }

    // Proper Media's Edge Bidder
    var edgeBidder = function() {
        var ENDPOINT_URL    = 'https://eb-staging.proper.io/v1/endpoint',
            timeout_handler = null,
            timeout_ms      = 250,
            max_batch_size  = 15,
            callback_map    = {},
            data            = [];

        function addRequest(request, callback, errFunc) {

            // Create unique if for callback
            var callback_id = guid();
            // Create callback map
            callback_map[callback_id] = {
                'success': callback,
                'error': errFunc
            }

            var default_request = {
                'url': '',
                'name': '',
                'method': '',
                'payload': {},
                'callback_id': callback_id
            };
            // Create new request object
            new_request = mergeObject(default_request, request);
            // Append new request
            data.push(new_request);

            if(data.length >= max_batch_size) {
                sendEdgeRequest();
            } else {
                // Reset timeout
                clearTimeout(timeout_handler);
                timeout_handler = null;
                timeout_handler = ProperMedia.utils.properSetTimeout.setTimeout(
                    sendEdgeRequest,
                    timeout_ms
                );
            }
        }

        function sendEdgeRequest() {
            // Clear timeout
            clearTimeout(timeout_handler);
            timeout_handler = null;

            // Check that there is data to send
            if(data.length > 0) {
                // send request
                jquery.ajax({
                    url: ENDPOINT_URL,
                    method: "POST",
                    requestType: 'cors',
                    data: JSON.stringify({"bidders": data}),
                    success: function(resp) {
                        // Parse Json Response
                        responses = safeJsonParse(resp);
                        // Loop through returned bids
                        if(responses && responses.bids && responses.bids.length > 0) {
                            for (var i = 0; i < responses.bids.length; i++) {
                                // Default respose object
                                var default_response = {
                                    'bidder': '',
                                    'payload': {},
                                    'callback_id': ''
                                };
                                // Create new response object
                                var response = mergeObject(default_response, responses.bids[i]);
                                // Check if we have a callback function
                                if(
                                    typeof response.callback_id !== 'undefined' &&
                                    typeof callback_map[response.callback_id] !== 'undefined' &&
                                    typeof callback_map[response.callback_id].success == 'function'
                                ) {
                                    callback_map[response.callback_id].success(JSON.stringify(response.payload));
                                    // Delete callback map
                                    delete callback_map[response.callback_id];
                                }
                            }
                        }
                    },
                    error: function(e) {
                        console.error("HOLY SMOKES");
                    }
                });
                // Clear data
                data = [];
            }
        }

        return {
            addRequest: addRequest,
            sendEdgeRequest: sendEdgeRequest
        };
    }

    var edgeBidderObj = edgeBidder();

    function guid() {
        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1,5);
        }
        return s4() + s4() + '_' + s4() + s4();
    }

    //export functions
    return {
        $: jquery
    };

})(window, document);

/*!
 * UAParser.js v0.7.19
 * Lightweight JavaScript-based User-Agent string parser
 * https://github.com/faisalman/ua-parser-js
 *
 * Copyright © 2012-2016 Faisal Salman <fyzlman@gmail.com>
 * Dual licensed under GPLv2 or MIT
 *
 * wget https://raw.githubusercontent.com/faisalman/ua-parser-js/master/src/ua-parser.js
 */
(function (window, undefined) {

    'use strict';

    //////////////
    // Constants
    /////////////

    var LIBVERSION  = '0.7.19',
        EMPTY       = '',
        UNKNOWN     = '?',
        FUNC_TYPE   = 'function',
        UNDEF_TYPE  = 'undefined',
        OBJ_TYPE    = 'object',
        STR_TYPE    = 'string',
        MAJOR       = 'major', // deprecated
        MODEL       = 'model',
        NAME        = 'name',
        TYPE        = 'type',
        VENDOR      = 'vendor',
        VERSION     = 'version',
        ARCHITECTURE= 'architecture',
        CONSOLE     = 'console',
        MOBILE      = 'mobile',
        TABLET      = 'tablet',
        SMARTTV     = 'smarttv',
        WEARABLE    = 'wearable',
        EMBEDDED    = 'embedded';

    ///////////
    // Helper
    //////////

    var util = {
        extend : function (regexes, extensions) {
            var margedRegexes = {};
            for (var i in regexes) {
                if (extensions[i] && extensions[i].length % 2 === 0) {
                    margedRegexes[i] = extensions[i].concat(regexes[i]);
                } else {
                    margedRegexes[i] = regexes[i];
                }
            }
            return margedRegexes;
        },
        has : function (str1, str2) {
          if (typeof str1 === "string") {
            return str2.toLowerCase().indexOf(str1.toLowerCase()) !== -1;
          } else {
            return false;
          }
        },
        lowerize : function (str) {
            return str.toLowerCase();
        },
        major : function (version) {
            return typeof(version) === STR_TYPE ? version.replace(/[^\d\.]/g,'').split(".")[0] : undefined;
        },
        trim : function (str) {
          return str.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
        }
    };

    ///////////////
    // Map helper
    //////////////

    var mapper = {

        rgx : function (ua, arrays) {

            //var result = {},
            var i = 0, j, k, p, q, matches, match;//, args = arguments;

            // loop through all regexes maps
            while (i < arrays.length && !matches) {

                var regex = arrays[i],       // even sequence (0,2,4,..)
                    props = arrays[i + 1];   // odd sequence (1,3,5,..)
                j = k = 0;

                // try matching uastring with regexes
                while (j < regex.length && !matches) {

                    matches = regex[j++].exec(ua);

                    if (!!matches) {
                        for (p = 0; p < props.length; p++) {
                            match = matches[++k];
                            q = props[p];
                            // check if given property is actually array
                            if (typeof q === OBJ_TYPE && q.length > 0) {
                                if (q.length == 2) {
                                    if (typeof q[1] == FUNC_TYPE) {
                                        // assign modified match
                                        this[q[0]] = q[1].call(this, match);
                                    } else {
                                        // assign given value, ignore regex match
                                        this[q[0]] = q[1];
                                    }
                                } else if (q.length == 3) {
                                    // check whether function or regex
                                    if (typeof q[1] === FUNC_TYPE && !(q[1].exec && q[1].test)) {
                                        // call function (usually string mapper)
                                        this[q[0]] = match ? q[1].call(this, match, q[2]) : undefined;
                                    } else {
                                        // sanitize match using given regex
                                        this[q[0]] = match ? match.replace(q[1], q[2]) : undefined;
                                    }
                                } else if (q.length == 4) {
                                        this[q[0]] = match ? q[3].call(this, match.replace(q[1], q[2])) : undefined;
                                }
                            } else {
                                this[q] = match ? match : undefined;
                            }
                        }
                    }
                }
                i += 2;
            }
        },

        str : function (str, map) {

            for (var i in map) {
                // check if array
                if (typeof map[i] === OBJ_TYPE && map[i].length > 0) {
                    for (var j = 0; j < map[i].length; j++) {
                        if (util.has(map[i][j], str)) {
                            return (i === UNKNOWN) ? undefined : i;
                        }
                    }
                } else if (util.has(map[i], str)) {
                    return (i === UNKNOWN) ? undefined : i;
                }
            }
            return str;
        }
    };

    ///////////////
    // String map
    //////////////

    var maps = {

        browser : {
            oldsafari : {
                version : {
                    '1.0'   : '/8',
                    '1.2'   : '/1',
                    '1.3'   : '/3',
                    '2.0'   : '/412',
                    '2.0.2' : '/416',
                    '2.0.3' : '/417',
                    '2.0.4' : '/419',
                    '?'     : '/'
                }
            }
        },

        device : {
            amazon : {
                model : {
                    'Fire Phone' : ['SD', 'KF']
                }
            },
            sprint : {
                model : {
                    'Evo Shift 4G' : '7373KT'
                },
                vendor : {
                    'HTC'       : 'APA',
                    'Sprint'    : 'Sprint'
                }
            }
        },

        os : {
            windows : {
                version : {
                    'ME'        : '4.90',
                    'NT 3.11'   : 'NT3.51',
                    'NT 4.0'    : 'NT4.0',
                    '2000'      : 'NT 5.0',
                    'XP'        : ['NT 5.1', 'NT 5.2'],
                    'Vista'     : 'NT 6.0',
                    '7'         : 'NT 6.1',
                    '8'         : 'NT 6.2',
                    '8.1'       : 'NT 6.3',
                    '10'        : ['NT 6.4', 'NT 10.0'],
                    'RT'        : 'ARM'
                }
            }
        }
    };

    //////////////
    // Regex map
    /////////////

    var regexes = {

        browser : [[

            // Presto based
            /(opera\smini)\/([\w\.-]+)/i,                                       // Opera Mini
            /(opera\s[mobiletab]+).+version\/([\w\.-]+)/i,                      // Opera Mobi/Tablet
            /(opera).+version\/([\w\.]+)/i,                                     // Opera > 9.80
            /(opera)[\/\s]+([\w\.]+)/i                                          // Opera < 9.80
            ], [NAME, VERSION], [

            /(opios)[\/\s]+([\w\.]+)/i                                          // Opera mini on iphone >= 8.0
            ], [[NAME, 'Opera Mini'], VERSION], [

            /\s(opr)\/([\w\.]+)/i                                               // Opera Webkit
            ], [[NAME, 'Opera'], VERSION], [

            // Mixed
            /(kindle)\/([\w\.]+)/i,                                             // Kindle
            /(lunascape|maxthon|netfront|jasmine|blazer)[\/\s]?([\w\.]*)/i,
                                                                                // Lunascape/Maxthon/Netfront/Jasmine/Blazer

            // Trident based
            /(avant\s|iemobile|slim|baidu)(?:browser)?[\/\s]?([\w\.]*)/i,
                                                                                // Avant/IEMobile/SlimBrowser/Baidu
            /(?:ms|\()(ie)\s([\w\.]+)/i,                                        // Internet Explorer

            // Webkit/KHTML based
            /(rekonq)\/([\w\.]*)/i,                                             // Rekonq
            /(chromium|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon)\/([\w\.-]+)/i
                                                                                // Chromium/Flock/RockMelt/Midori/Epiphany/Silk/Skyfire/Bolt/Iron/Iridium/PhantomJS/Bowser/QupZilla/Falkon
            ], [NAME, VERSION], [

            /(konqueror)\/([\w\.]+)/i                                           // Konqueror
            ], [[NAME, 'Konqueror'], VERSION], [

            /(trident).+rv[:\s]([\w\.]+).+like\sgecko/i                         // IE11
            ], [[NAME, 'IE'], VERSION], [

            /(edge|edgios|edga)\/((\d+)?[\w\.]+)/i                              // Microsoft Edge
            ], [[NAME, 'Edge'], VERSION], [

            /(yabrowser)\/([\w\.]+)/i                                           // Yandex
            ], [[NAME, 'Yandex'], VERSION], [

            /(puffin)\/([\w\.]+)/i                                              // Puffin
            ], [[NAME, 'Puffin'], VERSION], [

            /(focus)\/([\w\.]+)/i                                               // Firefox Focus
            ], [[NAME, 'Firefox Focus'], VERSION], [

            /(opt)\/([\w\.]+)/i                                                 // Opera Touch
            ], [[NAME, 'Opera Touch'], VERSION], [

            /((?:[\s\/])uc?\s?browser|(?:juc.+)ucweb)[\/\s]?([\w\.]+)/i         // UCBrowser
            ], [[NAME, 'UCBrowser'], VERSION], [

            /(comodo_dragon)\/([\w\.]+)/i                                       // Comodo Dragon
            ], [[NAME, /_/g, ' '], VERSION], [

            /(micromessenger)\/([\w\.]+)/i                                      // WeChat
            ], [[NAME, 'WeChat'], VERSION], [

            /(brave)\/([\w\.]+)/i                                              // Brave browser
            ], [[NAME, 'Brave'], VERSION], [

            /(qqbrowserlite)\/([\w\.]+)/i                                       // QQBrowserLite
            ], [NAME, VERSION], [

            /(QQ)\/([\d\.]+)/i                                                  // QQ, aka ShouQ
            ], [NAME, VERSION], [

            /m?(qqbrowser)[\/\s]?([\w\.]+)/i                                    // QQBrowser
            ], [NAME, VERSION], [

            /(BIDUBrowser)[\/\s]?([\w\.]+)/i                                    // Baidu Browser
            ], [NAME, VERSION], [

            /(2345Explorer)[\/\s]?([\w\.]+)/i                                   // 2345 Browser
            ], [NAME, VERSION], [

            /(MetaSr)[\/\s]?([\w\.]+)/i                                         // SouGouBrowser
            ], [NAME], [

            /(LBBROWSER)/i                                      // LieBao Browser
            ], [NAME], [

            /xiaomi\/miuibrowser\/([\w\.]+)/i                                   // MIUI Browser
            ], [VERSION, [NAME, 'MIUI Browser']], [

            /;fbav\/([\w\.]+);/i                                                // Facebook App for iOS & Android
            ], [VERSION, [NAME, 'Facebook']], [

            /safari\s(line)\/([\w\.]+)/i,                                       // Line App for iOS
            /android.+(line)\/([\w\.]+)\/iab/i                                  // Line App for Android
            ], [NAME, VERSION], [

            /headlesschrome(?:\/([\w\.]+)|\s)/i                                 // Chrome Headless
            ], [VERSION, [NAME, 'Chrome Headless']], [

            /\swv\).+(chrome)\/([\w\.]+)/i                                      // Chrome WebView
            ], [[NAME, /(.+)/, '$1 WebView'], VERSION], [

            /((?:oculus|samsung)browser)\/([\w\.]+)/i
            ], [[NAME, /(.+(?:g|us))(.+)/, '$1 $2'], VERSION], [                // Oculus / Samsung Browser

            /android.+version\/([\w\.]+)\s+(?:mobile\s?safari|safari)*/i        // Android Browser
            ], [VERSION, [NAME, 'Android Browser']], [

            /(chrome|omniweb|arora|[tizenoka]{5}\s?browser)\/v?([\w\.]+)/i
                                                                                // Chrome/OmniWeb/Arora/Tizen/Nokia
            ], [NAME, VERSION], [

            /(dolfin)\/([\w\.]+)/i                                              // Dolphin
            ], [[NAME, 'Dolphin'], VERSION], [

            /((?:android.+)crmo|crios)\/([\w\.]+)/i                             // Chrome for Android/iOS
            ], [[NAME, 'Chrome'], VERSION], [

            /(coast)\/([\w\.]+)/i                                               // Opera Coast
            ], [[NAME, 'Opera Coast'], VERSION], [

            /fxios\/([\w\.-]+)/i                                                // Firefox for iOS
            ], [VERSION, [NAME, 'Firefox']], [

            /version\/([\w\.]+).+?mobile\/\w+\s(safari)/i                       // Mobile Safari
            ], [VERSION, [NAME, 'Mobile Safari']], [

            /version\/([\w\.]+).+?(mobile\s?safari|safari)/i                    // Safari & Safari Mobile
            ], [VERSION, NAME], [

            /webkit.+?(gsa)\/([\w\.]+).+?(mobile\s?safari|safari)(\/[\w\.]+)/i  // Google Search Appliance on iOS
            ], [[NAME, 'GSA'], VERSION], [

            /webkit.+?(mobile\s?safari|safari)(\/[\w\.]+)/i                     // Safari < 3.0
            ], [NAME, [VERSION, mapper.str, maps.browser.oldsafari.version]], [

            /(webkit|khtml)\/([\w\.]+)/i
            ], [NAME, VERSION], [

            // Gecko based
            /(navigator|netscape)\/([\w\.-]+)/i                                 // Netscape
            ], [[NAME, 'Netscape'], VERSION], [
            /(swiftfox)/i,                                                      // Swiftfox
            /(icedragon|iceweasel|camino|chimera|fennec|maemo\sbrowser|minimo|conkeror)[\/\s]?([\w\.\+]+)/i,
                                                                                // IceDragon/Iceweasel/Camino/Chimera/Fennec/Maemo/Minimo/Conkeror
            /(firefox|seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([\w\.-]+)$/i,

                                                                                // Firefox/SeaMonkey/K-Meleon/IceCat/IceApe/Firebird/Phoenix
            /(mozilla)\/([\w\.]+).+rv\:.+gecko\/\d+/i,                          // Mozilla

            // Other
            /(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir)[\/\s]?([\w\.]+)/i,
                                                                                // Polaris/Lynx/Dillo/iCab/Doris/Amaya/w3m/NetSurf/Sleipnir
            /(links)\s\(([\w\.]+)/i,                                            // Links
            /(gobrowser)\/?([\w\.]*)/i,                                         // GoBrowser
            /(ice\s?browser)\/v?([\w\._]+)/i,                                   // ICE Browser
            /(mosaic)[\/\s]([\w\.]+)/i                                          // Mosaic
            ], [NAME, VERSION]

        ],

        cpu : [[

            /(?:(amd|x(?:(?:86|64)[_-])?|wow|win)64)[;\)]/i                     // AMD64
            ], [[ARCHITECTURE, 'amd64']], [

            /(ia32(?=;))/i                                                      // IA32 (quicktime)
            ], [[ARCHITECTURE, util.lowerize]], [

            /((?:i[346]|x)86)[;\)]/i                                            // IA32
            ], [[ARCHITECTURE, 'ia32']], [

            // PocketPC mistakenly identified as PowerPC
            /windows\s(ce|mobile);\sppc;/i
            ], [[ARCHITECTURE, 'arm']], [

            /((?:ppc|powerpc)(?:64)?)(?:\smac|;|\))/i                           // PowerPC
            ], [[ARCHITECTURE, /ower/, '', util.lowerize]], [

            /(sun4\w)[;\)]/i                                                    // SPARC
            ], [[ARCHITECTURE, 'sparc']], [

            /((?:avr32|ia64(?=;))|68k(?=\))|arm(?:64|(?=v\d+[;l]))|(?=atmel\s)avr|(?:irix|mips|sparc)(?:64)?(?=;)|pa-risc)/i
                                                                                // IA64, 68K, ARM/64, AVR/32, IRIX/64, MIPS/64, SPARC/64, PA-RISC
            ], [[ARCHITECTURE, util.lowerize]]
        ],

        device : [[

            /\((ipad|playbook);[\w\s\),;-]+(rim|apple)/i                        // iPad/PlayBook
            ], [MODEL, VENDOR, [TYPE, TABLET]], [

            /applecoremedia\/[\w\.]+ \((ipad)/                                  // iPad
            ], [MODEL, [VENDOR, 'Apple'], [TYPE, TABLET]], [

            /(apple\s{0,1}tv)/i                                                 // Apple TV
            ], [[MODEL, 'Apple TV'], [VENDOR, 'Apple']], [

            /(archos)\s(gamepad2?)/i,                                           // Archos
            /(hp).+(touchpad)/i,                                                // HP TouchPad
            /(hp).+(tablet)/i,                                                  // HP Tablet
            /(kindle)\/([\w\.]+)/i,                                             // Kindle
            /\s(nook)[\w\s]+build\/(\w+)/i,                                     // Nook
            /(dell)\s(strea[kpr\s\d]*[\dko])/i                                  // Dell Streak
            ], [VENDOR, MODEL, [TYPE, TABLET]], [

            /(kf[A-z]+)\sbuild\/.+silk\//i                                      // Kindle Fire HD
            ], [MODEL, [VENDOR, 'Amazon'], [TYPE, TABLET]], [
            /(sd|kf)[0349hijorstuw]+\sbuild\/.+silk\//i                         // Fire Phone
            ], [[MODEL, mapper.str, maps.device.amazon.model], [VENDOR, 'Amazon'], [TYPE, MOBILE]], [
            /android.+aft([bms])\sbuild/i                                       // Fire TV
            ], [MODEL, [VENDOR, 'Amazon'], [TYPE, SMARTTV]], [

            /\((ip[honed|\s\w*]+);.+(apple)/i                                   // iPod/iPhone
            ], [MODEL, VENDOR, [TYPE, MOBILE]], [
            /\((ip[honed|\s\w*]+);/i                                            // iPod/iPhone
            ], [MODEL, [VENDOR, 'Apple'], [TYPE, MOBILE]], [

            /(blackberry)[\s-]?(\w+)/i,                                         // BlackBerry
            /(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[\s_-]?([\w-]*)/i,
                                                                                // BenQ/Palm/Sony-Ericsson/Acer/Asus/Dell/Meizu/Motorola/Polytron
            /(hp)\s([\w\s]+\w)/i,                                               // HP iPAQ
            /(asus)-?(\w+)/i                                                    // Asus
            ], [VENDOR, MODEL, [TYPE, MOBILE]], [
            /\(bb10;\s(\w+)/i                                                   // BlackBerry 10
            ], [MODEL, [VENDOR, 'BlackBerry'], [TYPE, MOBILE]], [
                                                                                // Asus Tablets
            /android.+(transfo[prime\s]{4,10}\s\w+|eeepc|slider\s\w+|nexus 7|padfone|p00c)/i
            ], [MODEL, [VENDOR, 'Asus'], [TYPE, TABLET]], [

            /(sony)\s(tablet\s[ps])\sbuild\//i,                                  // Sony
            /(sony)?(?:sgp.+)\sbuild\//i
            ], [[VENDOR, 'Sony'], [MODEL, 'Xperia Tablet'], [TYPE, TABLET]], [
            /android.+\s([c-g]\d{4}|so[-l]\w+)(?=\sbuild\/|\).+chrome\/(?![1-6]{0,1}\d\.))/i
            ], [MODEL, [VENDOR, 'Sony'], [TYPE, MOBILE]], [

            /\s(ouya)\s/i,                                                      // Ouya
            /(nintendo)\s([wids3u]+)/i                                          // Nintendo
            ], [VENDOR, MODEL, [TYPE, CONSOLE]], [

            /android.+;\s(shield)\sbuild/i                                      // Nvidia
            ], [MODEL, [VENDOR, 'Nvidia'], [TYPE, CONSOLE]], [

            /(playstation\s[34portablevi]+)/i                                   // Playstation
            ], [MODEL, [VENDOR, 'Sony'], [TYPE, CONSOLE]], [

            /(sprint\s(\w+))/i                                                  // Sprint Phones
            ], [[VENDOR, mapper.str, maps.device.sprint.vendor], [MODEL, mapper.str, maps.device.sprint.model], [TYPE, MOBILE]], [

            /(lenovo)\s?(S(?:5000|6000)+(?:[-][\w+]))/i                         // Lenovo tablets
            ], [VENDOR, MODEL, [TYPE, TABLET]], [

            /(htc)[;_\s-]+([\w\s]+(?=\)|\sbuild)|\w+)/i,                        // HTC
            /(zte)-(\w*)/i,                                                     // ZTE
            /(alcatel|geeksphone|lenovo|nexian|panasonic|(?=;\s)sony)[_\s-]?([\w-]*)/i
                                                                                // Alcatel/GeeksPhone/Lenovo/Nexian/Panasonic/Sony
            ], [VENDOR, [MODEL, /_/g, ' '], [TYPE, MOBILE]], [

            /(nexus\s9)/i                                                       // HTC Nexus 9
            ], [MODEL, [VENDOR, 'HTC'], [TYPE, TABLET]], [

            /d\/huawei([\w\s-]+)[;\)]/i,
            /(nexus\s6p)/i                                                      // Huawei
            ], [MODEL, [VENDOR, 'Huawei'], [TYPE, MOBILE]], [

            /(microsoft);\s(lumia[\s\w]+)/i                                     // Microsoft Lumia
            ], [VENDOR, MODEL, [TYPE, MOBILE]], [

            /[\s\(;](xbox(?:\sone)?)[\s\);]/i                                   // Microsoft Xbox
            ], [MODEL, [VENDOR, 'Microsoft'], [TYPE, CONSOLE]], [
            /(kin\.[onetw]{3})/i                                                // Microsoft Kin
            ], [[MODEL, /\./g, ' '], [VENDOR, 'Microsoft'], [TYPE, MOBILE]], [

                                                                                // Motorola
            /\s(milestone|droid(?:[2-4x]|\s(?:bionic|x2|pro|razr))?:?(\s4g)?)[\w\s]+build\//i,
            /mot[\s-]?(\w*)/i,
            /(XT\d{3,4}) build\//i,
            /(nexus\s6)/i
            ], [MODEL, [VENDOR, 'Motorola'], [TYPE, MOBILE]], [
            /android.+\s(mz60\d|xoom[\s2]{0,2})\sbuild\//i
            ], [MODEL, [VENDOR, 'Motorola'], [TYPE, TABLET]], [

            /hbbtv\/\d+\.\d+\.\d+\s+\([\w\s]*;\s*(\w[^;]*);([^;]*)/i            // HbbTV devices
            ], [[VENDOR, util.trim], [MODEL, util.trim], [TYPE, SMARTTV]], [

            /hbbtv.+maple;(\d+)/i
            ], [[MODEL, /^/, 'SmartTV'], [VENDOR, 'Samsung'], [TYPE, SMARTTV]], [

            /\(dtv[\);].+(aquos)/i                                              // Sharp
            ], [MODEL, [VENDOR, 'Sharp'], [TYPE, SMARTTV]], [

            /android.+((sch-i[89]0\d|shw-m380s|gt-p\d{4}|gt-n\d+|sgh-t8[56]9|nexus 10))/i,
            /((SM-T\w+))/i
            ], [[VENDOR, 'Samsung'], MODEL, [TYPE, TABLET]], [                  // Samsung
            /smart-tv.+(samsung)/i
            ], [VENDOR, [TYPE, SMARTTV], MODEL], [
            /((s[cgp]h-\w+|gt-\w+|galaxy\snexus|sm-\w[\w\d]+))/i,
            /(sam[sung]*)[\s-]*(\w+-?[\w-]*)/i,
            /sec-((sgh\w+))/i
            ], [[VENDOR, 'Samsung'], MODEL, [TYPE, MOBILE]], [

            /sie-(\w*)/i                                                        // Siemens
            ], [MODEL, [VENDOR, 'Siemens'], [TYPE, MOBILE]], [

            /(maemo|nokia).*(n900|lumia\s\d+)/i,                                // Nokia
            /(nokia)[\s_-]?([\w-]*)/i
            ], [[VENDOR, 'Nokia'], MODEL, [TYPE, MOBILE]], [

            /android[x\d\.\s;]+\s([ab][1-7]\-?[0178a]\d\d?)/i                   // Acer
            ], [MODEL, [VENDOR, 'Acer'], [TYPE, TABLET]], [

            /android.+([vl]k\-?\d{3})\s+build/i                                 // LG Tablet
            ], [MODEL, [VENDOR, 'LG'], [TYPE, TABLET]], [
            /android\s3\.[\s\w;-]{10}(lg?)-([06cv9]{3,4})/i                     // LG Tablet
            ], [[VENDOR, 'LG'], MODEL, [TYPE, TABLET]], [
            /(lg) netcast\.tv/i                                                 // LG SmartTV
            ], [VENDOR, MODEL, [TYPE, SMARTTV]], [
            /(nexus\s[45])/i,                                                   // LG
            /lg[e;\s\/-]+(\w*)/i,
            /android.+lg(\-?[\d\w]+)\s+build/i
            ], [MODEL, [VENDOR, 'LG'], [TYPE, MOBILE]], [

            /android.+(ideatab[a-z0-9\-\s]+)/i                                  // Lenovo
            ], [MODEL, [VENDOR, 'Lenovo'], [TYPE, TABLET]], [

            /linux;.+((jolla));/i                                               // Jolla
            ], [VENDOR, MODEL, [TYPE, MOBILE]], [

            /((pebble))app\/[\d\.]+\s/i                                         // Pebble
            ], [VENDOR, MODEL, [TYPE, WEARABLE]], [

            /android.+;\s(oppo)\s?([\w\s]+)\sbuild/i                            // OPPO
            ], [VENDOR, MODEL, [TYPE, MOBILE]], [

            /crkey/i                                                            // Google Chromecast
            ], [[MODEL, 'Chromecast'], [VENDOR, 'Google']], [

            /android.+;\s(glass)\s\d/i                                          // Google Glass
            ], [MODEL, [VENDOR, 'Google'], [TYPE, WEARABLE]], [

            /android.+;\s(pixel c)[\s)]/i                                       // Google Pixel C
            ], [MODEL, [VENDOR, 'Google'], [TYPE, TABLET]], [

            /android.+;\s(pixel( [23])?( xl)?)\s/i                              // Google Pixel
            ], [MODEL, [VENDOR, 'Google'], [TYPE, MOBILE]], [

            /android.+;\s(\w+)\s+build\/hm\1/i,                                 // Xiaomi Hongmi 'numeric' models
            /android.+(hm[\s\-_]*note?[\s_]*(?:\d\w)?)\s+build/i,               // Xiaomi Hongmi
            /android.+(mi[\s\-_]*(?:one|one[\s_]plus|note lte)?[\s_]*(?:\d?\w?)[\s_]*(?:plus)?)\s+build/i,    // Xiaomi Mi
            /android.+(redmi[\s\-_]*(?:note)?(?:[\s_]*[\w\s]+))\s+build/i       // Redmi Phones
            ], [[MODEL, /_/g, ' '], [VENDOR, 'Xiaomi'], [TYPE, MOBILE]], [
            /android.+(mi[\s\-_]*(?:pad)(?:[\s_]*[\w\s]+))\s+build/i            // Mi Pad tablets
            ],[[MODEL, /_/g, ' '], [VENDOR, 'Xiaomi'], [TYPE, TABLET]], [
            /android.+;\s(m[1-5]\snote)\sbuild/i                                // Meizu Tablet
            ], [MODEL, [VENDOR, 'Meizu'], [TYPE, TABLET]], [
            /(mz)-([\w-]{2,})/i                                                 // Meizu Phone
            ], [[VENDOR, 'Meizu'], MODEL, [TYPE, MOBILE]], [

            /android.+a000(1)\s+build/i,                                        // OnePlus
            /android.+oneplus\s(a\d{4})\s+build/i
            ], [MODEL, [VENDOR, 'OnePlus'], [TYPE, MOBILE]], [

            /android.+[;\/]\s*(RCT[\d\w]+)\s+build/i                            // RCA Tablets
            ], [MODEL, [VENDOR, 'RCA'], [TYPE, TABLET]], [

            /android.+[;\/\s]+(Venue[\d\s]{2,7})\s+build/i                      // Dell Venue Tablets
            ], [MODEL, [VENDOR, 'Dell'], [TYPE, TABLET]], [

            /android.+[;\/]\s*(Q[T|M][\d\w]+)\s+build/i                         // Verizon Tablet
            ], [MODEL, [VENDOR, 'Verizon'], [TYPE, TABLET]], [

            /android.+[;\/]\s+(Barnes[&\s]+Noble\s+|BN[RT])(V?.*)\s+build/i     // Barnes & Noble Tablet
            ], [[VENDOR, 'Barnes & Noble'], MODEL, [TYPE, TABLET]], [

            /android.+[;\/]\s+(TM\d{3}.*\b)\s+build/i                           // Barnes & Noble Tablet
            ], [MODEL, [VENDOR, 'NuVision'], [TYPE, TABLET]], [

            /android.+;\s(k88)\sbuild/i                                         // ZTE K Series Tablet
            ], [MODEL, [VENDOR, 'ZTE'], [TYPE, TABLET]], [

            /android.+[;\/]\s*(gen\d{3})\s+build.*49h/i                         // Swiss GEN Mobile
            ], [MODEL, [VENDOR, 'Swiss'], [TYPE, MOBILE]], [

            /android.+[;\/]\s*(zur\d{3})\s+build/i                              // Swiss ZUR Tablet
            ], [MODEL, [VENDOR, 'Swiss'], [TYPE, TABLET]], [

            /android.+[;\/]\s*((Zeki)?TB.*\b)\s+build/i                         // Zeki Tablets
            ], [MODEL, [VENDOR, 'Zeki'], [TYPE, TABLET]], [

            /(android).+[;\/]\s+([YR]\d{2})\s+build/i,
            /android.+[;\/]\s+(Dragon[\-\s]+Touch\s+|DT)(\w{5})\sbuild/i        // Dragon Touch Tablet
            ], [[VENDOR, 'Dragon Touch'], MODEL, [TYPE, TABLET]], [

            /android.+[;\/]\s*(NS-?\w{0,9})\sbuild/i                            // Insignia Tablets
            ], [MODEL, [VENDOR, 'Insignia'], [TYPE, TABLET]], [

            /android.+[;\/]\s*((NX|Next)-?\w{0,9})\s+build/i                    // NextBook Tablets
            ], [MODEL, [VENDOR, 'NextBook'], [TYPE, TABLET]], [

            /android.+[;\/]\s*(Xtreme\_)?(V(1[045]|2[015]|30|40|60|7[05]|90))\s+build/i
            ], [[VENDOR, 'Voice'], MODEL, [TYPE, MOBILE]], [                    // Voice Xtreme Phones

            /android.+[;\/]\s*(LVTEL\-)?(V1[12])\s+build/i                     // LvTel Phones
            ], [[VENDOR, 'LvTel'], MODEL, [TYPE, MOBILE]], [

            /android.+;\s(PH-1)\s/i
            ], [MODEL, [VENDOR, 'Essential'], [TYPE, MOBILE]], [                // Essential PH-1

            /android.+[;\/]\s*(V(100MD|700NA|7011|917G).*\b)\s+build/i          // Envizen Tablets
            ], [MODEL, [VENDOR, 'Envizen'], [TYPE, TABLET]], [

            /android.+[;\/]\s*(Le[\s\-]+Pan)[\s\-]+(\w{1,9})\s+build/i          // Le Pan Tablets
            ], [VENDOR, MODEL, [TYPE, TABLET]], [

            /android.+[;\/]\s*(Trio[\s\-]*.*)\s+build/i                         // MachSpeed Tablets
            ], [MODEL, [VENDOR, 'MachSpeed'], [TYPE, TABLET]], [

            /android.+[;\/]\s*(Trinity)[\-\s]*(T\d{3})\s+build/i                // Trinity Tablets
            ], [VENDOR, MODEL, [TYPE, TABLET]], [

            /android.+[;\/]\s*TU_(1491)\s+build/i                               // Rotor Tablets
            ], [MODEL, [VENDOR, 'Rotor'], [TYPE, TABLET]], [

            /android.+(KS(.+))\s+build/i                                        // Amazon Kindle Tablets
            ], [MODEL, [VENDOR, 'Amazon'], [TYPE, TABLET]], [

            /android.+(Gigaset)[\s\-]+(Q\w{1,9})\s+build/i                      // Gigaset Tablets
            ], [VENDOR, MODEL, [TYPE, TABLET]], [

            /\s(tablet|tab)[;\/]/i,                                             // Unidentifiable Tablet
            /\s(mobile)(?:[;\/]|\ssafari)/i                                     // Unidentifiable Mobile
            ], [[TYPE, util.lowerize], VENDOR, MODEL], [

            /[\s\/\(](smart-?tv)[;\)]/i                                         // SmartTV
            ], [[TYPE, SMARTTV]], [

            /(android[\w\.\s\-]{0,9});.+build/i                                 // Generic Android Device
            ], [MODEL, [VENDOR, 'Generic']]
        ],

        engine : [[

            /windows.+\sedge\/([\w\.]+)/i                                       // EdgeHTML
            ], [VERSION, [NAME, 'EdgeHTML']], [

            /webkit\/537\.36.+chrome\/(?!27)/i                                  // Blink
            ], [[NAME, 'Blink']], [

            /(presto)\/([\w\.]+)/i,                                             // Presto
            /(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,     
                                                                                // WebKit/Trident/NetFront/NetSurf/Amaya/Lynx/w3m/Goanna
            /(khtml|tasman|links)[\/\s]\(?([\w\.]+)/i,                          // KHTML/Tasman/Links
            /(icab)[\/\s]([23]\.[\d\.]+)/i                                      // iCab
            ], [NAME, VERSION], [

            /rv\:([\w\.]{1,9}).+(gecko)/i                                       // Gecko
            ], [VERSION, NAME]
        ],

        os : [[

            // Windows based
            /microsoft\s(windows)\s(vista|xp)/i                                 // Windows (iTunes)
            ], [NAME, VERSION], [
            /(windows)\snt\s6\.2;\s(arm)/i,                                     // Windows RT
            /(windows\sphone(?:\sos)*)[\s\/]?([\d\.\s\w]*)/i,                   // Windows Phone
            /(windows\smobile|windows)[\s\/]?([ntce\d\.\s]+\w)/i
            ], [NAME, [VERSION, mapper.str, maps.os.windows.version]], [
            /(win(?=3|9|n)|win\s9x\s)([nt\d\.]+)/i
            ], [[NAME, 'Windows'], [VERSION, mapper.str, maps.os.windows.version]], [

            // Mobile/Embedded OS
            /\((bb)(10);/i                                                      // BlackBerry 10
            ], [[NAME, 'BlackBerry'], VERSION], [
            /(blackberry)\w*\/?([\w\.]*)/i,                                     // Blackberry
            /(tizen)[\/\s]([\w\.]+)/i,                                          // Tizen
            /(android|webos|palm\sos|qnx|bada|rim\stablet\sos|meego|contiki)[\/\s-]?([\w\.]*)/i,
                                                                                // Android/WebOS/Palm/QNX/Bada/RIM/MeeGo/Contiki
            /linux;.+(sailfish);/i                                              // Sailfish OS
            ], [NAME, VERSION], [
            /(symbian\s?os|symbos|s60(?=;))[\/\s-]?([\w\.]*)/i                  // Symbian
            ], [[NAME, 'Symbian'], VERSION], [
            /\((series40);/i                                                    // Series 40
            ], [NAME], [
            /mozilla.+\(mobile;.+gecko.+firefox/i                               // Firefox OS
            ], [[NAME, 'Firefox OS'], VERSION], [

            // Console
            /(nintendo|playstation)\s([wids34portablevu]+)/i,                   // Nintendo/Playstation

            // GNU/Linux based
            /(mint)[\/\s\(]?(\w*)/i,                                            // Mint
            /(mageia|vectorlinux)[;\s]/i,                                       // Mageia/VectorLinux
            /(joli|[kxln]?ubuntu|debian|suse|opensuse|gentoo|(?=\s)arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk|linpus)[\/\s-]?(?!chrom)([\w\.-]*)/i,
                                                                                // Joli/Ubuntu/Debian/SUSE/Gentoo/Arch/Slackware
                                                                                // Fedora/Mandriva/CentOS/PCLinuxOS/RedHat/Zenwalk/Linpus
            /(hurd|linux)\s?([\w\.]*)/i,                                        // Hurd/Linux
            /(gnu)\s?([\w\.]*)/i                                                // GNU
            ], [NAME, VERSION], [

            /(cros)\s[\w]+\s([\w\.]+\w)/i                                       // Chromium OS
            ], [[NAME, 'Chromium OS'], VERSION],[

            // Solaris
            /(sunos)\s?([\w\.\d]*)/i                                            // Solaris
            ], [[NAME, 'Solaris'], VERSION], [

            // BSD based
            /\s([frentopc-]{0,4}bsd|dragonfly)\s?([\w\.]*)/i                    // FreeBSD/NetBSD/OpenBSD/PC-BSD/DragonFly
            ], [NAME, VERSION],[

            /(haiku)\s(\w+)/i                                                   // Haiku
            ], [NAME, VERSION],[

            /cfnetwork\/.+darwin/i,
            /ip[honead]{2,4}(?:.*os\s([\w]+)\slike\smac|;\sopera)/i             // iOS
            ], [[VERSION, /_/g, '.'], [NAME, 'iOS']], [

            /(mac\sos\sx)\s?([\w\s\.]*)/i,
            /(macintosh|mac(?=_powerpc)\s)/i                                    // Mac OS
            ], [[NAME, 'Mac OS'], [VERSION, /_/g, '.']], [

            // Other
            /((?:open)?solaris)[\/\s-]?([\w\.]*)/i,                             // Solaris
            /(aix)\s((\d)(?=\.|\)|\s)[\w\.])*/i,                                // AIX
            /(plan\s9|minix|beos|os\/2|amigaos|morphos|risc\sos|openvms|fuchsia)/i,
                                                                                // Plan9/Minix/BeOS/OS2/AmigaOS/MorphOS/RISCOS/OpenVMS/Fuchsia
            /(unix)\s?([\w\.]*)/i                                               // UNIX
            ], [NAME, VERSION]
        ]
    };

    /////////////////
    // Constructor
    ////////////////

    var UAParser = function (uastring, extensions) {

        if (typeof uastring === 'object') {
            extensions = uastring;
            uastring = undefined;
        }

        if (!(this instanceof UAParser)) {
            return new UAParser(uastring, extensions).getResult();
        }

        var ua = uastring || ((window && window.navigator && window.navigator.userAgent) ? window.navigator.userAgent : EMPTY);
        var rgxmap = extensions ? util.extend(regexes, extensions) : regexes;

        this.getBrowser = function () {
            var browser = { name: undefined, version: undefined };
            mapper.rgx.call(browser, ua, rgxmap.browser);
            browser.major = util.major(browser.version); // deprecated
            return browser;
        };
        this.getCPU = function () {
            var cpu = { architecture: undefined };
            mapper.rgx.call(cpu, ua, rgxmap.cpu);
            return cpu;
        };
        this.getDevice = function () {
            var device = { vendor: undefined, model: undefined, type: undefined };
            mapper.rgx.call(device, ua, rgxmap.device);
            return device;
        };
        this.getEngine = function () {
            var engine = { name: undefined, version: undefined };
            mapper.rgx.call(engine, ua, rgxmap.engine);
            return engine;
        };
        this.getOS = function () {
            var os = { name: undefined, version: undefined };
            mapper.rgx.call(os, ua, rgxmap.os);
            return os;
        };
        this.getResult = function () {
            return {
                ua      : this.getUA(),
                browser : this.getBrowser(),
                engine  : this.getEngine(),
                os      : this.getOS(),
                device  : this.getDevice(),
                cpu     : this.getCPU()
            };
        };
        this.getUA = function () {
            return ua;
        };
        this.setUA = function (uastring) {
            ua = uastring;
            return this;
        };
        return this;
    };

    UAParser.VERSION = LIBVERSION;
    UAParser.BROWSER = {
        NAME    : NAME,
        MAJOR   : MAJOR, // deprecated
        VERSION : VERSION
    };
    UAParser.CPU = {
        ARCHITECTURE : ARCHITECTURE
    };
    UAParser.DEVICE = {
        MODEL   : MODEL,
        VENDOR  : VENDOR,
        TYPE    : TYPE,
        CONSOLE : CONSOLE,
        MOBILE  : MOBILE,
        SMARTTV : SMARTTV,
        TABLET  : TABLET,
        WEARABLE: WEARABLE,
        EMBEDDED: EMBEDDED
    };
    UAParser.ENGINE = {
        NAME    : NAME,
        VERSION : VERSION
    };
    UAParser.OS = {
        NAME    : NAME,
        VERSION : VERSION
    };

    ///////////
    // Export
    //////////

    // check js environment
    if (typeof(exports) !== UNDEF_TYPE) {
        // nodejs env
        if (typeof module !== UNDEF_TYPE && module.exports) {
            exports = module.exports = UAParser;
        }
        exports.UAParser = UAParser;
    } else {
        // We removed the interaction between requirejs and ua-parser-js.js here
        if (window) {
            // browser env
            window.UAParser = UAParser;
        }
    }

})(typeof window === 'object' ? window : this);

ProperMedia.report_ad = (function ($, properSetTimeout) {

  //global variables
  var ad_id = "";

  //listen for post messages from iframe
  if (window.addEventListener) addEventListener("message", TraceKit.wrap(listener), false);
  else attachEvent("onmessage", TraceKit.wrap(listener));

  function listener(event){
   
    //process message from main window
    if(typeof event == 'undefined' || typeof event.data == 'undefined') return false; 
    var msg = event.data.toString();
    var data = [];

    if(msg!="" && msg.indexOf('|')>=0) {
      data = msg.split("|");
      msg = data[0];
    }

    if(msg=="SubmitAdReport") submit(data[1], data[2]);
    else if(msg=="CloseAdReport") close();
  }


  //"Report Advertisement" link
  if (document.addEventListener) document.addEventListener( "click", TraceKit.wrap(someListener) );
  else document.attachEvent("onclick", TraceKit.wrap(someListener));

  function someListener(e){

    var eventReference = (typeof e !== "undefined")? e : event
    var element = eventReference.target;
    var found = 0;

    if(typeof element !== 'undefined') {
      //check if our button was clicked
      if(document.documentElement.classList) { //modern browsers
        if(element.classList.contains("report-ad")) found=1;
      }
      else if(typeof element.className !== 'undefined' && element.className.indexOf("report-ad") > -1) found=1;
    }


    if(found==1) {

      e.preventDefault();

      //highlight ad unit
      ad_id = element.getAttribute("data-aid");
      $('#'+ad_id).addClass('active-highlight');

      //create/show modal
      if(typeof $('#ProperMediaAdModal').obj === 'undefined') {

        // get site_name from ad_project
        var retData = ProperMedia.ad_project.getReportAdInfo( {'site_name' : 1, 'split_version' : 1} );
        var site_name = (typeof retData.site_name !== 'undefined') ? retData.site_name : '';
        var split_version = (typeof retData.split_version !== 'undefined') ? retData.split_version : '';

        var iframe = document.createElement('iframe');
        iframe.src = 'https://proper.io/adproject/report.php?pub='+site_name+'&split_version='+split_version;
        iframe.id = "ProperMediaAdModal";
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.position = "fixed";
        iframe.style.display = "block";
        iframe.style.zIndex = 2147483647;
        iframe.style.top = 0;
        iframe.style.left = 0;
        iframe.style.right = 0;
        iframe.style.bottom = 0;
        iframe.frameBorder = 0;

        //keep iframe to 100% of window
        if (iframe.attachEvent) {
            iframe.attachEvent("onload", resizeIframe);
        } else {
            iframe.onload=resizeIframe;
        }

        window.onresize = resizeIframe;
        document.body.appendChild(iframe);
      }
      else {
        document.getElementById('ProperMediaAdModal').contentWindow.postMessage("showForm","*");
        $('#ProperMediaAdModal').show();
      }

    }

  }

  function resizeIframe() {
    var height = window.innerHeight;
    height = (height < 0) ? 0 : height;
    document.getElementById('ProperMediaAdModal').style.height = height + 'px';
  }

  function pageY(elem) {
      return elem.offsetParent ? (elem.offsetTop + pageY(elem.offsetParent)) : elem.offsetTop;
  }


  //close form
  function close() {
      $('#ProperMediaAdModal').hide();
      $('#'+ad_id).removeClass('active-highlight');
  }

  // Prepare report post data
  function prepareReportData(issue,comment) {
    //fixing escape character
    comment = comment.replace("[proper-separator]","|");

    //get user's browser size
    var resolution = $(window).width()+"x"+$(window).height(); 

    //attempt to get ad's div html
    var div_html = "";
    try{ 
      div_html = $('#'+ad_id+' div iframe').contents().find("html").html(); 
    } catch(e) { 
      div_html = $('#'+ad_id).html(); 
    }

    // get data from ad_project
    var retData = ProperMedia.ad_project.getReportAdInfo( {'slot_id' : ad_id, 'site_name' : 1} );
    var site_name = (typeof retData.site_name !== 'undefined') ? retData.site_name : '';

    //add on html from autoplay block
    if(typeof retData.autoplay_html !== 'undefined' && retData.autoplay_html != '') div_html += retData.autoplay_html;
    unit_name = ad_id.replace("proper-ad-","");

    //parse ad displayed from bidder
    var log_lines  = (typeof retData.log_lines  !== 'undefined') ? retData.log_lines  : { 'proper' : '' }; 

    var saved_data = {}; var source = "dfp";
    if(typeof retData.saved_data !== 'undefined') {
      var saved_data = retData.saved_data;
      var source     = "bidder";
    }

    var bidder           = (typeof saved_data.bidder           !== 'undefined') ? saved_data.bidder           : "";
    var size             = (typeof saved_data.size             !== 'undefined') ? saved_data.size             : "";
    var request_url      = (typeof saved_data.request_url      !== 'undefined') ? saved_data.request_url      : "";
    var request_response = (typeof saved_data.request_response !== 'undefined') ? saved_data.request_response : "";
    var adcode           = (typeof saved_data.adcode           !== 'undefined') ? saved_data.adcode           : "";

    //parse DFP info
    var ad_info      = (typeof retData.ad_info      !== 'undefined') ? retData.ad_info      : {};
    var line_item_id = (typeof ad_info.line_item_id !== 'undefined') ? ad_info.line_item_id : "";
    var creative_id  = (typeof ad_info.creative_id  !== 'undefined') ? ad_info.creative_id  : "";

    if(source == "dfp" && typeof ad_info.size !== 'undefined') size = ad_info.size;

    //prepare post data
    return { 'ajax':1, 'website':site_name, 'ad_id': unit_name, 'source':source, 'bidder': bidder, 'request_url':request_url, 'request_response':request_response, 'adcode':adcode, 'size':size, 'line_item_id':line_item_id, 'creative_id':creative_id, 'comment':comment, 'issue':issue, 'resolution':resolution, 'os':window.device.os, 'os_group':window.device.os_group, 'browser':window.device.browser, 'browser_group':window.device.browser_group, 'log':log_lines['proper'], 'div_html':div_html };
  }

  //Submit Report Ad
  //If silent is set to true, the report will be sent programatically without user interaction
  function submit(issue,comment) {

    var post_data = prepareReportData(issue,comment);

    //send request
    $.ajax({
      url: 'https://proper.io/ajax/adreport.php', 
      method: "POST",
      data: JSON.stringify(post_data),
      success: function(resp) {

          console.log("ad report sent!");

          //send success message to iframe
          document.getElementById('ProperMediaAdModal').contentWindow.postMessage("success","*");
        },
        error: function(resp) {

          console.log('ajax error');

        }
    });

  }

  if (window.location.search.includes('proper_log_redirects=1')) {
    var _wasUnloadLogged = false;
    function logPageUnload()
    {
        if (!_wasUnloadLogged &&
          !document.activeElement.href &&
          document.activeElement.nodeName != 'IFRAME' &&
          document.activeElement.nodeName != 'BUTTON')
        {
          _wasUnloadLogged = true;

          //Record the original ad_id in case someone hit a report button somehow before the redirect
          var original_ad_id = ad_id;

          ProperMedia.ad_project.getAdSlots().forEach(function(el){
            
            ad_id = el;
            var post_data = prepareReportData('redirect','Automatically generated');
            
            if (typeof navigator.sendBeacon == 'function') {
                console.log('Proper Redirect Sent (beacon)');
                navigator.sendBeacon('https://proper.io/ajax/adreport.php', JSON.stringify(post_data));
            } else {
                console.log('Proper Redirect Sent (xhr)');
                var request = new XMLHttpRequest();
                request.open('POST', 'https://proper.io/ajax/adreport.php', false);  // `false` makes the request synchronous
                request.send(JSON.stringify(post_data));
            }

          });

          ad_id = original_ad_id;
        }
    }

    window.onbeforeunload = function (e) {
        //this will work only for Chrome
        logPageUnload();
    };

    window.onunload = function (e) {
        //this will work for other browsers
        logPageUnload();
    };

    var pagebeforehideHandler;
    window.addEventListener("pagebeforehide", pagebeforehideHandler = TraceKit.wrap(function(evt){
        //iOS Safari
        logPageUnload();
    }), false);

    var pagehideHandler;
    window.addEventListener("pagehide", pagehideHandler = TraceKit.wrap(function(evt){
        //iOS Safari
        logPageUnload();
    }), false);

    properSetTimeout.setTimeout(function(){
      window.onbeforeunload = null;
      window.onunload = null;
      window.removeEventListener("pagebeforehide", pagebeforehideHandler, false);
      window.removeEventListener("pagehide", pagehideHandler, false);
    }, 8000);
  }

  //export funcitons
  return {
    'submit' : submit,
    'close' : close,
  }

})(ProperMedia.jquery.$, ProperMedia.utils.properSetTimeout);

// @codekit-prepend "adpainter.js";
// @codekit-prepend "tracekit.js";
// @codekit-prepend "utils.js";
// @codekit-prepend "jquery.js";
// @codekit-prepend "ua-parser-js.js";
// @codekit-prepend "report-ad-v2.js";

//setup special options
var properSpecialOps = properSpecialOps || {};

//global variable for DFP
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];

//global variable for async
var propertag = propertag || {};
propertag.cmd = propertag.cmd || [];

// QuantCast
var _qevents = _qevents || [];

(function() {
    var elem = document.createElement('script');
    elem.src = (document.location.protocol == "https:" ? "https://secure" : "http://edge") + ".quantserve.com/quant.js";
    elem.async = true;
    elem.type = "text/javascript";
    var scpt = document.getElementsByTagName('script')[0];
    scpt.parentNode.insertBefore(elem, scpt);
})();

try {
    _qevents.push({
        qacct:"p-mEzuYq24VEJ-3"
    });
} catch (e) {
    console.error("Error pushing Quantcast event");
    console.error(e);
}


/**
 * Console Shim
 *
 * Some ancient browser don't have a console object defined by default
 * This shim basically "mutes" the errors for our exception handler as
 * we're not really interested in them.
 */
if(typeof console == 'undefined') {
    console = {
        log: function(m) {
            // do nothing
        },
        error: function(m) {
            // do nothing
        },
        info: function(m) {
            // do nothing
        },
        table: function(m) {
            // do nothing
        }
    }
}

//ad project class
ProperMedia.ad_project = (function(win, document) {

    //setup jquery selector
    var $ = ProperMedia.jquery.$;

    // Overwrite setTimeout & properSetInterval function to capture errors
    var properSetTimeout  = ProperMedia.utils.properSetTimeout;
    var properSetInterval = ProperMedia.utils.properSetInterval;

    // TraceKit Object
    var TraceKit = window.top.TraceKit;

    // Subscribe function for error tracking
    TraceKit.report.subscribe(sendError);
    // Unsubscribe default error tracking function
    TraceKit.report.unsubscribe(TraceKit.defaultSendError);

    /**
     * Send caught error back to Proper Media logging servers
     *
     * @param {Object} error - Caught error to report
     */
    function sendError(error) {
        'use strict';
        try {
            if (!error.stack) {
                error.stack = (new Error('force-added stack')).stack;
            }
            if(!error.name) {
                error.name = 'Unknown';
            }
            if(!error.message) {
                error.message = 'Unknown';
            }

        } catch (e) {
            console.error("Error building error data");
            console.error(e);
        }

        try {

            var postData = {
                'client_timestamp' : new Date().getTime(),
                'event_type'       : error.event_type || 'exception',
                'event_id'         : ProperMedia.utils.generateUUID(),
                'page_id'          : ProperMedia.utils.generateUUID(),
                'session_id'       : ProperMedia.utils.generateUUID(),
                'bidder'           : error.bidder || '',
                'user_id'          : ProperMedia.utils.validateValue(properUser.pubcid, {'type':'string'}),
                'publisher'        : ProperMedia.utils.validateValue(properOps.site_name, {'type':'string'}),
                'rtp_file_version' : ProperMedia.utils.validateValue(properOps.rtp_file_version, {'type':'string'}),
                'ad_project_tag'   : ProperMedia.utils.validateValue(properOps.rtp_file_revision, {'type':'string'}),
                'page_url'         : ProperMedia.utils.getPageUrl() || '',
                'in_iframe'        : false,
                'is_https'         : ('https:' == document.location.protocol) ? true : false,
                'user_agent'       : navigator.userAgent || '',
                'stack_trace'      : JSON.stringify(error.stack),
                'error_message'    : error.message.toString() || '',
                'error_name'       : error.name.toString() || ''
            }

            // Set page uuid
            if(properPage.uuid && properPage.uuid !== '') {
                postData['page_id'] = properPage.uuid;
            }

            // Set session id
            if(
                properSession &&
                properSession.sessionData &&
                properSession.sessionData.uuid &&
                properSession.sessionData.uuid !== ''
            ) {
                postData['session_id'] = properSession.sessionData.uuid;
            }

            //send request
            $.ajax({
                url: "https://events.proper.io/api/event",
                requestType: "fetch",
                method: "POST",
                data: JSON.stringify(postData),
                withCredentials: false,
                success: function(resp) {
                    console.log("Proper exception logged successfully.");
                },
                error: function() {
                    console.error("Unable to log Proper exception.");
                }
            });
        } catch (e) {
            console.error("Error sending exception data");
            console.error(e);
        }
    }


    //~~~~~~~~~~~~~~~~~
    // IMPORT OBJECTS

    var ViewabilityTracker = (function() {
	function ViewabilityTracker() {
		this.timer = null;
		this.elements = {};
		this.supportsPassive = passiveEventSupport();
		this.activeTab = true;

		// Don't start until consent is resolved
		consentManager.ready((function() {
			this.start();
			registerWindowViewabilityEventHandler(this);
		}).bind(this));
	}

	ViewabilityTracker.prototype.addElement = function(settings, callback) {

		// Lazyload Fetch Margin has to be greater than or equal to Render Margin
		if(settings.lazyload && settings.fetchMarginPercent < settings.renderMarginPercent) {
			sendError(new Error('Lazyload Fetch Margin has to be greater than or equal to Render Margin'));
			settings.fetchMarginPercent = settings.renderMarginPercent;
		}

		var entry = {
			id: settings.id,
			callback: callback,
			lazyload: settings.lazyload || false,
			viewability: settings.viewability || true,
			fetchMarginPercent: settings.fetchMarginPercent || 0,
			renderMarginPercent: settings.renderMarginPercent || 0,
			minHeight: settings.minHeight || 0,
			activeTab: true,
			viewable: false,
			inFetchZone: false,
			inRenderZone: false
		};
		this.elements[settings.id] = entry;
		if (this.started) this.runViewabilityCheck(entry.id);
	}

	// TODO: Add ability to remove element from viewability checks
	ViewabilityTracker.prototype.removeElement = function(id) { 
		if(this.elements[id]) {
			killEntry(this.elements[id]);
			delete this.elements[id];
		}
	}

	ViewabilityTracker.prototype.start = function() {
		// Tab is active
		this.activeTab = true;
		this.updateElelemtsActiveTab();
		
		var event = new CustomEvent('properActiveTab');
		window.dispatchEvent(event);

		if (this.started) return true;
 		var obj = this;
		this.timer = properSetInterval.setInterval.call(obj, function() {
			Object.keys(obj.elements).forEach(function(id) {
				obj.runViewabilityCheck(id);
			}, obj);
		}, 200);

		this.started = true;
	}

	ViewabilityTracker.prototype.stop = function() {
		clearInterval(this.timer);

		// Tab is inactive
		this.activeTab = false;
		this.updateElelemtsActiveTab();

		var event = new CustomEvent('properInactiveTab');
		window.dispatchEvent(event);

		Object.keys(this.elements).forEach(function(id) {
			killEntry(this.elements[id]);
		}, this);
		this.started = false;
	}

	ViewabilityTracker.prototype.updateElelemtsActiveTab = function() {
		Object.keys(this.elements).forEach(function(id) {
			this.elements[id].activeTab = this.activeTab;
		}, this);
	}

	ViewabilityTracker.prototype.runViewabilityCheck = function(id, forced) {
		var entry = this.elements[id] || false;
		if(entry) {
			var changed = false;
			if(entry.viewability) {
				changed = isEntryViewableByArea(entry);
			}
			if(entry.lazyload) {
				changed = checkLazyLoadMargin(entry) || changed;
			}
			if(changed || forced) {
				entry.callback(entry);
			}
		}
	}

	/**
	 * Returns the percentage of a slot object in view.
	 * 
	 * @author Tanner Mckenney <tanner@proper.io>
	 * 
	 * @param SlotObj The slot object
	 * 
	 * @return Int Percentage viewable.
	 */
	ViewabilityTracker.calculateViewablePercentage = function(slot) {
		var el = slot.getElement();
        
        if (el !== null) {
            if (window.top.document.visibilityState === 'visible') {
                var box = el.getBoundingClientRect();
                var intersects = {};

                if (typeof box !== 'undefined') {
                    intersects.left = Math.max(box.left, 0);
                    intersects.right = Math.min(box.right, window.top.innerWidth);

                    if (intersects.left >= intersects.right) {
                        return 0;
                    }

                    intersects.top = Math.max(box.top, 0);
                    intersects.bottom = Math.min(box.bottom, window.top.innerHeight);

                    if (intersects.top >= intersects.bottom) {
                        return 0;
                    }

                    intersects.width = intersects.right - intersects.left;
                    intersects.height = intersects.bottom - intersects.top;

                    var elementInViewArea = intersects.width * intersects.height;
                    var elementTotalArea = box.width * box.height;

                    return ((elementInViewArea / elementTotalArea) * 100);
                }
            } else {
                return 0;
            }
        }
        return 0;
	}

	function killEntry(entry) {
		entry.activeTab     = false;
		entry.viewable      = false;
		entry.inFetchZone   = false;
		entry.inRenderZone  = false;
		entry.callback(entry);
	}

	function isEntryViewableByArea(entry) {
		var changed = false;
		var viewable = entry.viewable;

		entry.element = entry.element || document.getElementById(entry.id)
		if (!entry.element) return false;

		var rect = entry.element.getBoundingClientRect();

		// handle the case when element is 0 height
		if (rect.height == 0 &&
			rect.top > 0 && rect.top < window.innerHeight &&
			rect.left > 0 && rect.right < window.innerWidth)
		{
			return true;
		}

		var rectArea = rect.width * rect.height;

		// the coordinate system for getBoundingClientRect assumes that the top left corner of
		// the viewport is 0,0 and increases down and to the right
		// dont use the x and y properties, browser support is inconsistent
		var intersectTop = Math.max(rect.top, 0);
		var intersectBottom = Math.min(rect.bottom, window.innerHeight);
		var intersectRight = Math.min(rect.right, window.innerWidth);
		var intersectLeft = Math.max(rect.left, 0);

		if (intersectTop < intersectBottom && intersectRight > intersectLeft) {
			var intersectArea = Math.abs(intersectBottom - intersectTop) * Math.abs(intersectRight - intersectLeft);
			viewable = (intersectArea / rectArea > 0.5);
		} else {
			viewable = false;
		}
		changed = viewable != entry.viewable
		entry.viewable = viewable;
		return changed;
	}

	function checkLazyLoadMargin(entry) {

		entry.element = entry.element || document.getElementById(entry.id)
		if (!entry.element) return false;

		var rect = entry.element.getBoundingClientRect(),
			inFetchZone  = entry.inFetchZone,
			inRenderZone = entry.inRenderZone,
			height       = rect.height || entry.minHeight,
			margin       = rect.top + (height / 2);

		// If element is out of view below
		if(margin > window.innerHeight) {
			margin -=  window.innerHeight;
		// If element is out of view above
		} else if(margin < 0) {
			margin = Math.abs(margin);
		} else {
			margin = 0;
		}

		var marginPercentage = (margin / window.innerHeight) * 100;

		inFetchZone  = (marginPercentage <= entry.fetchMarginPercent  || entry.fetchMarginPercent == -1);
		inRenderZone = (marginPercentage <= entry.renderMarginPercent || entry.fetchMarginPercent == -1);

		var changed = (inFetchZone != entry.inFetchZone || inRenderZone != entry.inRenderZone);
		entry.inFetchZone = inFetchZone;
		entry.inRenderZone = inRenderZone;

		return changed;
	}

	function registerWindowViewabilityEventHandler(tracker) {
		var hidden = 'hidden';

		var onchange = function onchange(evt) {
			if (document[hidden]) {
				tracker.stop();
			} else {
				tracker.start();
			}
		};

		var hiddenFn = function() {
			tracker.stop();
		};

		var visibleFn = function() {
			tracker.start();
		};

		// Wrap callback functions for exception handling
		onchange  = TraceKit.wrap(onchange);
		hiddenFn  = TraceKit.wrap(hiddenFn);
		visibleFn = TraceKit.wrap(visibleFn);

		// Standards:
		if (hidden in document) {
			document.addEventListener('visibilitychange', onchange);
		} else if ((hidden = 'mozHidden') in document) {
			document.addEventListener('mozvisibilitychange', onchange);
		} else if ((hidden = 'webkitHidden') in document) {
			document.addEventListener('webkitvisibilitychange', onchange);
		} else if ((hidden = 'msHidden') in document) {
			document.addEventListener('msvisibilitychange', onchange);
			// IE 9 and lower:
		} else if ('onfocusin' in document) {
			document.onfocusin = visibleFn;
			document.onfocusout = hiddenFn;
		} else if ('onpagehide' in window) {
			window.addEventListener('pagehide', hiddenFn, false);
			window.addEventListener('pageshow', visibleFn, false);
		} else if ('onblur' in window) {
			window.onfocus = visibleFn;
			window.onblur = hiddenFn;
		}
	}

	function passiveEventSupport() {
		try {
			var supported = false;
			var opts = Object.defineProperty({}, 'passive', {
				get: function() { supported = true; }
			});
			window.addEventListener("testPassive", null, opts);
			window.removeEventListener("testPassive", null, opts);
			return supported;
		} catch (e) {
			sendError(TraceKit.computeStackTrace(e));
			return false;
		}
	}

	return ViewabilityTracker;
})();

    // Page Object
var pageObj = (function() {
	function pageObj() {
		this.uuid                = null,    // Unique ID for page
		this.use_ssl             = false,   // https
		this.protocol            = 'http:', // Protocol for current page (http or https)
		this.url                 = '',      // Full page url
		this.domain              = '',      // Domain of sit
		this.path                = '',      // Current path
		this.get_vars            = {},      // GET params
		this.canonical_url       = '',      // Cononical url
		this.bidder_page_url     = '',      // Page param to use in bid request params. Used for SPA
		this.referrer            = '',      // Page referrer
		this.isolated            = 0,       // Don't include DFP
		this.width               = 0,       // Page width
		this.height              = 0,       // Page height
		this.tags                = [],      // Tags associated to page
		this.post_id             = '',      // Post ID associated to page
		this.slots  = {			   // List of slots on page
			'display': {
			},
			'video': {
			},
			'interstitial': {
			}
		},
		this.sra_settings = {
			"slot_queue": {},        // Queue slots to group sra requests
			"timeout_handler": null, // Timeout handler
			"timeout_ms"     : 10    // Ms to wait
		},
		this.video_enabled       = null,   // Flag if video is enabled on page
 		this.video_script_loaded = false,  // Flag if video code is loaded or not
		this.dynamic_css_class   = 'proper-dynamic-insertion',
		this.start_ts            = 0,      // Timestamp page started
		this.dfp_init            = false,  // Flag if dfp has been initialized
		this.dfp_correlator      = false,  // If the dfp correlator has been updated
		this.dfp_enabled_services= false,  // DFP services have been enable
		this.dont_send_bids      = false,  // Don't send out bids for this page
		this.viewability_tracker = {},     // Viewability object

		this.dynamic_ad_matches = [],

		// Single-page app settings
		this.spa_settings = {
			"enabled": false,                // Enables SPA logic
			"prefetch": false,               // Prefetch ads for next page
			"gallery_id": null,              // Way to group pages. Only show prefetched ads for same gallery
			"page_number": 1,                // Page depth
			"gallery_base_url": ''           // Url to use when sending bid requests for prefetching
		};
	}


	pageObj.prototype.init = function() {
		// Log page was started
		this.start_ts = ProperMedia.utils.getTimestampMs();		
        // Set page url to be used in bid requests
        this.setBidPageUrl();
        // Viewability code
        this.viewability_tracker = new ViewabilityTracker();
        // log page width
        properLog.mylog('width: ' + this.width);
        // Handle session data
        properSession.init();
		// Init the bidder data
		properLog.init_bid_data();
        // Build Slots
    	this.buildSlots();
        // Start initial auction
    	properAdPool.startNewAuction();
    	// Check if debug console is enabled
    	checkProperDebugConsole();
	}


	/**
	 * Set what url to send to bidders in bid requests
	 */
	pageObj.prototype.setBidPageUrl = function() {
        if(
        	this.spa_settings['enabled'] &&
        	this.spa_settings['gallery_id'] &&
        	this.spa_settings['gallery_base_url']
    	) {
        	this.bidder_page_url = this.spa_settings['gallery_base_url'];
    	} else {
    		this.bidder_page_url = this.url;
    	}
	}


	/**
	 * Set page variables
	 */
	pageObj.prototype.setPageVariables = function() {
		this.uuid = ProperMedia.utils.generateUUID();
		// Set window variable for video project to use
		window.proper_ad_page_uuid = this.uuid;
		// Check page protocol
    	if('https:' == document.location.protocol) {
    		this.protocol = "https:";
    		this.use_ssl  = true;
    	} else this.protocol = "http:";

    	// Page variables
        this.url           = ProperMedia.utils.getPageUrl();
        this.path          = ProperMedia.utils.getPagePath();
        this.domain        = ProperMedia.utils.getPageDomain();
        this.get_vars      = ProperMedia.utils.getUrlParameters(window.location.search.substring(1));
        this.referrer      = ProperMedia.utils.getPageReferrer();
        this.canonical_url = ProperMedia.utils.getCanonicalUrl();
        this.width         = $(window).width();
        this.height        = $(window).height();

        // Only run on approved domain
        this.checkDomainProtection();
        // Check if proper_test mode is enabled
    	this.checkProperTestMode();
        // Check if page is isolated
        this.checkPageIsolation();
        // Update page tags
        this.setTags();
        // Update post ID
        this.setPostId();
        // Update SPA settings
       	this.setSPASettings();
       	// Update video enabled
       	this.setVideoEnabled();
		// Populate dynamic ads array
		this.setDynamicAdMatches();
	}


	/**
     * Calculate how long the page has been open
     */
	pageObj.prototype.getTimeOnPage = function() {
		if (this.start_ts == 0) return 0;
		return Date.now() - this.start_ts;
	}


	/**
     * Chech if code is only allowed to run on specified domain
     */
	pageObj.prototype.checkDomainProtection = function() {
		// checking if domain verification is enabled
        if(properOps.domain_protection) {
        	var domains = [properOps.domain].concat(properOps.additional_domains);
        	var matches = domains.filter(function(domain) {
        		var regex = new RegExp('(^|\\.)' + domain.replace(/(http(s)?:\/\/)?(www\.)?/, '') + '$');
	        	return this.domain.match(regex)
        	}, this);
        	if(matches.length == 0) {
        		properLog.mylog('WARNING: Domains don\'t match. Bids wont be sent out for this page');
				this.dont_send_bids = true;
        	}
        }
        return this.dont_send_bids;
	}


	/**
     * Chech get variables if script should be run in testing mode
     */
    pageObj.prototype.checkProperTestMode = function() {

    	// Test bidder with test ids / endpoints
    	if(typeof this.get_vars.proper_test !== 'undefined' && this.get_vars.proper_test !== "") {
        	properOps.testing_mode.bidder = this.get_vars.proper_test;
            properOps.testing_mode.ids = true;
        } else {
	        // Test bidder
	        if(typeof this.get_vars.proper_bidder !== 'undefined' && this.get_vars.proper_bidder !== "") {
	            properOps.testing_mode.bidder = this.get_vars.proper_bidder;
	        }
	        // Use test ids / endpoints
	        if(typeof this.get_vars.proper_test_ids !== 'undefined' && this.get_vars.proper_test_ids !== "") {
	            properOps.testing_mode.ids = true;
	        }
	    }

        if(properOps.testing_mode.bidder || properOps.testing_mode.ids) {
        	properLog.mylog("TESTING MODE");

        	properOps.testing_mode.enabled = true;
	        properOps.isolated = (typeof this.get_vars.proper_dfp !== 'undefined' && this.get_vars.proper_dfp == 1) ? 0 : 1;

	        // Turn off refresh
	        // properOps.refresh.desktop.enabled = 0;
	        // properOps.refresh.mobile.enabled  = 0;

	        this.isolated = properOps.isolated;
        }

    }


    /**
     * Chech if page should be run in isolation mode. No DFP
     */
	pageObj.prototype.checkPageIsolation = function() {
		// checking if page is isolated
		if(properOps.isolated_urls.length > 0) {
			for (var i = 0; i < properOps.isolated_urls.length; i++) {
				var path = properOps.isolated_urls[i];
				if(path && this.path == path) {
					this.isolated = 1;
					break;
				}
			}
		}

		if(typeof properSpecialOps.isolated !== 'undefined' && this.isolated == 0) {
			this.isolated = properSpecialOps.isolated;
		}

		consentManager.ready((function() {
			properLog.mylog("CMP resolved: Present: " + gdprConsent.cmpPresent + ", Applies: " + gdprConsent.gdprApplies + ", Consent String: " + gdprConsent.consentString);

			// disable DFP/Adsense/etc if no consent for "Storage and access of
			// information" or "Personalisation"...
			if (gdprConsent.isolated) {
				properOps.isolated = 1;
				this.isolated = 1;
				properLog.mylog("Isolated mode due to consent");
			} else if(properOps.dfp_per_slot != 1){
				// Load DFP if page isn't isolated
				this.initDfp();
			}
		}).bind(this));
	}


	/**
     * Set page tags
     */
	pageObj.prototype.setTags = function() {
		//update tags variable
		properOps.tags = (typeof properSpecialOps.tags != 'undefined' && properSpecialOps.tags != null) ? properSpecialOps.tags : properOps.tags;
		if(typeof properSpecialOps.tags !== "undefined") this.tags = properOps.tags;
	}


	/**
     * Set page post ID
     */
	pageObj.prototype.setPostId = function() {
		// update post_id
		properOps.post_id = (typeof properSpecialOps.post_id != 'undefined' && properSpecialOps.post_id != null) ? properSpecialOps.post_id : properOps.post_id;
		this.post_id = properOps.post_id;
	}


	/**
	 * Set Single Page App settings
	 */
	pageObj.prototype.setSPASettings = function() {
		// Set single page application settings
        ProperMedia.utils.mergeObject(this.spa_settings, ProperMedia.utils.deepCopy(properSpecialOps.spa_settings));
	}


	/**
     * Set Video Enabled
     */
	pageObj.prototype.setVideoEnabled = function() {
        // Check if video is enabled for page
        this.video_enabled = (typeof properSpecialOps.video_enabled !== 'undefined') ? !!properSpecialOps.video_enabled : this.video_enabled;
	}


	/**
	 * Load the video player code
	 */
	pageObj.prototype.loadVideoPlayerScript = function() {
		if(
			this.video_enabled === true &&
			(
				this.video_script_loaded == false &&
				typeof window.ProperMediaVideo == "undefined"
			)
		) {
			// Init propervideotag variable
			window.propervideotag = window.propervideotag || [];
			// Load script
		    var script   = document.createElement('script');
			script.src   = 'https://player.propervideo.io/new_rtp/main.js';
		    script.async = true;

		    // script.onload = function() { }
		    window.top.document.getElementsByTagName('head')[0].appendChild(script);
		}
		this.video_script_loaded = true;
	}


	/**
	 * Build all slots on page
	 */
	pageObj.prototype.buildSlots = function() {

		Object.keys(properOps.ad_slots).reverse().forEach(function(slot_type) {
			Object.keys(properOps.ad_slots[slot_type]).forEach(function(slot_name) {
				if(slot_type != 'dynamic') this.buildSlot(slot_type, slot_name);
			}, this);
		}, this);

		//loop through and add the ad-painter generated dynamic ads
		for(a in this.dynamic_ad_matches) {
			this.buildSlot('dynamic', this.dynamic_ad_matches[a]);
		}

	}

	/**
	 * Build one slot obj
	 * @param {String} slot_type - display/video
	 * @param {String} slot_name - name of slot
	 */
	pageObj.prototype.buildSlot = function(slot_type, slot_name) {

		var slot = null;

		if(!slot_type || !slot_name) return slot;

		var device_type     = properDevice.isMobile() ? 'mobile' : 'desktop';
		var slot_settings   = ProperMedia.utils.deepAccess(properOps, 'ad_slots' + '.' + slot_type + '.' + slot_name) || {};
		var dynamicSettings = ProperMedia.utils.deepAccess(slot_settings, 'dynamic.' + device_type) || { 'enabled': false };

		if(dynamicSettings['enabled']) {
			// Ignore elements that have already been used
			var cssselector = dynamicSettings['cssselector'] + ':not(.' + this.dynamic_css_class + ')';

			// Get Elements on page from query selector
			var elements = document.querySelectorAll(cssselector);
			if(elements && elements.length > 0) {

				for (var i = 0; i < elements.length; i++) {
					var element = elements[i];

					dynamicSettings['instances'] = (parseInt(dynamicSettings['instances']) || 0) + 1;

					var settings = ProperMedia.utils.deepCopy(slot_settings);
					settings['dynamic'][device_type]['instance_number'] = dynamicSettings['instances'];

					// Build slot object
					var demand_type = (slot_type == 'video') ? 'video' : 'display'
					var slot = new slotObj( demand_type , slot_name, settings, element);
				}
			}
		// Static slots
		} else {
			// Slot doesnt already exist
			if(!ProperMedia.utils.deepAccess(this, 'slots.' + slot_type + '.' + slot_name)) {
				// Build slot object
				slot = new slotObj(slot_type, slot_name, slot_settings);
			} else {
				slot = ProperMedia.utils.deepAccess(this, 'slots.' + slot_type + '.' + slot_name);
			}
		}
		return slot;
	}


	/**
	 * Rebuild Slots
	 */
	pageObj.prototype.rebuildSlots = function() {
		// Rebuild slots
		Object.keys(this.slots).forEach(function(slot_type) {
			Object.keys(this.slots[slot_type]).forEach(function(slot_name) {
				var slot = this.getSlotFromPageObject(slot_name, [slot_type]);
				// If slot is on the page
				if(slot && slot.getElement()) {
					slot.rebuildSlot();
				}
			}, this);
		}, this);
		// Build new slots
		this.buildSlots();
	}


	/**
	 * Set up next page for single-page application
	 */
	pageObj.prototype.SpaNextPage = function() {
		properLog.mylog('========== New SPA Page ==========');
		// Calculate time on previous page
		var time_on_page = this.getTimeOnPage();
		// Log time on page
		properLog.mylog('Time on page: ' + time_on_page);
		// Increment page number
		this.spa_settings['page_number']++;
		// Log new page was started
		this.start_ts = ProperMedia.utils.getTimestampMs();
		// Set page variables
		this.setPageVariables();

		// Flag for clearing cached ads for SPA
        var cleared_cached_ads = false;
        // Check if should clear cached ads. Only carry ads through same gallery pages
        if(
        	!ProperMedia.utils.deepAccess(this.spa_settings, 'gallery_id') ||
        	!ProperMedia.utils.deepAccess(properSpecialOps, 'spa_settings.gallery_id') ||
        	ProperMedia.utils.deepAccess(this.spa_settings, 'gallery_id') !== ProperMedia.utils.deepAccess(properSpecialOps, 'spa_settings.gallery_id')
    	) {
        	cleared_cached_ads = properAdPool.clearCachedAds();
    	} else {
    		// Get rid of all expired ads
    		properAdPool.clearExpiredAds();
    	}

        // Set page url to be used in bid requests
        this.setBidPageUrl();
       	// Log page width
        properLog.mylog('width: '+this.width);
        // Handle session data
        properSession.init();
		// Init the bidder data
		properLog.init_bid_data();
	    // Set single page application settings
	    this.setSPASettings();
        // Reset auction number
        properAdPool.auction_count = 0;
        properAdPool.vid_auction_count = 0;
        // Start auction
    	properAdPool.startNewAuction();
    	// Rebuild slots for new page
    	this.rebuildSlots();
	}


	/**
	 * Set up next page for single-page application
	 */
	pageObj.prototype.InfScrollNextPage = function() {
		properLog.mylog('========== New Infinite Scroll Page ==========');
		// Calculate time on previous page
		var time_on_page = this.getTimeOnPage();
		// Log time on page
		properLog.mylog('Time on page: ' + time_on_page);
		// Increment page number
		this.spa_settings['page_number']++;
		// Log new page was started
		this.start_ts = ProperMedia.utils.getTimestampMs();
		// Set page variables
		this.setPageVariables();
       	// Log page width
        properLog.mylog('width: '+this.width);
        // Handle session data
        properSession.init();
		// Init the bidder data
		properLog.init_bid_data();
        // Reset auction number
        properAdPool.auction_count = 0;
        // Reset video auction count
        properAdPool.vid_auction_count = 0;
        // Start auction
    	properAdPool.startNewAuction();
    	// Build new slots for new page
    	this.buildSlots();
	}


	/**
	 * Init DFP library
	 */
    pageObj.prototype.initDfp = function() {

    	if(this.dfp_init == 1) return false;

        // Load Confiant DFP On-Page Integration
        if(properOps.confiant == 1) {
            confiantWrapper.loadDFPTag(window);
        // Load Ad Lightning DFP On-Page Integration
        } else if(ProperMedia.utils.deepAccess(properSpecialOps, 'adlightning.enabled')) {
            adLightningWrapper.loadDFPTag(window);
        }

        // Load GoogleTag (Needed for DFP)
        (function() {
            var gads = document.createElement('script');
            gads.async = true;
            gads.type = 'text/javascript';
            var useSSL = 'https:' == document.location.protocol;
            gads.src = (useSSL ? 'https:' : 'http:') +
            '//securepubads.g.doubleclick.net/tag/js/gpt.js';
            var node = document.getElementsByTagName('script')[0];
            node.parentNode.insertBefore(gads, node);
        })();

        // Create DFP request
        googletag.cmd.push(function() {
			if (gdprConsent.noPersonalization) {
				// disable personalized GPT ads
				googletag.pubads().setRequestNonPersonalizedAds(1);
			}

			if(uspConsent.restrictDataProcessing) {
            	googletag.pubads().setPrivacySettings({
                    'restrictDataProcessing': true
                });
            }

            // This listener will be called when a creative iframe load event fires.
			googletag.pubads().addEventListener('slotOnload', function(event) {
				var slot_name = ProperMedia.utils.extractSlotName(event.slot.getSlotElementId());
                var slot = properPage.getSlotFromPageObject(slot_name);

                properLog.mylog('DFP slotOnload: '+ slot_name);
                if(slot) {
            		slot.dispatchCustomEvent('proper-ads-fired', 
        				{
        					'cpm': ProperMedia.utils.deepAccess(slot, 'displayed_ad.price'),
        					'size': ProperMedia.utils.deepAccess(slot, 'displayed_ad.size'),
        					'ad_type': 'display'
        				}
    				);
            		if(slot.hasWinningBid() && slot.winning_ad.displayed == 1) {
            			slot.winning_ad.onBidWon();
            		}
                }
			});


            // Dfp slot render ended
            googletag.pubads().addEventListener('slotRenderEnded', TraceKit.wrap(function(event) {

                var slot_name = ProperMedia.utils.extractSlotName(event.slot.getSlotElementId());
                var slot = properPage.getSlotFromPageObject(slot_name);

                properLog.mylog('DFP slotRenderEnded: '+ slot_name);

                if(slot) {
                	slot.tracking_times.dfp_returned_ts = ProperMedia.utils.getTimestampMs();
                    // Setup creative
                    if(event.advertiserId == properOps.amazon_advertiser) {
                        event.size = (typeof slot.bids.a9 !== 'undefined' && typeof slot.bids.a9.responses !== 'undefined' && typeof slot.bids.a9.responses.size !== 'undefined' ) ? slot.bids.a9.responses.size.split("x") : slot.default_size.split("x");
                    }

                    // Tracker for non-bidder creatives (proper media didn't win but we still have an ad)
                    if(event.advertiserId != properOps.proper_advertiser && event.advertiserId != properOps.amazon_advertiser && event.isEmpty==false) {
                        proper_render_dfp(slot_name, event.size, event.advertiserId, event.lineItemId, event.yieldGroupIds);
                        proper_inview(event.isEmpty, slot_name, event.size.join('x'), event.creativeId, event.lineItemId, event.advertiserId);
                    }

                    if(!slot.sticky && 
                    	ProperMedia.utils.deepAccess(properSpecialOps, 'adlightning.enabled') && 
                    	ProperMedia.utils.deepAccess(properSpecialOps, 'adlightning.reportAd')
                	) {
                    	adLightningWrapper.addReportAd(event);
                    }
                }
            }));

            // Slot Onload Function
            googletag.pubads().addEventListener('slotOnload', TraceKit.wrap(function(event) {
                var slot_name;
                try {
	                slot_name = ProperMedia.utils.extractSlotName(event.slot.getSlotElementId());
	                var slot = properPage.getSlotFromPageObject(slot_name);

	                if(slot) {
	                    // Detect Google Confirmed Click
	                    if(window.top.document.getElementById(slot.dfpIframeId)) {
	                        var googleIframeContentDocument = window.top.document.getElementById(slot.dfpIframeId).contentWindow.document;
	                        if (googleIframeContentDocument){
	                            if(googleIframeContentDocument.getElementById('common_15click_overlay') || googleIframeContentDocument.getElementById('common_15click_anchor')) {
	                                sendError(new Error('Detected Google Confirmed Click: ' + slot.dfp_name));
	                            }
	                        }
	                    }
	                }
	            } catch(e) {
	                properLog.mylog("Error Detecting Google Confirmed Click: " + slot_name);
	            }
            }));

            // Mark ad requests as NON child-directed.
            googletag.pubads().setTagForChildDirectedTreatment(0);
            // Disable initial load of ads
            googletag.pubads().disableInitialLoad();
            // Enable googles SRA mode
            googletag.pubads().enableSingleRequest();
            // Enable googletag
            googletag.enableServices();
            this.dfp_enabled_services = true;

        });
        this.dfp_init = 1;
    }


    /**
     * Call queued slots for google SRA call
     */
    pageObj.prototype.dfpSraCall = function() {

    	// Create DFP request
        googletag.cmd.push((function() {
	    	clearTimeout(this.sra_settings.timeout_handler);
	        this.sra_settings.timeout_handler = null;
	    	if(Object.keys(this.sra_settings.slot_queue).length > 0) {

				if(properSpecialOps.update_correlator == 1 && this.dfp_correlator == false && this.spa_settings.page_number > 1) {
			        googletag.pubads().updateCorrelator();
			        this.dfp_correlator = true;
			        properLog.mylog("Correlator updated for page: "+this.spa_settings.page_number);
			    }

			    var sra_dfp_slots = [];
			    Object.keys(this.sra_settings.slot_queue).forEach(function(slot_name) {
			    	var slot = this.sra_settings.slot_queue[slot_name];

			    	sra_dfp_slots.push(slot.dfp_slot);
			        slot.tracking_times.dfp_sent_ts = ProperMedia.utils.getTimestampMs();
			        properLog.mylog("DFP refresh called: "+slot.name);
			        slot.dfp_refreshed = 1;
			        slot.auction_send_complete = true;
			    }, this);

				this.sra_settings.slot_queue = {};
			    googletag.pubads().refresh(sra_dfp_slots);
			}
		}).bind(this));
	}

    /**
     *
     * Safe way of grabbing a slot from a page object.
     *
     * @param {pageObj} page - The Page Object
     * @param {String} slot_name - The Slot name; A string preferably.
     * @param {Array} slot_types - The Slot name; A string preferably.
     *
     * @returns {slotObj|null} - The slot object or Null.
     */
    pageObj.prototype.getSlotFromPageObject = function(slot_name, slot_types) {

		var slot = null;
		var slot_types = slot_types || Object.keys(this.slots) || ['display', 'video'];

		slot_types.forEach(function(slot_type) {
			if(this.slots[slot_type][slot_name]) {
				slot = this.slots[slot_type][slot_name];
				return;
			}
    	}, this);

        return slot;
    }


    /**
     * Get slot from page object by slot number
     * @param {Int} slot_number
     *
     * @returns {slotObj|null} - The slot object or Null.
     */
    pageObj.prototype.getSlotByNumber = function(slot_number, slot_types) {

    	var slot = null;
    	var slot_types = slot_types || Object.keys(this.slots);

    	slot_types.forEach(function(slot_type) {
			Object.keys(this.slots[slot_type]).forEach(function(slot_name) {
				var temp_slot = this.slots[slot_type][slot_name];
    			if(temp_slot.number == slot_number) {
    				slot = temp_slot;
    				return;
    			}
			}, this);
    	}, this);

        return slot;
    }


	/**
	* Fill dynamic_ad_matches with ads to load on this url
	*/
	pageObj.prototype.setDynamicAdMatches = function(){

		var ads_to_show = []

		// everything in the url after "www.domain.com/"
		var url_str = this.url.substr( this.url.indexOf(this.domain) + this.domain.length, this.url.length - 1 ).replace(window.location.hash, '');

		//everything in the url after "?"
		var utm_str = !url_str.includes("?") ? false : url_str.split("?")[1]

		//if there's a "?", remove it and everything after
		url_str = !utm_str ? url_str : url_str.split("?")[0]

		// loop through all page_groups
		for(group in properOps.page_groups) {
			var draw_ads = false;
			var g = properOps.page_groups[group]

			// loop through all page matches
	    	for ( url in g.url_matches ) {
	      		if(
					//hard match
					url_str == g.url_matches[url]
					||
					//wildcard match
					 g.url_matches[url].indexOf("*") > -1
					 &&
					 1 + url_str.search( g.url_matches[url].split("/").join("\/").split("=").join("\\\=").split("*").join(".*") )
			 	){
			 		draw_ads = true;
			 	}
    		}

			// if no matches, move onto the next loop
			if(!draw_ads) continue;

			// loop through all url_exclued ONLY if match was found
			for ( url in g.url_exclude ) {
    			if(
					//hard match
					url_str == g.url_exclude[url]
					||
					//wildcard match
					g.url_exclude[url].indexOf("*") > -1
					&&
					1 + url_str.search( g.url_exclude[url].split("/").join("\/").split("=").join("\\\=").split("*").join(".*") )
				){
					draw_ads = false;
					continue;
				}
			}

			// now add successful matches to our "return" var
			if(draw_ads) {
				ads_to_show = ads_to_show.concat(g.ads)
			}

			// lastly, check for extra ads
			if(!utm_str) continue;

			for( utm_group in g.url_mods ){
				for( utm in g.url_mods[utm_group].conditions){
					if( 1 + utm_str.search( g.url_mods[utm_group].conditions[utm] )){
						ads_to_show = ads_to_show.concat( g.url_mods[utm_group].extra_ads )
						continue
					}
				}
			}

		}
		this.dynamic_ad_matches = ads_to_show
	}

    return pageObj;

})();

    // Slot Object
var slotObj = (function() {

	function slotObj(type, name, settings, referenceNode) {
		this.name                   = '',    // Slot name
		this.dfp_name               = '',    // Name used for ad slot in DFP
		this.number                 = 0,     // Slot number
		this.type                   = '',    // Slot type. Ex: display, video
		this.div_id                 = '',    // Div id for slot
		this.max_tier               = 0,     // Resolution tier for slot sizes
		this.size                   = '0x0', // Size of slot
		this.sizes                  = [],    // possible slot sizes
		this.default_size           = [0,0], // default slot size (used for testing placeholder)
		this.min_width       	    = 0,     // smallest width of any size enabled (used for container size)
		this.min_height       	    = 0,     // smallest height of any size enabled (used for container size)
		this.last_displayed_ts      = 0,     // time slot was last displayed on page
		this.dfp_slot               = {},    // dfp request setup
		this.dfp_init			    = 0, 	// flag if DFP is initialized for this slot (only used in V6)
		this.dfp_ready              = 0,     // dfp request is ready to be sent for slot
		this.dfp_sent               = 0,     // dfp request has been sent
		this.dfp_refreshed          = 0,     // dfp request to refresh has been sent
		this.google_tag             = null   // Google tag object
		this.mapped_dfp_sizes       = 0,     // Flag if dfp size mapping has been set
		this.dfp_enabled_services   = false, // flag if DFP services have been enabled for slot
		this.dfp_targeting		    = {},    // hold keys added to DFP slot
		this.auction_send_complete  = false, // sent bids to header bidders and dfp
		this.winning_ad             = {},    // current winning ad from header bidders
		this.displayed_ad           = {},    // Ad that was displayed
		this.displayed              = 0,     // slot ad has been displayed
		this.delay_handle           = null,  // handle for timeout
		this.auction_started_ts     = null,  // time that the auction process started for the slot
		this.max_timeout_handle     = null,  // handle for max timeout
		this.max_timeout_met        = false, // flag to tell if max timeout has been met
		this.max_timeout      	    = 1200,  // max number of ms to wait before sending DFP request
		this.wait_interval          = 50,   // number of ms to wait
		this.wait_interval_handle   = null,  // handle for wait interval
		this.min_time_on_page       = 2000,  // Minimum time slot has to be on page before rebuilding for next page
		this.rebuild_timeout_handle = null,  // Handler for rebuilding slot
		this.exclude_advertiser     = [],    // keep advertiser ID's to exclude for refresh
		this.advertiserId 		    = 0,     // keep advertiser ID of current winner (excluding Proper Media)
		this.report_ad_tool         = 0,     // include report ad tool or not
		this.video_player           = null,  // Video player to use if video demand is enabled for slot
		this.video_type             = '',    // Video type: instream or outstream
		this.ad_types               = [],    // List of ad types that can display in slot. [display, video]
		this.sticky                 = 0,     // sicky slot or not
		this.sticky_settings = {   // Sticky Slot settings
		    "brand" : 1,             // Show Proper Media Brand on Sticky
		    "close_btn" : 1,         // Show Close Button
		    "disable_on_close" : 0,  // Disable sticky for user once its closed
		    "freq_cap_enabled" : 0,  // Eable max number of times to show to user
		    "freq_cap" : 0,          // Number of times to show a sticky to a user
		    "position" : "right",    // Position of side sticky
		}
		this.refresh = {
			"enabled": 0,              // Enable refresh
			"max": 5,                  // Max number of times a slot can refresh
			"count": 0,                // How many times slot has refreshed
			"interval": 60000,         // How long slot has to be on page before refreshing (ms)
			"min_interval": 15000,     // Has to be on the page for at least this amount of time before refreshing (ms)
			"current_interval": 60000, // The refresh interval that is calculated and currently set for the slot (ms)
			"inview_interval": 15000,  // How long the slot has to be inview before refreshing (ms)
			"exclude_dfp": 0,          // Dont go to dfp on refresh
		},
		this.floors = {
			"backup": 0.15, // Default floor
			"sizes": {}     // Size floors
		},
		this.lazyload = {
			"enabled": 1,             // Enable Lazyload
			"inFetchZone": false,     // Flag for slot is in the fetch zone
			"inRenderZone": false,    // Flag for slot is in the render zone
			"fetchMarginPercent": 0,  // Percent of viewport height for fetch zone
			"renderMarginPercent": 0  // Percent of viewport height for render zone
		},
		this.viewability = {
			"viewable": false,      // Slot is viewable or not
			"activeTab": true,      // Slot is in an active tab
			"entered_inview_ts": 0, // Ts slot became in view (ms)
			"total_time_inview": 0  // Time that slot has been in view (ms)
		},
		this.dynamic = {
			"enabled": false,
			"cssplacement": 'after',
			"cssselector": '',
			"instance_number": 0,
			"child_name": '',
			"css_ad":'',
			"css_page":''
		},
		this.tracking_times = {
			"built_ts": 0,
			"bids_ready_ts": 0,
			"dfp_sent_ts": 0,
			"dfp_returned_ts": 0,
			"creative_on_page": 0
		},
		this.kill_slot = false;  // Kill ads and slot logic

		this.buildSlot(type, name, settings, referenceNode);
	}


	/**
	 * Find the slot's div element (potentially inside an iframe)
	 * @return element
	 */
	slotObj.prototype.getElement = function() {
		return (this.iframe_window || top).document.getElementById(this.div_id);
	}


	/**
	 * Find the slot's document (potentially inside an iframe)
	 */
	slotObj.prototype.getContentDocument = function() {
		return this.iframe_window ?
			this.iframe_window.document :
			this.iframe_id ?
			window.top.document.getElementById(this.iframe_id).contentDocument :
			window.top.document.getElementById(this.div_id+"-iframe") ?
			window.top.document.getElementById(this.div_id+"-iframe").contentDocument :
			window.top.document;
	}


	/**
	 * Set sticky settings
	 * @param {Object} settings - Set refresh config settings
	 * @return boolean
	 */
	slotObj.prototype.setStickySettings = function(settings) {
		try {
			if(this.sticky) {
				var stickyObj = ProperMedia.utils.mergeObject({}, this.sticky_settings, (settings.sticky_settings || {}));
				this.sticky_settings = ProperMedia.utils.deepCopy(stickyObj);
			}
		} catch(e) {
			properLog.mylog('Error setting sticky settings: ' + this.name);
			return false;
		}
		return true;
	}

	/**
	 * Set refresh settings
	 * @param {Object} settings - Set refresh config settings
	 * @return boolean
	 */
	slotObj.prototype.setRefresh = function(settings) {
		try {
			var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
			var refresh_settings = (settings.refresh && settings.refresh[device_type]) ? settings.refresh[device_type] : {};

			var refreshObj = ProperMedia.utils.mergeObject({}, this.refresh, properOps.refresh[device_type], refresh_settings);
			this.refresh = ProperMedia.utils.deepCopy(refreshObj);
		} catch(e) {
			properLog.mylog('Error setting refresh settings: ' + this.name);
			return false;
		}
		return true;
	}


	/**
	 * Set lazy-load settings
	 * @param {Object} settings - Set lazy-load config settings
	 * @return boolean
	 */
	slotObj.prototype.setLazyload = function(settings) {
		try {
			var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
			var lazyload_settings = (settings.lazyload && settings.lazyload[device_type]) ? settings.lazyload[device_type] : {};

			var lazyloadObj = ProperMedia.utils.mergeObject({}, this.lazyload, properOps.lazyload[device_type], lazyload_settings);
			this.lazyload = ProperMedia.utils.deepCopy(lazyloadObj);

			// Dont lazy-load sticky units
			if(this.sticky) this.lazyload.enabled = false;

		} catch(e) {
			properLog.mylog('Error setting lazy-load settings: ' + this.name);
			return false;
		}
		return true;
	}


	/**
	 * Set price floors
	 * @param {Object} settings - Set floor config settings
	 * @return boolean
	 */
	slotObj.prototype.setFloors = function(settings) {
		try {
			var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
			var floor_settings = (settings.floors && settings.floors[device_type]) ? settings.floors[device_type] : {};

			var floorsObj = ProperMedia.utils.mergeObject({}, this.floors, properOps.floors[device_type], floor_settings);
			this.floors = ProperMedia.utils.deepCopy(floorsObj);

		} catch(e) {
			properLog.mylog('Error setting floors settings: ' + this.name);
			return false;
		}
		return true;
	}


	/**
	 * Set dynamic insertion settings
	 * @param {Object} settings - Set floor config settings
	 * @return boolean
	 */
	slotObj.prototype.setDynamic = function(settings) {
		try {
			var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
			var dynamic_settings = (settings.dynamic && settings.dynamic[device_type]) ? settings.dynamic[device_type] : {};

			var dynamictObj = ProperMedia.utils.mergeObject({}, this.dynamic, dynamic_settings);
			this.dynamic    = ProperMedia.utils.deepCopy(dynamictObj);

		} catch(e) {
			properLog.mylog('Error setting dynamic settings: ' + this.name);
			return false;
		}
		return true;
	}


	/**
	 * Get price floor for size
	 */
	slotObj.prototype.getFloor = function(size) {
		var floor = this.floors.sizes[size] || this.floors.backup || 0;
		return parseFloat(floor);
	}


	/**
	 * Check if sticky frequency cap has been met
	 * @return boolean
	 */
	slotObj.prototype.checkStickyFreqCapMet = function() {
		return (
			this.sticky == 1 &&
            (
                (   // Check if sticky has been closed
                    properOps.disable_sticky_on_close &&
                    properUser.stickyFreqCapHandler.getStickyClosedCookie() == true
                ) ||
                (   // Check if sticky frequency cap has been met
                    properOps.enable_sticky_freq_cap &&
                    properUser.stickyFreqCapHandler.getStickyUnitImps() >= properOps.sticky_freq_cap
                )
            )
        ) ? true : false;
	}


	/**
	 * Configure the viewability tracker
	 */
	slotObj.prototype.setViewabilityTracker = function() {

		// Configure viewability tracker
		var viewabilityConfig = {
			'id'                 : this.div_id,
			'lazyload'           : this.lazyload.enabled,
			'viewability'        : true,
			'fetchMarginPercent' : this.lazyload.fetchMarginPercent,
			'renderMarginPercent': this.lazyload.renderMarginPercent,
			'minHeight'          : this.min_height
		}

		properPage.viewability_tracker.addElement(
			viewabilityConfig,
			this.viewabilityChange.bind(this)
		);
	}


	/**
	 * Insert slot div into DOM
	 * @param {Element} referenceNode
	 * @param {String}  cssplacement
	 */
	slotObj.prototype.insertDynamicSlot = function(referenceNode, cssplacement) {

		//build iframe and add ad code
        var div1 = document.createElement('div');
        var div2 = document.createElement('div');

        div1.className = "proper-ad-unit" + (this.sticky ? " ad-sticky " + this.name : "");

        if(this.sticky) {
        	var div3 = document.createElement('div');
        	div3.id  = 'proper-ad-' + this.name;
        	div2.className = "sticky-inner";
        	div2.appendChild(div3);
        } else {
        	div2.id = 'proper-ad-' + this.name;
        }

		if(this.dynamic.css_ad != '') {
			div1.style = this.dynamic.css_ad
		}

		if(this.dynamic.css_page != '') {
		    head = document.head || document.getElementsByTagName('head')[0],
		    style = document.createElement('style');

			head.appendChild(style);
			style.type = 'text/css';

			if (style.styleSheet) { // This is required for IE8 and below.
				style.styleSheet.cssText = this.dynamic.css_page;
			} else {
				style.appendChild(document.createTextNode(this.dynamic.css_page));
			}
		}

        if(cssplacement == 'after') {
			referenceNode.parentNode.insertBefore(div1, referenceNode.nextSibling)
		} else if(cssplacement == 'before') {
			referenceNode.parentNode.insertBefore(div1, referenceNode);
		} else if(cssplacement == 'append') {
			referenceNode.appendChild(div1);
		} else if(cssplacement == 'prepend') {
			if(referenceNode.childNodes && referenceNode.childNodes.length > 0) {
				referenceNode.insertBefore(div1, referenceNode.childNodes[0]);
			} else {
				referenceNode.appendChild(div1);
			}
		}
        div1.appendChild(div2);

        $(referenceNode).addClass(properPage.dynamic_css_class);
	}


	/**
	 * Build Slot Object
	 * @param {String} type - Type of slot. Ex: display, video
	 * @param {String} name - Name of slot
	 * @param {Object} settings - Settings definition object
	 * @param {String} referenceNode - DOM Node
	 */
	slotObj.prototype.buildSlot = function(type, name, settings, referenceNode) {
		
		this.type           = type || 'display';
		this.name           = name;
		this.dfp_name       = name;
		this.number         = settings.number || 0;
		this.sticky         = settings.sticky || 0;
		this.size_map       = settings.resolution_size_map || {};
		this.report_ad_tool = settings.report_ad_tool || properOps.report_ad_tool;
		this.div_id         = (this.type == 'display') ? "proper-ad-" + name : this.name;
		this.dfpAdUnitPath  = '/' + properOps.dfp_id + '/' + name;
		this.dfpIframeId    = 'google_ads_iframe_' + this.dfpAdUnitPath + '_0';

		if(!this.name || (this.type == 'display' && !this.number)) {
			return false;
		}

		// Dynamic settings
		this.setDynamic(settings);
		if(this.dynamic.enabled) {
			this.child_name    = 'dynamic_' + this.dynamic.instance_number;
			this.dfpAdUnitPath = '/' + properOps.dfp_id + '/' + this.dfp_name + '/' + this.child_name;
			this.dfpIframeId   = 'google_ads_iframe_' + this.dfpAdUnitPath + '_0';

			this.name   = this.name + '_' + this.dynamic.instance_number;
			this.number = parseFloat(this.number + (this.dynamic.instance_number / 100));
			this.div_id = "proper-ad-" + this.name;

			if(settings.custom_css){
				this.dynamic.css_ad   = (settings.custom_css[0]) ? settings.custom_css[0] : '';
				this.dynamic.css_page = (settings.custom_css[1]) ? settings.custom_css[1] : '';
			}
		}

		this.getMaxTier();
		this.parseTierSizes();

		// Don't build slot if no sizes defined for page resolution
		if(this.sizes.length == 0) {
			return false;
		}

		this.setFloors(settings);
		this.setLazyload(settings);

		// Insert dynamic slots
		if(this.dynamic.enabled) {
			this.insertDynamicSlot(referenceNode, this.dynamic.cssplacement);
		}

		// Dont build slot if element isnt on the page
		if(!this.getElement()) {
			return false;
		}

		// Set video player
		if(settings.video_player && properPage.video_enabled !== false) {
			// Get player settings
			var player_settings = ProperMedia.utils.deepAccess(properOps , 'video_players.' + settings.video_player) || {};
			if(Object.keys(player_settings).length > 0) {
				this.video_player = new videoPlayer(settings.video_player, player_settings, this)
				this.video_type   = this.video_player.player_settings.video_type;
			}
		}

		// What ad types can play in slot
		if(this.type == 'display') {
			this.setStickySettings(settings);
			this.setRefresh(settings);

			this.ad_types.push('display');
			if(this.video_player && properPage.video_enabled !== false) {
				this.ad_types.push('video');
			}
		} else if(this.type == 'video' && this.video_player instanceof videoPlayer && properPage.video_enabled !== false) {
			this.ad_types.push('video');
		}

		this.checkVideoEnabled();

		//move stickys into the #inner-wrapper
		if(this.sticky) {

			//check if the ad is already inside .sticky-inner
			if(!this.getElement().parentNode.className.includes('sticky-inner')) {

				var par = this.getElement().parentNode;
				par.classList.add( this.name );

				//create .sticky-inner
				var sticky_wrapper = document.createElement("div");
				sticky_wrapper.setAttribute("class","sticky-inner");

				//add .sticky-inner to the parent
				par.appendChild( sticky_wrapper );

				//move this ad element inside .sticky-inner
				sticky_wrapper.insertAdjacentElement('beforeEnd', this.getElement() );

			}
		}

		this.setViewabilityTracker();

		if(
			(
				this.type == 'display' &&
				!this.lazyload.enabled
			) ||
			(
				this.type == 'video' &&
				ProperMedia.utils.deepAccess(this, 'video_player.auto_insert')
			)
		) {
			if(!this.checkBidsReady()) {
				this.setWaitInterval();
				this.setMaxAuctionTimeout();
			}
		}

		if(this.type == 'display') {
			// GDPR has resolved
			consentManager.ready((function() {
				if(properPage.isolated == 0 && this.refresh.exclude_dfp == 0) {
					// Handle loading differently if multiple DFP instances are used
	 				if(properOps.dfp_per_slot == 1) {
	 					if(this.dfp_init == 0) {
	 						this.initDfp();
	 					} else if(this.mapped_dfp_sizes == 0) {
	 						this.buildDfpSizeMapping();
	 					}

	 				} else {
						if(properPage.dfp_init == 0) {
							properPage.initDfp();
						}
						if(properPage.dfp_init == 1) {
							if(this.mapped_dfp_sizes == 0) {
								this.buildDfpSizeMapping();
							}
						}
					}
				}
			}).bind(this));
		} else if(this.type == 'interstitial') {
			// GDPR has resolved
			consentManager.ready((function() {
				if(!properOps.dfp_per_slot) {
					if(properPage.dfp_init == 0) {
						properPage.initDfp();
					}
					if(properPage.dfp_init == 1) {
						if(this.mapped_dfp_sizes == 0) {
							this.buildDfpSizeMapping();
						}
					}
 				}
			}).bind(this));

		}

		properLog.mylog('Building slot: ' + this.name);
		this.tracking_times.built_ts = ProperMedia.utils.getTimestampMs();
		
		// Add slot object to page object
		properPage.slots[this.type][this.name] = this;
		
		return true;
	}


	/**
	 * Update video enabled for page and load video script
	 */
	slotObj.prototype.checkVideoEnabled = function() {
		// Slot has video enabled
		if(this.ad_types.indexOf('video') !== -1 || properPage.video_enabled == true) {
			if(properPage.video_enabled === null) {
				properPage.video_enabled = true;
			}
			// Load script if it isn't already loaded
			properPage.loadVideoPlayerScript();
		}
	}


	/**
	 * Rebuild slot
	 */
	slotObj.prototype.rebuildSlot = function() {

		if(
			this.rebuild_timeout_handle == null &&
			this.type == 'display'
		) {
			var timeout = Math.max(0, this.min_time_on_page - this.timeSinceDisplayed())
			properLog.mylog('Rebuilding slot: ' + this.name + ' (' + timeout + ')');

			// Reset refresh settings
            var slot_settings = ProperMedia.utils.deepAccess(properOps, 'ad_slots' + '.' + this.type + '.' + this.name) || {};
            this.setRefresh(slot_settings);

			// Get slot tier for previous page
			var last_max_tier = this.max_tier;
			// Get max tier for page width
			this.getMaxTier();
			// If tier sizes have changed
			if(last_max_tier !== this.max_tier) {
				// Set up slot sizes for tier
				this.parseTierSizes();
			}

			this.rebuild_timeout_handle = properSetTimeout.setTimeout.call(
				this,
				function() {
					clearTimeout(this.rebuild_timeout_handle);
 					this.rebuild_timeout_handle = null;
					// Reset refresh count
					this.refresh.count = 0;
					// Reset slot data
					this.resetBidData();
					if(this.sizes.length > 0) {
						// GDPR has resolved
						consentManager.ready((function() {
							// Display slot
			            	if(!this.checkBidsReady()) {
				            	this.setWaitInterval();
				            	this.setMaxAuctionTimeout();
				            }
						}).bind(this));
					}
				},
				timeout
			);
		}
	}


	/**
	 * Get the max tier
	 */
	slotObj.prototype.getMaxTier = function() {
		// get max tier for current resolution
		this.max_tier = 0;
		Object.keys(this.size_map).forEach(function(tier) {
			tier = parseInt(tier);
			if(properPage.width >= tier && tier >= this.max_tier) {
				this.max_tier = tier;
			}
		}, this);
	}


	/**
	 * Parse Tier Sizes
	 */
	slotObj.prototype.parseTierSizes = function() {
		// and find new sizes for current max tier width
		var min = 0;
		this.sizes = this.size_map[this.max_tier] || [];

		if(this.sizes && this.sizes.length > 0) {

			// Loop through sizes to get smallest possible size
			for(var i = 0; i < this.sizes.length; i++) {

				var s = this.sizes[i].split('x');
				s[0] = parseInt(s[0]) || NaN;
				s[1] = parseInt(s[1]) || NaN;

				if(!isNaN(s[0]) && !isNaN(s[1])) {

					// Exclude 1x1
					if(s[0] != 1 && s[1] != 1 ) {
						// min width/height
						if(s[0] < this.min_width || this.min_width == 0) this.min_width = s[0];
						if(s[1] < this.min_height || this.min_height == 0) this.min_height = s[1];

						//min size
						if((s[0]*s[1]) < min || min == 0) {
							this.default_size = this.sizes[i].split('x');
							min = s[0]*s[1];
						}
					}
				} else if(this.sizes[i] == 'interstitial') {
					this.setInterstitial();
					break;
				}
			}
			return true;
		}
		return false;
	}

	/**
	 * Set Interstitial data
	 */
	slotObj.prototype.setInterstitial = function() {
		this.type         = 'interstitial';
		this.ad_types     = ['interstitial'];
		this.sizes        = ['interstitial'];
		this.min_width    = 1;
		this.min_height   = 1;
		this.default_size = [1,1];
		this.refresh.enabled  = false;
		this.lazyload.enabled = false;
	}

	// Get google tag object
	slotObj.prototype.googletag = function() {
		if(!this.google_tag) {
			if(properOps.dfp_per_slot == 1) {
				this.google_tag = {};
			} else {
				this.google_tag = googletag;
			}
		}
		if(typeof this.google_tag.cmd == "undefined") {
			this.google_tag.cmd = [];
		}
		return this.google_tag;
	}

 	/**
 	 * Define DFP slot and maps sizes
 	 */
    slotObj.prototype.buildDfpSizeMapping = function() {

        if(this.getElement() && this.sizes.length > 0 && this.mapped_dfp_sizes == 0) {

            //create DFP request
            this.googletag().cmd.push((function() {

                var sizes = [[1,1]];
                for (var i = 0; i < this.sizes.length; i++) {
                	var size = this.sizes[i];

                    // Exclude 1x1
                    if(size == '1x1') continue;

                    // Parse Size
                    var w_h = size.split('x');
                    w_h[0] = parseInt(w_h[0]);
                    w_h[1] = parseInt(w_h[1]);

                    if(!isNaN(w_h[0]) && !isNaN(w_h[1])) {
                        sizes.push(w_h);
                    } else if(size == 'fluid') {
                        sizes.push(size);
                    }
                }

                // define slot
                if(this.type == 'interstitial') {
                	this.dfp_slot = this.googletag().defineOutOfPageSlot(this.dfpAdUnitPath, this.googletag().enums.OutOfPageFormat.INTERSTITIAL).addService(this.googletag().pubads());
                } else if(ProperMedia.utils.checkOutOfPage(this.dfpAdUnitPath)) {
                    this.dfp_slot = this.googletag().defineOutOfPageSlot(this.dfpAdUnitPath, this.div_id).addService(this.googletag().pubads());
                } else {
                    this.dfp_slot = this.googletag().defineSlot(this.dfpAdUnitPath, sizes, this.div_id).addService(this.googletag().pubads());
                }

                /* Special tracking */

                // Post ID
                if(typeof properPage.post_id == 'undefined' || properPage.post_id == null || properPage.post_id == "") properPage.post_id = "unknown";
                this.dfp_slot.setTargeting('post_id', properPage.post_id.toString());

                // Member
                if(typeof properOps.member == 'undefined' || properOps.member == null || properOps.member == "") properOps.member = "no";
                this.dfp_slot.setTargeting('member', properOps.member.toString());

                // Add identifiers
                this.dfp_slot.setTargeting("split_version", properOps.rtp_file_version.toString());
                // this.dfp_slot.setTargeting("is_mobile", properPage.is_mobile.toString());
                this.dfp_slot.setTargeting("proper_site", properOps.site_name);
                this.dfp_slot.setTargeting("proper_slot", this.number);
                this.dfp_slot.setTargeting("proper_page", properPage.page_number);

                // Set tag targeting
                var tagArr = [];
                if(typeof properPage.tags !== 'undefined' && properPage.tags.length > 0) {
                    for (var i = 0; i < properPage.tags.length; i++) {
                        var k = properPage.tags[i];
                        //add desktop/mobile support
                        if(properDevice.isMobile()) {
                            tagArr.push(k+"_mobile");
                        } else {
                            tagArr.push(k+"_desktop");
                        }
                    }
                    tagArr = tagArr.concat(properPage.tags);
                }

                if(tagArr.length > 0) {
                    // Add tags to DFP request
                    this.dfp_slot.setTargeting('tags',[tagArr.toString()]);
                    this.dfp_targeting['tags'] = 1;
                } else if(this.dfp_targeting['tags'] == 1) {
                    // Remove tags from DFP request
                    this.dfp_slot.clearTargeting("tags");
                    this.dfp_targeting['tags'] = 0;
                }

                // Sticky unit
                if(this.sticky) {
                    this.dfp_slot.setTargeting("proper_sticky", this.sticky.toString());
                }

                // Loop through each size specific floor
                if(Object.keys(this.floors.sizes).length > 0) {
                    Object.keys(this.floors.sizes).map(function(size) {
                        var floor = this.floors.sizes[size];
                        if(floor > this.floors.backup) {
                            // Round floor to price bucket
                            var rounded_size_floor = round_floor(floor);
                            // Add dfp targeting for size specific floor
                            this.dfp_slot.setTargeting("proper_floor_"+size, rounded_size_floor.toFixed(2).toString());
                        }
                    }, this);
                }

                // Round floor to price bucket
                var rounded_slot_floor = round_floor(this.floors.backup);
                // Add dfp targeting for slot backup floor
                this.dfp_slot.setTargeting("proper_floor", rounded_slot_floor.toFixed(2).toString());

                //track session depth
                if(properSession.sessionData.depth > 0) {
                    this.dfp_slot.setTargeting("s_depth", properSession.sessionData.depth.toString());
                }
            }).bind(this));

            this.mapped_dfp_sizes = 1;
            if(this.bids_ready == 1 && !this.dfp_ready) {
	      		this.addBidToDfpSlot();
	        }
        }
    }


    /**
	 * Check if bid should be put back into pool
	 */
	slotObj.prototype.recycleBid = function() {
		if(
            this.hasWinningBid() &&
            !this.winning_ad.checkIfExpired() &&
            this.winning_ad.displayed == 0
        ) {
            properAdPool.addBidToPool(this.winning_ad);
            // Reset winning ad
            delete this.winning_ad;
            this.winning_ad = {};
        }
	}


    /**
     * Clear the winning bid.
     * Put bid back into pool if it is still good
     */
    slotObj.prototype.clearWinningBid = function() {
    	// Check if there is a winning bid
		if(this.hasWinningBid()) {
			// Should bid be put back into pool
			if(
				this.winning_ad.displayed == 0 &&
				!this.winning_ad.checkIfExpired()
			) {
				// Put bid back into pool
	            properAdPool.addBidToPool(this.winning_ad);
			}
			// Reset winning ad
			delete this.winning_ad;
			this.winning_ad = {};
		}
		return true;
    }


    /**
	 * Check if slot has a winning ad to display
	 */
	slotObj.prototype.hasWinningBid = function() {
		// If a winning ad was found
		if(
			this.winning_ad instanceof adObj &&
			this.winning_ad.bidder !== '' &&
			this.winning_ad.price > 0
		) {
			return true;
		} else{
			return false;
		}
	}


    /**
	 * Get winning bid from ad pool
	 * @param {Array}  ad_types - array of allowed ad types. [display, video]
	 * @param {String} video_type - instream or outstream
	 */
	slotObj.prototype.getWinningBid = function(ad_types, video_type) {
		var ad_types   = ad_types   || this.ad_types;
		var video_type = video_type || this.video_type;
		// Clear out the current winning bid
		this.clearWinningBid();
		// Get bid from ad pool
		properAdPool.getWinningBid(this, ad_types, video_type);
		// Check if a winning bid has been found
		return this.hasWinningBid();
	}


	/**
	 * Bids are ready to send to dfp or display
	 */
    slotObj.prototype.checkBidsReady = function() {
    	
 		// Make sure we haven't already started
 		if(
 			checkKillAllAds() ||
 			!this.getElement() ||
 			this.kill_slot == true ||
 			this.type == 'interstitial' || 
 			this.auction_send_complete == true ||
 			(
 				this.lazyload.enabled &&
 				!this.lazyload.inRenderZone
				)
			) {
 			return false;
 		}

 		// Wait until there isnt an aution running or the max timeout is met
 		if((Object.keys(properAdPool.auctions).length > 0 || Object.keys(properAdPool.finished_auctions).length == 0) && !this.max_timeout_met) {
 			return false;
 		}

 		// If there is a winning bid or max timeout it met
        if(
    		this.getWinningBid(this.ad_types, this.video_type) ||
    		this.max_timeout_met
    	) {

			// bids are ready to send to dfp
			this.bids_ready = 1;
			this.tracking_times.bids_ready_ts = ProperMedia.utils.getTimestampMs();

			if(
				this.type == 'display' &&
				(
					(
						this.hasWinningBid() &&
						this.winning_ad.type == 'display' &&
						this.ad_types.indexOf(this.winning_ad.type) !== -1
					) ||
					(
						!this.hasWinningBid() &&
						this.max_timeout_met
					)
				)
			) {

				// Destroy video slot
				if(this.ad_types.indexOf('video') !== -1 && this.video_player instanceof videoPlayer) {
					this.video_player.removePlayer();
				}

	 			// display winning ad. Dont send to dfp
	 			if(properPage.isolated == 1 || this.refresh.exclude_dfp == 1) {
	 				if(!this.lazyload.enabled || this.lazyload.inRenderZone) {
						if(showWinningAd(this)) {
							this.auction_send_complete = true;
						}
					}

				// add highest price to dfp
	 			} else {
	 				//handle loading differently if multiple DFP instances are used
	 				if(properOps.dfp_per_slot == 1) {
	 					if(this.dfp_init == 0) {
	 						this.initDfp();
	 					} else if(this.mapped_dfp_sizes == 0) {
	 						this.buildDfpSizeMapping();
	 					} else if(this.dfp_ready == 0) {
	 						this.addBidToDfpSlot();
	 					} else if(!this.dfp_sent || !this.dfp_refreshed) {
	 						this.dfpDisplayOrRefresh();
	 					}

	 				} else {
						if(properPage.dfp_init == 0) {
							properPage.initDfp();
						}
						if(properPage.dfp_init == 1) {
							if(this.mapped_dfp_sizes == 0) {
								this.buildDfpSizeMapping();
							}
							if(this.mapped_dfp_sizes == 1) {
								if(this.dfp_ready == 0) {
									this.addBidToDfpSlot();
								}
								if(this.dfp_ready == 1) {
									if(
										this.dfp_sent == 0 ||
	                        			this.dfp_refreshed == 0
		                			) {
										this.dfpDisplayOrRefresh();
									}
								}
							}
						}
					}
	 			}
	 		// Insert video player
	 		} else if(
	 			(
					( // If there is a winning video bid and slot allowes video
						this.hasWinningBid() &&
						this.winning_ad.type == 'video' &&
						this.ad_types.indexOf(this.winning_ad.type) !== -1
					) ||
					( // If video slot and the max timer is up
						this.type == 'video' &&
						this.max_timeout_met
					)
				) &&
				( // video is enabled for slot and video player isnt on page yet
	 				this.video_player &&
	 				this.video_player instanceof videoPlayer
 				)
 			) {
	 			// Disable refresh
				this.refresh.enabled = 0;
				this.removeRefreshTimeout();
 				this.auction_send_complete = true;
 				this.video_player.removePlayer();
				this.video_player.insertPlayer();
	 		}

 			if(this.auction_send_complete == true) {
				// Clear interval & timeout
        		this.clearWaitInterval();
            	this.clearMaxAuctionTimeout();
 			}
	 		return true;
	 	} else {
	 		this.clearWinningBid();
	 		return false;
	 	}
 	}


 	/**
 	 * Initialize DFP at a slot level
 	 */
 	slotObj.prototype.initDfp = function () {

 		if(this.dfp_init == 1) return false;

		var iframe_window, iframe_needs_dfp_script = false;

		// Check if slot is using an existing iframe document
		if (this.iframe_window) {
			iframe_window = this.iframe_window;
			iframe_needs_dfp_script = true;

		// Check if slot is using an existing iframe
		} else if (this.iframe_id) {
			var iframe = document.getElementById(this.iframe_id);
			if(!iframe) {
				properLog.mylog("ERROR: "+this.iframe_id+" doesn't exist in the DOM.");
				return;
			}

			this.iframe_window = iframe.contentWindow;
			iframe_window      = iframe.contentWindow;
			iframe_needs_dfp_script = true;

		} else {

			//Check if div exists
			var doc = document.getElementById(this.div_id);
			if(!doc) {
				properLog.mylog("WARNING: " + this.div_id + " doesn't exist in the DOM. This should re-run when proper_display is called");
				return;
			}

			//build iframe to load DFP without interfering with top level page
			var iframe = document.createElement('iframe');
			doc.innerHTML="";
			doc.appendChild(iframe);
			iframe.id                  = this.div_id+"-iframe";
			iframe.frameBorder         = 0;
			iframe.scrolling           = "no";
			iframe.marginWidth         = "0";
			iframe.marginHeight        = "0";
			iframe.style.overflow      = "hidden";
			iframe.style.border        = "0px";
			iframe.style.width         = "1px";
			iframe.style.height        = "1px";
			iframe.style.verticalAlign = "bottom";
			//iframe.src="javascript:\"<html><head></head><body style='background:transparent'></body></html>\"";
			var html = "<html><head><script src='https://securepubads.g.doubleclick.net/tag/js/gpt.js' async></script></head><body><div id='"+this.div_id+"'></div></body></html>";
			iframe.src="javascript:\""+html+"\"";
			iframe.contentWindow.document.open();
			iframe.contentWindow.document.write(html);
			iframe.contentWindow.document.close();
			iframe_window = iframe.contentWindow;
			this.iframe_window = iframe_window;
		}

		if (iframe_needs_dfp_script) {
			//Load GoogleTag DFP Library
			var gads = document.createElement('script');
			gads.async = true;
			gads.type = 'text/javascript';
			var useSSL = 'https:' == document.location.protocol;
			gads.src = (useSSL ? 'https:' : 'http:') + '//securepubads.g.doubleclick.net/tag/js/gpt.js';
			iframe_window.document.getElementsByTagName('head')[0].appendChild(gads);
		}

		// Load Confiant DFP On-Page Integration
        if(properOps.confiant == 1) {
            confiantWrapper.loadDFPTag(iframe_window);
        // Load Ad Lightning DFP On-Page Integration
        } else if(ProperMedia.utils.deepAccess(properSpecialOps, 'adlightning.enabled')) {
            adLightningWrapper.loadDFPTag(window);
        }

		//create googletag object in iframe
		iframe_window.googletag = iframe_window.googletag || {};
		this.google_tag = iframe_window.googletag || {};
		if(typeof this.googletag().cmd == "undefined") this.googletag().cmd = [];

		//googletag monitor events
		this.googletag().cmd.push((function() {

			if (gdprConsent.noPersonalization) {
				// disable personalized GPT ads
				this.googletag().pubads().setRequestNonPersonalizedAds(1);
			}

			if(uspConsent.restrictDataProcessing) {
                this.googletag().pubads().setPrivacySettings({
                    'restrictDataProcessing': true
                });
            }


            // This listener will be called when a creative iframe load event fires.
			this.google_tag.pubads().addEventListener('slotOnload', function(event) {
				var slot_name = ProperMedia.utils.extractSlotName(event.slot.getSlotElementId());
                var slot = properPage.getSlotFromPageObject(slot_name);

                properLog.mylog('DFP slotOnload: '+ slot_name);

                if(slot) {
            		slot.dispatchCustomEvent('proper-ads-fired', 
            			{
            				'cpm': ProperMedia.utils.deepAccess(slot, 'displayed_ad.price'),
            				'size': ProperMedia.utils.deepAccess(slot, 'displayed_ad.size'),
        					'ad_type': 'display'
            			}
        			);
            		if(slot.hasWinningBid() && slot.winning_ad.displayed == 1) {
            			slot.winning_ad.onBidWon();
            		}
                }
			});


			// Dfp slot render ended
			this.googletag().pubads().addEventListener('slotRenderEnded', TraceKit.wrap(function(event) {

				var slot_id   = event.slot.getSlotElementId();
				var slot_name = ProperMedia.utils.extractSlotName(slot_id);
				var slot      = properPage.getSlotFromPageObject(slot_name);

				if(slot) {
					properLog.mylog('DFP slotRenderEnded: '+ slot_name);

					slot.tracking_times.dfp_returned_ts = ProperMedia.utils.getTimestampMs();
					//tracker for non-bidder creatives (proper media didn't win but we still have an ad)
					if(event.advertiserId !== properOps.proper_advertiser && event.advertiserId != properOps.amazon_advertiser && event.isEmpty == false) {
						proper_render_dfp(slot_name, event.size, event.advertiserId, event.lineItemId, event.yieldGroupIds);
						//add: report ad / sticky slide up / etc
						proper_inview(event.isEmpty, slot_name, event.size.join('x'), event.creativeId, event.lineItemId, event.advertiserId);
					}

					if(!slot.sticky && 
						ProperMedia.utils.deepAccess(properSpecialOps, 'adlightning.enabled') && 
						ProperMedia.utils.deepAccess(properSpecialOps, 'adlightning.reportAd')
					) {
                    	adLightningWrapper.addReportAd(event);
                    }
				}
			}));

			// Slot Onload Function
            this.googletag().pubads().addEventListener('slotOnload', TraceKit.wrap(function(event) {
            	var slot_name;
            	try {
	            	slot_name = ProperMedia.utils.extractSlotName(event.slot.getSlotElementId());
	                var slot = properPage.getSlotFromPageObject(slot_name);

	                if(slot) {
	                	// Detect Google Confirmed Click
	                    var properIframeContentDocument = slot.getContentDocument();
	                    if (properIframeContentDocument && properIframeContentDocument.getElementById(slot.dfpIframeId)){
		                	var googleIframeContentDocument = properIframeContentDocument.getElementById(slot.dfpIframeId).contentWindow.document;
		                	if (googleIframeContentDocument){
								if(googleIframeContentDocument.getElementById('common_15click_overlay') || googleIframeContentDocument.getElementById('common_15click_anchor')) {
									sendError(new Error('Detected Google Confirmed Click: ' + slot.dfp_name));
								}
							}
						}
	                }
	            } catch(e) {
	            	properLog.mylog("Error Detecting Google Confirmed Click: " + slot_name);
	            }
            }));

			// Mark ad requests as NON child-directed.
            this.googletag().pubads().setTagForChildDirectedTreatment(0);
            // Disable initial load of ads
            this.googletag().pubads().disableInitialLoad();
            // Enable googles SRA mode
            this.googletag().pubads().enableSingleRequest();
            // Enable googletag
            this.googletag().enableServices();
			this.dfp_enabled_services = true;

		}).bind(this));

		this.dfp_init = 1;

		this.buildDfpSizeMapping();

	}


    slotObj.prototype.addBidToDfpSlot = function () {

        //create DFP request
        this.googletag().cmd.push((function() {

            if (
                this.dfp_ready ||
                !this.mapped_dfp_sizes ||
                !this.isSlotDefinedInGPT() ||
                this.winning_ad.type == 'video'
            ) {
                return false;
            }

            // check if there is a winning ad
            if(this.hasWinningBid()) {

                //round to match line items
                this.winning_ad.dfp_price = roundPriceToDfpBucket(this.winning_ad.price);

                // logging price sent to dfp
                properLog.mylog("Bid added to DFP request (" + this.winning_ad.bidder + ", " + this.name + "@" + this.winning_ad.size + ") = " + this.winning_ad.dfp_price);

                // add bidder
                this.dfp_slot.setTargeting("proper_bidder", properOps.site_name + "_" + this.winning_ad.bidder);

                // set targeting for new price
                this.dfp_slot.setTargeting("proper_bid", this.winning_ad.dfp_price);


            } else {
            	if(this.dfp_slot.getTargeting("proper_bid").length > 0) {
            		this.dfp_slot.clearTargeting("proper_bid");
            	}
            	if(this.dfp_slot.getTargeting("proper_bidder").length > 0) {
            		this.dfp_slot.clearTargeting("proper_bidder");
            	}
                properLog.mylog("Bid added to DFP request (" + this.name + ") = 0.00");
            }

            this.dfp_slot.setTargeting("s_depth", properSession.sessionData.depth.toString());

            //exclude advertisers for refresh
            if(this.refresh.count > 0) {

                var list = [];
                if(this.advertiserId != 0) {
                    list.push(this.advertiserId); // exclude last winner
                    this.advertiserId = 0;        // reset avertiser id
                }

                list = list.concat(this.exclude_advertiser);

                //set dfp values
                if(list.length > 0) {
                	this.dfp_slot.setTargeting("exclude_advertiser", list);
                } else if(this.dfp_slot.getTargeting("exclude_advertiser").length > 0) {
                	this.dfp_slot.clearTargeting("exclude_advertiser");
                }

            //exclude google on proper_test
            } else if(typeof properPage.get_vars.proper_dfp !== 'undefined' && properPage.get_vars.proper_dfp == 1 && properOps.testing_mode.enabled == true) {
                this.dfp_slot.setTargeting("exclude_advertiser", [properOps.google_advertiser, properOps.adsense_advertiser]);
            }

            // additional targeting
            if(typeof this.refresh.count === 'undefined') {
                this.dfp_slot.setTargeting("refresh_count", 0);
            } else {
                this.dfp_slot.setTargeting("refresh_count", this.refresh.count.toString());
                // this.dfp_slot.setTargeting("auction_count", this.auction_num.toString());
            }

            this.dfp_ready = 1;
            if(this.getElement()) {
                // Display or refresh dfp slot
                this.dfpDisplayOrRefresh();
            }
        }).bind(this));
    }


    /**
     * Call DFP to display or refresh slot
     */
    slotObj.prototype.dfpDisplayOrRefresh = function() {
		this.googletag().cmd.push((function(){
	    	// If googletag.display hasn't been called yet
	        if(!this.dfp_sent) {
		        this.dfp_sent = 1;
	    		this.googletag().display(this.div_id);
	    	}

	    	if(properOps.dfp_per_slot == 1) {
	    		this.dfpSraCall();
	    	} else {
		    	if(!ProperMedia.utils.deepAccess(properPage, 'sra_settings.slot_queue.'+this.name)) {
			    	// Add slot to queue
			    	properPage.sra_settings.slot_queue[this.name] = this;
			    	// send request after 10ms (wait for more ad units to finish)
			        clearTimeout(properPage.sra_settings.timeout_handler);
			        properPage.sra_settings.timeout_handler = null;
			        properPage.sra_settings.timeout_handler = properSetTimeout.setTimeout.call(properPage, function() { properPage.dfpSraCall(); }, properPage.sra_settings.timeout_ms);
			    }
			}
		}).bind(this));
    }

    /**
     * Call queued slots for google SRA call
     */
    slotObj.prototype.dfpSraCall = function() {
    	this.googletag().cmd.push((function(){
	    	if(properSpecialOps.update_correlator == 1 && properPage.dfp_correlator == false && properPage.spa_settings.page_number > 1) {
		        this.googletag().pubads().updateCorrelator();
		        properPage.dfp_correlator = true;
		        properLog.mylog("Correlator updated for page: "+properPage.spa_settings.page_number);
		    }

	        this.tracking_times.dfp_sent_ts = ProperMedia.utils.getTimestampMs();
	        properLog.mylog("DFP refresh called: "+this.name);
	        this.dfp_refreshed = 1;
	        this.auction_send_complete = true;

		    this.googletag().pubads().refresh([this.dfp_slot]);
		}).bind(this));
	}


    /**
     * Wait for more bids to come back
     */
 	slotObj.prototype.setWaitInterval = function() {
 		properLog.mylog("Set wait interval for " + this.name + " ( " + this.wait_interval + " )");
 		var obj = this;
 		if(this.wait_interval_handle == null) {
 			this.wait_interval_handle = properSetInterval.setInterval.call(
 				obj,
 				function() {
					obj.checkBidsReady();
				},
				obj.wait_interval
			);
 		}
    }


    /**
     * Reset timeout
     */
 	slotObj.prototype.clearWaitInterval = function() {
 		clearInterval(this.wait_interval_handle);
 		this.wait_interval_handle = null;
 	}


 	/**
 	 * Set max time that auction can run
 	 */
 	slotObj.prototype.setMaxAuctionTimeout = function() {
 		var obj = this;
 		if(this.max_timeout_handle == null) {
 			this.auction_started_ts = ProperMedia.utils.getTimestampMs();
 			this.max_timeout_handle = properSetTimeout.setTimeout.call(
 				obj,
 				function() {
 					obj.max_timeout_met = true;
 					obj.clearWaitInterval();
 					obj.clearMaxAuctionTimeout();
					obj.checkBidsReady();
				},
 				obj.max_timeout
			);
 		}
    }


    /**
     * Reset max timeout for auction
     */
 	slotObj.prototype.clearMaxAuctionTimeout = function() {
 		clearTimeout(this.max_timeout_handle);
 		this.max_timeout_handle = null;
 	}


 	/**
 	 * Calculate and set the refresh interval
 	 * @return boolean
 	 */
 	slotObj.prototype.setRefreshInterval = function() {
 		// Check if bidder should NOT be refreshed
 		if(
 			this.refresh.enabled == 0 ||
 			(
 				this.winning_ad.displayed == 1 &&
 				ProperMedia.utils.deepAccess(properOps, 'bidder_info.'+this.winning_ad.bidder+'.dont_refresh') == 1
			)
		) {
 			this.refresh.enabled = 0;
 			return false;
 		}

 		// Set default refresh interval
 		var refresh_interval = Math.max(this.refresh.interval, this.refresh.min_interval);

 		// Inview refresh is enabled for slot
 		if(this.refresh.inview_interval !== -1) {
 			// Slot is viewabile
 			if(this.viewability.viewable) {
 				refresh_interval = Math.max(
 					0,
 					(this.refresh.inview_interval - this.viewability.total_time_inview),
 					(refresh_interval - this.timeSinceDisplayed())
				);
 			} else {
 				// Slot is NOT viewable
 				return false;
 			}
 		} else {
 			refresh_interval = Math.max(
					0,
					(refresh_interval - this.timeSinceDisplayed())
			);
 		}

 		// Set refresh interval
		this.refresh.current_interval = refresh_interval;
 		this.addRefreshTimeout(this.refresh.current_interval);
 		return true;
 	}


 	/**
 	 * Set refresh timout
 	 * @return boolean
 	 */
 	slotObj.prototype.addRefreshTimeout = function(refresh_interval) {
 		var obj = this;
		this.removeRefreshTimeout(); // remove any existing handler
 		this.refresh_handler = properSetTimeout.setTimeout.call(
 			obj,
			function() {
				obj.removeRefreshTimeout();
				obj.refreshSlot();
			},
			refresh_interval
		);
		properLog.mylog(this.name+': Starting refresh timer. ms = '+refresh_interval);
 	}


 	/**
 	 * Calculate time since last refresh
 	 */
	slotObj.prototype.timeSinceDisplayed = function() {
		if (this.last_displayed_ts == 0) return 0;
		return Date.now() - this.last_displayed_ts;
	}


	/**
 	 * Remove refresh timeout
 	 */
 	slotObj.prototype.removeRefreshTimeout = function() {
 		if(this.refresh_handler) {
	 		properLog.mylog(this.name+': Removing refresh timer.');
	 		clearTimeout(this.refresh_handler);
	 		this.refresh_handler = null;
	 	}
 	}


 	/**
 	 * Reset slot data
 	 */
 	slotObj.prototype.resetBidData = function() {
		this.last_displayed_ts     = 0,
		this.dfp_ready             = 0,
		this.dfp_refreshed         = 0,
		this.winning_ad            = {},
		this.exclude_advertiser    = [],
		this.advertiserId 		   = 0,
		this.auction_started_ts    = 0,
		this.max_timeout_met       = false,
		this.auction_send_complete = false,

		this.viewability.entered_inview_ts = (this.viewability.viewable) ? ProperMedia.utils.getTimestampMs() : 0,
		this.viewability.total_time_inview = 0;

		this.clearWaitInterval();
		this.clearMaxAuctionTimeout()
		this.removeRefreshTimeout();
 	}


 	/**
 	 * Refresh Slot
 	 */
    slotObj.prototype.refreshSlot = function(forceRefresh) {
    	// Check refresh max
        if(this.refresh.count < this.refresh.max) {
        	// Only refresh in fetch zone for lazy-load
	 		if(
 				this.lazyload.enabled &&
 				!this.lazyload.inFetchZone
 			) {
	 			return false;
	 		}

            properLog.mylog('Refreshing slot: ' + this.name);

            // increment refresh count
            this.refresh.count++;
            
            // Reset data
    		this.resetBidData();
        	// Display slot
        	if(!this.checkBidsReady()) {
            	this.setWaitInterval();
            	this.setMaxAuctionTimeout();
            }
        	return true;
        } else {
        	return false;
        }
    }


    /**
     * Calculate time slot has been inview
     */
 	slotObj.prototype.getTimeInview = function() {
		if (this.viewability.entered_inview_ts == 0) return 0;
		return Date.now() - this.viewability.entered_inview_ts;
	}


	/**
	 * Callback for slot viewability change and lazy-load margins
	 * @param {viewabilityObj}
	 */
	slotObj.prototype.viewabilityChange = function(viewabilityObj) {

		// Slot has switched between Viewable/Hidden OR Tab has switched between Active/Inactive
		if(this.viewability.viewable !== viewabilityObj.viewable || this.viewability.activeTab !== viewabilityObj.activeTab) {
			properLog.mylog(this.name + ': Viewability Change. visible = ' + viewabilityObj.viewable + ' Active Tab = ' + viewabilityObj.activeTab);

			// Update viewability state
			this.viewability.viewable = viewabilityObj.viewable;

			// If slot is viewable or Tab has switched between Active/Inactive
			// if (viewabilityObj.viewable || this.viewability.activeTab !== viewabilityObj.activeTab) {

				if ( // Slot has already dispalyed && hasnt reached max refreshes
					this.displayed &&
					this.refresh.enabled &&
					this.refresh.count < this.refresh.max &&
					viewabilityObj.activeTab &&
					(
						( // Slot is viewable and inview interval is set
							viewabilityObj.viewable &&
							this.refresh.inview_interval !== -1
						) ||
						( // Inview interval isnt set and tab switched to active from inactive
							this.refresh.inview_interval == -1
						)
					)
				) {
					// either start a refresh timer or replace with a shorter one.
					this.setRefreshInterval();
				} else {
					// remove refresh timeout
					this.removeRefreshTimeout();
				}
			// }

			// Slot IS viewable
			if(viewabilityObj.viewable) {
				this.dispatchCustomEvent('inview');
				this.viewability.entered_inview_ts = ProperMedia.utils.getTimestampMs();
			// Slot is NOT viewable
			} else {
				this.dispatchCustomEvent('not-inview');
				this.viewability.total_time_inview += this.getTimeInview();
			}

			// Update active tab state
			this.viewability.activeTab = viewabilityObj.activeTab
		}

		// Check if slot is still in DOM
		if(!this.viewability.viewable && !this.getElement()) {
			this.deleteSlot(true);
			return false;
		}

		// Lazy Load is enabled
		if(this.lazyload.enabled) {

			// Slot has entered or exited fetch zone
			if(this.lazyload.inFetchZone !== viewabilityObj.inFetchZone) {
				properLog.mylog(this.name + ': LazyLoad Change. inFetchZone = '+viewabilityObj.inFetchZone);
				// Update lazy-load state
				this.lazyload.inFetchZone = viewabilityObj.inFetchZone;

				// Slot is in fetch zone
				if(this.lazyload.inFetchZone) {
					// Set interval
					if(!this.wait_interval_handle && !this.max_timeout_met) {
						// Amount of time to wait for bids
						this.setWaitInterval();
					}
					// Set max timeout
					if(!this.max_timeout_handle && !this.max_timeout_met) {
						this.setMaxAuctionTimeout();
					}
				} else {
					this.clearWaitInterval();
				}
			}

			// Slot has entered or exited render zone
			if(this.lazyload.inRenderZone !== viewabilityObj.inRenderZone) {
				properLog.mylog(this.name + ': LazyLoad Change. inRenderZone = '+viewabilityObj.inRenderZone);

				// Update lazy-load state
				this.lazyload.inRenderZone = viewabilityObj.inRenderZone;

				// Slot is in render zone
				if(this.lazyload.inRenderZone) {
					// Display
					this.checkBidsReady();
				}
			}
		}
		return true;
	}

	/**
	 * Displatch event for listeners
	 * @param {String} event_type
	 */
	slotObj.prototype.dispatchCustomEvent = function(event_type, ext) {
		var ext = ext || {};

		var detail = ProperMedia.utils.mergeObject({
	            'slot': this.name,
	            'event': event_type
	        },
	        ext
        );

		var event = new CustomEvent('properEvents', { 'detail': detail });
        window.dispatchEvent(event);
	}


	/**
	 * Get list of slots defined in GPT
	 * @return {Array} gpt_slots
	 */
	slotObj.prototype.getGPTSlots = function() {
		var gpt_slots = [];
		if(properPage.isolated == 0) {
			this.googletag().cmd.push((function() {
				gpt_slots = this.googletag().pubads().getSlots().map(
					function(slot) {
						return slot.getSlotElementId();
					}
				);
			}).bind(this));
		}
        return gpt_slots;
    }


    /**
	 * Check if slot is defined in GPT
	 * @return {Boolean}
	 */
	slotObj.prototype.isSlotDefinedInGPT = function() {
        if(!this.div_id) return false;
        return (this.getGPTSlots().indexOf(this.div_id) !== -1);
    }


    /**
     * Remove previous ad's creative from page
     */
    slotObj.prototype.removeCreative = function() {
    	if(
            this.refresh.count > 0 &&
            ProperMedia.utils.deepAccess(this, 'displayed_ad.bidder')
        ) {
            var bidderAdapterName = bidderToAdapterName(this.displayed_ad.bidder);
            if (
                typeof bidAdapters[bidderAdapterName] !== 'undefined' &&
                typeof bidAdapters[bidderAdapterName].removeCreative == 'function'
            ) {
                bidAdapters[bidderAdapterName].removeCreative(this);
            }
        }
    }


    /**
     * Remove slot Elem from DOM
     */
    slotObj.prototype.removeElemFromDOM = function() {
    	var elem = window.top.document.getElementById(this.div_id);
		if(elem) {
    		if(elem.parentNode.className.indexOf('proper-ad-unit') !== -1) {
    			elem = elem.parentNode;
    		}
    		elem.parentNode.removeChild(elem);
    	}
    }


    /**
     *  Delete slot object
     * @param {Boolean} removeFromDOM
     */
	slotObj.prototype.deleteSlot = function(removeFromDOM) {
		if(this.kill_slot == false) {
			// Kill slot from displaying
			this.kill_slot = true;
 			// Remove slot refresh
			this.refresh.enabled = 0;
			// Reset bid data
			this.resetBidData();
 			// Reset settings
			this.lazyload.enabled = 0;
			// Destroy DFP object
			this.destroyDfpSlot();
			// Remove element from viewability checks
			properPage.viewability_tracker.removeElement(this.div_id);
			// If slot is still in DOM
			if(removeFromDOM && this.getElement()) {
				this.removeElemFromDOM();
			}
			// Check if slot is in page object
			if(properPage.getSlotFromPageObject(this.name, [this.type])) {
				// Remove slot from page object
				delete properPage.slots[this.type][this.name];
			}
			properLog.mylog('Deleted Slot: ' + this.name);
		}
	}


	/**
	 * Destroy GPT slot object
	 */
	slotObj.prototype.destroyDfpSlot = function() {
		if(properPage.isolated == 0 && this.isSlotDefinedInGPT()) {
			// Destroy dpf slots
			this.googletag().cmd.push((function(){
				this.googletag().destroySlots([this.dfp_slot]);
			}).bind(this));

			this.dfp_slot         = {},
			this.dfp_init         = 0,
			this.dfp_ready        = 0,
			this.dfp_sent         = 0,
			this.dfp_refreshed    = 0,
			this.mapped_dfp_sizes = 0;
		}
	}


	return slotObj;

})();

    // Ad Object
var videoPlayer = function(player_id, settings, slot) {

	this.slot = null,
	this.auto_insert = false,
	this.auto_inserted = false,

	this.player_settings = {
		"id"                  : '',
		"div_id"              : '',
		"dfp_ad_unit"         : '',
		"video_id"            : '',
		"video_type"          : '',
		"number_of_ads"       : 10,
		"autoplay"            : 1,
		"backfill"            : false,
		"backfill_id"         : '',
		"small_player"        : "desktop_ad",
		"small_player_bottom" : 100,
		"ad_failure_limit"    : 5,
		"vast_timeout"        : 5000,
		"no_ads_no_player"    : false
	},

	/** 
	 * Find the video's div element (potentially inside an iframe)
	 * @return element
	 */
	this.getElement = function() {
		return top.document.getElementById(this.player_settings.div_id);
	}


	/** 
	 * Initialize player object
	 * @param {String} player_id 
	 * @param {Object} settings 
	 */
	this.init = function(player_id, settings, slot) {
		this.slot = slot;
		this.checkAutoInsert();
		this.setPlayerSettings(player_id, settings.player_settings)
	}


	/** 
	 * Initialize player object
	 * @param {String} player_id 
	 * @param {Object} settings 
	 */
	this.checkAutoInsert = function() {
		// Get Slots element
 		var elem = top.document.getElementById(this.slot.div_id);
 		if(elem && 
 			(
 				elem.classList.contains("propervideo-main_player_container") || 
 				elem.hasAttribute("data-video-id") 
			)
		) {
 			this.div_id      = this.slot.div_id;
 			this.auto_insert = false;
 		} else {
 			this.auto_insert = true;
 		}
	}

	/** 
	 * Set the player settings
	 * @param {String} player_id 
	 * @param {Object} settings 
	 */
	this.setPlayerSettings = function(player_id, player_settings) {
		var div_id = (this.player_settings.div_id) ? this.player_settings.div_id : player_id + "-" + ProperMedia.utils.makeid(10);
		var player_settings      = ProperMedia.utils.mergeObject({}, this.player_settings, (player_settings || {}), { "id": player_id, "div_id": div_id });
		player_settings.autoplay = player_settings.autoplay ? 1 : 0;
		this.player_settings     = ProperMedia.utils.deepCopy(player_settings);	
	}


	/** 
	 * Insert player on to page
	 * @param {slotObj} slot  
	 */
 	this.insertPlayer = function() {
 		// Get Slots element
 		var elem = top.document.getElementById(this.slot.div_id);

 		if(elem && this.auto_insert) {

 			// Check if player is already in the DOM
 			if(!document.getElementById(this.player_settings.div_id)) {

 				// Clear out old HTML
 				this.slot.getElement().innerHTML = '';
		 		// Hide Proper Ad iframe for dfp per slot scenario
	 			if(properOps.dfp_per_slot) {
	 				var iframeElem = top.document.getElementById(this.slot.div_id + '-iframe');
	 				if(iframeElem) {
	 					iframeElem.style.width  = '0px'; 
	 					iframeElem.style.height = '0px'; 
	 				}
	 			}

		 		var playerElem = this.buildPlayerElem();
		 		elem.prepend(playerElem);
		 		this.auto_inserted = true;

		 	} else {
		 		window.top.propervideotag = window.top.propervideotag || []; 
		 		if(this.auto_inserted && this.player_settings.video_type == 'outstream') {
			 		window.top.propervideotag.push(
			 			(function() { 
			 				window.top.propervideo_display(this.player_settings.div_id, this.slot.name, properOps.site_name, "outstream_restart"); 
			 			}).bind(this)
		 			);
			 	} else {
			 		window.top.propervideotag.push(
			 			(function() { 
			 				window.top.propervideo_display(this.player_settings.div_id, this.slot.name, properOps.site_name); 
		 				}).bind(this)
	 				);
			 	}
		 	}
	 	}
 	}

 	/** 
	 * Remove player from the page
	 */
 	this.removePlayer = function() {
 		try {
	 		var elem = top.document.getElementById(this.player_settings.div_id);
	 		if(elem) {
	 			this.auto_inserted = false;
	 			elem.remove();
	 		}
	 		this.destroyVideoPlayerObj();
	 	} catch(e) {}
  	}


  	/**
  	 * Video player has been destroyed
  	 */
  	this.destroyVideoPlayer = function() {
  		this.removePlayer();
        var slot_settings = ProperMedia.utils.deepAccess(properOps, 'ad_slots' + '.' + this.slot.type + '.' + this.slot.name) || {};
        this.slot.setRefresh(slot_settings);
        this.slot.refreshSlot();
  	}


  	/**
  	 * Destroy video player obj 
  	 */
  	this.destroyVideoPlayerObj = function() {
  		if(
				typeof ProperMediaVideo !== 'undefined' && 
				ProperMedia.utils.deepAccess(ProperMediaVideo, 'ad_project.applications') && 
				ProperMedia.utils.deepAccess(ProperMediaVideo, 'ad_project.applications').length
			) {
				for (var i = 0; i < ProperMediaVideo.ad_project.applications.length; i++) {
					if(
						ProperMedia.utils.deepAccess(ProperMediaVideo, 'ad_project.applications.' + i + '.video_player.destroy_player') &&
						ProperMedia.utils.deepAccess(ProperMediaVideo, 'ad_project.applications.' + i + '.div_name') == this.player_settings.div_id
					) {
							ProperMediaVideo.ad_project.applications[i].video_player.destroy_player();
							break;
		 			}
				}
 		}
  	}


 	/** 
	 * Build Player Element to insert into DOM
	 * @param playerElem  
	 */
 	this.buildPlayerElem = function() {

		if(this.player_settings.video_type == 'instream') {
 
	 		var playerElem = document.createElement('div');

	 		playerElem.id = this.player_settings.div_id;

	 		// playerElem.setAttribute("data-auto-injected", true);
	 		playerElem.setAttribute("data-video-id",      this.player_settings.video_id);
	 		playerElem.setAttribute("data-small-player",  this.player_settings.small_player);

	 		if(this.player_settings.number_of_ads) {
	 			playerElem.setAttribute("data-number-of-ads", this.player_settings.number_of_ads);
	 		}
	 		if(this.player_settings.autoplay) {
	 			playerElem.setAttribute("data-autoplay", (this.player_settings.autoplay) ? 1 : 0);
			}

	 		var code = 'var window.top.propervideotag = window.top.propervideotag || []; window.top.propervideotag.push(function(){ window.top.propervideo_display("' + this.player_settings.div_id + '", "' + this.slot.name + '", "' + this.slot.name + '"); });';

	 		var script = document.createElement('script');
			script.type = 'text/javascript';
			script.appendChild(document.createTextNode(code));
			playerElem.appendChild(script);

			return playerElem;

		} else if(this.player_settings.video_type == 'outstream') {

			var playerElem = document.createElement('div');

	 		playerElem.id = this.player_settings.div_id;

	 		playerElem.setAttribute("data-auto-injected", true);
	 		playerElem.setAttribute("data-video-id",     properOps.site_name + '-' + this.player_settings.video_type);
	 		playerElem.setAttribute("data-outstream",    this.player_settings.video_type);
	 		playerElem.setAttribute("data-small-player", this.player_settings.small_player);
	 		playerElem.setAttribute("data-backfill",     this.player_settings.backfill);
	 		
	 		if(this.player_settings.backfill && this.player_settings.backfill_id) {
	 			playerElem.setAttribute("data-backfill-id",  this.player_settings.backfill_id);
	 		}

	 		if(this.player_settings.number_of_ads) {
	 			playerElem.setAttribute("data-number-of-ads", this.player_settings.number_of_ads);
	 		}
	 		if(this.player_settings.autoplay) {
	 			playerElem.setAttribute("data-autoplay", (this.player_settings.autoplay) ? 1 : 0);
			}

	 		var code = 'window.top.propervideotag = window.top.propervideotag || []; window.top.propervideotag.push(function(){ window.top.propervideo_display("' + this.player_settings.div_id + '", "' + this.slot.name + '", "' + properOps.site_name + '", "outstream_restart"); });';

	 		var script = document.createElement('script');
			script.type = 'text/javascript';
			script.appendChild(document.createTextNode(code));
			playerElem.appendChild(script);

			return playerElem;
		}
 	}


 	this.adSuccessCallback = function() {
 		console.log("adSuccessCallback");
 	}


 	this.adErrorCallback = function() {
 		console.log("adErrorCallback");	
 	}

 	this.init(player_id, settings, slot);

}

    // Bid Object
var bidObj = (function() {
	 function bidObj(bidder_name, bidder_data, auction) {
		
		this.bidder    = bidder_name,
		this.auction   = auction, // instance of auctionObj
		this.sent      = 0,
		this.returned  = 0,
		this.requests  = bidder_data,
		this.responses = [];
	}

	/**
 	 * Update number of requests sent
 	 * @param {Int} count 
 	 */
	bidObj.prototype.incrementRequestsSent = function(count) {
		this.sent += !isNaN(parseInt(count)) ? parseInt(count) : 0;
		this.auction.incrementRequestsSent(count);
	}

	/**
     * Update number of bid responses
 	 * @param {Int} count 
 	 */
	bidObj.prototype.incrementBidResponseCount = function(count) {
		this.returned += !isNaN(parseInt(count)) ? parseInt(count) : 0;
		this.auction.incrementBidResponseCount(count);
	}

	/**
 	 * Log we received a bid back and add it to the pool
 	 * @param {adObj} ad 
 	 */
	bidObj.prototype.logBidResponse = function(ad) {
		// log bid response
		this.responses.push(ad);
		this.auction.logBidResponse(ad);
		properLog.log_bid(ad);
	}

	return bidObj;

})();
    // Ad Object
var adObj = (function() {
	function adObj(obj) {

		this.type        = obj.type        || 'display' // Ad type: display or video
		this.gross       = obj.gross       || 0,        // Gross amount
		this.price       = obj.price       || 0,        // Price including rev share
		this.displayed   = obj.displayed   || 0,        // If ad won and was displayed
		this.dfp_price   = obj.dfp_price   || 0,        // Price sent to DFP
		this.bidder      = obj.bidder      || '',       // Bidder
		this.size        = obj.size        || '1x1',    // Size of ad
		this.adcode      = obj.adcode      || '',       // Ad code to be inserted
		this.nurl        = obj.nurl        || '',       // Win notification url
		this.burl        = obj.burl        || '',       // Delivery url
		this.vast_tag    = obj.vast_tag    || '',       // Vast tag for video ads
		this.vast_type   = obj.vast_type   || '',       // Vast type for video ads: tag or url
		this.vpaid       = obj.vpaid       || false,    // VPaid Video format
		this.video_type  = obj.video_type  || '',       // Video type for video ads: instream or outstream
		this.tag_id      = obj.tag_id      || '',       // Tag id
		this.ad_details  = obj.ad_details  || {},       // Object to store extra data
		this.request_url = obj.request_url || '',       // Bid endpoint
		this.response    = obj.response    || {},       // List of responses
		this.response_ms = obj.response_ms || 0,        // How long it took to get bid back
		this.received_ts = obj.received_ts || 0,        // Timestamp when bid was returned
		this.ttl         = obj.ttl         || 120000;   // Ad time to live
	}


	/**
	 * How much time has passed since bid was received
	 * @return {Int}
	 */
	adObj.prototype.timePassed = function() {
		var d = new Date();
		var ts = d.getTime();
		var ms = ts - this.received_ts;
		return ms;
 	}


 	/**
	 * Check if Ad's ttl has passed
	 * @return {Boolean}
	 */
 	adObj.prototype.checkIfExpired = function() {
 		return (this.timePassed() > this.ttl) ? true : false;
 	}


 	/**
	 * Check if Ad's ttl has passed
	 * @return {Boolean}
	 */
 	adObj.prototype.timeTillExpiration = function() {
 		return this.ttl - this.timePassed();
 	}


 	/**
 	 * Called once a bid has won and adcode is placed on the page
 	 */
 	adObj.prototype.onBidWon = function() {
 		var bidderAdapterName = bidderToAdapterName(this.bidder);
 		if (
 			typeof bidAdapters[bidderAdapterName] !== 'undefined' &&
 			typeof bidAdapters[bidderAdapterName].onBidWon !== 'undefined'
			) {
        	bidAdapters[bidderAdapterName].onBidWon(this);
        }
 	}

 	return adObj;

})();

    	// Device object
	var deviceObj = function() {

		this.browser       = '',
		this.browser_group = '',
		this.device_type   = '',
		this.os            = '',
		this.os_group      = '';

		/**
	     * Use uaParser to detect browser and device.
	     * Implements overwrite(s) to consolidate
	     * @return void
	     */
		this.init = function() {

			// mappings to combine sub-categories
	    	var uaParserMappings = {
	    		'browser': {
	    			'IE':              'Explorer',
	    			'Chrome Headless': 'Chrome',
	    			'Chrome WebView':  'Chrome'
	    		},
	    		'device': {
	    			'console':         'desktop'
	    		}
	    	}

	    	if(typeof UAParser !== 'undefined') {
	    		(function() {
	    			var result = (new UAParser()).getResult();

	                // get browser and version from uaParser
	    			this.browser = result.browser.name;
	    			if(result.browser.version) {
	    				this.browser += ' ' + result.browser.version;
	    			}

	                // get browser name from uaParser
	    			this.browser_group = result.browser.name;

	    			// check for mapping for this browser name
	    			if (typeof uaParserMappings.browser !== 'undefined'
	    				&& typeof uaParserMappings.browser[this.browser_group] !== 'undefined') {
	    				this.browser_group = uaParserMappings.browser[this.browser_group];
	    			}

	                // get device type from uaParser
	    			this.device_type = result.device.type;
	    			if(!this.device_type) {
	    				this.device_type = 'desktop';
	    			}

	    			// check for mapping for this device type
	    			if (typeof uaParserMappings.device !== 'undefined'
	    				&& typeof uaParserMappings.device[this.device_type] !== 'undefined') {
	    				this.device_type = uaParserMappings.device[this.device_type];
	    			}

	                // get os and version from uaParser
	    			this.os = result.os.name;
	    			if(result.os.version) {
	    				this.os += ' ' + result.os.version;
	    			}
	                // get os name from uaParser
	    			this.os_group  = result.os.name;
	    		}.bind(this))();
	    	}

	    	window.device = {
	    		'browser':       this.browser,
				'browser_group': this.browser_group,
				'device_type':   this.device_type,
				'os':            this.os,
				'os_group':      this.os_group
	    	}

		}

		/**
		 * Check if device is mobile
		 */ 
		this.isMobile = function() {
			return (this.device_type == 'mobile') ? true : false;
		}

		this.init();
	}

    var userIds = (function() {

	// Constants
	var COOKIE        = 'cookie';
	var LOCAL_STORAGE = 'localstorage';
	
	// Prebid optout
	PBJS_USER_ID_OPTOUT_NAME = '_pbjs_id_optout';

	// Global Variables
	var identityAdapters  = {};
	var validStorageTypes = [];
	var eidsArray         = [];
	var uidsObj           = {};
	var userIdData        = {};

	var done_matching    = false;
	var timeout          = 50;
	var timeout_handle   = null;
	var auctionCallback  = null;

	var pendingCallbacks = 0;

	/**
	 * test browser support for storage config types (local storage or cookie), initializes identityAdapters but consentManagement is required,
	 * so a callback is added to fire after the consentManagement module.
	 */
	function init() {

		// list of browser enabled storage types
		validStorageTypes = [
			ProperMedia.utils.localStorageIsEnabled() ? LOCAL_STORAGE : null,
			ProperMedia.utils.cookiesAreEnabled() ? COOKIE : null
		].filter(function(i) { return i !== null; });

		// exit immediately if opt out cookie or local storage keys exists.
		if (validStorageTypes.indexOf(COOKIE) !== -1 && getCookie(PBJS_USER_ID_OPTOUT_NAME)) {
			properLog.mylog('userIds - opt-out cookie found, exit module');
			return;
		}
		if (validStorageTypes.indexOf(LOCAL_STORAGE) !== -1 && ProperMedia.utils.getDataFromLocalStorage(PBJS_USER_ID_OPTOUT_NAME)) {
			properLog.mylog('userIds - opt-out localStorage found, exit module');
			return;
		}

		getUserIdData();
		
		var userIds = properOps.userIds;
    	if (userIds && userIds.identityAdapters && userIds.identityAdapters.length) {
			updateIdentityAdapters();
		} else {
			matchingDone();
		}
	}


	function getUserIdData() {
		// Get User Data if passed through properSpecialOps
        if( ProperMedia.utils.deepAccess(properSpecialOps, 'userIdData') ) {
            userIdData = ProperMedia.utils.deepAccess(properSpecialOps, 'userIdData');
        // Get User Data if passed through a cookie
        } else if( ProperMedia.utils.getCookieValue('properUserIdData') ) {
            userIdData = ProperMedia.utils.getCookieValue('properUserIdData');
        }
        if(userIdData && ProperMedia.utils.isStr(userIdData)) {
        	userIdData = ProperMedia.utils.safeJsonParse(userIdData);
        }
	}

	/**
	 * update identityAdapters by validating against existing configs and storage types
	 */
	function updateIdentityAdapters() {
		var configs = ProperMedia.utils.deepAccess(properOps, 'userIds.identityAdapters') || [];
		if (!configs.length) {
			return;
		}

		for (var i = 0; i < configs.length; i++) {
			var config = configs[i];
			if(config.name && userIdAdapters[config.name]) {
				var identityAdapter = userIdAdapters[config.name];
				if(ProperMedia.utils.isFn(identityAdapter.initialize)) {
					identityAdapter.initialize(userIdData);
				}
				if(config.config && ProperMedia.utils.isPlainObject(config.config)) {
					ProperMedia.utils.mergeObject(identityAdapter.config, config.config);
				}
				if(config.storage && ProperMedia.utils.isPlainObject(config.storage)) {
					ProperMedia.utils.mergeObject(identityAdapter.storage, config.storage);	
				}
				if(identityAdapter.config.enabled) {
					identityAdapters[config.name] = userIdAdapters[config.name];
				}
			} else {
				properLog.mylog('Coudln\'t find identityAdapter with name: ' + config.name);
			}
		}

		if(Object.keys(identityAdapters).length > 0) {
			// GDPR has returned
        	consentManager.ready(
            	function() {
            		Object.keys(identityAdapters).forEach(function(name) {
            			getIdentityAdapterValue(identityAdapters[name]);
            		});
            		addTimeout();
            		processIdentityAdapterCallbacks();
            	}
        	)
		} else {
			matchingDone();
		}
	}

	function getIdentityAdapterValue(identityAdapter) {
		if(identityAdapter.storage) {
			var response;
			var storage  = identityAdapter.storage;
			var storedId = getStoredValue(storage, undefined);

		    var refreshNeeded = false;
		    if (typeof storage.refreshInSeconds === 'number') {
				var storedDate = new Date(getStoredValue(storage, 'last'));
				refreshNeeded = storedDate && (Date.now() - storedDate.getTime() > storage.refreshInSeconds * 1000);
		    }

		    if (!storedId || refreshNeeded) {
				// No id previously saved, or a refresh is needed, or consent has changed. Request a new id from the identityAdapter.
				response = identityAdapter.getId(storedId);
			} else if (typeof identityAdapter.extendId === 'function') {
				// If the id exists already, give identityAdapter a chance to decide additional actions that need to be taken
				response = identityAdapter.extendId(storedId);
			}

			if (ProperMedia.utils.isPlainObject(response)) {
				if (response.id) {
					// A getId/extendId result assumed to be valid user id data, which should be saved to users local storage or cookies
					setStoredValue(storage, response.id);
					storedId = response.id;
				}

				if (typeof response.callback === 'function') {
					// Save async callback to be invoked after auction
					identityAdapter.callback = response.callback;
					pendingCallbacks++;
				}
			}

			if (storedId) {
				// cache decoded value (this is copied to every adUnit bid)
				identityAdapter.idObj = identityAdapter.decode(storedId);
		    }
		} else if (identityAdapter.config.value) {
			// cache decoded value (this is copied to every adUnit bid)
			identityAdapter.idObj = identityAdapter.config.value;
		} else {
			var response = identityAdapter.getId();
			if (ProperMedia.utils.isPlainObject(response)) {
				if (typeof response.callback === 'function') { 
					identityAdapter.callback = response.callback; 
					pendingCallbacks++;
				}
				if (response.id) { 
					identityAdapter.idObj = identityAdapter.decode(response.id); 
				}
			}
		}
	}


	function processIdentityAdapterCallbacks() {
		if(pendingCallbacks > 0) {
			Object.keys(identityAdapters).forEach(function (name) {
				var identityAdapter = identityAdapters[name];
				if(ProperMedia.utils.isFn(identityAdapter.callback)) {
					identityAdapter.callback(function callbackCompleted(idObj) {
						// if valid, id data should be saved to cookie/html storage
						if (idObj) {
							if (identityAdapter.storage) {
								setStoredValue(identityAdapter.storage, idObj);
							}
							// cache decoded value (this is copied to every adUnit bid)
							identityAdapter.idObj = identityAdapter.decode(idObj);
						} else {
							properLog.mylog('UserID: '+ identityAdapter.name + ' - request id responded with an empty value');
						}
						pendingCallbacks--;
						if(pendingCallbacks == 0) {
							matchingDone();
						}
					});

					// clear callback, this prop is used to test if all identityAdapter callbacks are complete below
					identityAdapter.callback = undefined;
				}
			});
		} else {
			matchingDone();
		}
	}


	/**
	 * @param {identityAdaptersStorage} storage
	 * @param {String|undefined} key optional key of the value
	 * @returns {string}
	 */
	function getStoredValue(storage, key) {
		var storedKey = key ? storage.name + '_' + key : storage.name;
		var storedValue;
		try {
			if (storage.type === COOKIE) {
				storedValue = getCookie(storedKey);
			} else if (storage.type === LOCAL_STORAGE) {
				var storedValueExp = ProperMedia.utils.getDataFromLocalStorage(storage.name + '_exp');
				// empty string means no expiration set
				if (storedValueExp === '') {
					storedValue = ProperMedia.utils.getDataFromLocalStorage(storedKey);
				} else if (storedValueExp) {
					if ((new Date(storedValueExp)).getTime() - Date.now() > 0) {
						storedValue = decodeURIComponent(ProperMedia.utils.getDataFromLocalStorage(storedKey));
					}
				}
			}
			// support storing a string or a stringified object
			if (typeof storedValue === 'string' && storedValue.charAt(0) === '{') {
				storedValue = ProperMedia.utils.safeJsonParse(storedValue);
			}
		} catch (e) {
			properLog.mylog(e);
		}
		return storedValue;
	}


	/**
	 * @param {identityAdapterContainer} identityAdapter
	 * @param {(Object|string)} value
	 */
	function setStoredValue(storage, value) {
		try {
			var valueStr = ProperMedia.utils.isPlainObject(value) ? JSON.stringify(value) : value;
			var expiresStr = (new Date(Date.now() + (storage.expires * (60 * 60 * 24 * 1000)))).toUTCString();
			if (storage.type === COOKIE) {
				setCookie(storage.name, valueStr, expiresStr, 'Lax', null);
				if (typeof storage.refreshInSeconds === 'number') {
					setCookie(storage.name + '_last', new Date().toUTCString(), expiresStr, 'Lax', null);
				}
			} else if (storage.type === LOCAL_STORAGE) {
				ProperMedia.utils.setDataInLocalStorage(storage.name + '_exp', expiresStr);
				ProperMedia.utils.setDataInLocalStorage(storage.name, encodeURIComponent(valueStr));
				if (typeof storage.refreshInSeconds === 'number') {
					ProperMedia.utils.setDataInLocalStorage(storage.name + '_last', new Date().toUTCString());
				}
			}
		} catch (error) {
			properLog.mylog(error);
		}
	}

	// This function will generate eids array
	function createUidObjAndEidsArray() {
		Object.keys(identityAdapters).forEach(function(name) {
			var identityAdapter = identityAdapters[name];
			if(ProperMedia.utils.isPlainObject(identityAdapter.idObj) && Object.keys(identityAdapter.idObj).length) {
				var eid = createEidObject(identityAdapter);
				if (eid) {
					eidsArray.push(eid);
				}

				Object.keys(identityAdapter.idObj).forEach(function (key) {
					uidsObj[key] = identityAdapter.idObj[key];
				});

			}
		});
	}

	// this function will create an eid object for the given UserId sub-module
	function createEidObject(identityAdapter) {
		var eid = {};
		eid.source = identityAdapter['source'] || '';
		var value = ProperMedia.utils.isFn(identityAdapter['getValue']) ? identityAdapter['getValue'](identityAdapter.idObj) : identityAdapter.idObj;
		if (ProperMedia.utils.isStr(value)) {
			var uid = { 
				"id": value, 
				"atype": identityAdapter['atype'] || 1
			};
			// getUidExt
			if (ProperMedia.utils.isFn(identityAdapter['getUidExt'])) {
				var uidExt = identityAdapter['getUidExt'](identityAdapter.idObj);
				if (uidExt) {
					uid.ext = uidExt;
				}
			}
			eid.uids = [uid];
			// getEidExt
			if (ProperMedia.utils.isFn(identityAdapter['getEidExt'])) {
				var eidExt = identityAdapter['getEidExt'](identityAdapter.idObj);
				if (eidExt) {
					eid.ext = eidExt;
				}
			}
			return eid;
		}
		return null;
	}

	/**
	 * @param {string} key
	 * @param {string} value
	 * @param {string} [expires='']
	 * @param {string} [sameSite='/']
	 * @param {string} [domain] domain (e.g., 'example.com' or 'subdomain.example.com').
	 * If not specified, defaults to the host portion of the current document location.
	 * If a domain is specified, subdomains are always included.
	 * Domain must match the domain of the JavaScript origin. Setting cookies to foreign domains will be silently ignored.
	 */
	var setCookie = function (key, value, expires, sameSite, domain) {
		var domainPortion = (domain && domain !== '') ? ' ;domain=' + encodeURIComponent(domain) : '';
		var expiresPortion = (expires && expires !== '') ? ' ;expires=' + expires : '';
		var isNone = (sameSite != null && sameSite.toLowerCase() == 'none')
		var secure = (isNone) ? '; Secure' : '';
		document.cookie = key + '=' + encodeURIComponent(value) + expiresPortion + ';path=/' + domainPortion + (sameSite ? '; SameSite=' + sameSite : '') + secure;
	};

	/**
	 * @param {string} name
	 * @returns {(string|null)}
	 */
	var getCookie = function(name, done) {
		var m = window.document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]*)\\s*(;|$)');
		return m ? decodeURIComponent(m[2]) : null;
	};

	// add timeout
	function addTimeout() {
 		timeout_handle = properSetTimeout.setTimeout(matchingDone, timeout);
 	}

 	// reset timeout
 	function resetTimeout() {
 		clearTimeout(timeout_handle);
 		timeout_handle = null;
 	}

 	// We are done matching
	function matchingDone() {

		if(done_matching == 1) return;
		done_matching = 1;

		// Create EIds
		createUidObjAndEidsArray();

		// Check for callback function to send s2s bids
		if(ProperMedia.utils.isFn(auctionCallback)) {
			auctionCallback();
			auctionCallback = null;
		}

		properLog.mylog('UserId Matching Done');

		// turning off timeout
		resetTimeout();
	}


	function isDoneMatching() {
		return !!done_matching;
	}

	function setCallback(callbackFn) {
		auctionCallback = callbackFn;
	}

	function getEidsArray() {
		return ProperMedia.utils.deepCopy(eidsArray || []);
	}

	function getUIdsObj() {
		return ProperMedia.utils.deepCopy(uidsObj || {});
	}

	function getUserIdData() {
		return ProperMedia.utils.deepCopy(userIdData || {});
	}

	return {
		init: init,
		getCookie: getCookie,
		setCookie: setCookie,
		getUIdsObj: getUIdsObj,
		setCallback: setCallback,
		getEidsArray: getEidsArray,
		getUserIdData: getUserIdData,
		isDoneMatching: isDoneMatching
	};
	
})();

    	// user object
	var userObj = function() {
		this.lang    = '',              // users language
		this.tzone   = '',              // users timezone
		this.member  = 'no',            // user is a memeber
		this.facebook_user = 'unknown'; // User is logged into facebook
		this.pubcid  = '';              // Publisher Common ID

		this.init = function() {
			this.tzone  = new Date().getTimezoneOffset();
        	this.lang   = navigator.language || navigator.browserLanguage || navigator.userLanguage || navigator.systemLanguage;
        	this.pubcid = ProperMedia.utils.deepAccess(userIdAdapters, 'pubCommonId.idObj._pubcid') || ProperMedia.utils.generateUUID();
		}

		this.stickyFreqCapHandler = {

			setStickyClosedCookie: function() {
				var date = new Date();
				date.setHours(23,59,59,0); // Expires at midnight
				document.cookie = "properStickyClosed=true; expires="+date.toGMTString()+"; path=/; SameSite=Lax;";
			},

			getStickyClosedCookie: function() {
				return ProperMedia.utils.getCookieValue('properStickyClosed') == "true" ? true : false;
			},

			setStickyUnitImps: function(unitImpressions) {
				var date = new Date();
				date.setHours(23,59,59,0); // Expires at midnight
				document.cookie = "properStickyUnitImps="+parseInt(unitImpressions)+"; expires="+date.toGMTString()+"; path=/; SameSite=Lax;";
			},

			getStickyUnitImps: function() {
				return parseInt(ProperMedia.utils.getCookieValue('properStickyUnitImps')) != NaN ? parseInt(ProperMedia.utils.getCookieValue('properStickyUnitImps')) : 0;
			},

			incrementStickyUnitImps: function() {
				var unitImpressions = this.getStickyUnitImps() || 0;
				unitImpressions += 1;
				this.setStickyUnitImps(unitImpressions);
			},

			expireCookie: function(cookieName) {
				document.cookie = cookieName+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax;";
			},
		}
	}

    	// Log object
	var logObj = function() {

		this.log_lines       = {},   // list of events
		this.autoplay_html   = {},   // holds html from killed auto-play video ad
		this.rogue_data      = [],   // holds data of ads displayed to send back the tracker (this one will be cleared in between tracker calls to save)
		this.saved_data      = {},   // holds data for ad report tool
		this.bid_data        = {},   // holds bid data
		this.ad_info         = {},   // holds creative and line item ID's for each ad displayed
		this.rogue_timeout   = null, // holds timeout function in case tracker take too long
		this.tracker_timeout = null, // holds timeout function for reporting bad ads
		this.tracker_wait	 = 250;  // number of ms to wait for more bids before sending tracking request

		// setup the page data
		this.init_bid_data = function() {

			// Send out pending bids
			if(
				ProperMedia.utils.deepAccess(this, 'bid_data.ad_slots') && 
				Object.keys(this.bid_data.ad_slots).length > 0
			) {
				this.proper_tracker();
			}

			//custom settings
			if(properOps.site_name=="greatergood_ctg" || properOps.site_name=="historyinorbit" || properOps.site_name=="groovyhistory") this.tracker_wait=100;

			this.bid_data = {
				website           : ProperMedia.utils.validateValue(properOps.site_name, {'type':'string','default_val':'unknown','max_len':40}),
				url               : ProperMedia.utils.validateValue(properPage.url, {'type':'string','max_len':255}),
				url_path          : ProperMedia.utils.validateValue(properPage.path, {'type':'string','max_len':150}),
				os                : ProperMedia.utils.validateValue(properDevice.os_group, {'type':'string','max_len':30}),
				browser           : ProperMedia.utils.validateValue(properDevice.browser_group, {'type':'string','max_len':30}),
				device            : ProperMedia.utils.validateValue(properDevice.device_type, {'type':'string','max_len':10}),
				use_ssl           : ProperMedia.utils.validateValue(properPage.use_ssl, {'type':'boolean'}),
				is_mobile         : ProperMedia.utils.validateValue(properDevice.device_type == 'mobile', {'type':'boolean'}),
				is_isolated       : ProperMedia.utils.validateValue(properPage.isolated, {'type':'boolean'}),
				session_depth     : ProperMedia.utils.validateValue(properSession.sessionData.depth, {'type':'number'}),
				session_guid      : ProperMedia.utils.validateValue(properSession.sessionData.uuid, {'type':'string'}),
				resolution_width  : ProperMedia.utils.validateValue(properPage.width, {'type':'number','max':99999}),
			    resolution_height : ProperMedia.utils.validateValue(properPage.height, {'type':'number','max':99999}),
			    rtp_file_version  : ProperMedia.utils.validateValue(properOps.rtp_file_version, {'type':'number'}),
			    referrer          : ProperMedia.utils.validateValue(properSession.sessionData.referrer, {'type':'string','max_len':255}),
			    utm_source        : ProperMedia.utils.validateValue(properSession.sessionData.utm_source, {'type':'string','max_len':65}),
			    utm_campaign      : ProperMedia.utils.validateValue(properSession.sessionData.utm_campaign, {'type':'string','max_len':255}),
			    utm_medium	      : ProperMedia.utils.validateValue(properSession.sessionData.utm_medium, {'type':'string','max_len':50}),
			    utm_term	      : ProperMedia.utils.validateValue(properSession.sessionData.utm_term, {'type':'string','max_len':50}),
				utm_content	      : ProperMedia.utils.validateValue(properSession.sessionData.utm_content, {'type':'string','max_len':50}),
			    page_guid         : ProperMedia.utils.validateValue(properPage.uuid, {'type':'string'}),
			    tags              : (typeof properOps.tags != 'undefined') ? properOps.tags.join(",") : '',
			    ad_slots          : {}
			}

			// log pageview
			this.send_pageview_pixel();
		}

		// Send pixel signifying a page load
		this.send_pageview_pixel = function() {

			// Send pixel signifying a page load
			this.bid_data.ad_slots['pageview_pixel'] = {
				slot_name         : 'pageview_pixel',
                bidder            : 'pageview_pixel',
                price             : 0,
                gross             : 0,
                size              : '0x0',
                refresh_cnt       : 0,
                line_item_id      : '',
                response_ms       : 0,
                auction_duration  : 0,
                precent_bids_ready: 0,
                tag_id            : ''
			}
			this.proper_tracker();
		}

		this.log_bid = function(ad) {
			this.mylog(ad.bidder + " (" + ad.tag_id + "@" + ad.size + ") = " + ad.price);
	    }

	    this.mylog = function(content, id) {

	        id = id || "proper"; //GET variable to check for

	        //save log
	        this.log_lines[id] = ProperMedia.utils.checkData(this.log_lines[id]);
	        this.log_lines[id].push(content);

	        //print to screen automatically
	        //logger.enableLogger();
	        if(properPage.get_vars[id] == 1 || (id == "proper" && ProperMedia.utils.getCookieValue('proper_log') == 1) ) console.log(content);
	        //logger.disableLogger();
	    }

	    // log autoplay data
	    this.rogue_tracker = function() {

			// clear timeout
			clearTimeout(this.rogue_timeout);
			this.rogue_timeout = null;

			// send bidder data for ads that displayed
			if(this.rogue_data.length > 0) {

				// clear data before sending request in case more comes in
				var post_data = this.rogue_data;
				this.rogue_data = [];

				var log = this;

				// send request
				$.ajax({
					url: 'https://proper.io/ajax/tracker.php?rogue=1',
					method: "POST",
					data: "data=" + JSON.stringify(post_data),
					headers: {"Content-type": "application/x-www-form-urlencoded"},
					success: function(resp) {
						log.mylog("autoplay ads tracked! x"+post_data.length);
					}
				});
			}
		}

		this.proper_tracker = function() {
			var log       = this;
			var post_data = {};

			//clear timeout
			clearTimeout(this.tracker_timeout);
			this.tracker_timeout = null;

			if (Object.keys(this.bid_data.ad_slots).length > 0) {

				//clear data before sending request in case more comes in
				post_data = JSON.stringify(this.bid_data);

				// clearing data after is it sent
				this.bid_data.ad_slots = {};

				// Dont log test bids
				if(!properOps.testing_mode.ids) {
					// send request
					$.ajax({
						url: 'https://bids.proper.io/api/bidding',
						method: "POST",
						withCredentials: false,
						data: post_data,
						success: function(resp) {
							log.mylog("bids tracked!");
						},
						error: function(e) {
							log.mylog("error tracking bid data");
						}
					});
				} else {
					log.mylog("Not logging winnig bids. Test IDs are being used.");
				}
			}

		}

		this.track_rogue = function (slot, rogue_type) {

	        // check if ad was from a bidder or dfp
	        var ad = {};
	        if(typeof slot.winning_ad.displayed !== 'undefined' && slot.winning_ad.displayed == 1) {
	            ad = slot.winning_ad;
	        } else {
	            ad = { "bidder": "static_tag", "price" : 0, "size": "", "adcode": "[DFP STATIC TAG]" }; //static tag
	        }

	        //log results
	        this.mylog('rogue '+rogue_type+' detected (slot='+slot.name+", bidder="+ad.bidder+")");

	        //track data after 500ms (wait for more ad units to finish)
	        this.rogue_data.push(
	            {
	                "rogue_type"   : rogue_type,
	                "bidder"       : ad.bidder,
	                "cpm"          : ad.price,
	                "size"         : ad.size,
	                "slot"         : slot.dfp_name,
	                "website"      : properOps.site_name,
	                "device"       : properDevice.device_type,
	                "os"           : properDevice.os_group,
	                "browser"      : properDevice.browser_group,
	                "is_mobile"    : properDevice.isMobile(),
	                "tag_id"       : ad.tag_id,
	                "ad_details"   : ad.ad_details,
	                "split_version": properOps.rtp_file_version
	            }
	        );
	        clearTimeout(this.rogue_timeout);
	        this.rogue_timeout = null;
	        this.rogue_timeout = properSetTimeout.setTimeout.call(
	        	this,
	        	function() {
	        		this.rogue_tracker();
	        	},
	        	this.tracker_wait
        	);

	        // Get next best bid
	        if(slot.getWinningBid()) {
	            showWinningAd(slot);
	            return;
	        }
	    }


	    /**
	     * Proper debug log
	     */
	    this.proper_log = function(id) {

	        id = id || "proper";

	        //output page object
	        if(id == "page") {
	            console.log(properPage);
	            return;
	        }

	        function getResponses() {

	            var output = [];

	            var slots = properPage.slots;

	            Object.keys(properPage.slots).forEach(function(slot_type) {
    				Object.keys(properPage.slots[slot_type]).forEach(function(slot_name) {
		                var slot = slots[slot_type][slot_name];
		                if(slot instanceof slotObj) {
		                    for (var ad_id = 0; ad_id < slot.ads.length; ad_id++) {
		                        var response = slot.ads[ad_id];
		                        var row = adObjToOutput(response);

		                        if(ProperMedia.utils.indexOfObjectInArray(output, row) === -1) {
		                            output.push(row);
		                        }
		                    }
		                }

		                if(slot.hasWinningBid()) {
		                    var row = adObjToOutput(slot.winning_ad);

		                    if(ProperMedia.utils.indexOfObjectInArray(output, row) === -1) {
		                        output.push(row);
		                    }
		                }
	                }, this);
	    		}, this);

	            return output;

	            function adObjToOutput(response) {
	                return {
	                    'slot_name'   : response.slot.name,
	                    'size'        : response.size,
	                    'bidder'      : response.bidder,
	                    'time'        : response.response_ms,
	                    'floor'       : response.floor,
	                    'cpm'         : response.price,
	                    'dfp_price'   : response.dfp_price,
	                    'gross'       : response.gross,
	                    'price'       : response.price,
	                    'tag_id'      : response.tag_id,
	                    'refresh_cnt' : response.slot.refresh.count,
	                    'displayed'   : response.displayed
	                };
	            }

	        }

	        //output bids table
	        if(id == "bid_table") {
	            var output = getResponses();

	            if (output.length) {
	                if (console.table) {
	                    console.table(output);
	                } else {
	                    for (var j = 0; j < output.length; j++) {
	                        console.log(output[j]);
	                    }
	                }
	            } else {
	                console.warn('No responses');
	            }
	            return;
	        }

	        //save bids table to csv
	        if(id == "bid_table_csv") {
	            var output = getResponses();

	            if (output.length) {
	                csv_output = "";

	                header_keys = Object.keys(output[0]);
	                for (var j = 0; j < header_keys.length; j++) {
	                    csv_output += '"' + header_keys[j] + '"' + (j < header_keys.length - 1 ? ',' : '');
	                }
	                for (var j = 0; j < output.length; j++) {
	                    csv_output += "\n" + '"' + ProperMedia.utils.objectValues(output[j]).join('","') + '"';
	                }

	                var element = document.createElement('a');
	                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv_output));
	                element.setAttribute('download', "proper_bid_table_" + document.location.hostname + ".csv"); //filename

	                element.style.display = 'none';
	                document.body.appendChild(element);

	                element.click();

	                document.body.removeChild(element);
	            } else {
	                console.warn('No responses');
	            }
	            return;
	        }

	        //turn on console
	        //logger.enableLogger();

	        //cookie check
	        if(id == "on") {

	            id = "proper";

	            //setup cookie to expire in 1 day
	            var date  = new Date();
	            var hours = 1; //expire in x hours
	            date.setTime(date.getTime()+(hours*60*60*1000));

	            document.cookie="proper_log=1; expires="+date.toGMTString()+"; path=/; SameSite=Lax;";
	            console.log("NOTICE: Turning on persistent logging. Run proper_log('off'); to turn off.");

	        } else if(id == "off") {

	            id = "proper";
	            console.log("NOTICE: Turning off persistent logging.");
	            document.cookie = "proper_log=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax;";
	            //logger.disableLogger();
                properPage.get_vars[id] = 0;
	            return false;
	        }

	        //output saved log for (proper, sovrn, brealtime, aol, etc.)
            for (var x = 0; x < properLog.log_lines[id].length; x++) {
                if(properLog.log_lines[id][x]) console.log(properLog.log_lines[id][x]);
                //turn on live console ouput for additional logs that come through after this
                properPage.get_vars[id] = 1;
            }

	        //turn off console
	        //logger.disableLogger();

	        return true;
	    }


	}

    	// Set Default Options (different for each website)
	var optionsObj = function() {
		
		this.rtp_file_version   = 0,
		this.dfp_per_slot       = 0,
		this.prebid_version     = '4.25.0',
		this.post_id            = '',
		this.tags               = ["unknown"],
		this.additional_domains =  [],
		this.site_name          = "",
		this.domain             = "",
		this.domain_protection  = 0,
		this.confiant           = 0,
		this.extra_css          = '',
		this.extra_js           = '',                                   
		this.dfp_id             = 5376056,
		this.google_advertiser  = 42904576,
		this.proper_advertiser  = 600883576,
		this.amazon_advertiser  = 455011336,  // No longer used?
		this.adsense_advertiser = 1349528536, // No longer used?
		this.report_ad_tool     = 0,
		this.testing_mode       = {
			enabled: false,
			bidder: false,
			ids: false
		},
		this.video_players      = {}, // List of video player objects
		this.ad_slots           = {},
		this.isolated_urls      = [],
		this.eb_endpoint        = 'https://eb.proper.io/s2s', // PROD "https://eb.proper.io/s2s", // STAGING: "https://eb-staging.proper.io/s2s", // LOCAL: "http://localhost:3534/s2s"
		this.usync_endpoint     = 'https://usync.proper.io/v1/usersync', // PROD "https://usync.proper.io/v1/usersync", // STAGING: "https://usync-staging.proper.io/v1/usersync", // LOCAL: "http://localhost:3534/v1/usersync"
		this.sandbox_iframe     = 1,  // serve in sandboxed iframe to stop redirects
		this.sandbox_options    = [   // what to allow in sandbox
			"allow-popups", 
			"allow-pointer-lock", 
			"allow-scripts", 
			"allow-same-origin"
		], 
		this.audience_pixels = {
			"enabled": false,
			"thresholds": []
		},
		this.native_sizes           = {
	        'native_horizontal': '1x1',
	        'native_vertical'  : '1x1',
	        'sticky_horizontal': '1x1'
    	},
		this.schain = {
		    "ver": "1.0",
		    "complete": 0,
		    "nodes": []
		},
		this.refresh = {                  // Default Refresh settings
			"desktop": {
			    "enabled" : 1,                  // Enable site wide refresh
			    "interval" : 60000,             // How long to wait to refresh 
			    "inview_interval" : 15000,      // How long a slot has to be viewable for before refreshing
			    "max" : 5,                      // Max Number of times to refresh a slot
			    "exclude_dfp" : 0               // Dont indlude DFP in refresh auction 
			},
			"mobile": {
				"enabled" : 1,                  // Enable site wide refresh
			    "interval" : 30000,             // How long to wait to refresh 
			    "inview_interval" : 15000,      // How long a slot has to be viewable for before refreshing
			    "max" : 5,                      // Max Number of times to refresh a slot
			    "exclude_dfp" : 0               // Dont indlude DFP in refresh auction 	
			}
		},
		this.floors = {
			"desktop": {
				"backup": 0.15, // Default Floor for desktop
	        	"sizes": {}     // Desktop specific size floors
			},
			"mobile": {
				"backup": 0.15, // Default Floor for desktop
	        	"sizes": {}     // Desktop specific size floors
			}
		},
		this.lazyload = {           // Lazyload settings
			"desktop": {
			    "enabled" : 1,            // Enable lazy-loading
				"fetchMarginPercent": 0,  // Percent of viewport height for fetch zone
				"renderMarginPercent": 0  // Percent of viewport height for render zone
			},
			"mobile": {
				"enabled" : 1,            // Enable lazy-loading
				"fetchMarginPercent": 0,  // Percent of viewport height for fetch zone
				"renderMarginPercent": 0  // Percent of viewport height for render zone	
			}
		},
		this.userIds = {
            "identityAdapters": [
                {
                    "name": "id5Id",
                    "config": {
                        "enabled": true
                    },
                    "storage": {}
                },
                {
                    "name": "identityLink",
                    "config": {
                        "enabled": true
                    },
                    "storage": {}
                },
                {
                    "name": "pubCommonId",
                    "config": {
                        "enabled": true
                    },
                    "storage": {}
                },
                {
                    "name": "fabrickId",
                    "config": {
                        "enabled": false,
                        "apiKey": ""
                    },
                    "storage": {}
                }
            ]
        },
		this.bidders = {
			'header': {},
			's2s': {}
		},
		this.bidder_info = {			
			"adaptmx_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'display',
				"bid_grouping": 'page',
				"adapter_name": 's2s'
	    	},
	    	"adaptmx_instream_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'video',
	    		"video_type"  : 'instream',
				"bid_grouping": 'page',
				"adapter_name": 's2s',
				"default_bid_ttl": 300000
	    	},
	    	"adaptmx_outstream_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'video',
	    		"video_type"  : 'outstream',
				"bid_grouping": 'page',
				"adapter_name": 's2s',
				"default_bid_ttl": 300000
	    	},
	    	"pubmatic_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'display',
				"bid_grouping": 'slot',
				"adapter_name": 's2s',
				"default_bid_ttl": 60000
	    	},
	    	"sovrn_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'display',
				"bid_grouping": 'page',
				"adapter_name": 's2s'
	    	},
            "sonobi_s2s" : {
            	"rev_share"   : 1,
            	"demand_type" : 'display',
            	"bid_grouping": 'slot',
            	"adapter_name": 's2s'
            },
	    	"gumgum_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'display',
				"bid_grouping": 'page',
				"adapter_name": 's2s',
		        "native_sizes": {
		            "desktop": {
		                '1x1': 'sticky_horizontal'
		            },
		            "mobile": {
		                '1x1': 'sticky_horizontal'
		            }
		        }
	    	},
	    	"mediagrid_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'display',
				"bid_grouping": 'page',
				"adapter_name": 's2s'
	    	},
	    	"verizon_media_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'display',
				"bid_grouping": 'slot',
				"adapter_name": 's2s'
	    	},
	    	"aol_instream_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'video',
	    		"video_type"  : 'instream',
				"bid_grouping": 'page',
				"adapter_name": 's2s'
	    	},
	    	"aol_outstream_s2s" : {
	    		"rev_share"   : 1,
	    		"demand_type" : 'video',
	    		"video_type"  : 'outstream',
				"bid_grouping": 'page',
				"adapter_name": 's2s'
	    	},
	    	"magnite_s2s" : {
				"rev_share"   : 1,
				"demand_type" : 'display',
				"bid_grouping": 'page',
				"adapter_name": 's2s'
			},
			"yieldmo_s2s" : {
				"rev_share"   : 1,
				"demand_type" : 'display',
				"bid_grouping": 'page',
				"adapter_name": 's2s'
			},
	    	"brealtime" : {
	    		"rev_share"   : 0.9,
	    		"demand_type" : 'display',
				"bid_grouping": 'page',
        		"default_bid_ttl": 300000,
        		"adapter_name": 'appnexus'
	    	},
	    	"districtm" : {
	    		"rev_share"   : 0.9,
	    		"demand_type" : 'display',
				"bid_grouping": 'page',
        		"default_bid_ttl": 300000,
        		"adapter_name": 'appnexus'
	    	},
	    	"shemedia" : {
	    		"rev_share"   : 0.5,
	    		"demand_type" : 'display',
				"bid_grouping": 'page',
        		"default_bid_ttl": 300000,
        		"adapter_name": 'rubicon'
	    	},
	    	"openx_pmp" : {
	    		"rev_share"   : 1,
				"bid_grouping": 'slot'
	    	},
	    	"triplelift_instream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'triplelift'
	    	},
	    	"undertone_instream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'undertone'
	    	},
	    	"undertone_outstream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'undertone'
	    	},
	    	"thirtythreeacross_instream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'instream',
				"bid_grouping"   : 'slot',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'thirtythreeacross'
	    	},
	    	"thirtythreeacross_outstream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'outstream',
				"bid_grouping"   : 'slot',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'thirtythreeacross'
	    	},
	    	"smart_adserver_instream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'smart_adserver'
			},
			"smart_adserver_outstream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'smart_adserver'
			},
			"rhythmone_instream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 600000,
				"adapter_name"   : 'rhythmone'
	    	},
	    	"rhythmone_outstream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 600000,
				"adapter_name"   : 'rhythmone'
	    	},
	    	"districtmdmx_instream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 'districtmdmx'
	    	},
	    	"districtmdmx_outstream" : {
	    		"rev_share"      : 1,
	    		"demand_type"    : 'video',
	    		"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 'districtmdmx'
	    	},
			"amazon_tam_instream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'a9'
			},
			"emx_instream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'emx'
      		},
      		"emx_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'emx'
      		},
			"sonobi_instream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'sonobi'
			},
			"sonobi_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'sonobi'
			},
			"appnexus_instream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 'appnexus'
			},
			"appnexus_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 'appnexus'
			},
			"ix_instream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 'ix'
			},
			"ix_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 'ix'
			},
			"magnite_instream_s2s" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 's2s'
			},
			"magnite_outstream_s2s" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 's2s'
			},
			"aol_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'aol_instream'
			},
			"beachfront_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'beachfront_instream'
			},
			"openx_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'openx_instream'
			},			
			"pubmatic_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'pubmatic_instream'
			},			
			"rubicon_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 'rubicon_instream'
			},
			"spotx_outstream" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 360000,
				"adapter_name"   : 'spotx_instream'
			},
			"beeswax_s2s" : {
  				"rev_share"      : 1,
				"demand_type"    : 'display',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 's2s'
			},
      		"beeswax_instream_s2s" : {
        		"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 's2s'
			},
      		"beeswax_outstream_s2s" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 's2s'
			},
			"xandr_s2s" : {
				"rev_share"      : 1,
				"demand_type"    : 'display',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 300000,
				"adapter_name"   : 's2s'
			},
			"xandr_instream_s2s" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'instream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 's2s'
			},
			"xandr_outstream_s2s" : {
				"rev_share"      : 1,
				"demand_type"    : 'video',
				"video_type"     : 'outstream',
				"bid_grouping"   : 'page',
				"default_bid_ttl": 3600000,
				"adapter_name"   : 's2s'
			}
		}
	}

    /** 
 * Ad Pool Object
 */
var adPoolObj = (function() {

	function adPoolObj() {
		this.initialized       = false, // If object variables have been initialized
		this.ads               = [],    // List of ads to choose from
		this.displayed_ads     = [],    // List of displayed ads
		this.auctions          = {},    // List of auctions
		this.finished_auctions = {},    // List of auctions that have finished
		this.total_auctions    = 0,     // Total number of auctions that have run
		this.auction_count     = 0,     // Count of auctions that have been run. Resets on spa pages
		this.vid_auction_count = 0,     // Count of video auctions that have been run. Resets on spa pages
		this.max_auctions      = 10,    // Maximum number of auctions per page
		this.last_auction_ts   = 0,     // Timestamp that last auction finished
		this.timeout_handle    = null,  // handle for max timeout
		this.timeout           = 58000, // Ms between auctions
		this.default_timeout   = 58000, // Ms between auctions
		this.min_timeout       = 3000,  // Minimum amount of time to wait between auctions. Rate limit SPA pages
		this.auction_rounds    = 1,     // Number of auction rounds 
		this.sizes             = {};    // Sizes defined at resolution

		this.init();
	}


	/**
	 * Init Ad Pool Object
	 */
	adPoolObj.prototype.init = function() {
		// Only send out bids on active tab
		// Listen for tab active event
		window.addEventListener('properActiveTab', (function(e) {
			this.setNextAuctionTimeout();
		}).bind(this));

		// Listen for tab inactive event
		window.addEventListener('properInactiveTab', (function(e) {
			// Log pending bids before unloading
        	properLog.proper_tracker();
        	// Pause timeout till next auction
			this.clearNextAuctionTimeout();
		}).bind(this));
	}


	/**
	 * Set sizes that are defined for browser resolution
	 * @return boolean
	 */
	adPoolObj.prototype.setSizes = function() {
		try {
			this.sizes = {};
			
			// Get sizes of slots on page
			Object.keys(properPage.slots).map(function(slot_type) {
				if(Object.keys(properPage.slots[slot_type]).length) {
					Object.keys(properPage.slots[slot_type]).map(function(slot_name) { 
						if(properPage.slots[slot_type][slot_name].sizes.length > 0) {
							for (var i = 0; i < properPage.slots[slot_type][slot_name].sizes.length; i++) {
								var size = properPage.slots[slot_type][slot_name].sizes[i];
								if(properSpecialOps.no_bid_limit) {
									this.sizes[size] = 99;
								} else {
									this.sizes[size] = (this.sizes[size]) ? this.sizes[size] + 1 : 1;
								}
							}
						}
					}, this);
				}
			}, this);

			if(!Object.keys(this.sizes).length) {
				var auction_sizes = ProperMedia.utils.deepAccess(properOps, 'auctions.resolution_size_map') || {};
				if(Object.keys(auction_sizes).length > 0) {
					Object.keys(auction_sizes).forEach(function(tier) {
						if(properPage.width >= tier) {
							auction_sizes[tier].forEach(function(size) {
								this.sizes[size] = 99;
							}, this);
						}
					}, this);
				}
			}
		} catch(e) {
			properLog.mylog('Error setting auction sizes');
			return false;
		}
		return true;
	}


	/** 
	 * Set max auction rounds
	 * @return boolean
	 */
	adPoolObj.prototype.setAuctionRounds = function() {
		try {
			var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
			this.auction_rounds = parseInt(ProperMedia.utils.deepAccess(properOps, 'auctions.' + device_type + '.rounds') || this.auction_rounds);
		} catch(e) {
			properLog.mylog('Error setting auction rounds');
			return false;
		}
		return true;
	}


	/** 
	 * Set max auctions
	 * @return boolean
	 */
	adPoolObj.prototype.setMaxAuctions = function() {
		try {
			var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
			this.max_auctions = parseInt(ProperMedia.utils.deepAccess(properOps, 'auctions.' + device_type + '.max') || this.max_auctions);
		} catch(e) {
			properLog.mylog('Error setting max auction');
			return false;
		}
		return true;
	}


	/** 
	 * Set default auction timeout by device
	 * @return boolean
	 */
	adPoolObj.prototype.setDefaultTimeout = function() {
		try {
			var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
			this.default_timeout = parseInt(ProperMedia.utils.deepAccess(properOps, 'auctions.' + device_type + '.timeout') || this.default_timeout);
		} catch(e) {
			properLog.mylog('Error setting auction default timeout');
			return false;
		}
		return true;
	}


	/**
	 * Check that max auctions hasn't been reached
	 */
	adPoolObj.prototype.checkMaxAuctionsReached = function() {
		return (this.auction_count < this.max_auctions) ? false : true;
	}

	/**
	 * @param {auctionObj} auction
	 */
	adPoolObj.prototype.startNewAuction = function() {

		if(!userIds.isDoneMatching()) {
        	properLog.mylog('Wait for UserId Matching To Finish.');
			userIds.setCallback(this.startNewAuction.bind(this));
			return false;
        }

		this.initialized = true;
		this.setSizes();
		this.setMaxAuctions();
		this.setAuctionRounds();
		this.setDefaultTimeout();
		this.clearNextAuctionTimeout();
		this.setNextAuctionTimeout();
	}

	/**
	 * @param {auctionObj} auction
	 */
	adPoolObj.prototype.startNewVideoAuction = function(video_type) {
		this.setSizes();
		this.sendVideoAuction(video_type);
		this.clearExpiredAds();
	}

	/**
	 * Send out auction
	 */
	adPoolObj.prototype.sendVideoAuction = function(video_type) {
		properLog.mylog('Starting New Video Auction');
		this.vid_auction_count++;
		// Create new auction
        var auction = new auctionObj(parseFloat(this.total_auctions + '.' + this.vid_auction_count), 'video', video_type);
        // Add auction to array
        this.auctions[auction.id] = auction;
        // Send out auction bids
        auction.sendBids();
        return true;
	}

	/**
	 * Send out auction
	 */
	adPoolObj.prototype.sendAuction = function() {
		if(this.checkMaxAuctionsReached()) { 
			properLog.mylog('Max Auctions reached: ' + this.max_auctions);
			return false;
		} else {
			properLog.mylog('Starting New Auction');
			// Increment Auction Count
			this.auction_count  += 1;
			this.total_auctions += 1;
			if(properPage.video_enabled) {
				this.vid_auction_count++;
			}
			// Create new auction
	        var auction = new auctionObj(this.total_auctions);
	        // Add auction to array
	        this.auctions[auction.id] = auction;
	        // Send out auction bids
	        auction.sendBids();
	        return true;
	    }
	}


	/**
	 * Auction has finished running
	 * @param {String} id - Id of auction that finished
	 */
	adPoolObj.prototype.auctionFinished = function(id) {
		if(this.auctions[id]) {
			// Proper Auction Finished
			var properAuctionDoneEvent = new Event('properAuctionDone');
			window.dispatchEvent(properAuctionDoneEvent);
			var tempObj = {};
			tempObj[id] = this.auctions[id];
			// Timestamp auction finished
			this.last_auction_ts = Date.now();
			// Move finished auction
			ProperMedia.utils.mergeObject(this.finished_auctions, tempObj);
			delete this.auctions[id];
			// Start a timer to queue the next auction
			this.setNextAuctionTimeout();
		}
	}


	/**
	 * @param {adObj} ads
	 */
	adPoolObj.prototype.addBidToPool = function(ad) {
		if(ad.price > 0) {
			var newAd = new adObj(ProperMedia.utils.deepCopy(ad));
			// Add to size pool
			this.ads.push(newAd);
			// sort ads on price
 			this.ads.sort(function(a, b) {
				return parseFloat(b.price) - parseFloat(a.price);
			});
		}
	}


	/**
	 * Get the highest bid that meets slot specifications
	 * @param {slotObj} slot
	 * @param {Array} ad_types
	 */
	adPoolObj.prototype.getWinningBid = function(slot, ad_types, video_type) {
		// Get slots possible sizes
		var sizes = slot.sizes;

		var ad_types = ad_types || ['display', 'video']

		if(this.ads.length > 0) {

			// Check that page and slot support video ads
			if(
				properPage.video_enabled === false ||
				!(slot.video_player instanceof videoPlayer)
			) {
				ad_types = ['display'];
			}

 			// Loop through ads
 			for(var i = 0; i < this.ads.length; i++) {

	 			// get ad with highest price
				var winning_ad = this.ads[i];

				// Check if bid has expired
				if(winning_ad.checkIfExpired()) {
					this.ads.splice(i,1).pop();
					continue;
				}

				// Check if winning ad had beed displayed before 
				if(winning_ad.displayed == 1) continue;
				// Get a specific type of ad
				if(ad_types.indexOf(winning_ad.type) == -1) continue;
				// Get the correct video type ad. Instream or Outstream
				if(winning_ad.type == 'video' && (!video_type || video_type !== winning_ad.video_type)) continue;
				// Check if winning ad size is in slots sizes 
				if(sizes.indexOf(winning_ad.size) == -1) continue;
				// Only refresh to ads the same size as the current sticky ad
				if(slot.sticky == 1 && slot.displayed == 1 && slot.refresh.count > 0 && slot.size !== winning_ad.size) continue;
				// Exclude advertisers on refresh
				if(slot.refresh.count > 0 && ProperMedia.utils.deepAccess(properOps, 'bidder_info.'+winning_ad.bidder+'.dont_refresh') == 1) continue;
				// get / set price floor
				var floor_price = (properOps.testing_mode.enabled) ? 0 : slot.getFloor(winning_ad.size);

				// Don't include ads that don't break price floor
				if( winning_ad.price >= floor_price) {
					// set winning ad
					slot.winning_ad = new adObj(ProperMedia.utils.deepCopy(winning_ad));
					// remove the winning ad from the ads array
					this.ads.splice(i,1).pop();
					break;
				}
			}
		}
	}


	/**
	 * Calculate time until next auction
	 */
	adPoolObj.prototype.calcTimeout = function() {
		// First page or first page of Single Page App with prefetch is enabled
		if(
			(
				this.total_auctions == 0 &&
				this.auction_count == 0
			) ||
			(
				this.total_auctions == 1 &&
				this.auction_count == 1 &&
				properPage.spa_settings.enabled &&
				properPage.spa_settings.prefetch
			)
		) {
			this.timeout = 0;
		// Rate Limit Single Page App
		} else if(
			this.auction_count == 0 &&
			this.total_auctions > 0
		) {
			this.timeout = (this.timeSinceLastAuction() < this.min_timeout) ? this.min_timeout : 0;
		} else {			
	    	this.timeout = Math.max(this.min_timeout, this.default_timeout);
		}
		this.timeout = this.timeout - this.timeSinceLastAuction();
	}


	/**
 	 * Check if auctions currently running and how much time is left
 	 */
 	adPoolObj.prototype.getTimeLeftOnRunningAuctions = function() { 		
 		var times = [];
 		try {
	 		if(Object.keys(this.auctions).length) {
	 			Object.keys(this.auctions).forEach(function(id) {
	 				var auction = this.auctions[id];
	 				var time = Math.max(0, auction.max_timeout - auction.auctionTimePassed());
	 				if(time > 0) {
	 					times.push(time);
	 				}
	 			}, this);
	 		}
	 	} catch(e) {
	 		console.log(e);
	 	}
 		return times;
    }


	/**
 	 * Set max time that auction can run
 	 */
 	adPoolObj.prototype.setNextAuctionTimeout = function() {
 		if(this.timeout_handle == null && !this.checkMaxAuctionsReached() && this.initialized) {
			this.calcTimeout();
			this.timeout_handle = properSetTimeout.setTimeout.call(
				this, 
				function() {
					this.clearNextAuctionTimeout();
					this.sendAuction();
					this.clearExpiredAds();
				},
				Math.max(0, this.timeout)
			);
		}
    }


    /** 
     * Reset max timeout for auction
     */
 	adPoolObj.prototype.clearNextAuctionTimeout = function() {
 		clearTimeout(this.timeout_handle);
 		this.timeout_handle = null;
 	}


 	/**
 	 * Calculate time since Auction Finished
 	 */
	adPoolObj.prototype.timeSinceLastAuction = function() {
		if (this.last_auction_ts == 0) return 0;
		return Date.now() - this.last_auction_ts;
	}


	/**
	 * Get rid of expired ads
	 */
	adPoolObj.prototype.clearExpiredAds = function() {
		if(this.ads.length > 0) {
 			// Loop through ads
 			for(var i = 0; i < this.ads.length; i++) {
 				// Check if bid has expired
				if(this.ads[i].checkIfExpired()) {
					// Remove ad and decrement loop index to compensate
					this.ads.splice(i--, 1);
				}
 			}
 		}
	}


	/**
	 * Clears all saved ads 
	 */
	adPoolObj.prototype.clearCachedAds = function() {
		properLog.mylog('Clearing Cached Ads');
		this.ads = [];
		this.displayedAds = [];
	}

	return adPoolObj;
})();

    /** 
 * Auction Object
 */
var auctionObj = (function(auction_num) {

	function auctionObj(auction_num, demand_type, video_type) {
		this.id                 = ProperMedia.utils.makeid(5), // Unique ID for auction
		this.requests_sent      = 0,                           // Number of network requests sent
		this.bids               = {},                          // Bid Objects
		this.bids_sent_finished = false,                       // Finished sending out bids
		this.bids_sent          = 0,                           // Number of bids sent
		this.bids_returned      = 0,                           // Number of bids returned
		this.bids_started_ts    = 0,                           // Timestamp when auction was started
		this.bids_done_ts       = 0,                           // Timestamp when auction finished
		this.auction_bidders    = [],                          // Bideders in auction and data to send out 
		this.max_timeout        = 1500,                        // Max Timeout to stop waiting for bids to come back
		this.max_timeout_handle = null,                        // Handler for max timeout
		this.auction_num        = auction_num,                 // Auction number
		this.demand_type        = demand_type || null          // Used to limit to just display or video demand partners
		this.video_type         = video_type || null           // Used to limit to just instream or outstream video 
	}

	/**
	 * Send bid requests
	 */
	auctionObj.prototype.sendBids = function() {

        if(checkKillAllAds()) {
            return false;
        }

		// start max timeout to send DFP request
    	this.setMaxAuctionTimeout();
    	// Log bids started to be sent
		this.bids_started_ts = ProperMedia.utils.getTimestampMs();
		// Send s2s bidders
		this.sendS2SBidders();
		// Send header bidders
		this.sendHeaderBidders();
		// Finished sending out bids
		this.bids_sent_finished = true;
	}

	/**
	 * Send S2S. I.e.: interact with S2S as a client.
     * Send out as single request which includes all S2S bidders.
	 */
	auctionObj.prototype.sendS2SBidders = function() {

		// Check if cookie matching is done
		if(!cookieMatching.done_matching) {
			properLog.mylog('Wait for S2S Cookie Matching To Finish.');
			cookieMatching.callback = this.sendS2SBidders.bind(this);
			return;
		}

		// Get bidders in auction
        this.getAuctionBidders('s2s');

		// Check that there are bidders enabled in auction
		if(this.auction_bidders.length > 0) {

            var tagIds = {};
            var device = properDevice.isMobile() ? 'mobile' : 'desktop';

            // loop through enabled S2S bidders and load tagIds list
            this.auction_bidders.forEach(function(bidderS2S){
            	var bidderDataS2S = ProperMedia.utils.deepAccess(properOps, 'bidders.s2s.' + bidderS2S +  '.tag_ids.' + device) || false;

            	if(!bidderDataS2S || bidderDataS2S.length == 0) {
        			return false;
        		}

        		// Site ID
        		var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.s2s.' + bidderS2S + '.site_id') || '';
            	// Get group of tag ids
            	var auction_round = parseInt(properAdPool.auction_count - 1) % parseInt(properAdPool.auction_rounds);
        		var tag_ids = Object.filter((bidderDataS2S[auction_round] || {}), function(size) {
        			return typeof properAdPool.sizes[size] !== 'undefined' && bidderDataS2S[auction_round][size].length > 0;
        		});

        		for (var size in tag_ids) {
        			var bid_limit = properAdPool.sizes[size];
        			tag_ids[size].splice(bid_limit, (tag_ids[size].length - bid_limit));
        		}

        		// Bidder floors
        		var bidder_floors = ProperMedia.utils.deepAccess(properOps, 'bidders.s2s' + '.' + bidderS2S + '.floors.' + device) || {};
        		
        		if(Object.keys(tag_ids).length > 0) {
	                tagIds[bidderS2S] = {
	                    'tag_ids': tag_ids,
	                    'site_id': site_id,
	                    'bidder_floors': bidder_floors
	                };
	            }
            });

            if(Object.keys(tagIds).length > 0) {
	            // Init bid object
	            this.bids['s2s'] = new bidObj('s2s', tagIds, this);

	            // send out as single request which includes all S2S bidders
	            try {
	                consentManager.ready(
	                    (function() {
	                        bidAdapters['s2s'].send(this.bids['s2s']);
	                    }).bind(this)
	                );
	            } catch (e) {
	                console.error(e);
	                // Log error formatting request
	                e.bidder = 's2s';
	                sendError(TraceKit.computeStackTrace(e));
	            }
	        }
        }
	}

	/**
	 * Send Requests to header bidders
	 */
	auctionObj.prototype.sendHeaderBidders = function() {
		// Get bidders in auction
		this.getAuctionBidders('header');
		// Check that there are bidders enabled in auction
		if(this.auction_bidders.length > 0) {
			var device = properDevice.isMobile() ? 'mobile' : 'desktop';
			// Shuffle bidder order
        	this.shuffleBidders();
        	// Loop through each bidder
        	this.auction_bidders.forEach(function(bidder) {

        		var bidderData        = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder +  '.tag_ids.' + device) || false;
        		var bidderAdapterName = bidderToAdapterName(bidder);

        		if(!bidderData || bidderData.length == 0) {
        			return false;
        		}

        		// Get group of tag ids
        		var auction_round = parseInt(properAdPool.auction_count - 1) % parseInt(properAdPool.auction_rounds);
        		var tagIds = Object.filter((bidderData[auction_round] || {}), function(size) {
        			return typeof properAdPool.sizes[size] !== 'undefined' && bidderData[auction_round][size].length > 0;
        		});

        		for (var size in tagIds) {
        			var bid_limit = properAdPool.sizes[size];
        			tagIds[size].splice(bid_limit, (tagIds[size].length - bid_limit));
        		}

				if(Object.keys(tagIds).length > 0) {
	        		// Init bid object
	        		this.bids[bidder] = new bidObj(bidder, tagIds, this);

					try {
		                if (typeof bidAdapters[bidderAdapterName] !== 'undefined') {
		                	consentManager.ready(
	                            (function() {
		                    		bidAdapters[bidderAdapterName].send(this.bids[bidder]);
		                    	}).bind(this)
	                    	);
		                }
		            } catch (e) {
		                console.error(e);
		                // Log error formatting request
		                e.bidder = bidderAdapterName;
		                sendError(TraceKit.computeStackTrace(e));
		            }
	            }

        	}, this);
		}
	}

	/**
	 * Get bidders in auction
     *
     * @param {String} bidder_type - 's2s' or 'header'
	 */
	auctionObj.prototype.getAuctionBidders = function(bidder_type) {
	 	this.auction_bidders = Object.keys(properOps.bidders[bidder_type] || {}).filter(function(bidder) {
	 		var bidderObj         = properOps.bidders[bidder_type][bidder];
	 		var bidderAdapterName = bidderToAdapterName(bidder);
	 		var demand_type       = ProperMedia.utils.deepAccess(properOps, 'bidder_info.' + bidder + '.demand_type') || 'display';
	 		var video_type        = ProperMedia.utils.deepAccess(properOps, 'bidder_info.' + bidder + '.video_type')  || null;

	 		return (
	 			(
	 				!this.demand_type || 
	 				this.demand_type == demand_type
 				) &&
	 			(
		 			(   // Display bidder Or Video is enabled
		 				demand_type == 'display' || 
		 				(
		 					demand_type == 'video' &&
		 					properPage.video_enabled == true &&
		 					(
		 						!this.video_type || 
	 							this.video_type == video_type
	 						)
	 					)
	 				) &&
	 				(
			 			(   // Bidder is enabled and not in testing mode
			 				bidderObj.enabled && 
			 				!bidderObj.test && 
			 				!properOps.testing_mode.bidder
		 				) || 
		 				(   // In testing mode for bidder
		 					properOps.testing_mode.bidder == bidder
						)
					)
				)
			);
	 	}, this);
	}

    /** 
     * Randomize bidder order
     */
    auctionObj.prototype.shuffleBidders = function() {
    	var currentIndex = this.auction_bidders.length, temporaryValue, randomIndex;

		// While there remain elements to shuffle...
		while (0 !== currentIndex) {

			// Pick a remaining element...
			randomIndex = Math.floor(Math.random() * currentIndex);
			currentIndex -= 1;

			// And swap it with the current element.
			temporaryValue = this.auction_bidders[currentIndex];
			this.auction_bidders[currentIndex] = this.auction_bidders[randomIndex];
			this.auction_bidders[randomIndex] = temporaryValue;
		}

		return this.auction_bidders;
    }

    /**
 	 * Set max time that auction can run
 	 */
 	auctionObj.prototype.setMaxAuctionTimeout = function() {
 		var obj = this;
 		if(this.max_timeout_handle == null) {
 			this.max_timeout_handle = properSetTimeout.setTimeout.call(
 				obj, 
 				function() {
					// Max timeout was reached
					this.auctionFinished();
				},
 				obj.max_timeout 
			);
 		}
    }

    /** 
     * Reset max timeout for auction
     */
 	auctionObj.prototype.clearMaxAuctionTimeout = function() {
 		clearTimeout(this.max_timeout_handle);
 		this.max_timeout_handle = null;
 	}

 	/**
 	 * Update total number of requests sent
 	 * @param {Int} count - Number of requests sent out
 	 */
 	auctionObj.prototype.incrementRequestsSent = function(count) {
		this.bids_sent += !isNaN(parseInt(count)) ? parseInt(count) : 0;
		this.requests_sent++;
	}

	/** 
	 * Keep track of how many bids have returned
	 * @param {Int} count - Number of requests returned
	 */
 	auctionObj.prototype.incrementBidResponseCount = function(count) {
		this.bids_returned += !isNaN(parseInt(count)) ? parseInt(count) : 0;

 		if(this.bids_sent <= this.bids_returned && this.bids_sent_finished == true) {
 			// All bids have returned
 			this.auctionFinished();
 		}
 	}

 	/**
 	 * Get Percent of bids that have been returned
 	 * @return {Float} 
 	 */
 	auctionObj.prototype.getPerecentBidsReady = function() {
		return (this.bids_sent > 0) ? ((this.bids_returned / this.bids_sent) * 100).toFixed(2) : 0;
	}

	/** 
	 * Log a bid response
	 * @param {String}
	 */
 	auctionObj.prototype.logBidResponse = function(ad) {
		// Log bid to pool		
		properAdPool.addBidToPool(ad);
    }

 	/** 
 	 * Calculate auction ms
 	 */
 	auctionObj.prototype.calcAuctionMs = function() {
 		return (this.bids_done_ts > 0 && this.bids_started_ts > 0 && this.bids_done_ts > this.bids_started_ts) ? this.bids_done_ts - this.bids_started_ts : -1;
 	}

 	/**
 	 * Calculate how long it's been since we started the auction
 	 */
 	auctionObj.prototype.auctionTimePassed = function() {
		var d = new Date();
		var ts = d.getTime();
		return ts - this.bids_started_ts;
 	} 	

 	/**
 	 *	Auction finished running
 	 */
 	auctionObj.prototype.auctionFinished = function() {
 		properLog.mylog('Auction Finished');
 		this.clearMaxAuctionTimeout();
 		this.bids_done_ts = ProperMedia.utils.getTimestampMs();
 		properAdPool.auctionFinished(this.id);
 	}

 	return auctionObj;

})();

        // see http://prebid.org/prebid-server/developers/cookie-syncs.html
    var cookieMatchingObj = function() {

		this.proper_tracker_cookie = {       // cookie saved by us to track user and bidder cookies
			'pid' : '', 
			'bidders': {} 
		}, 
		this.supported_bidders = {  // list of bidders that use server to server
			'sovrn': 1,
			'sonobi': 1, 
			'yieldmo': 1,
			'adaptmx': 1, 
			'magnite': 1,
			'pubmatic': 1, 
			'districtm': 1,
			'mediagrid': 1,
			'aol_instream': 1,
			'verizon_media': 1,
			'magnite_instream': 1,
			'magnite_outstream': 1
		},
		this.cookie_map = {
			'magnite': ['magnite', 'magnite_instream', 'magnite_outstream']
		},
		this.done_matching  = false,  // flag to tell if we are done matching cookies with bidders
		this.sent           = 0,      // number of requests sent to bidders to match
		this.received       = 0,      // number of requests returned from bidders
		this.timeout        = 1000,   // timeout ms
		this.timeout_handle = null,   // handle for timeout to wait for cookie matching responses
		this.callback       = null,   // callback function

		this.init = function() {
			// check Proper tracker cookie
			this.getTrackerCookie();

			// Get Proper User ID
			this.proper_tracker_cookie.proper_uid = properUser.pubcid || ProperMedia.utils.deepAccess(userIdAdapters, 'pubCommonId.idObj._pubcid');
		}

		// check if we need to do cookie matching
		this.cookieMatch = function() {

			// Get array of s2s bidders from config
			var s2s_bidders = [];
			Object.keys(ProperMedia.utils.deepAccess(properOps, 'bidders.s2s') || {}).forEach(function(bidder) {
				if(ProperMedia.utils.deepAccess(properOps, 'bidders.s2s.' + bidder + '.enabled')) {
					s2s_bidders.push(bidder);
				}
			})

			// loop through server to server bidders
			for (var i = 0; i < s2s_bidders.length; i++) {
				var bidder = s2s_bidders[i].replace('_s2s', '');
				// If cookie matching is supported for this bidder
				if(this.supported_bidders[bidder] == 1) {
					// if we don't have the bidders matching cookie
					if( typeof this.proper_tracker_cookie.bidders[bidder] === 'undefined' || this.proper_tracker_cookie.bidders[bidder] == 0 ) {

						// check if we have cookie but havent sent it to proper.io yet
						if(typeof ProperMedia.utils.getCookieValue(bidder+'_cookie') !== 'undefined' && ProperMedia.utils.getCookieValue(bidder+'_cookie') !== '') {
                            this.proper_tracker_cookie.bidders[bidder] = 1;
						} else {
							consentManager.ready(
	                            (function() {
	                            	this.requestCookieMatch(bidder);
		                    	}).bind(this)
	                    	);
						}
					}

					if(bidder == 'pubmatic') {
                        $(function() {
                            try {
                                // Append Iframe to do sync up-pixeling
                                var iframe = document.createElement('iframe');
                                iframe.style.display = 'none';
                                iframe.src = 'https://ads.pubmatic.com/AdServer/js/user_sync.html?p=156374&s=206686&predirect=';
                                document.body.appendChild(iframe);
                            } catch(e) {
                            	console.log(e);
                            	sendError(TraceKit.computeStackTrace(e));
                            }
                        });
                    }
				}
			}

			// Save cookie
			this.setTrackerCookie();

			// if we didnt sent any maching requests
			if(this.sent == 0) {
				this.matchingDone();

			// set timeout to wait for cookie matching responses
			} else {
				this.addTimeout();
			}
		}

		this.requestCookieMatch = function(bidder) {

			//logging
 			properLog.mylog('Start ' + bidder + ' Cookie Matching');
 			
 			var consentData = [];
 			// GDPR Consent
	        if (gdprConsent.cmpPresent) {
	            consentData.push('gdpr=' + gdprConsent.gdprApplies.toString());
	            if (gdprConsent.consentString) {
	                consentData.push('gdpr_consent=' + gdprConsent.consentString);
	            }
	        }

	        // USP Consent
	        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
	            consentData.push('us_privacy=' + uspConsent.usPrivacy);
	        }
	        var consentString = consentData.join('&');

			var redir = properOps.usync_endpoint + '?bidder='+bidder+'&proper_uid='+this.proper_tracker_cookie.proper_uid+'&uid=';

			//send request
			var obj = this,
				uid = '',
				uri = '';

			var onload = false; 

			// AdaptMX
			if(bidder == 'adaptmx') {
				uri = 'https://prebid.a-mo.net/cchain/0?cb=' + encodeURIComponent(redir) + '&' + consentString;
			// Sovrn
			} else if(bidder == 'sovrn') {
				uid = '$UID';
				uri = 'https://ap.lijit.com/pixel?redir=' + encodeURIComponent(redir + uid) + '&' + consentString;
			// Pubmatic
			} else if(bidder == 'pubmatic') {
				uid = '#PM_USER_ID';
				uri ='https://image6.pubmatic.com/AdServer/UCookieSetPug?oid=1&rd=' + encodeURIComponent(redir + uid) + '&' + consentString;
			// DistrictM
			} else if(bidder == 'districtm') {
				uid = '$UID';
				uri = 'https://ib.adnxs.com/getuid?' + encodeURIComponent(redir + uid) + '&' + consentString;
			// Sonobi
            } else if(bidder == 'sonobi') {
            	uid = '[UID]';
                uri = 'https://sync.go.sonobi.com/us?loc=' + encodeURIComponent(redir + uid) + '&' + consentString;
            } else if(bidder == 'yieldmo') {
				uid = '$UID';
            	uri = "https://ads.yieldmo.com/pbsync?&redirectUri=" + encodeURIComponent(redir + uid) + '&' + consentString;
            } else if(bidder == 'mediagrid') {
            	uid = '${BSW_UUID}';
            	uri = "https://x.bidswitch.net/check_uuid/" + encodeURIComponent(redir + uid) + '?' + consentString;
        	} else if(bidder == 'verizon_media') {
            	uri = "https://ups.analytics.yahoo.com/ups/58355/sync?redir=true";
            	onload = (function() {
            		this.received++;
            	}).bind(this);
            } else if(bidder == 'aol_instream') {
            	uri = "https://pixel.advertising.com/ups/58316/sync?redir=true&" + consentString;
            } else if(bidder == 'magnite' || bidder == 'magnite_instream' || bidder == 'magnite_outstream') {
            	
            	var iframe_id = 'multisync-iframe';

            	// Check if iframe is on page already
            	if(!document.getElementById(iframe_id)) {
	            	// Build iframe
			        var iframe = document.createElement('iframe');

			        // Set iframe attr
			        iframe.id            = iframe_id;
			        iframe.width         = 0;
			        iframe.height        = 0;
			        iframe.marginWidth   = 0;
			        iframe.marginHeight  = 0;
			        iframe.scrolling     = "no";
			        iframe.frameBorder   = 0;
			        iframe.style.border  = "0px";
			        iframe.style.display = "none";

			     	// Set iframe src
			        iframe.src = "https://secure-assets.rubiconproject.com/utils/xapi/multi-sync.html?p=8777&endpoint=us-west";
			        // Add iframe elem to DOM
			        document.body.appendChild(iframe);
			    }

            }

			if(uri != '') {
				obj.sent++; 
				$.ajax({
					url: uri,
					requestType: "jsonp",
					onload: onload
				});
			}
		}

		this.updateBidderCookieData = function(bidder, bidder_uid) {

			var bidder     = bidder.replace('_s2s', '');
			var map_bidder = bidder.replace(/_instream|_outstream/,'');
			var bidders    = (this.cookie_map[map_bidder]) ? this.cookie_map[map_bidder] : [bidder];

			for (var i = 0; i < bidders.length; i++) {
				// save backup cookie
				var date  = new Date();
				var days = 365; //expire in x hours
				date.setTime(date.getTime()+(days*24*60*60*1000));
				document.cookie = bidders[i]+"_cookie="+bidder_uid+"; expires="+date.toGMTString()+"; path=/; domain=."+properPage.domain+"; SameSite=Lax;";

				this.proper_tracker_cookie.bidders[bidders[i]] = 1;
			}
			this.setTrackerCookie();
		}

		// Log a response has come back
		this.logMatchingResponse = function(bidder, proper_uid, bidder_uid) {

			this.updateBidderCookieData(bidder, bidder_uid);
			this.received++;

			if(bidder == 'sonobi') {
				$(function() {
                    try {
                        var script = document.createElement('script');
						script.src = "//sync.go.sonobi.com/uc.js?pubid=" + (proper_uid || this.proper_tracker_cookie.proper_uid);
						script.async = true;
						script.type = "text/javascript";
						var scpt = document.getElementsByTagName('script')[0];
						scpt.parentNode.insertBefore(script, scpt);
                    } catch(e) {
                    	console.log(e);
                    	sendError(TraceKit.computeStackTrace(e));
                    }
                });
			}

			// check if we have gotten all responses back
			if(this.received >= this.sent) {
				this.matchingDone();
			}
		}

		// We are done cookie matching
		this.matchingDone = function() {

			if(this.done_matching == 1) return;
 			this.done_matching = 1;

			// Check for callback function to send s2s bids
			if(ProperMedia.utils.isFn(this.callback)) {
				this.callback();
				this.callback = null;
			}

 			properLog.mylog('S2S Cookie Matching Done');

 			// turning off timeout
 			this.resetTimeout();
		}

        // check Proper tracker cookie
		this.getTrackerCookie = function() {
			// check for our cookie
			if(typeof ProperMedia.utils.getCookieValue('proper_tracker_cookie') !== 'undefined') {

				// Get cookie value
				var cookie_string_value = ProperMedia.utils.getCookieValue('proper_tracker_cookie') || '';

				// Check if cookie is base64 encoded and decode
				if(ProperMedia.utils.isBase64(cookie_string_value)) {
					cookie_string_value = ProperMedia.utils.b64DecodeUnicode(cookie_string_value);
				} else {
					cookie_string_value = decodeURIComponent(cookie_string_value);
				}
				// Set cookie object
				this.proper_tracker_cookie = ProperMedia.utils.safeJsonParse(cookie_string_value) || this.proper_tracker_cookie;
			}
		}

		// set / update the tracking cookie
		this.setTrackerCookie = function() {
			var date  = new Date();
			date.setTime(date.getTime()+(365*24*60*60*1000));

			// Base 64 encoded cookie value
			var encoded_cookie_value = ProperMedia.utils.b64EncodeUnicode(JSON.stringify(this.proper_tracker_cookie));

			// save tracker cookie
			document.cookie = "proper_tracker_cookie="+encoded_cookie_value+"; expires="+date.toGMTString()+"; path=/; domain=."+properPage.domain+"; SameSite=Lax;";
		}

		// add timeout
		this.addTimeout = function() {
			var obj = this;
	 		this.timeout_handle = properSetTimeout.setTimeout.call(obj, function(){ obj.resetTimeout(); obj.matchingDone(); }, obj.timeout );
	 	}

		// reset timeout
	 	this.resetTimeout = function() {
	 		clearTimeout(this.timeout_handle);
	 		this.timeout_handle = null;
	 	}
	}
    var audiencePixels = (function() {

	var config = {
		enabled: false,
		thresholds: []
	};

	var audiencePixels = {
		init: function(configObj) {
			config = ProperMedia.utils.mergeObject(config, configObj);
		},
		checkThresholds: checkThresholds
	}

	function checkThresholds() {
		var threshold = {
			'price': 0,
			'pixel': ''
		}
		config.thresholds.map(function(obj) {
			if(properSession.sessionData.revenue > obj.price && properSession.sessionData.revenue > threshold.price) {
				threshold = obj;
			}
		});
		if(threshold.price) {
			placePixel(threshold)
		}
	}

	function placePixel(threshold) {
		properLog.mylog("Place audience pixel: " + threshold.price);
		if(config.enabled && threshold.pixel) {
			var id = "audience-pixel-" + threshold.price.toString();
			if(!document.getElementById(id)) {
				var iframe = document.createElement('iframe');
				iframe.id = id;
				iframe.width = '0px';
        		iframe.height = '0px';
        		iframe.style.display = 'none';
				// Add iframe elem to DOM
	        	document.getElementsByTagName('body')[0].appendChild(iframe);
	        	
	        	iframe.contentWindow.document.open();
	            iframe.contentWindow.document.write(threshold.pixel.toString());
	            iframe.contentWindow.document.close();
			}
		}
	}

	return audiencePixels;

})();
    	var sessionObj = function() {

		this.sessionData = {
			uuid     	 : '', // session id (universal unique id)
			depth    	 : 0,  // depth of session
			referrer 	 : '', // referrer
			utm_campaign : '', // utm vars
			utm_source 	 : '', // utm vars
			utm_medium 	 : '', // utm vars
			utm_term 	 : '', // utm vars
			utm_content  : '', // utm vars
			revenue      : 0   // Running total of session revenue  
		},
		this.newCookieName = 'properSessionData',
		this.oldCookieName = 'sessionData';

		this.init = function() {

			this.getSessionCookie();

			// Get session depth count
			if (typeof this.sessionData['depth'] !== 'undefined') {
				this.sessionData['depth'] = this.sessionData['depth'] + 1;
			} else this.sessionData['depth'] = 1;

			var utm_variables = [ 'utm_medium', 'utm_source', 'utm_campaign', 'utm_term', 'utm_content' ];
			// See if any UTM variables are defined in the query parameters.
			var check_utm_vars = utm_variables.some(function(variable) {
				return (typeof properPage.get_vars[variable] !== 'undefined');
			}, this);

			// Referrer is not the same domain as the current page
			if (properPage.referrer !== '' && !ProperMedia.utils.matchDomain(properPage.domain, properPage.referrer)) {
				this.checkForChange('referrer', properPage.referrer);
				// We want to force a check of the UTM vars, even if none are
				// defined in the current query parameters.
				check_utm_vars = true;
			}

			if (check_utm_vars) {
				// Check each of the UTM variables for a change or removal
				utm_variables.forEach(function(variable) {
					this.checkForChange(variable, properPage.get_vars[variable] || '');
				}, this);
			}

			// Do we need to generate a session id?
			if (typeof this.sessionData.uuid == 'undefined' || this.sessionData.uuid == '') {
				this.sessionData.uuid = ProperMedia.utils.generateUUID();
				// If the session has been reset, use the current referrer as
				// the session's new referrer.
				this.sessionData.referrer = properPage.referrer;
			}
			this.setSessionRevenue(0);

			window.proper_ad_session_uuid = this.sessionData.uuid;

			this.setSessionCookie();
		}

		this.checkForChange = function(variable, value) {
			if (this.sessionData[variable] !== value) {
				this.sessionData[variable] = value;
				this.sessionData.uuid = '';
				this.sessionData.depth = 1;
			}
		}

		this.getSessionCookie = function() {

			// Check for new cookie
			if(typeof ProperMedia.utils.getCookieValue(this.newCookieName) !== 'undefined') {

				// Get cookie value
				var cookie_string_value = ProperMedia.utils.getCookieValue(this.newCookieName) || '';

				// Check if cookie is base64 encoded and decode
				if(ProperMedia.utils.isBase64(cookie_string_value)) {
					cookie_string_value = ProperMedia.utils.b64DecodeUnicode(cookie_string_value);
				} else {
					cookie_string_value = decodeURIComponent(cookie_string_value);
				}
				// Set settion object
				var cookieSessionData = ProperMedia.utils.safeJsonParse(cookie_string_value) || {};
				ProperMedia.utils.mergeObject(this.sessionData, cookieSessionData);

            // Check for old cookie
			} else if(typeof ProperMedia.utils.getCookieValue(this.oldCookieName) !== 'undefined') {
				var cookieData = ProperMedia.utils.safeJsonParse(ProperMedia.utils.getCookieValue(this.oldCookieName));
                if(cookieData != null) {

                	// Only copy over our variables from old coookie
                	for(key in this.sessionData) {
                		if(typeof cookieData[key] !== 'undefined') {
                			this.sessionData[key] = cookieData[key];
                		}
                	}

                	// decode variables if they are encoded in the cookie
                	if(typeof cookieData.encoded != 'undefined' && cookieData.encoded == 1) {
						this.sessionData['referrer'] 	 = decodeURIComponent(this.sessionData['referrer']);
						this.sessionData['utm_campaign'] = decodeURIComponent(this.sessionData['utm_campaign']);
						this.sessionData['utm_source']   = decodeURIComponent(this.sessionData['utm_source']);
						this.sessionData['utm_medium']   = decodeURIComponent(this.sessionData['utm_medium']);
						this.sessionData['utm_term']  	 = decodeURIComponent(this.sessionData['utm_term']);
						this.sessionData['utm_content']  = decodeURIComponent(this.sessionData['utm_content']);
					}
                }
			}
		}

	    this.setSessionCookie = function() {
			// cookie to expire in 30 min
			var date  = new Date();
			date.setTime(date.getTime()+(30*60*1000));

			// Base 64 encoded cookie value
			var encoded_cookie_value = ProperMedia.utils.b64EncodeUnicode(JSON.stringify(this.sessionData));

			// save session cookie
			document.cookie = this.newCookieName+"="+encoded_cookie_value+"; expires="+date.toGMTString()+"; path=/; domain=."+properPage.domain+"; SameSite=Lax;";
	    }

	    this.deleteCookie = function(cookieName) {
	    	var date  = new Date();
			date.setTime(date.getTime()-(60*1000));
	    	document.cookie = cookieName+"=; expires="+date.toGMTString()+"; path=/; domain=."+properPage.domain+"; SameSite=Lax;";
	    }

	    this.setSessionRevenue = function(price) {
	    	this.sessionData.revenue += (parseFloat(price) / 1000) || 0;
	    	properLog.mylog("Session revenue: " + this.sessionData.revenue);
	    	this.setSessionCookie();
	    	audiencePixels.checkThresholds();
	    }
	}

    var userSyncs = (function() {
    var started   = false;
    var demandTypeDisplay = true;
    var demandTypeVideo   = true;
    var interval  = null;
    var container = null;
    var pending   = [];

    function id(prefix) {
        return (prefix || '') + Math.random().toString(16).substr(2);
    }

    var insert = {
        'iframe': function(sync) {
            var ifr = document.createElement('iframe');
            ifr.id = id('i-');
            ifr.frameborder = '0';
            ifr.allowtransparency = 'true';
            ifr.marginheight = '0';
            ifr.marginwidth = '0';
            ifr.width = '0';
            ifr.hspace = '0';
            ifr.vspace = '0';
            ifr.height = '0';
            ifr.scrolling = 'no';
            ifr.style.display = 'none';
            ifr.style.width = '0';
            ifr.style.height = '0';
            ifr.sandbox = 'allow-scripts allow-same-origin';
            ifr.src = sync.url;
            ifr.onload = function() {
                ProperMedia.utils.setDataInLocalStorage('ProperUserSync.'+sync.bidder, Date.now());
            }

            container.appendChild(ifr);
        },
        'image': function(sync) {
            var img = new Image();
            img.src = sync.url;
            img.onload = function() {
                ProperMedia.utils.setDataInLocalStorage('ProperUserSync.'+sync.bidder, Date.now());
            }
        }
    };

    function process() {
        pending.splice(0, 5).forEach(function(sync) {
            insert[sync.type](sync);
        });

        if (pending.length === 0) {
            clearInterval(interval);
            interval = null;
        }
    }

    function resume() {
        if (!started) return;
        if (pending.length === 0) return;
        if (interval !== null) return;
        interval = setInterval(process, 1500);
        // Do the first batch right away
        process();
    }

    /**
     * Determine if we should inject sync pixels for the given bidder
     */
    function shouldSyncBidder(bidder) {

        // Only sync bidders that are enabled
        if(!ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.enabled')) {
            return false;
        }

        // edge cases
        if (!ProperMedia.utils.hasLocalStorage()) {
            return true;
        }
        var localStorageUserSync = ProperMedia.utils.getDataFromLocalStorage('ProperUserSync.'+bidder);
        if (!localStorageUserSync
            || ((Date.now() - parseInt(localStorageUserSync)) > 2592000000) // 30 days have passed
        ) {
            // we should inject this bidder sync pixel
            return true;
        }

        // we should not inject this bidder sync pixel again
        return false;
    }

    return {
        // function for adding a user sync from bidder adapters
        add: function(syncs) {
            propertag.cmd.push(function() {
                var sync_data      = ProperMedia.utils.isArray(syncs) ? syncs[0] : syncs;
                var syncDemandType = ProperMedia.utils.deepAccess(sync_data, 'demand_type');
                var bidder         = ProperMedia.utils.deepAccess(sync_data, 'bidder');

                // append user sync data to list of user syncs if relevant demand type is active
                if ( (
                    (syncDemandType == 'video' && demandTypeVideo)
                    ||
                    ((syncDemandType == 'display' || !syncDemandType) && demandTypeDisplay)
                    ) && shouldSyncBidder(bidder)
                ) {
                    pending = pending.concat(syncs);
                    resume();
                }
            });
            return true;
        },
        // function for starting user sync
        start: function() {
            if (!started) {
                started = true;
                container = document.createElement('div');
                container.id = id('us-');
                container.style.display = 'none';
                container.style.width = '0';
                container.style.height = '0';
                document.body.appendChild(container);
            }
            resume();
        }
    };
})();

    var debugConsole = function() {

	this.enabled 				= false
	this.resize_elem 			= null
	this.breadcrumb_elem 		= null
	this.debug_cont_elem 		= null
	this.debug_console_elem 	= null
	this.view_refresh_timer 	= null
	this.debug_style_elem 		= null

	/*
	 * Init debug console
	 */
	this.createDebugConsole = function(type) {
		// Set enable flag
		this.enabled = true;

		// Check if debug element exists
		if(!this.debug_console_elem) {
			this.debug_console_elem = document.createElement('div');
	        this.debug_console_elem.id = 'proper-debug-console';
			if(type=='overlay')
			this.debug_console_elem.classList.add('short')
	        document.body.appendChild(this.debug_console_elem);
	    }

	    if(!this.resize_elem) {
	    	this.resize_elem = document.createElement('div');
			this.resize_elem.innerHTML = "&#8942;"
        	this.resize_elem.id = 'proper-debug-console-resizer';
        	this.debug_console_elem.appendChild(this.resize_elem);
	    }

	    if(!this.breadcrumb_elem) {
	    	this.breadcrumb_elem = document.createElement('div');
        	this.breadcrumb_elem.id = 'proper-debug-console-breadcrumb';
        	this.debug_console_elem.appendChild(this.breadcrumb_elem);
	    }

	    if(!this.debug_cont_elem) {
	    	this.debug_cont_elem = document.createElement('div');
        	this.debug_cont_elem.id = 'proper-debug-console-cont';
        	this.debug_console_elem.appendChild(this.debug_cont_elem);
	    }

		if(!this.debug_style_elem){
			this.debug_style_elem = document.createElement('style')
			this.debug_style_elem.id = 'proper-debug-styling'
			this.debug_style_elem.innerHTML = this.debug_console_css
			document.body.appendChild(this.debug_style_elem)
		}

		if(this.resize_elem && this.breadcrumb_elem) this.setDragAndResizeActions();

	    // Add Slot Overlays
	    this.addSlotOverlays();
	    if(type == 'overlay') {
	    	this.createOverlayView(properPage);
		} else {
			// Create Page Debug View
		    //this.createPageView(properPage);
			this.createOverview();
		}
	}


	/*
	 * Create overlay for all slot divs in dom
	 */
	this.addSlotOverlays = function() {
		Object.keys(properPage.slots).forEach(function(slot_type) {
			Object.keys(properPage.slots[slot_type]).forEach(function(slot_name) {
                var slot = properPage.slots[slot_type][slot_name];
	    		this.addSlotOverlay(slot);
    		}, this);
	    }, this);
	}

	/*
	 * Create overlay for slot divs in dom
	 * @param slot 	slotObj
	 */
	this.addSlotOverlay = function(slot) {

		if(slot instanceof slotObj) {
			// Get slot element
			var elem = slot.getElement();

			if(elem) {
				// Remove overlay already exists
				var overlay_elem = $(elem).parent().find('.proper-debug-overlay').remove();
				// Create element
				overlay_elem = document.createElement('div');

				// Add Class
				$(overlay_elem).addClass('proper-debug-overlay');
				// Overlay div with background color
	            var slot_overlay = document.createElement('div');
	            $(slot_overlay).addClass('proper-debug-overlay-background');
	            // Overlay html
	            var slot_overlay_html = document.createElement('div');
	            $(slot_overlay_html).addClass('proper-debug-overlay-text');
	            $(slot_overlay_html).html(
	            	[
	            		slot.name,
	                	'Size: ' + slot.displayed_ad.size,
	                	'Bidder: ' + slot.displayed_ad.bidder,
	                	'CPM: ' + slot.displayed_ad.price
                	].join('<br>')
                );

	            $(slot_overlay).on('click', (function() {
	    			this.createSlotView(slot);
	            }).bind(this));

	            // Add divs to dom
	            overlay_elem.append(slot_overlay_html);
	            overlay_elem.append(slot_overlay);
				$(elem).parent().append(overlay_elem);
	        }
	    } else {
	    	return false;
	    }
	    return true;
	}


	/*
	 * Destroy debug console
	 */
	this.destroyDebugConsole = function() {
		// Set enable flag
		this.enabled = false;

		if(this.debug_console_elem) {
			this.debug_console_elem.parentNode.removeChild(this.debug_console_elem);
		}
		if(this.debug_style_elem) {
			this.debug_style_elem.parentNode.removeChild(this.debug_style_elem);
		}
		if(this.view_refresh_timer) {
			clearTimeout(this.view_refresh_timer);
		}

		this.view_refresh_timer = null;
		this.debug_console_elem = null;
		this.breadcrumb_elem = null;
		this.debug_cont_elem = null;
		this.debug_style_elem = null;
		this.resize_elem = null;

	    Object.keys(properPage.slots).forEach(function(slot_type) {
			Object.keys(properPage.slots[slot_type]).forEach(function(slot_name) {
                var slot = properPage.slots[slot_type][slot_name];
	    		this.removeSlotOverlay(slot);
	    	}, this);
	    }, this);
	}


	/*
	 * Remove overlay for slot divs in dom
	 * @param slot 	slotObj
	 */
	this.removeSlotOverlay = function(slot) {
		if(slot instanceof slotObj) {
			// Get slot element
			var elem = slot.getElement();

			if(elem) {
				// Remove overlay already exists
				var overlay_elem = $(elem).parent().find('.proper-debug-overlay').remove();
	        }
	    } else {
	    	return false;
	    }
	    return true;
	}


	/*
	 * Create breadcrumb bar
	 * @param view 	String	view name
	 * @param obj 	pageObj|slotObj
	 */
 	this.refreshViewTimer = function(view, obj) {
 		clearTimeout(this.view_refresh_timer);
		this.view_refresh_timer = properSetTimeout.setTimeout.call(this, this.loadViewCallback, 2500, view, obj);
	}


	/*
	 * Create breadcrumb bar
	 * @param view 	String
	 * @param obj 	Obj
	 */
	this.loadViewCallback = function(view, obj) {
		this.addSlotOverlays();
		if(view == 'overview') {
			this.createOverview();
		} else if(view == 'overlay') {
			this.createOverlayView(obj);
		} else if(view == 'page') {
			this.createPageView(obj);
		} else if(view == 'slot') {
			this.createSlotView(obj);
		} else if(view == 'ad_pool') {
			this.createAdPoolView(obj);
		} else if(view == 'auction') {
			this.createAuctionView(obj);
		}
	}


	/*
	 * Create breadcrumb bar
	 * @param crumbtrail 	Object
	 */
	this.createBreadcrumb = function(crumbtrail) {

	    this.breadcrumb_elem.innerHTML = '';

		Object.keys(crumbtrail).forEach(function(i) {
			var crumb = crumbtrail[i];
			var span = document.createElement('div');
			$(span).addClass('proper-debug-breadcrumb');
			span.innerHTML = crumb['text'];

			$(span).on('click', (function() {
    			this.loadViewCallback(crumb['text'].replaceAll(" ","_"), crumb['obj']);
            }).bind(this));
			this.breadcrumb_elem.appendChild(span);

			if(i < crumbtrail.length - 1) {
				var spacer = document.createElement('div');
				$(spacer).addClass('proper-debug-breadcrumb-spacer');
				this.breadcrumb_elem.appendChild(spacer);
			} else if (i == crumbtrail.length - 1) {
				this.refreshViewTimer(crumb['text'], crumb['obj']);
			}

		}, this);


		var close_btn = document.createElement('span');
		$(close_btn).addClass('proper-debug-close-console-btn');
		close_btn.innerHTML = '&times;';
		$(close_btn).on('click', (function() {
			this.destroyDebugConsole();
        }).bind(this));
		this.breadcrumb_elem.appendChild(close_btn);

	}


	/*
	 * Create and insert title element into view
	 * @param title_html	String Html to put in title
	 */
	this.createTitleElement = function(title_html) {
		// Create Slots Title
		var title_elem = document.createElement('div');
		$(title_elem).addClass('proper-debug-cont-title');
		title_elem.style.cssText = 'padding: 4px; margin: 4px; font-size: 1em; font-weight: 700; display: inline-block;';
		$(title_elem).html(title_html);
		this.debug_cont_elem.appendChild(title_elem);
	}

	/*
	 * Create and insert state element into view
	 * @param states	Obj
	 */
	this.createStateElements = function(states) {
		// Slot State Container
		var states_cont_elem = document.createElement('div');
        $(states_cont_elem).addClass('proper-debug-state-cont');
        this.debug_cont_elem.appendChild(states_cont_elem);

    	Object.keys(states).forEach(function(state) {

            var state_elem = document.createElement('div');
            $(state_elem).addClass('proper-debug-state-cell');
			if(!states[state]) $(state_elem).addClass('proper-debug-state-cell red')
            $(state_elem).html(state);
        	states_cont_elem.appendChild(state_elem);

	    }, this);


	}


	/*
	 * Create Overview view
	 */
	this.createOverview = function() {

		var cumbtrail = [
			{
				"text": 'overview',
				"obj" : {}
			}
		];
		// Create breadcrumb
		this.createBreadcrumb(cumbtrail);
		// Clear html
		this.debug_cont_elem.innerHTML = '';

		this.createTitleElement('Sections');

		// sections
		var sections_cont_elem = document.createElement('div');
		$(sections_cont_elem).addClass('proper-debug-sections-cont');
		this.debug_cont_elem.appendChild(sections_cont_elem);

		//sections > pages
		var page_elem = document.createElement('button');
		$(page_elem).addClass('proper-debug-page-cell');
		if(properPage instanceof pageObj == false) $(page_elem).addClass('proper-debug-page-cell red');
		$(page_elem).html('Page &amp; Slots');

		$(page_elem).on('click', (function() {
			this.createPageView(properPage);
		}).bind(this));

		sections_cont_elem.appendChild(page_elem);

		// sections > ad pool
		var ad_pool_elem = document.createElement('button');
		$(ad_pool_elem).addClass('proper-debug-ad-pool-cell');
		if(properAdPool.ads.length == 0) $(ad_pool_elem).addClass('proper-debug-ad-pool-cell red');
		$(ad_pool_elem).html('Ad Pool &amp; Auctions');

		$(ad_pool_elem).on('click', (function() {
			this.createAdPoolView(properAdPool);
		}).bind(this));

		sections_cont_elem.appendChild(ad_pool_elem);



		// Create Device Title
		this.createTitleElement('Device');

	    // Device Data
	    var device_data = [
			{ "property": 'OS',            "value" : properDevice.os },
			{ "property": 'OS Group',      "value" : properDevice.os_group },
			{ "property": 'Browser',       "value" : properDevice.browser },
			{ "property": 'Browser Group', "value" : properDevice.browser_group },
			{ "property": 'Device Type',   "value" : properDevice.device_type },
			{ "property": 'User Agent',    "value" : navigator.userAgent }
		];

		this.createTable('#proper-debug-console-cont', device_data, false);

		// Create Title
		this.createTitleElement('Session Data');

	    var session_data = [
			{ "property": 'UUID',         "value" : properSession.sessionData.uuid },
			{ "property": 'Depth',        "value" : properSession.sessionData.depth },
			{ "property": 'Referrer',     "value" : properSession.sessionData.referrer },
			{ "property": 'UTM campaign', "value" : properSession.sessionData.utm_campaign },
			{ "property": 'UTM source',   "value" : properSession.sessionData.utm_source },
			{ "property": 'UTM medium',   "value" : properSession.sessionData.utm_medium },
			{ "property": 'UTM term',     "value" : properSession.sessionData.utm_term },
			{ "property": 'UTM content',     "value" : properSession.sessionData.utm_content }
		];

		this.createTable('#proper-debug-console-cont', session_data, false);

		// Create Page Title
		this.createTitleElement('Special Ops');

		// pre element
		var pre = document.createElement('pre');
		pre.innerHTML = JSON.stringify(properSpecialOps, undefined, 2);
		this.debug_cont_elem.appendChild(pre);


		// hr element
		this.debug_cont_elem.appendChild(document.createElement('hr'));


	}

	/*
	 * Create Page view
	 * @param slot slotObj
	 */
	this.createOverlayView = function(page) {

		var cumbtrail = [
			{
				"text": 'overlay',
				"obj" : page
			}
		];
		// Create breadcrumb
		this.createBreadcrumb(cumbtrail);
		// Clear html
		this.debug_cont_elem.innerHTML = '';

		// Page slots
		var slots_cont_elem = document.createElement('div');
        $(slots_cont_elem).addClass('proper-debug-page-slots-cont');
        this.debug_cont_elem.appendChild(slots_cont_elem);

        Object.keys(page.slots).forEach(function(slot_type) {
			Object.keys(page.slots[slot_type]).forEach(function(slot_name) {
                var slot = page.slots[slot_type][slot_name];

	            var background_color = (slot.getElement()) ? '#00800087' : '#ff000070';

	            var slot_elem = document.createElement('div');

	            $(slot_elem).addClass('proper-debug-page-slot-cell');
	            $(slot_elem).addClass('proper-debug-scroll-slot-inview');
	            $(slot_elem).html(slot.name);

	            $(slot_elem).on('click', (function() {
		        	var elem = slot.getElement();
					elem.scrollIntoView();
		        }).bind(this));

	        	slots_cont_elem.appendChild(slot_elem);

	        }, this);
	    }, this);
	}


	/*
	 * Create Page view
	 * @param slot slotObj
	 */
	this.createPageView = function(page) {

		var cumbtrail = [
			{
				"text": 'overview',
				"obj" : {}
			},
			{
				"text": 'page',
				"obj" : page
			}
		];
		// Create breadcrumb
		this.createBreadcrumb(cumbtrail);
		// Clear html
		this.debug_cont_elem.innerHTML = '';

		// Create Slots Title
		this.createTitleElement('Slots');

		// Page slots
		var slots_cont_elem = document.createElement('div');
        $(slots_cont_elem).addClass('proper-debug-page-slots-cont');
        this.debug_cont_elem.appendChild(slots_cont_elem);

        Object.keys(properPage.slots).forEach(function(slot_type) {
			Object.keys(properPage.slots[slot_type]).forEach(function(slot_name) {
                var slot = properPage.slots[slot_type][slot_name];

	            var background_color = (slot.getElement()) ? '#00800087' : '#ff000070';

	            var slot_elem = document.createElement('button');
	            $(slot_elem).addClass('proper-debug-page-slot-cell');
	            $(slot_elem).html(slot.name);

	            $(slot_elem).on('click', (function() {
	    			this.createSlotView(slot);
	            }).bind(this));

	        	slots_cont_elem.appendChild(slot_elem);
	        }, this);
	    }, this);

		// Create Slots Title
		this.createTitleElement('States');

		// States
		var states = {};
		if(page.isolated !== 1 && properOps.dfp_per_slot == 0) {
    		states["DFP Init"] = properPage.dfp_init;
    		if(typeof properPage.dfp_enabled_services !== 'undefined' && properPage.dfp_enabled_services == true) {
        		if(typeof googletag.pubads().isSRA == 'function' && googletag.pubads().isSRA()) {
        			states["DFP Single Request Enabled"] = 1;
        		}
        	}
    	}

    	if(Object.keys(states).length > 0) {
    		this.createStateElements(states);
		}

		// Create Page Title
		this.createTitleElement('Page Data');

		// Page Data
	    var page_data = [
	    	{ "property": 'UUID',         "value" : page.uuid },
			{ "property": 'Url',          "value" : page.url },
			{ "property": 'Referrer',     "value" : page.referrer },
			{ "property": 'Protocol',     "value" : page.protocol },
			{ "property": 'Canonical url',"value" : page.canonical_url },
			{ "property": 'Isolated',     "value" : page.isolated },
			{ "property": 'Width',        "value" : page.width },
			{ "property": 'Height',       "value" : page.height },
			{ "property": 'Tags',         "value" : page.tags.join(', ') },
			{ "property": 'Post id',      "value" : page.post_id },
			{ "property": 'SPA enabled',  "value" : page.spa_settings['enabled'] }
		];

		// Single-Page App settings
		if(page.spa_settings['enabled'] == true){
			page_data = page_data.concat([
				{ "property": 'SPA gallery id',       "value" : page.spa_settings['gallery_id'] },
				{ "property": 'SPA gallery url',      "value" : page.spa_settings['gallery_base_url'] },
				{ "property": 'SPA page number',      "value" : page.spa_settings['page_number'] },
				{ "property": 'SPA prefetch enabled', "value" : page.spa_settings['prefetch'] },
			]);
		}

		this.createTable('#proper-debug-console-cont', page_data, false);


	}


	/*
	 * Create slot view
	 * @param slot slotObj
	 */
	this.createSlotView = function(slot) {

		var cumbtrail = [
			{
				"text": 'overview',
				"obj" : {}
			},
			{
				"text": 'page',
				"obj" : properPage
			},
			{
				"text": 'slot',
				"obj" : slot
			}
		];
		// Create breadcrumb
		this.createBreadcrumb(cumbtrail);
		// Clear html
		this.debug_cont_elem.innerHTML = '';

		// Create Slots Title
		this.createTitleElement('Slots');

		// Page slots
		var slots_cont_elem = document.createElement('div');
        $(slots_cont_elem).addClass('proper-debug-page-slots-cont');
        this.debug_cont_elem.appendChild(slots_cont_elem);

		var current_slot_name = slot.name.toString()

        Object.keys(properPage.slots).forEach(function(slot_type) {
			Object.keys(properPage.slots[slot_type]).forEach(function(slot_name) {

				console.log(typeof current_slot_name, typeof slot_name)

                var slot = properPage.slots[slot_type][slot_name];

	            var background_color = (slot.getElement()) ? '#00800087' : '#ff000070';

	            var slot_elem = document.createElement('button');
	            $(slot_elem).addClass('proper-debug-page-slot-cell');
				if(current_slot_name == slot_name){
					$(slot_elem).addClass('proper-debug-page-slot-cell active')
					console.log('ADDED',slot_name)
				}
	            $(slot_elem).html(slot.name);

	            $(slot_elem).on('click', (function() {
	    			this.createSlotView(slot);
	            }).bind(this));

	        	slots_cont_elem.appendChild(slot_elem);
	        }, this);
	    }, this);

        // States
		this.createTitleElement('States');

        var states = {
        	"In DOM": slot.getElement() ? 1 : 0
        };
        if(properPage.isolated == 0) {
        	if(properOps.dfp_per_slot == 1) {
        		states["Slot DFP Init"] = slot.dfp_init;
        		if(slot.dfp_enabled_services == true) {
        			if(typeof slot.googletag().pubads().isSRA == 'function' && slot.googletag().pubads().isSRA()) {
        				states["DFP Single Request"] = 1;
        			}
        		}
        	} else {
        		states["DFP Init"] = properPage.dfp_init;
        		if(properPage.dfp_enabled_services == true) {
	        		if(typeof googletag.pubads().isSRA == 'function' && googletag.pubads().isSRA()) {
	        			states["DFP Single Request Enabled"] = 0;
	        		}
	        	}
        	}
        	states["Mapped DFP Sizes"] = slot.mapped_dfp_sizes;
        	states["DFP Ready"]        = slot.dfp_ready;
        	states["DFP Sent"]         = slot.dfp_sent;

        	if(slot.refresh.enabled && slot.refresh.count > 0) {
        		states["DFP Refreshed"] = slot.dfp_refreshed;
        	}
        }
        states["Displayed"] = slot.displayed;

        this.createStateElements(states);

        // Create Title
		this.createTitleElement(slot.name);

		var eye_elem = document.createElement('div');
        $(eye_elem).addClass('proper-debug-scroll-slot-inview');
        eye_elem.style.cssText = 'display: inline-block; cursor: pointer;';
        $(eye_elem).html('&#128065;');
        $(eye_elem).on('click', (function() {
        	var elem = slot.getElement();
			elem.scrollIntoView();
        }).bind(this));
        this.debug_cont_elem.appendChild(eye_elem);

		var sizes_arr = slot.sizes || [];

		var time_inview = (slot.viewability.viewable == false) ? slot.viewability.total_time_inview : slot.viewability.total_time_inview + slot.getTimeInview();

		// Slot Data
		var slot_data = [
			{ "property": 'Type',                    "value" : slot.type                          },
			{ "property": 'Size',                    "value" : slot.size                          },
			{ "property": 'Sizes',                   "value" : sizes_arr.join(', ')               },
			{ "property": 'Default size',            "value" : slot.default_size.join('x')        },
			{ "property": 'Div ID',                  "value" : slot.div_id                        },
			{ "property": 'Number',                  "value" : slot.number                        },
			// { "property": 'Position',                "value" : slot.position                   },
			{ "property": 'Refresh',                 "value" : slot.refresh.enabled               },
			{ "property": 'Refresh cnt',             "value" : slot.refresh.count                 },
			{ "property": 'Refresh max',             "value" : slot.refresh.max                   },
			{ "property": 'Refresh interval',        "value" : slot.refresh.current_interval      },
			{ "property": 'Refresh inview interval', "value" : slot.refresh.inview_interval       },
			{ "property": 'Viewable',                "value" : slot.viewability.viewable          },
			{ "property": 'Time inview',             "value" : time_inview                        },
			{ "property": 'Sticky',                  "value" : slot.sticky                        }
		];

		if(slot.sticky == 1) {
			slot_data = slot_data.concat([
				{ "property": 'Position',         "value" : slot.sticky_settings.position         },
				{ "property": 'Brand',            "value" : slot.sticky_settings.brand            },
				{ "property": 'Close btn',        "value" : slot.sticky_settings.close_btn        },
				{ "property": 'Disable on close', "value" : slot.sticky_settings.disable_on_close },
				{ "property": 'Freq cap enabled', "value" : slot.sticky_settings.freq_cap_enabled },
				{ "property": 'Freq cap',         "value" : slot.sticky_settings.freq_cap         }
			]);
		}

		// Lazy-load settings
		slot_data = slot_data.concat([
			{ "property": 'Lazyload enabled', "value" : slot.lazyload.enabled }
		]);
		if(slot.lazyload.enabled) {
			slot_data = slot_data.concat([
				{ "property": 'In fetch zone',  "value" : slot.lazyload.inFetchZone },
				{ "property": 'In render zone', "value" : slot.lazyload.inRenderZone },
				{ "property": 'Fetch zone %',   "value" : slot.lazyload.fetchMarginPercent + '%' },
				{ "property": 'Render zone %',  "value" : slot.lazyload.renderMarginPercent + '%' }
			]);
		}

		// dynamic settings
		slot_data = slot_data.concat([
			{ "property": 'Dynamic enabled', "value" : slot.dynamic.enabled }
		]);
		if(slot.dynamic.enabled) {
			slot_data = slot_data.concat([
				{ "property": 'CSS Placement', "value" : slot.dynamic.cssplacement },
				{ "property": 'CSS Selector',  "value" : slot.dynamic.cssselector },
				{ "property": 'Instance number', "value" : slot.dynamic.instance_number }
			]);
		}

		// Singe-Page Prefetch Settings
        if(
			properPage.spa_settings['enabled'] == true &&
			properPage.spa_settings['prefetch'] == true
		) {
			slot_data = slot_data.concat([
				{ "property": 'Prefetch enabled', "value" : 1 },
			]);
        }

		this.createTable('#proper-debug-console-cont', slot_data, false);

		// pre element
		var pre = document.createElement('pre');
		pre.innerHTML = JSON.stringify({ "floors": slot.floors }, undefined, 2);
		this.debug_cont_elem.appendChild(pre);

		// Displayed Ad Data
		if(slot.displayed == 1 && Object.keys(slot.displayed_ad).length > 0) {
			// Create Title
			this.createTitleElement('Displayed Ad');

			var dfp_response_time = Math.max(0, ProperMedia.utils.getTimePassed(slot.tracking_times.dfp_sent_ts, slot.tracking_times.dfp_returned_ts));

			var displayed_ad_data = [
				{ "property": 'Bidder',     "value" : slot.displayed_ad.bidder },
				{ "property": 'Media Type', "value" : slot.displayed_ad.type },
				{ "property": 'Size',       "value" : slot.displayed_ad.size },
				{ "property": 'Price',      "value" : slot.displayed_ad.price },
				{ "property": 'Gross',      "value" : slot.displayed_ad.gross },
				{ "property": 'DFP price',  "value" : slot.displayed_ad.dfp_price },
				{ "property": 'Tag ID',     "value" : slot.displayed_ad.tag_id || '' }
			];

			if(
				ProperMedia.utils.deepAccess(properOps, 'bidders.header.'+slot.displayed_ad.bidder) ||
				ProperMedia.utils.deepAccess(properOps, 'bidders.s2s.'+slot.displayed_ad.bidder)
			) {
				displayed_ad_data = displayed_ad_data.concat([
					{ "property": 'Header Response Time', "value" : slot.displayed_ad.response_ms + ' ms'}
				]);
			}

			displayed_ad_data = displayed_ad_data.concat([
				{ "property": 'DFP Response Time', "value" : dfp_response_time + ' ms' }
			]);

			this.createTable('#proper-debug-console-cont', displayed_ad_data, false);

		}
	}

	/*
	 * Create Ad Pool view
	 * @param adPool
	 */
	this.createAdPoolView = function(adPool) {
		var cumbtrail = [
			{
				"text": 'overview',
				"obj" : {}
			},
			{
				"text": 'ad pool',
				"obj" : adPool
			}
		];

		// Create breadcrumb
		this.createBreadcrumb(cumbtrail);
		// Clear html
		this.debug_cont_elem.innerHTML = '';


		// Create Ad Pool Title
		this.createTitleElement('Auctions');

		// Page ad Pool
		var auction_cont_elem = document.createElement('div');
        $(auction_cont_elem).addClass('proper-debug-auction-cont');
        this.debug_cont_elem.appendChild(auction_cont_elem);

        Object.keys(adPool.finished_auctions).forEach(function(auction_index) {
            var auction = adPool.finished_auctions[auction_index];

            var background_color = (auction.bids_sent) ? '#00800087' : '#ff000070';

            var auction_elem = document.createElement('button');
            $(auction_elem).addClass('proper-debug-auction-cell');
            // auction_elem.style.cssText = 'border: 2px solid black; padding: 4px; margin: 4px; width: fit-content; display: inline-block; cursor: pointer; background: ' + background_color;
            $(auction_elem).html('Auction ' + auction.auction_num);

            $(auction_elem).on('click', (function() {
    			this.createAuctionView(auction, adPool);
            }).bind(this));

        	auction_cont_elem.appendChild(auction_elem);

	    }, this);

		Object.keys(adPool.auctions).forEach(function(auction_index) {
            var auction = adPool.auctions[auction_index];

            var background_color = (auction.bids_sent) ? '#00800087' : '#ff000070';

            var auction_elem = document.createElement('button');
            $(auction_elem).addClass('proper-debug-auction-cell');
            // auction_elem.style.cssText = 'border: 2px solid black; padding: 4px; margin: 4px; width: fit-content; display: inline-block; cursor: pointer; background: ' + background_color;
            $(auction_elem).html('Auction ' + auction.auction_num);

            $(auction_elem).on('click', (function() {
    			this.createAuctionView(auction, adPool);
            }).bind(this));

        	auction_cont_elem.appendChild(auction_elem);

	    }, this);

		// hr element
		this.debug_cont_elem.appendChild(document.createElement('hr'));

		// Create Bidders Title
		this.createTitleElement('Bidders');

		// Bidders
		var bidders_cont_elem = document.createElement('div');
        $(bidders_cont_elem).addClass('proper-debug-bidders-cont');
        this.debug_cont_elem.appendChild(bidders_cont_elem);

        Object.keys(properOps.bidders).forEach(function(bidder_type) {
			Object.keys(properOps.bidders[bidder_type]).forEach(function(bidder_name) {
                var bidder = properOps.bidders[bidder_type][bidder_name];

	            // var background_color = (bidder.enabled) ? '#00800087' : '#ff000070';

	            var bidder_elem = document.createElement('div');
	            $(bidder_elem).addClass('proper-debug-bidder-cell');
				if(!bidder.enabled) $(bidder_elem).addClass('red');
	            $(bidder_elem).html(bidder_name);

	        	bidders_cont_elem.appendChild(bidder_elem);
	        }, this);
	    }, this);

		// hr element
		this.debug_cont_elem.appendChild(document.createElement('hr'));


		// Create Title
		this.createTitleElement('Bids (' + adPool.ads.length + ')');

	    // Ad Pool bids
		var ad_pool_ad_data = [];
		for (var i = 0; i < adPool.ads.length; i++) {
			var ad = adPool.ads[i];
			 ad_pool_ad_data.push(
				{
					"bidder"     : ad.bidder,
					"type"       : ad.type,
					"size"       : ad.size,
					"gross"      : ad.gross,
					"price"      : ad.price,
					"dfp_price"  : ad.dfp_price,
					"tag_id"     : ad.tag_id,
					"response_ms": ad.response_ms,
					"ttl"        : ad.ttl
				}
			);
		}

		this.createTable('#proper-debug-console-cont', ad_pool_ad_data, true);


		// Create Title
		this.createTitleElement('Displayed Bids');

	    // Ad Pool bids
		ad_pool_ad_data = [];
		for (var i = 0; i < adPool.displayed_ads.length; i++) {
			var ad = adPool.displayed_ads[i];
			 ad_pool_ad_data.push(
				{
					"bidder"     : ad.bidder,
					"type"       : ad.type,
					"size"       : ad.size,
					"gross"      : ad.gross,
					"price"      : ad.price,
					"dfp_price"  : ad.dfp_price,
					"tag_id"     : ad.tag_id,
					"response_ms": ad.response_ms,
					"ttl"        : ad.ttl
				}
			);
		}

		this.createTable('#proper-debug-console-cont', ad_pool_ad_data, true);
	}


	/*
	 * Create auction view
	 * @param auction auctionObj
	 */
	this.createAuctionView = function(auction) {
		var cumbtrail = [
			{
				"text": 'overview',
				"obj" : {}
			},
			{
				"text": 'ad pool',
				"obj" : properAdPool
			},
			{
				"text": 'auction',
				"obj" : auction
			}
		];

		// Create breadcrumb
		this.createBreadcrumb(cumbtrail);
		// Clear html
		this.debug_cont_elem.innerHTML = '';

		// Create Title
		this.createTitleElement('Auction Data');

	    var auction_data = [
	    	{ "property": 'Network Requests',     "value" : auction.requests_sent },
			{ "property": 'Bids returned / sent', "value" : auction.bids_returned + ' / ' + auction.bids_sent },
			{ "property": 'Bids sent',            "value" : auction.bids_started_ts ? 1 : 0 },
			{ "property": 'Bids ready',           "value" : auction.bids_done_ts ? 1 : 0 },
			{ "property": 'Auction ms',           "value" : auction.calcAuctionMs() },
			{ "property": 'Max timeout',          "value" : auction.max_timeout }
		];

		this.createTable('#proper-debug-console-cont', auction_data, false);

		// Slot bids
		this.createTitleElement('Bids');

		var bid_data = [];
		if(Object.keys(auction.bids).length > 0) {
			Object.keys(auction.bids).forEach(function(bidder) {
				var bidder_bids = auction.bids[bidder];
				if(bidder_bids.responses.length > 0) {
					for (var i = 0; i < bidder_bids.responses.length; i++) {
						var ad = bidder_bids.responses[i];
					 	bid_data.push({
							"displayed"  : ad.displayed,
							"bidder"     : ad.bidder,
							"type"       : ad.type,
							"size"       : ad.size,
							"gross"      : ad.gross,
							"price"      : ad.price,
							"dfp_price"  : ad.dfp_price,
							"tag_id"     : ad.tag_id,
							"response ms": ad.response_ms,
							"ttl"        : ad.ttl
						});
					}
				}
			});
		}

		this.createTable('#proper-debug-console-cont', bid_data, true);
	}

	/*
	 * Create Page view
	 * @param selector	String  html css selector
	 * @param data 	Array	array of data to show in tabke
	 * @param show_headers	boolean	If header column should be added to table
	 */
	this.createTable = function(selector, data, show_headers) {

		buildHtmlTable();

		var table;

		function buildHtmlTable() {

			table = document.createElement('table');
			$(table).addClass('proper-debug-table');
			table.style.cssText = 'margin: 5px;';
			$(selector).append(table);

			var columns = addAllColumnHeaders();

			for (var i = 0; i < data.length; i++) {
				var row = document.createElement('tr');
				for (var colIndex = 0; colIndex < columns.length; colIndex++) {
					var cellValue = data[i][columns[colIndex]];
					if (cellValue == null) {
						cellValue = "";
					}
					var td = document.createElement('td');
					td.style.cssText = 'padding: 5px;';
					td.innerHTML = cellValue;
					$(row).append(td);
				}
				$(table).append(row);
			}
		}

		// Adds a header row to the table and returns the set of columns.
		// Need to do union of keys from all records as some records may not contain
		// all records.
		function addAllColumnHeaders() {
			var columnSet = [];
			var headerTr = document.createElement('tr');

			for (var i = 0; i < data.length; i++) {
				var rowHash = data[i];
				for (var key in rowHash) {
					if (columnSet.includes(key) == false) {
						columnSet.push(key);
						var th = document.createElement('th');
						th.innerHTML = key;
						$(headerTr).append(th);
					}
				}
			}
			if(show_headers == true) {
				$(table).append(headerTr);
			}

			return columnSet;
		}

	}


	/*
	 * Make console resizable
	 */
	this.setDragAndResizeActions = function() {

		var minimum_size     = 20;
		var original_height  = 0;
		var original_width	 = 0;
		var original_y       = 0;
		var original_mouse_y = 0;
		var original_x       = 0;
		var original_mouse_x = 0;

		var element 		 = this.debug_console_elem;
		var currentResizer 	 = this.resize_elem;

		var currentDragBar 	 = this.breadcrumb_elem;

		currentResizer.addEventListener('mousedown', function(e) {
			e.preventDefault();

			original_height = parseFloat(getComputedStyle(element, null).getPropertyValue('height').replace('px', ''));
			original_width  = parseFloat(getComputedStyle(element, null).getPropertyValue('width').replace('px', ''));

			original_y = element.getBoundingClientRect().top;
			original_mouse_y = e.pageY;

			original_x = element.getBoundingClientRect().left;
			original_mouse_x = e.pageX;

			window.addEventListener('mousemove', resize)
			window.addEventListener('mouseup', stopResize)
		})

		currentDragBar.addEventListener('mousedown', function(e) {
			e.preventDefault();

			original_y = element.getBoundingClientRect().top;
			original_mouse_y = e.pageY;

			original_x = element.getBoundingClientRect().left;
			original_mouse_x = e.pageX;

			window.addEventListener('mousemove', dragTo)
			window.addEventListener('mouseup', stopDrag)

		})

		function resize(e) {

			var height = original_height + (e.pageY - original_mouse_y)
			var width = original_width + (e.pageX - original_mouse_x)

			if (height > minimum_size) {
				element.style.height = height + 'px'
				//element.style.top = original_y + (e.pageY - original_mouse_y) + 'px'
			}

			if (width > minimum_size) {
				element.style.width = width + 'px'
				//element.style.left = original_x + (e.pageX - original_mouse_x) + 'px'
			}
		}

		function dragTo(e) {

			console.log(original_y,original_mouse_y)

			element.style.top = original_y + (e.pageY - original_mouse_y) + 'px'
			element.style.left = original_x + (e.pageX - original_mouse_x) + 'px'

		}

		function stopResize() {
			window.removeEventListener('mousemove', resize)
		}
		function stopDrag() {
			window.removeEventListener('mousemove', dragTo)
		}
	}



	this.css_values = {

		fontMedium: '12px',
		fontLarge: '16px',

		maxZ: 2147483647,

		purple: 	'#2C3050',
		purpleLight:'#555F9E',
		purpleDark: '#1A1D3E',

		green: 		'#44B558',
		greenLight: '#57EB73',
		greenDark: 	'#008C2B',

		grayLight: 	'#f6f8fa',
		grayDark:	'#3b565d',


	}



	this.debug_console_css = '\
		@keyframes console-tween-in {\
			from {left: -500px}\
			to {left: 15px}\
		}\
		#proper-debug-console {\
			background: ' + this.css_values.grayLight + ';\
			z-index: ' + this.css_values.maxZ + ';\
			position: fixed;\
			top: 15px;\
			left: 15px;\
			width: calc(100% - 30px);\
			overflow: auto;\
			height: 500px;\
			width: 600px;\
			border-radius: 5px;\
			color:' + this.css_values.grayDark + ';\
			font-size:12px;\
			max-width: calc(100vw - 30px);\
			box-shadow: 0 0 0 7px rgba(255,255,255,0.7), 0 10px 10px 0 rgba(0,0,0,0.65), inset 0 -4px 0 0 white;\
			animation: console-tween-in 500ms ease-out;\
		}#proper-debug-console.short {\
			height:250px;\
		}#proper-debug-console-cont {\
			padding: 8px 8px;\
		}\
		#proper-debug-console-resizer {\
			width: 12px;\
			height: 20px;\
			position: sticky;\
			z-index: 9999999;\
			background: white;\
			color: gray;\
			font-size:16px;\
			display:flex;\
			align-items:center;\
			justify-content:center;\
			cursor: nwse-resize;\
			top:calc(100% - 20px);\
			left:calc(100% - 12px);\
			margin-bottom: -20px;\
		}\
		#proper-debug-console-breadcrumb {\
			font-weight: bold;\
			border-radius: 6px 6px 0 0;\
			padding-left: 11px;\
			background: ' + this.css_values.purple + ';\
			position: sticky;\
			top:0;\
			z-index: 999;\
			cursor: move;\
			box-shadow:inset 0 0 0 4px ' + this.css_values.grayLight + ';\
			display:flex;\
			height:50px;\
		}.proper-debug-breadcrumb {\
			margin: 0px 3px;\
			cursor: pointer;\
			display:block;\
			color:white;\
		}.proper-debug-breadcrumb:not(:last-of-type){\
			opacity:0.7;\
		}\
		#proper-debug-console-breadcrumb > * {\
			display:flex;\
			align-items:center;\
			text-transform: capitalize;\
		}.proper-debug-breadcrumb-spacer {\
			margin-right:3px;\
		}.proper-debug-breadcrumb-spacer:after {\
			content:\'\';\
			width: 4px;\
			height:4px;\
			border-top: solid 1px white;\
			border-right: solid 1px white;\
			transform: rotate(45deg);\
			opacity:0.7;\
		}\
		.proper-debug-close-console-btn {\
			padding: 4px;\
			margin: 0 12px 0 auto;\
			cursor: pointer;\
			display: inline-block;\
			float: right;\
			font-size:21px;\
			font-family:\'Futura\', sans-serif !important;\
			font-weight:normal;\
			color: white;\
		}\
		#proper-debug-console-cont {\
			display:flex;\
			flex-direction:column;\
		}#proper-debug-console-cont > * {\
			flex: 1 1 100%;\
			margin:6px 0 0 0 !important;\
			padding:0;\
		}\
		.proper-debug-overlay-text {\
			text-align: left;\
			z-index: ' + (this.css_values.maxZ - 1) + ';\
			padding: 4px 8px 8px 8px;\
			position: absolute;\
			top: 0px;\
			left: 0px;\
			opacity: .90;\
			background: ' + this.css_values.greenLight + ';\
			font-size: ' + this.css_values.fontMedium + ';\
			line-height: 1.3em;\
			color: black;\
		}\
		.proper-debug-overlay-background {\
			cursor: pointer;\
			box-shadow: 0 0 0 4px ' + this.css_values.greenLight + ';\
			z-index: ' + (this.css_values.maxZ - 2) + ';\
			position: absolute;\
			top: 0px;\
			bottom: 0px;\
			left: 0px;\
			right: 0px;\
			max-width: calc(100vw - 8px);\
			margin:0 auto;\
		}\
		.proper-debug-page-slot-cell {\
			border: 2px solid black;\
			padding: 4px;\
			margin: 4px;\
			width: fit-content;\
			display: inline-block;\
			cursor: pointer;\
		}.proper-debug-page-slot-cell.active {\
			background:' + this.css_values.greenLight + ' !important\
		}\
		.proper-debug-state-cell,\
		.proper-debug-bidder-cell {\
			padding: 4px 6px 4px 18px;\
			margin: 4px;\
			width: fit-content;\
			display: inline-block;\
			position:relative;\
			background: white;\
			border-radius:30px;\
			box-shadow: 0 1px 5px 0 rgba(0,0,0,0.1);\
		}.proper-debug-state-cell:before,\
		.proper-debug-bidder-cell:before{\
			content:\'\';\
			width:8px;\
			height:8px;\
			position: absolute;\
			left: 5px;\
			top: 6px;\
			z-index:3;\
			margin-right:5px;\
			background-image: linear-gradient(' + this.css_values.greenLight + ',' + this.css_values.greenDark + ');\
			border-radius: 5px;\
			box-shadow: inset 0 0 2px 0 ' + this.css_values.greenLight + ';\
		}.proper-debug-state-cell.red,\
		.proper-debug-bidder-cell.red {\
			color:red;\
		}.proper-debug-state-cell.red:before,\
		.proper-debug-bidder-cell.red:before {\
			background:red;\
			box-shadow:none;\
		}\
		.proper-debug-state-cell{\
			border-radius:0;\
		}.proper-debug-state-cell:first-of-type {\
			border-radius: 30px 0 0 30px;\
		}\
		.proper-debug-state-cell:last-of-type {\
			border-radius: 0 30px 30px 0;\
		}.proper-debug-state-cell:first-of-type:last-of-type{\
			border-radius: 30px;\
		}\
		.proper-debug-state-cell:not(:last-of-type) {\
			margin-right:-2px;\
		}\
		.proper-ad-unit,\
		.proper-ad-insert {\
			background: ' + this.css_values.greenDark + 'AA;\
		}.proper-ad-unit:hover,\
		.proper-ad-insert:hover {\
			background: ' + this.css_values.greenLight + ';\
		}\
		#proper-debug-console table {\
			border-top: solid 2px ' + this.css_values.purple + ';\
			background:white;\
			border-bottom: solid 1px #ccc;\
			line-height:1.4em;\
		}#proper-debug-console table td:not(:first-of-type){\
			border-left: solid 1px #ccc;\
		}#proper-debug-console table td:first-of-type{\
			min-width:100px;\
			background:white;\
			width:1px;\
			font-weight:bold;\
		}#proper-debug-console table th {\
			font-weight:bold;\
			border-bottom:solid 1px #cccccc80;\
		}\
		#proper-debug-console hr {\
			border:none;\
			border-bottom: solid 1px ' + this.css_values.grayDark + ';\
			opacity:0.3;\
		}\
		#proper-debug-console button {\
			-webkit-appearance:none;\
			cursor:pointer;\
			border:none;\
			border-radius: 4px;\
			padding: 5px 9px;\
			font-weight:bold;\
			color:white;\
			background:' + this.css_values.green + ';\
			display:inline-block;\
		}#proper-debug-console button:not(:hover) {\
			opacity:0.9;\
		}\
		#proper-debug-console button.red {\
			background:red;\
		}';
}

    var consentManager = (function() {

	var status = {
		gdpr: false,
		uspc: false
	}

	var pendingWaiters = [];
    var consentManager = {
        cmpPresent: null,
        ready: function(callback) { 
            pendingWaiters.push(callback); 
        },
        consentReady: function(type) {
        	status[type] = true;
        	if(
                (type == 'gdpr' && gdprConsent && gdprConsent.gdprApplies) ||
                (type == 'uspc' && uspConsent && uspConsent.cmpApplies) ||
                (ProperMedia.utils.objectValues(status).filter(function(value) { return (value == false) }).length == 0)
            ) {
                callPendingWaiters();
        	}
        }
    };

	function callPendingWaiters() {
        consentManager.ready = function(callback) { callback(consentManager); };
        pendingWaiters.forEach(consentManager.ready);
        pendingWaiters.length = 0;
    }

    return consentManager;

})()
    /**
 * This module adds USPAPI (CCPA) consentManagement support to prebid.js. It
 * interacts with supported USP Consent APIs to grab the user's consent
 * information and make it available for any USP (CCPA) supported adapters to
 * read/pass this information to their system.
 */
var uspConsent = (function() {

    var DEFAULT_CONSENT_TIMEOUT = 50,
        USPAPI_VERSION = 1;

    var consentTimeout = DEFAULT_CONSENT_TIMEOUT,
        timer;

    var pendingWaiters = [];
    var uspConsent = {
        cmpPresent: null
    };

    var fail_count = 0,
        timeoutHandler = null;

    function checkCmpApplies() {
        return (uspConsent.usPrivacy && uspConsent.usPrivacy.match(/^\d{1}[\w-]{1}Y[\w-]{1}$/)) ? true : false;
    }

    lookupUspConsent(processUspData, uspapiFailed);
    if (consentTimeout === 0) {
        processUspData(undefined, hookConfig);
    } else {
        timer = setTimeout(uspapiTimeout, consentTimeout);
    }

    /**
     * This function handles interacting with an USP compliant consent manager to obtain the consent information of the user.
     * Given the async nature of the USP's API, we pass in acting success/error callback functions to exit this function
     * based on the appropriate result.
     * @param {function(string)} uspSuccess acts as a success callback when USPAPI returns a value; pass along consentObject (string) from USPAPI
     * @param {function(string)} uspError acts as an error callback while interacting with USPAPI; pass along an error message (string)
     */
    function lookupUspConsent(uspSuccess, uspError) {
        function handleUspApiResponseCallbacks() {
            var uspResponse = {};

            function afterEach() {
                if (uspResponse.usPrivacy) {
                    uspSuccess(uspResponse);
                } else {
                    uspError('Unable to get USP consent string.');
                }
            }

            return {
                consentDataCallback: function(consentResponse, success) {
                    if (success && consentResponse.uspString) {
                        uspResponse.usPrivacy = consentResponse.uspString;
                    }
                    afterEach();
                }
            };
        }

        var callbackHandler = handleUspApiResponseCallbacks();
        var uspapiCallbacks = {};

        // to collect the consent information from the user, we perform a call to USPAPI
        // to collect the user's consent choices represented as a string (via getUSPData)

        // the following code also determines where the USPAPI is located and uses the proper workflow to communicate with it:
        // - use the USPAPI locator code to see if USP's located in the current window or an ancestor window. This works in friendly or cross domain iframes
        // - if USPAPI is not found, the iframe function will call the uspError exit callback to abort the rest of the USPAPI workflow
        // - try to call the __uspapi() function directly, otherwise use the postMessage() api
        // find the CMP frame/window

        try {
            // try to call __uspapi directly
            uspConsent.cmpPresent = true;
            window.__uspapi('getUSPData', USPAPI_VERSION, callbackHandler.consentDataCallback);
        } catch (e) {
            // must not have been accessible, try using postMessage() api
            var f = window;
            var uspapiFrame;
            while (!uspapiFrame) {
                try {
                    if (f.frames['__uspapiLocator']) uspapiFrame = f;
                } catch (e) { }
                if (f === window.top) break;
                f = f.parent;
            }

            if (!uspapiFrame) {
                uspConsent.cmpPresent = false;
                return uspError('USP CMP not found.');
            }
            callUspApiWhileInIframe('getUSPData', uspapiFrame, callbackHandler.consentDataCallback);
        }
        console.log('USP CMP found.');
        
        function callUspApiWhileInIframe(commandName, uspapiFrame, moduleCallback) {
            /* Setup up a __uspapi function to do the postMessage and stash the callback.
            This function behaves, from the caller's perspective, identicially to the in-frame __uspapi call (although it is not synchronous) */
            window.__uspapi = function (cmd, ver, callback) {
                var callId = Math.random() + '';
                var msg = {
                    __uspapiCall: {
                        command: cmd,
                        version: ver,
                        callId: callId
                    }
                };

                uspapiCallbacks[callId] = callback;
                uspapiFrame.postMessage(msg, '*');
            }

            /** when we get the return message, call the stashed callback */
            window.addEventListener('message', readPostMessageResponse, false);

            // call uspapi
            window.__uspapi(commandName, USPAPI_VERSION, uspapiCallback);

            function readPostMessageResponse(event) {
                var res = event && event.data && event.data.__uspapiReturn;
                if (res && res.callId) {
                    if (typeof uspapiCallbacks[res.callId] !== 'undefined') {
                        uspapiCallbacks[res.callId](res.returnValue, res.success);
                        delete uspapiCallbacks[res.callId];
                    }
                }
            }

            function uspapiCallback(consentObject, success) {
                window.removeEventListener('message', readPostMessageResponse, false);
                moduleCallback(consentObject, success);
            }
        }
    }

    /**
     * This function checks the consent data provided by USPAPI to ensure it's in an expected state.
     * If it's bad, we exit the module depending on config settings.
     * If it's good, then we store the value and exits the module.
     * @param {object} consentObject required; object returned by USPAPI that contains user's consent choices
     */
    function processUspData(consentObject) {
        var valid = !!(consentObject && consentObject.usPrivacy);
        if (!valid) {
            uspapiFailed("USPAPI returned unexpected value during lookup process.", consentObject);
            return;
        }
        clearTimeout(timer);
        storeUspConsentData(consentObject);
    }

    /**
     * General timeout callback when interacting with USPAPI takes too long.
     */
    function uspapiTimeout() {
        consentManager.consentReady('uspc');
        uspapiFailed('USPAPI workflow exceeded timeout threshold.');
    }

    /**
     * This function contains the controlled steps to perform when there's a problem with USPAPI.
     * @param {string} errMsg required; should be a short descriptive message for why the failure/issue happened.
     * @param {object} extraArgs contains additional data that's passed along in the error/warning messages for easier debugging
    */
    function uspapiFailed(errMsg, extraArgs) {
        console.log(errMsg);
        fail_count++;
        if(fail_count > 2 || uspConsent.cmpPresent) {
            clearTimeout(timer);
            consentManager.consentReady('uspc');
        } else {
            timeoutHandler = setTimeout(function() { lookupUspConsent(processUspData, uspapiFailed);}, 50);
        }
    }

    /**
     * Stores USP data locally in module and then invokes uspDataHandler.setConsentData() to make information available in adaptermanger.js for later in the auction
     * @param {object} cmpConsentObject required; an object representing user's consent choices (can be undefined in certain use-cases for this function only)
     */
    function storeUspConsentData(consentObject) {
        console.log('Received a response from CMP', consentObject);
        if (consentObject && consentObject.usPrivacy) {
            uspConsent.usPrivacy  = consentObject.usPrivacy;
            uspConsent.cmpApplies = checkCmpApplies();
        }
        consentManager.consentReady('uspc');
    }

    /**
    * A configuration function that initializes some module variables, as well as add a hook into the requestBids function
    * @param {object} config required; consentManagementUSP module config settings; usp (string), timeout (int), allowAuctionWithoutConsent (boolean)
    */
    function setConsentConfig() {
        if (!properOps.uspConfig || typeof properOps.uspConfig !== 'object') {
            console.log('consentManagement.usp config not defined, exiting usp consent manager');
            return;
        }

        if (ProperMedia.utils.isNumber(properOps.uspConfig.timeout)) {
            consentTimeout = properOps.uspConfig.timeout;
        } else {
            consentTimeout = DEFAULT_CONSENT_TIMEOUT;
            console.log("properOps.uspConfig config did not specify timeout. Using system default setting ("+DEFAULT_CONSENT_TIMEOUT+").");
        }

        console.log('USPAPI uspConsent has been activated...');
    }
    return uspConsent;
})()
    var gdprConsent = (function() {

    var DEFAULT_CMP = 'iab',
        DEFAULT_CONSENT_TIMEOUT = 100,
        DEFAULT_ALLOW_AUCTION_WO_CONSENT = true;

    var consentTimeout = DEFAULT_CONSENT_TIMEOUT,
        timer = null,
        gdprScope = false,
        allowAuction = {
            'value': DEFAULT_ALLOW_AUCTION_WO_CONSENT,
            'definedInConfig': false
        };


    var gdprConsent = {
        cmpVersion: 0,
        gdprApplies: false,
        cmpPresent: null
    };

    var fail_count = 0,
        timeoutHandler = null;

    lookupIabConsent(processCmpData, cmpFailed);
    if (consentTimeout === 0) {
        processCmpData(undefined);
    } else {
        timer = setTimeout(cmpTimedOut.bind(null), consentTimeout);
    }

    /**
     * This function handles interacting with an IAB compliant CMP to obtain the consent information of the user.
     * Given the async nature of the CMP's API, we pass in acting success/error callback functions to exit this function
     * based on the appropriate result.
     * @param {function(string)} cmpSuccess acts as a success callback when CMP returns a value; pass along consentObject (string) from CMP
     * @param {function(string)} cmpError acts as an error callback while interacting with CMP; pass along an error message (string)
     */
    function lookupIabConsent(cmpSuccess, cmpError) {
        function findCMP() {
            var f = window;
            var cmpFrame;
            var cmpFunction;
            while (!cmpFrame) {
                try {
                    if (typeof f.__tcfapi === 'function' || typeof f.__cmp === 'function') {
                        if (typeof f.__tcfapi === 'function') {
                            gdprConsent.cmpVersion = 2;
                            cmpFunction = f.__tcfapi;
                        } else {
                            gdprConsent.cmpVersion = 1;
                            cmpFunction = f.__cmp;
                        }
                        cmpFrame = f;
                        break;
                    }
                } catch (e) { }

                // need separate try/catch blocks due to the exception errors thrown when trying to check for a frame that doesn't exist in 3rd party env
                try {
                    if (f.frames['__tcfapiLocator']) {
                        gdprConsent.cmpVersion = 2;
                        cmpFrame = f;
                        break;
                    }
                } catch (e) { }

                try {
                    if (f.frames['__cmpLocator']) {
                        gdprConsent.cmpVersion = 1;
                        cmpFrame = f;
                        break;
                    }
                } catch (e) { }

                if (f === window.top) break;
                f = f.parent;
            }
            return {
                'cmpFrame': cmpFrame,
                'cmpFunction': cmpFunction
            };
        }

        function v2CmpResponseCallback(tcfData, success) {
            console.log('Received a response from CMP', tcfData, success);
            if (success) {
                if (tcfData.gdprApplies === false || tcfData.eventStatus === 'tcloaded' || tcfData.eventStatus === 'useractioncomplete') {
                    cmpSuccess(tcfData);
                } else if(tcfData.eventStatus === 'cmpuishown') {
                    gdprConsent.gdprApplies = true;
                    clearTimeout(timer);
                }
            } else {
               cmpError('CMP unable to register callback function.  Please check CMP setup.');
            }
        }

        function handleV1CmpResponseCallbacks() {
            var cmpResponse = {};

            function afterEach() {
                if (cmpResponse.getConsentData && cmpResponse.getVendorConsents) {
                    console.log('Received all requested responses from CMP', cmpResponse);
                    cmpSuccess(cmpResponse);
                }
            }

            return {
                consentDataCallback: function (consentResponse) {
                    cmpResponse.getConsentData = consentResponse;
                    afterEach();
                },
                vendorConsentsCallback: function (consentResponse) {
                    cmpResponse.getVendorConsents = consentResponse;
                    afterEach();
                }
            }
        }

        var v1CallbackHandler = handleV1CmpResponseCallbacks();
        var cmpCallbacks = {};

        var cpmData = findCMP(),
            cmpFrame = cpmData.cmpFrame,
            cmpFunction = cpmData.cmpFunction;

        if (!cmpFrame) {
            return cmpError('GDPR CMP not found.');
        } else {
            gdprConsent.cmpPresent = true;
        }
        // to collect the consent information from the user, we perform two calls to the CMP in parallel:
        // first to collect the user's consent choices represented in an encoded string (via getConsentData)
        // second to collect the user's full unparsed consent information (via getVendorConsents)

        // the following code also determines where the CMP is located and uses the proper workflow to communicate with it:
        // check to see if CMP is found on the same window level as prebid and call it directly if so
        // check to see if prebid is in a safeframe (with CMP support)
        // else assume prebid may be inside an iframe and use the IAB CMP locator code to see if CMP's located in a higher parent window. this works in cross domain iframes
        // if the CMP is not found, the iframe function will call the cmpError exit callback to abort the rest of the CMP workflow

        if (ProperMedia.utils.isFn(cmpFunction)) {
            console.log('Detected CMP API is directly accessible, calling it now...');
            if (gdprConsent.cmpVersion === 1) {
                cmpFunction('getConsentData', null, v1CallbackHandler.consentDataCallback);
                cmpFunction('getVendorConsents', null, v1CallbackHandler.vendorConsentsCallback);
            } else if (gdprConsent.cmpVersion === 2) {
                cmpFunction('addEventListener', gdprConsent.cmpVersion, v2CmpResponseCallback);
            }
        } else if (gdprConsent.cmpVersion === 1 && inASafeFrame() && typeof window.$sf.ext.cmp === 'function') {
            // this safeframe workflow is only supported with TCF v1 spec; the v2 recommends to use the iframe postMessage route instead (even if you are in a safeframe).
            console.log('Detected Proper.io is encased in a SafeFrame and CMP is registered, calling it now...');
            callCmpWhileInSafeFrame('getConsentData', v1CallbackHandler.consentDataCallback);
            callCmpWhileInSafeFrame('getVendorConsents', v1CallbackHandler.vendorConsentsCallback);
        } else {
            console.log('Detected CMP is outside the current iframe where Proper.io is located, calling it now...');
            if (gdprConsent.cmpVersion === 1) {
                callCmpWhileInIframe('getConsentData', cmpFrame, v1CallbackHandler.consentDataCallback);
                callCmpWhileInIframe('getVendorConsents', cmpFrame, v1CallbackHandler.vendorConsentsCallback);
            } else if (gdprConsent.cmpVersion === 2) {
                callCmpWhileInIframe('addEventListener', cmpFrame, v2CmpResponseCallback);
            }
        }

        function inASafeFrame() {
            return !!(window.$sf && window.$sf.ext);
        }

        function callCmpWhileInSafeFrame(commandName, callback) {
            function sfCallback(msgName, data) {
                if (msgName === 'cmpReturn') {
                    var responseObj = (commandName === 'getConsentData') ? data.vendorConsentData : data.vendorConsents;
                    callback(responseObj);
                }
            }

            var width  = 1;
            var height = 1;
            window.$sf.ext.register(width, height, sfCallback);
            window.$sf.ext.cmp(commandName);
        }

        function callCmpWhileInIframe(commandName, cmpFrame, moduleCallback) {
            var apiName = (gdprConsent.cmpVersion === 2) ? '__tcfapi' : '__cmp';

            /* Setup up a __cmp function to do the postMessage and stash the callback.
                This function behaves (from the caller's perspective identicially to the in-frame __cmp call */
            window[apiName] = function (cmd, arg, callback) {
                var callId = Math.random() + '';
                var callName = apiName + 'Call';
                var msg = {};

                msg[callName] = {
                    command  : cmd,
                    parameter: arg,
                    callId   : callId
                }
                
                if (gdprConsent.cmpVersion !== 1) msg[callName].version = gdprConsent.cmpVersion;

                cmpCallbacks[callId] = callback;
                cmpFrame.postMessage(msg, '*');
            }

            /** when we get the return message, call the stashed callback */
            window.addEventListener('message', readPostMessageResponse, false);

            // call CMP
            window[apiName](commandName, undefined, moduleCallback);

            function readPostMessageResponse(event) {
                var cmpDataPkgName = apiName+'Return';
                var json = (typeof event.data === 'string' && event.data.includes(cmpDataPkgName)) ? JSON.parse(event.data) : event.data;
                if (json[cmpDataPkgName] && json[cmpDataPkgName].callId) {
                    var payload = json[cmpDataPkgName];
                    // TODO - clean up this logic (move listeners?); we have duplicate messages responses because 2 eventlisteners are active from the 2 cmp requests running in parallel
                    if (typeof cmpCallbacks[payload.callId] !== 'undefined') {
                        cmpCallbacks[payload.callId](payload.returnValue, payload.success);
                    }
                }
            }
        }
    }


    /**
     * This function checks the consent data provided by CMP to ensure it's in an expected state.
     * If it's bad, we exit the module depending on config settings.
     * If it's good, then we store the value and exits the module.
     * @param {object} consentObject required; object returned by CMP that contains user's consent choices
     */
    function processCmpData(consentObject) {
        function checkV1Data(consentObject) {
            var gdprApplies = consentObject && consentObject.getConsentData && consentObject.getConsentData.gdprApplies;
            return !!(
                (
                    typeof gdprApplies !== 'boolean') ||
                    (
                        gdprApplies === true &&
                        !(
                            ProperMedia.utils.isStr(consentObject.getConsentData.consentData) &&
                            ProperMedia.utils.isPlainObject(consentObject.getVendorConsents) &&
                            Object.keys(consentObject.getVendorConsents).length > 1
                        )
                    )
                );
        }

        function checkV2Data() {
            // if CMP does not respond with a gdprApplies boolean, use defaultGdprScope (gdprScope)
            var gdprApplies = consentObject && typeof consentObject.gdprApplies === 'boolean' ? consentObject.gdprApplies : gdprScope;
            var tcString = consentObject && consentObject.tcString;
            return !!(
                (typeof gdprApplies !== 'boolean') ||
                (gdprApplies === true && !ProperMedia.utils.isStr(tcString))
            );
        }

        // determine which set of checks to run based on cmpVersion
        var checkFn = (gdprConsent.cmpVersion === 1) ? checkV1Data : (gdprConsent.cmpVersion === 2) ? checkV2Data : null;

        // Raise deprecation warning if 'allowAuctionWithoutConsent' is used with TCF 2.
        if (allowAuction.definedInConfig && gdprConsent.cmpVersion === 2) {
            console.log("'allowAuctionWithoutConsent' ignored for TCF 2");
        } else if (!allowAuction.definedInConfig && gdprConsent.cmpVersion === 1) {
            console.log("'allowAuctionWithoutConsent' using system default: ("+DEFAULT_ALLOW_AUCTION_WO_CONSENT+".");
        }

        if (ProperMedia.utils.isFn(checkFn)) {
            if (checkFn(consentObject)) {
                cmpFailed("CMP returned unexpected value during lookup process.", consentObject);
            } else {
                clearTimeout(timer);
                storeConsentData(consentObject);
            }
        } else {
            cmpFailed('Unable to derive CMP version to process data.  Consent object does not conform to TCF v1 or v2 specs.', consentObject);
        }
    }

    /**
     * General timeout callback when interacting with CMP takes too long.
     */
    function cmpTimedOut() {
        cmpFailed('CMP workflow exceeded timeout threshold.');
    }

    /**
     * This function contains the controlled steps to perform when there's a problem with CMP.
     * @param {string} errMsg required; should be a short descriptive message for why the failure/issue happened.
     * @param {object} extraArgs contains additional data that's passed along in the error/warning messages for easier debugging
    */
    function cmpFailed(errMsg, extraArgs) {
        console.log(errMsg);
        fail_count++;
        if(fail_count > 2 || gdprConsent.cmpPresent) {
            clearTimeout(timer);
            // still set the consentData to undefined when there is a problem as per config options
            if (allowAuction.value) {
                storeConsentData(undefined);
            }
            consentManager.consentReady('gdpr');
        } else {
            timeoutHandler = setTimeout(function() { lookupIabConsent(processCmpData, cmpFailed);}, 50);
        }
    }

    /**
     * Stores CMP data locally in module and then invokes gdprDataHandler.setConsentData() to make information available in adaptermanager.js for later in the auction
     * @param {object} cmpConsentObject required; an object representing user's consent choices (can be undefined in certain use-cases for this function only)
     */
    function storeConsentData(cmpConsentObject) {
        if (gdprConsent.cmpVersion === 1) {
            gdprConsent.consentString = (cmpConsentObject) ? cmpConsentObject.getConsentData.consentData : undefined;
            gdprConsent.vendorData    = (cmpConsentObject) ? cmpConsentObject.getVendorConsents : undefined;
            gdprConsent.gdprApplies   = (cmpConsentObject) ? cmpConsentObject.getConsentData.gdprApplies : gdprScope;

            /*
            if (gdprConsent.gdprApplies) {
                var purposeConsents = ProperMedia.utils.deepAccess(cmpConsentObject, 'vendorData.purposeConsents');
                if(purposeConsents) {
                    // if no consent for "Personalisation" (used to configure DFP/Adsense/etc)
                    gdprConsent.noPersonalization = !purposeConsents[2];
                    // if no consent for "Storage and access of information" or "Personalisation"...
                    if (!purposeConsents[1] && !purposeConsents[2]) {
                        // disable DFP/Adsense/etc
                        gdprConsent.isolated = true;
                    }
                }
            }*/

        } else {
            gdprConsent.consentString = (cmpConsentObject) ? cmpConsentObject.tcString : undefined;
            gdprConsent.vendorData    = (cmpConsentObject) || undefined;
            gdprConsent.gdprApplies   = cmpConsentObject && typeof cmpConsentObject.gdprApplies === 'boolean' ? cmpConsentObject.gdprApplies : gdprScope;
            
            if (cmpConsentObject && cmpConsentObject.addtlConsent && ProperMedia.utils.isStr(cmpConsentObject.addtlConsent)) {
                gdprConsent.addtlConsent = cmpConsentObject.addtlConsent;
            };
            /*
            if (gdprConsent.gdprApplies) {
                // if no consent for "Personalisation" (used to configure DFP/Adsense/etc)
                var consents = ProperMedia.utils.deepAccess(cmpConsentObject, 'purpose.consents');
                if(consents) {
                    gdprConsent.noPersonalization = !consents[2];
                    // if no consent for "Storage and access of information" or "Personalisation"...
                    if (!consents[1] && !consents[2]) {
                        // disable DFP/Adsense/etc
                        gdprConsent.isolated = true;
                    }
                }
            }*/
        }
        gdprConsent.apiVersion = gdprConsent.cmpVersion;
        consentManager.consentReady('gdpr');
    }

    /**
     * A configuration function that initializes some module variables, as well as add a hook into the requestBids function
     * @param {{cmp:string, timeout:number, allowAuctionWithoutConsent:boolean, defaultGdprScope:boolean}} config required; consentManagement module config settings; cmp (string), timeout (int), allowAuctionWithoutConsent (boolean)
     */
    function setConsentConfig() {
        // if `config.gdpr` or `config.usp` exist, assume new config format.
        // else for backward compatability, just use `config`
        if (!properOps.gdprConfig || typeof properOps.gdprConfig !== 'object') {
            console.log('consentManagement config not defined, exiting consent manager');
            return;
        }

        if (ProperMedia.utils.isNumber(properOps.gdprConfig.timeout)) {
            consentTimeout = properOps.gdprConfig.timeout;
        } else {
            consentTimeout = DEFAULT_CONSENT_TIMEOUT;
            console.log("consentManagement config did not specify timeout.  Using system default setting ("+DEFAULT_CONSENT_TIMEOUT+").");
        }

        if (typeof properOps.gdprConfig.allowAuctionWithoutConsent === 'boolean') {
            allowAuction.value = properOps.gdprConfig.allowAuctionWithoutConsent;
            allowAuction.definedInConfig = true;
        }

        // if true, then gdprApplies should be set to true
        gdprScope = properOps.gdprConfig.defaultGdprScope === true;

        console.log('consentManagement module has been activated...');
    }

    return gdprConsent;

})()


    var confiantWrapper = (function() {

    var confiantWrapper = {

        cdnHost:'clarium.global.ssl.fastly.net',
        confiantId: 'TzdoClhg0h30W2CCYiFFb2rl5ww',
        mapBlockingType: {
            '1': {
                'type': 'manual',
                'desc': 'Deprecated'
            },
            '2': {
                'type': 'creative',
                'desc': 'Creative-based detection'
            },
            '3': {
                'type': 'provider_security',
                'desc': 'Domain-based detection for unsafe domains'
            },
            '4': {
                'type': 'banned_domain',
                'desc': 'Domain-based detection for banned domains'
            },
            '5': {
                'type': 'provider_ibv',
                'desc': 'Domain-based detection for in-banner-video'
            },
            '6': {
                'type': 'unsafejs',
                'desc': 'Javascript-based detection for unsafe ads'
            },
            '7': {
                'type': 'hrap',
                'desc': 'Domain-based detection for high risk ad platform domains'
            }
        },

        loadDFPTag: function(win) {

            win = win || window;

            this.confiantId = properSpecialOps.confiantId || this.confiantId;

            // Load version 2 of confiant
            if(properSpecialOps.confiant_version == 2) {

                var w = win;
                w._clrm = w._clrm || {};
                w._clrm.gpt = {
                    propertyId: this.confiantId,
                    confiantCdn: this.cdnHost,
                    sandbox: 0,
                    mapping: 'W3siaSI6MiwidCI6Int7b319Ont7d319eHt7aH19IiwicCI6MCwiRCI6MSwiciI6W119LHsiaSI6NiwidCI6Int7Y299fTp7e3d9fXh7e2h9fSIsInAiOjUwLCJEIjowLCJyIjpbeyJ0IjoiZXgiLCJzIjpudWxsLCJ2IjoiY28ifV19XQ==',
                    activation: '||neq|NDM5NjA3NDE2,||neq|NDk4NzQ4NDU2,||neq|NTExMjA0NTc2,||neq|ODA2NzU4NTc2,||neq|ODA2NzYxMjE2,||neq|ODEyODU5NjE2,||neq|ODEyODg1Mjk2,||neq|MTU2MTIwNzQ1Ng==',
                    callback: TraceKit.wrap(this.callback.bind(this))
                };
                var e = document.createElement('script');
                e.async = true;
                e.src = '//' + this.cdnHost + '/gpt/a/wrap.js?v2_1';
                win.document.getElementsByTagName('head')[0].appendChild(e);

            // Load Version 3 of confiant
            } else {

                win.confiant = win.confiant || {};
                win.confiant.callback = TraceKit.wrap(this.callback.bind(this));
                
                var e = win.document.createElement('script');
                e.async = true;
                e.src = 'https://confiant-integrations.global.ssl.fastly.net/'+this.confiantId+'/gpt_and_prebid/config.js';
                win.document.getElementsByTagName('head')[0].appendChild(e);
            }
        },

        callback: function(blockingType, blockingId, isBlocked, wrapperId, tagId, impressionData) {

            var slot = {},
                ad   = {
                    cpm      : 0.00,
                    size     : '1x1', 
                    bidder   : 'dfp',
                    blockData: arguments
                };

            if(impressionData && typeof impressionData.dfp !== 'undefined') {

                // Parse Advertiser
                var advertiserId = impressionData.dfp.ad || null;
                var yieldGroup   = impressionData.dfp.y  || null;
                if(advertiserId == properOps.amazon_advertiser) {
                    ad.bidder = "a9";
                } else if(advertiserId == properOps.adsense_advertiser) {
                    ad.bidder = "adsense";
                } else if(advertiserId == properOps.google_advertiser || advertiserId == 1 || advertiserId == null || yieldGroup != null) {
                    ad.bidder = "adx";  
                }

                var dfp_slot = impressionData.dfp.s || (impressionData.dfp.A || '').replace('/'+properOps.dfp_id+'/', '') || '';
                if(dfp_slot) {
                    // Parse out slot name and page number
                    var slot_name = ProperMedia.utils.extractSlotName(dfp_slot);
                    if(properPage && slot_name) {
                        // Get slot object
                        slot = properPage.getSlotFromPageObject(slot_name);
                        if(slot) {

                            // Set ad size
                            ad.size = slot.size;

                            if(ad.bidder == "adx" || ad.bidder == "adsense") { // dynamic allocation
                                var floor = slot.getFloor(slot.size);
                                if(typeof slot.winning_ad !== "undefined" && typeof slot.winning_ad.dfp_price !== "undefined" && slot.winning_ad.dfp_price > floor) {
                                    ad.cpm = parseFloat(slot.winning_ad.dfp_price) + 0.01;
                                } else {
                                    ad.cpm = parseFloat(floor) + 0.01; // if not winning ad, it must have beat the floor at least
                                }
                            }

                            if(isBlocked) {
                                // Get next best bid
                                if(slot.getWinningBid()) {
                                    // show winning ad
                                    showWinningAd(slot); 
                                    return; 
                                }
                            }
                        } else {
                            properLog.mylog("Confiant DFP Callback: Cannnot determin slot.");
                        }
                    } else {
                        properLog.mylog("Confiant DFP Callback: Cannnot determin page.");
                    }
                }
            }
            this.trackBadAd(properPage, ad);
        },        

        wrapTag: function(slot, doc, winning_ad) {
            // Logging
            properLog.mylog('Running confiant: ' + slot.name);

            this.confiantId = properSpecialOps.confiantId || this.confiantId;

            // Confiant functions
            var confiantWrap = TraceKit.wrap(function(a,b,c,d,e){function f(a){return(m(a)||"")[s]("/","_")[s]("+","-")}function g(b,c,d){var e=w+n(b)+"&d="+c,f="err__"+1*new Date;k[f]=d;var g="<"+q+" on"+t+'="void('+f+'())" '+r+'="'+e+'" type="text/java'+q+'" ></'+q+">";a[v](g)}function h(){var c=f(d+"/"+x.k.hb_bidder[0]+":"+x.k.hb_size[0]),h={wh:c,wd:l.parse(l[u](x)),wr:0};g(c,f(l[u](h)),function(){a[v](b.ad)});var i={prebid:{adId:b.adId,cpm:b.cpm}},j={d:h,t:b.ad,cb:e,id:i};k[d]={},k[d][c]=j}var i=b.bidder,j=b.size,k=a.parentWindow||a.defaultView,l=k.JSON,m=k.btoa,n=k.encodeURIComponent;if(!l||!m)return!1;var o="t",p="i",q="script",r="src",s="replace",t="error",u="stringify",v="wr"+p+o+"e",w="https://"+c+"/?wrapper="+n(d)+"&tpid=",x={k:{hb_bidder:[i],hb_size:[j]}};return h(),a.close(),!0});
            // Callback for blocked bad ad
            var callback = TraceKit.wrap(function(blockingType, blockingId, isBlocked, wrapperId, tagId, impressionData) {

                var ad = {
                    cpm      : winning_ad.price,
                    size     : winning_ad.size, 
                    bidder   : winning_ad.bidder,
                    blockData: arguments
                };

                if(isBlocked) {
                    // Logging
                    properLog.mylog('Confiant blocked ad: ' + slot.name + ' - ' + ad.bidder);

                    // Reset winning ad and get rid of bad ad
                    slot.winning_ad = {};
                    // Get next best bid
                    if(slot.getWinningBid()) {
                        // show winning ad
                        showWinningAd(slot); 
                        return; 
                    }
                }
                this.trackBadAd(properPage, ad);
            });

            // Do the actual ad serving and fall back on document.write if failure
            var bid = { 
                bidder: winning_ad.bidder, 
                size: winning_ad.size, 
                ad: winning_ad.adcode
            }

            if (!confiantWrap(doc, bid, this.cdnHost, this.confiantId, callback.bind(this))) {
                properLog.mylog('confiant failed: '+slot.name);
                doc.write(ad.adcode);
            }
        },

        trackBadAd: function(page, ad) {
            try {
                var postData = {
                    'client_timestamp' : new Date().getTime(),
                    'event_type'       : 'rogue_ad', 
                    'event_id'         : ProperMedia.utils.generateUUID(),
                    'page_id'          : ProperMedia.utils.generateUUID(),
                    'session_id'       : ProperMedia.utils.generateUUID(),
                    'bidder'           : ad.bidder || '',
                    'user_id'          : ProperMedia.utils.validateValue(properUser.pubcid, {'type':'string'}),
                    'publisher'        : ProperMedia.utils.validateValue(properOps.site_name, {'type':'string'}),
                    'rtp_file_version' : ProperMedia.utils.validateValue(properOps.rtp_file_version, {'type':'string'}),
                    'ad_project_tag'   : ProperMedia.utils.validateValue(properOps.rtp_file_revision, {'type':'string'}),
                    'page_url'         : getPageUrl() || '',
                    'in_iframe'        : (properOps.run_dfp_in_window !== 1) ? true : false,
                    'is_https'         : ('https:' == document.location.protocol) ? true : false,
                    'user_agent'       : navigator.userAgent || '',
                    'stack_trace'      : JSON.stringify(ad),
                    'error_message'    : this.mapBlockingType[ad.blockData[0]].desc || 'Confiant Flagged Ad',
                    'error_name'       : this.mapBlockingType[ad.blockData[0]].type || 'rogue_ad'
                }
                    
                // Set page uuid
                if(page.uuid && page.uuid !== '') {
                    postData['page_id'] = page.uuid;
                }

                // Set session id
                if(ProperMedia.utils.deepAccess(properSession, 'sessionData.uuid')) {
                    postData['session_id'] = properSession.sessionData.uuid;
                }

                //send request
                $.ajax({
                    url: "https://events.proper.io/api/event",
                    requestType: "fetch",
                    method: "POST",
                    data: JSON.stringify(postData),
                    withCredentials: false,
                    success: function(resp) {
                        console.log("Proper exception logged successfully.");
                    },
                    error: function() {
                        console.error("Unable to log Proper exception.");
                    }
                });
            } catch (e) {
                console.error("Error sending exception data");
                console.error(e);
            }
        }
    }
    return confiantWrapper;
})();
    var adLightningWrapper = (function() {

    var adLightningWrapper = {

        clientId: 'properio',

        loadDFPTag: function(win) {

            win = win || window;

            this.clientId = ProperMedia.utils.deepAccess(properSpecialOps, 'adlightning.clientId') || this.clientId;
            
            var e = win.document.createElement('script');
            e.async = true;
            e.src = 'https://tagan.adlightning.com/' + this.clientId + '/op.js';
            win.document.getElementsByTagName('head')[0].appendChild(e);
        },

        addReportAd: function(event) {
            try {
                var adId = event.slot.getSlotElementId();

                var adReportDialogSelector = ProperMedia.utils.makeid(10) + '-' + adId;

                var addParentReporterDiv = document.createElement('div');
                addParentReporterDiv.id = adReportDialogSelector;
                addParentReporterDiv.className = 'adl-report-ad-container-parent';

                var buttonDiv = document.createElement('div');
                buttonDiv.className = 'adl-report-ad-container';

                var createReportBtnEvent = {
                    "adlAction": 'createUserReportButton',
                    "selector" : '#' + adReportDialogSelector,
                    "uniqueId" : event.creativeId || event.sourceAgnosticCreativeId,
                    "targetAd" : adId
                };

                addParentReporterDiv.appendChild(buttonDiv);

                var adContainer = document.getElementById(adId);

                // Remove adl-report-ad-container-parent if exists
                var adContainerParent = adContainer.parentElement.getElementsByClassName("adl-report-ad-container-parent");
                if(adContainerParent && adContainerParent.length) {
                    adContainerParent[0].remove();
                }

                if(adContainer) { 
                    adContainer.insertAdjacentElement("afterend", addParentReporterDiv);
                    window.postMessage(createReportBtnEvent, '*');
                }
            } catch(e) {
                properLog.mylog('Error creating Ad Lightning report ad button. ' + JSON.stringify(e) );
            }

        }
    }
    return adLightningWrapper;
})();

    // END IMPORT OBJECTS
    //~~~~~~~~~~~~~~~~~~~~

    //~~~~~~~~~~~~~~~~~
    //   GLOBAL VARS

    var bidAdapters      = {},
        userIdAdapters   = {},
        properLog        = new logObj(),
        properOps        = new optionsObj(),
        properSession    = new sessionObj(),
        properDevice     = new deviceObj(),
        properUser       = new userObj(),
        cookieMatching   = new cookieMatchingObj(),
        properPage       = new pageObj(),
        properAdPool     = new adPoolObj(),
        debugObj         = new debugConsole();

    // IDENTITY ADAPTERS
    /** 
 * PubCommonId Object
 */
var pubCommonId = (function() {

    var ID_NAME         = '_pubcid';
    var OPTOUT_NAME     = '_pubcid_optout';
    var DEFAULT_EXPIRES = 525600; // 1-year worth of minutes
    var PUB_COMMON      = 'PublisherCommonId';
    var EXP_SUFFIX      = '_exp';
    var COOKIE          = 'cookie';
    var LOCAL_STORAGE   = 'localstorage';

    function pubCommonId() {
        this.name     = 'pubcid';
        this.source   = 'pubcid.org';
        this.atype    = 1;
        this.config = {
            "enabled": true,
            "create" : true,
            "extend" : true
        };
        this.storage = {
            "type": LOCAL_STORAGE,
            "name": ID_NAME,
            "expires": DEFAULT_EXPIRES
        };
        this.idObj    = {};
        this.callback = null;
    }


    /**
     * decode the stored id value for passing to bid requests
     * @function
     * @param {string} value
     * @returns {{idl_env:string}}
     */
    pubCommonId.prototype.decode = function(value) {
        return { 'pubcid': value }
    }

    pubCommonId.prototype.getValue = function(data) {
        return data['pubcid']
    }

    pubCommonId.prototype.init = function () {
        if(ProperMedia.utils.localStorageIsEnabled()) {
            this.storage.type = LOCAL_STORAGE;
        } else if(ProperMedia.utils.cookiesAreEnabled()) {
            this.storage.type = COOKIE;
        } else {
            this.storage.type = null;
        }
        this.getId();
    }

    /**
     * Set an item in the storage with expiry time.
     * @param {string} key Key of the item to be stored
     * @param {string} val Value of the item to be stored
     * @param {number} expires Expiry time in minutes
     */
    function setStorageItem(key, val, expires) {
        try {
            if (expires !== undefined && expires != null) {
                var expStr = (new Date(Date.now() + (expires * 60 * 1000))).toUTCString();
                ProperMedia.utils.setDataInLocalStorage(key + EXP_SUFFIX, expStr);
            }
            ProperMedia.utils.setDataInLocalStorage(key, val);
        } catch (e) {
            properLog.mylog(JSON.stringify(e));
        }
    }

    /**
     * Retrieve an item from storage if it exists and hasn't expired.
     * @param {string} key Key of the item.
     * @returns {string|null} Value of the item.
     */
    function getStorageItem (key) {
        var val = null;

        try {
            var expVal = ProperMedia.utils.getDataFromLocalStorage(key + EXP_SUFFIX);

            if (!expVal) {
                // If there is no expiry time, then just return the item
                val = ProperMedia.utils.getDataFromLocalStorage(key);
            } else {
                // Only return the item if it hasn't expired yet.
                // Otherwise delete the item.
                var expDate = new Date(expVal);
                var isValid = (expDate.getTime() - Date.now()) > 0;
                if (isValid) {
                    val = ProperMedia.utils.getDataFromLocalStorage(key);
                } else {
                    removeStorageItem(key);
                }
            }
        } catch (e) {
            properLog.mylog(JSON.stringify(e));
        }

        return val;
    }

    /**
    * Remove an item from storage
    * @param {string} key Key of the item to be removed
    */
    pubCommonId.prototype.removeStorageItem = function(key) {
        try {
            ProperMedia.utils.removeDataFromLocalStorage(key + EXP_SUFFIX);
            ProperMedia.utils.removeDataFromLocalStorage(key);
        } catch (e) {
            properLog.mylog(JSON.stringify(e));
        }
    }

    /**
     * Read a value either from cookie or local storage
     * @param {string} name Name of the item
     * @param {string} type storage type override
     * @returns {string|null} a string if item exists
     */
    pubCommonId.prototype.readValue = function(name, type) {
        var value;
        if (!type) { 
            type = this.storage.type; 
        }
        if (type === COOKIE) {
            value = userIds.getCookie(name);
        } else if (type === LOCAL_STORAGE) {
            value = getStorageItem(name);
        }

        if (value === 'undefined' || value === 'null') { return null; }

        return value;
    }

    /**
     * Write a value to either cookies or local storage
     * @param {string} name Name of the item
     * @param {string} value Value to be stored
     * @param {number} expInterval Expiry time in minutes
     */
    pubCommonId.prototype.writeValue = function(name, value, expInterval) {
        if (name && value) {
            if (this.storage.type === COOKIE) {
                setCookie(name, value, expInterval, 'Lax');
            } else if (this.storage.type === LOCAL_STORAGE) {
               setStorageItem(name, value, expInterval);
            }
        }
    }

    pubCommonId.prototype.getId = function() {
        var pubcid = null;

        var optout = (ProperMedia.utils.cookiesAreEnabled() && this.readValue(OPTOUT_NAME, COOKIE)) || (ProperMedia.utils.hasLocalStorage() && this.readValue(OPTOUT_NAME, LOCAL_STORAGE));

        // Pass control to the next function if not enabled
        if (!this.config.enabled || !this.storage.type || optout) {
            return false;
        }

        if (typeof window[PUB_COMMON] === 'object') {
            // If the page includes its own pubcid object, then use that instead.
            pubcid = window[PUB_COMMON].getId();
            properLog.mylog(PUB_COMMON + ': pubcid = ' + pubcid);
        } else {
            // Otherwise get the existing cookie
            pubcid = this.readValue(ID_NAME);

            if(!pubcid) {
                if(this.storage.type == COOKIE) {
                    // Check localstorage
                    pubcid = this.readValue(ID_NAME, LOCAL_STORAGE);
                } else if(this.storage.type == LOCAL_STORAGE) {
                    // Check cookie
                    pubcid = this.readValue(ID_NAME, COOKIE);
                }
            } 

            if (!pubcid) {
                if (this.config.create) {
                    // Special handling for local storage to retain previously stored id in cookies
                    if (this.storage.type === LOCAL_STORAGE) {
                        pubcid = this.readValue(ID_NAME, COOKIE);
                    }
                    // Generate a new id
                    if (!pubcid) {
                        pubcid = ProperMedia.utils.generateUUID();
                    }
                    // Update the cookie/storage with the latest expiration date
                    this.writeValue(ID_NAME, pubcid, this.storage.expires);
                    // Only return pubcid if it is saved successfully
                    pubcid = this.readValue(ID_NAME);
                }
            } else if (this.config.extend) {
                // Update the cookie/storage with the latest expiration date
                this.writeValue(ID_NAME, pubcid, this.storage.expires);
            }

            properLog.mylog('pubCommonId: pubcid = ' + pubcid);
        }
        this.idObj = {
            "pubcid": pubcid
        }
        return true;
    }

    // Helper to set a cookie
    function setCookie(name, value, expires, sameSite) {
        var expTime = new Date();
        expTime.setTime(expTime.getTime() + expires * 1000 * 60);
        userIds.setCookie(name, value, expTime.toGMTString(), sameSite);
    }

    return pubCommonId;

})();

userIdAdapters.pubCommonId = new pubCommonId();
// ProperPubCId = new pubCommonId();

    /** 
 * Id5 Object
 */
var id5IdAdapter = (function() {

	var NB_EXP_DAYS              = 30;
	var ID5_STORAGE_NAME         = 'id5id';
	var ID5_PRIVACY_STORAGE_NAME = ID5_STORAGE_NAME + '_privacy';

    function id5Id() { 
    	this.name     = 'id5Id';
    	this.source   = 'id5-sync.com';
    	this.atype    = 1;
    	this.config = {
    		"enabled"  : true,
    		'partnerId': 445
    	};
    	this.storage = {
			"type": 'localstorage',
			"name": ID5_STORAGE_NAME,
			"expires": 90, // 90 days
			"refreshInSeconds": 8 * 3600 // 8 Hours
		};
		this.idObj    = {};
		this.callback = null;
    }


    id5Id.prototype.getValue = function(data) {
		return data.id5id.uid
    }

    id5Id.prototype.getUidExt = function(data) {
		if (data.ext) {
			return data.ext;
		}
    }

	/**
	* decode the stored id value for passing to bid requests
	* @function decode
	* @param {(Object|string)} value
	* @returns {(Object|undefined)}
	*/
	id5Id.prototype.decode = function(value) {
		var universalUid;
		var linkType = 0;

		if (value && typeof value.universal_uid === 'string') {
			universalUid = value.universal_uid;
			linkType = value.link_type || linkType;
		} else {
			return undefined;
		}

		let responseObj = {
			"id5id": {
				"uid": universalUid,
				"ext": {
					"linkType": linkType
				}
			}
		};

		return responseObj;
	}

	/**
	* performs action to obtain id and return a value in the callback's response argument
	*/
	id5Id.prototype.getId = function(cacheIdObj) {

		var url        = "https://id5-sync.com/g/v2/" + this.config.partnerId + ".json";
		var hasGdpr    = (gdprConsent && typeof gdprConsent.gdprApplies === 'boolean' && gdprConsent.gdprApplies) ? 1 : 0;
		var us_privacy = (uspConsent.cmpPresent && uspConsent.usPrivacy) ? uspConsent.usPrivacy : '';
		var signature  = (cacheIdObj && cacheIdObj.signature) ? cacheIdObj.signature : '';

		var data = {
			'gdpr'        : hasGdpr,
			'gdpr_consent': hasGdpr ? gdprConsent.consentString : '',
			'partner'     : this.config.partnerId,
			'nbPage'      : incrementNb(this.config.partnerId),
			'o'           : 'pbjs',
			'pd'          : '',
			'provider'    : '',
			'rf'          : properPage.referrer,
			's'           : signature,
			'top'         : 1,
			'u'           : properPage.url,
			'us_privacy'  : us_privacy,
			'v'           : properOps.prebid_version
		};

		var resp = function (callback) {
			$.ajax({
	            url: url,
	            method: "POST",
	            requestType: "cors",
	            data: JSON.stringify(data),
	            success: (function(response) {
	                var responseObj;
					if (response) {
						try {
							responseObj = ProperMedia.utils.safeJsonParse(response);
							resetNb(this.config.partnerId);
							if (responseObj.privacy) {
								storeInLocalStorage(ID5_PRIVACY_STORAGE_NAME, JSON.stringify(responseObj.privacy), NB_EXP_DAYS);
							}

						} catch (error) {
							properLog.mylog(error);
						}
					}
					callback(responseObj);
	            }).bind(this),
	            error: function(error) {
	            	properLog.mylog('UserID - ID5 submodule getId fetch encountered an error: ' +  JSON.stringify(error));
					callback();
	            }
	        });

		};
		return {callback: resp};
	}

	/**
	 * Similar to Submodule#getId, this optional method returns response to for id that exists already.
	 *  If IdResponse#id is defined, then it will be written to the current active storage even if it exists already.
	 *  If IdResponse#callback is defined, then it'll called at the end of auction.
	 *  It's permissible to return neither, one, or both fields.
	 * @function extendId
	 * @param {SubmoduleConfig} config
	 * @param {Object} cacheIdObj - existing id, if any
	 * @return {(IdResponse|function(callback:function))} A response object that contains id and/or callback.
	 */
	id5Id.prototype.extendId = function(cacheIdObj) {
 		var partnerId = this.config.partnerId || 0;
		incrementNb(partnerId);
		return cacheIdObj;
	}

	function expDaysStr(expDays) {
		return (new Date(Date.now() + (1000 * 60 * 60 * 24 * expDays))).toUTCString();
	}
	function nbCacheName(partnerId) {
		return ID5_STORAGE_NAME + '_' + partnerId + '_nb';
	}
	function storeNbInCache(partnerId, nb) {
  		storeInLocalStorage(nbCacheName(partnerId), nb, NB_EXP_DAYS);
	}
	function getNbFromCache(partnerId) {
		var cacheNb = getFromLocalStorage(nbCacheName(partnerId));
		return (cacheNb) ? parseInt(cacheNb) : 0;
	}
	function incrementNb(partnerId) {
		var nb = (getNbFromCache(partnerId) + 1);
		storeNbInCache(partnerId, nb);
		return nb;
	}
	function resetNb(partnerId) {
		storeNbInCache(partnerId, 0);
	}

	/**
	* This will make sure we check for expiration before accessing local storage
	* @param {string} key
	*/
	function getFromLocalStorage(key) {
		var storedValueExp = ProperMedia.utils.getDataFromLocalStorage(key + "_exp");
		// empty string means no expiration set
		if (storedValueExp === '') {
			return ProperMedia.utils.getDataFromLocalStorage(key);
		} else if (storedValueExp) {
			if ((new Date(storedValueExp)).getTime() - Date.now() > 0) {
				return ProperMedia.utils.getDataFromLocalStorage(key);
			}
		}
		// if we got here, then we have an expired item or we didn't set an
		// expiration initially somehow, so we need to remove the item from the
		// local storage
		ProperMedia.utils.removeDataFromLocalStorage(key);
		return null;
	}
	
	/**
	 * Ensure that we always set an expiration in local storage since
	 * by default it's not required
	 * @param {string} key
	 * @param {any} value
	 * @param {integer} expDays
	 */
	function storeInLocalStorage(key, value, expDays) {
		ProperMedia.utils.setDataInLocalStorage(key + "_exp", expDaysStr(expDays));
		ProperMedia.utils.setDataInLocalStorage(key, value);
	}

	return id5Id;

})();

userIdAdapters.id5Id = new id5IdAdapter();
    /** 
 * identityLink Object
 */
var identityLinkAdapter = (function() {

    function identityLink() {
        this.name        = 'identityLink';
        this.envelope    = '';
        this.email       = '';
        this.emailHashes = [];
        this.source      = 'liveramp.com';
        this.atype       = 1;
        this.config = {
            "enabled"    : true,
            "placementID": 72,
            "ats_enabled": false
        };
        this.storage = {
            "type": "cookie",
            "name": "idl_env",
            "expires": 30
        };
        this.idObj    = {};
        this.callback = null;
    }

    identityLink.prototype.initialize = function(userIdData) {
        // Get email from UserId data
        if(userIdData.email) {
            this.email = userIdData.email;
        // liveramp email is passed through properSpecialOps
        } else if( ProperMedia.utils.deepAccess(properSpecialOps, 'liveramp_email') ) {
            this.config.ats_enabled = true;
            this.email = ProperMedia.utils.deepAccess(properSpecialOps, 'liveramp_email');
        // liveramp email is passed through a cookie
        } else if( ProperMedia.utils.getCookieValue('proper_lre') ) {
            this.config.ats_enabled = true;
            this.email = ProperMedia.utils.getCookieValue('proper_lre');
        }
        if(this.email && ProperMedia.utils.isBase64(this.email)) {
            this.email = ProperMedia.utils.b64DecodeUnicode(this.email);
        }

        // liveramp email hashes is passed through properSpecialOps
        if( ProperMedia.utils.deepAccess(properSpecialOps, 'liveramp_emailHashes') ) {
            this.config.ats_enabled = true;
            this.emailHashes = ProperMedia.utils.getCookieValue('liveramp_emailHashes') || [];
        }

        if(this.config.ats_enabled) {
            this.loadASTScript();
        }
    }

    identityLink.prototype.loadASTScript = function() {
        var atsScript = window.top.document.createElement('script');
        atsScript.onload = (function() {
            var params = { 
                "placementID": this.config.placementID
            };
            if(this.email) {
                params["email"] = this.email.toLowerCase().trim();
            }
            if(this.emailHashes && this.emailHashes.length) {
                params["emailHashes"] = this.emailHashes;   
            }
            window.top.ats.start(params);
        }).bind(this);
        atsScript.src = 'https://ats.rlcdn.com/ats.js';
        window.top.document.body.appendChild(atsScript);
    }

    /**
     * decode the stored id value for passing to bid requests
     * @function
     * @param {string} value
     * @returns {{idl_env:string}}
     */
    identityLink.prototype.decode = function(value) {
        return { 'idl_env': value }
    }

    identityLink.prototype.getValue = function(data) {
        return data.idl_env
    }

    /**
     * performs action to obtain id and return a value in the callback's response argument
     * @function
     * @returns {IdResponse|undefined}
     */
    identityLink.prototype.getId = function() {

        var hasGdpr = (gdprConsent && typeof gdprConsent.gdprApplies === 'boolean' && gdprConsent.gdprApplies) ? 1 : 0;
        var gdprConsentString = hasGdpr ? gdprConsent.consentString : '';
        var tcfPolicyV2 = ProperMedia.utils.deepAccess(gdprConsent, 'vendorData.tcfPolicyVersion') === 2;

        // use protocol relative urls for http or https
        if (hasGdpr && (!gdprConsentString || gdprConsentString === '')) {
            properLog.mylog('identityLink: Consent string is required to call envelope API.');
            return;
        }
        var url = 'https://api.rlcdn.com/api/identity/envelope?pid=' + this.config.placementID + (hasGdpr ? (tcfPolicyV2 ? '&ct=4&cv=' : '&ct=1&cv=') + gdprConsentString : '');
        var resp = function (callback) {
            // Check ats during callback so it has a chance to initialise.
            // If ats library is available, use it to retrieve envelope. If not use standard third party endpoint
            if (window.top.ats) {
                properLog.mylog('identityLink: ATS exists!');
                window.top.ats.retrieveEnvelope(function (envelope) {
                    if (envelope) {
                        properLog.mylog('identityLink: An envelope can be retrieved from ATS!');
                        setEnvelopeSource(true);
                        callback(ProperMedia.utils.safeJsonParse(envelope).envelope || '');
                    } else {
                        getEnvelope(url, callback);
                    }
                });
            } else {
                getEnvelope(url, callback);
            }
        };

        return { callback: resp };
    }

    // return envelope from third party endpoint
    function getEnvelope(url, callback) {
        
        if (!ProperMedia.utils.getCookieValue('_lr_retry_request')) {
            setRetryCookie();
            properLog.mylog('identityLink: A 3P retrieval is attempted!');
            setEnvelopeSource(false);

            $.ajax({
                url: url,
                method: "GET",
                requestType: "cors",
                success: function(response) {
                    var responseObj;
                    if (response) {
                        try {
                            responseObj = ProperMedia.utils.safeJsonParse(response);
                        } catch (error) {
                            properLog.mylog(error);
                        }
                    }
                    callback((responseObj && responseObj.envelope) ? responseObj.envelope : '');
                },
                error: function(error) {
                    properLog.mylog('identityLink: identityLink: ID fetch encountered an error ' +  JSON.stringify(error));
                    callback();
                }
            });
        }
    }

    function setRetryCookie() {
        var now = new Date();
        now.setTime(now.getTime() + 3600000);
        userIds.setCookie('_lr_retry_request', 'true', now.toUTCString());
    }

    function setEnvelopeSource(src) {
        let now = new Date();
        now.setTime(now.getTime() + 2592000000);
        userIds.setCookie('_lr_env_src_ats', src, now.toUTCString());
    }


    return identityLink;

})();

userIdAdapters.identityLink = new identityLinkAdapter();

    /** 
 * fabrickId Object
 */
var fabrickIdAdapter = (function() {

    function fabrickId() { 
    	this.name     = 'fabrickId';
    	this.source   = 'neustar.biz';
    	this.atype    = 1;
    	this.config = {
    		"enabled": true,
    		'apiKey': null
    	};
    	this.storage = {
			"type": 'cookie',
			"name": 'fabrickId',
			"expires": 7 // 7 days
		};
		this.idObj    = {};
		this.callback = null;
    }


    fabrickId.prototype.initialize = function(userIdData) {
    	if(userIdData) {
	        // Get email from UserId data
	        if(userIdData.email) {
	        	if(!ProperMedia.utils.isBase64(userIdData.email)) {
	        		userIdData.email = ProperMedia.utils.b64EncodeUnicode(userIdData.email);
	        	}
	            this.config.e = userIdData.email;
	        }
	    }
	    if(userIdData.ipv4) {
            this.config.i4 = userIdData.ipv4;
        }
        if(userIdData.ipv6) {
            this.config.i6 = userIdData.ipv6;
        }
    }


    fabrickId.prototype.getValue = function(data) {
		return data.fabrickId
    }

	/**
	 * decode the stored id value for passing to bid requests
	 * @function decode
	 * @param {(Object|string)} value
	 * @returns {(Object|undefined)}
	 */
	fabrickId.prototype.decode = function(value) {
		if (value && value.fabrickId) {
			return { 'fabrickId': value.fabrickId };
		} else {
			return undefined;
		}
	}

	/**
	* performs action to obtain id and return a value in the callback's response argument
	*/
	fabrickId.prototype.getId = function(cacheIdObj) {
		try {
			if (!this.config.enabled) {
				return;
			}
			if (typeof this.config.apiKey !== 'string') {
				properLog.mylog('fabrick submodule requires an apiKey.');
				return;
			}
			try {
				var url = 'https://fid.agkn.com/f?';
				var keysArr = Object.keys(this.config);
				for (var i in keysArr) {
					var k = keysArr[i];
					if (k === 'url' || k === 'refererInfo' || k === 'enabled') {
						continue;
					}
					var v = this.config[k];
					if (Array.isArray(v)) {
						for (var j in v) {
							url += k + '=' + v[j] + '&';
						}
					} else {
						url += k + '=' + v + '&';
					}
				}
				// pull off the trailing &
				url = url.slice(0, -1)
				var urls = [];
				url = truncateAndAppend(urls, url, 'r', properPage.referer);
				// if (referer.stack && referer.stack[0]) {
				// 	url = truncateAndAppend(urls, url, 'r', referer.stack[0]);
				// }
				url = truncateAndAppend(urls, url, 'r', properPage.canonical_url);
				url = truncateAndAppend(urls, url, 'r', properPage.url);

				var resp = function (callback) {
					$.ajax({
			            url: url,
			            method: "GET",
			            requestType: "cors",
			            success: (function(response) {
			                var responseObj;
							if (response) {
								try {
									responseObj = ProperMedia.utils.safeJsonParse(response);
								} catch (error) {
									properLog.mylog(error);
									responseObj = {};
								}
							}
							callback(responseObj);
			            }).bind(this),
			            error: function(error) {
							properLog.mylog('fabrickId fetch encountered an error', error);
							callback();
						}
			        });

				};



				return {callback: resp};
			} catch (e) {
				properLog.mylog('fabrickIdSystem encountered an error', e);
			}
		} catch (e) {
			properLog.mylog('fabrickIdSystem encountered an error', e);
		}
	}

	function truncateAndAppend(urls, url, paramName, s) {
		if (s && url.length < 2000) {
			if (s.length > 200) {
				s = s.substring(0, 200);
			}
			// Don't send the same url in multiple params
			if (urls.indexOf(s) == -1) {
				urls.push(s);
				return url + '&' + paramName + '=' + s
			}
		}
		return url;
	}

	return fabrickId;

})();

userIdAdapters.fabrickId = new fabrickIdAdapter();
    

    // DISPLAY BIDDERS
    bidAdapters.a9 = (function() {
     // this may be overridden in function send()
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 120000
    };

    var bidder = "a9";

    var amazon_ready = 0,
        amazon_loading = 0;

    var ENDPOINT_URL = 'https://c.amazon-adsystem.com/e/dtb/bid';

    var amzn_price_map = {
        'display': {
            '1guboqo': 0.01, 'z31o8w': 0.02, '1yllp8g': 0.03, '8g4ni8': 0.04, '17yoohs': 0.05, 'q7eo00': 0.06, '1ppyozk': 0.07, 'cvy5mo': 0.08, '1cei6m8': 0.09, 'un864g': 0.10, '1u5s740': 0.11, '40b5ds': 0.12, '13iv6dc': 0.13, 'lrl5vk': 0.14, '1la56v4': 0.15, 'f3uwow': 0.16, '1emexog': 0.17, 'wv4x6o': 0.18, '1wdoy68': 0.19, '687wg0': 0.20, '15qrxfk': 0.21, 'nzhwxs': 0.22, '1ni1xxc': 0.23, 'ao1ekg': 0.24, '1a6lfk0': 0.25, 'sfbf28': 0.26, '1rxvg1s': 0.27, '1seebk': 0.28, '11ayfb4': 0.29, 'jjoetc': 0.30, '1j28fsw': 0.31, 'g7ta80': 0.32, '1fqdb7k': 0.33, 'xz3aps': 0.34, '1xhnbpc': 0.35, '7c69z4': 0.36, '16uqayo': 0.37, 'p3gagw': 0.38, '1om0bgg': 0.39, 'brzs3k': 0.40, '1bajt34': 0.41, 'tj9slc': 0.42, '1t1ttkw': 0.43, '2wcruo': 0.44, '12ewsu8': 0.45, 'knmscg': 0.46, '1k66tc0': 0.47, 'dzwj5s': 0.48, '1digk5c': 0.49, 'vr6jnk': 0.50, '1v9qkn4': 0.51, '549iww': 0.52, '14mtjwg': 0.53, 'mvjjeo': 0.54, '1me3ke8': 0.55, '9k311c': 0.56, '192n20w': 0.57, 'rbd1j4': 0.58, '1qtx2io': 0.59, 'og0sg': 0.60, '10701s0': 0.61, 'ifq1a8': 0.62, '1hya29s': 0.63, 'grsgzk': 0.64, '1gachz4': 0.65, 'yj2hhc': 0.66, '1y1migw': 0.67, '7w5gqo': 0.68, '17ephq8': 0.69, 'pnfh8g': 0.70, '1p5zi80': 0.71, 'cbyyv4': 0.72, '1buizuo': 0.73, 'u38zcw': 0.74, '1tlt0cg': 0.75, '3gbym8': 0.76, '12yvzls': 0.77, 'l7lz40': 0.78, '1kq603k': 0.79, 'ejvpxc': 0.80, '1e2fqww': 0.81, 'wb5qf4': 0.82, '1vtpreo': 0.83, '5o8pog': 0.84, '156sqo0': 0.85, 'nfiq68': 0.86, '1my2r5s': 0.87, 'a427sw': 0.88, '19mm8sg': 0.89, 'rvc8ao': 0.90, '1rdw9a8': 0.91, '18f7k0': 0.92, '10qz8jk': 0.93, 'izp81s': 0.94, '1ii991c': 0.95, 'fnu3gg': 0.96, '1f6e4g0': 0.97, 'xf43y8': 0.98, '1wxo4xs': 0.99, '6s737k': 1.00, '16ar474': 1.01, 'ojh3pc': 1.02, '1o214ow': 1.03, 'b80lc0': 1.04, '1aqkmbk': 1.05, 'szalts': 1.06, '1shumtc': 1.07, '2cdl34': 1.08, '11uxm2o': 1.09, 'k3nlkw': 1.10, '1jm7mkg': 1.11, 'dfxce8': 1.12, '1cyhdds': 1.13, 'v77cw0': 1.14, '1uprdvk': 1.15, '4kac5c': 1.16, '142ud4w': 1.17, 'mbkcn4': 1.18, '1lu4dmo': 1.19, '903u9s': 1.20, '18inv9c': 1.21, 'qrdurk': 1.22, '1q9xvr4': 1.23, '4gu0w': 1.24, 'zn0v0g': 1.25, 'hvquio': 1.26, '1heavi8': 1.27, 'hlr94w': 1.28, '1h4ba4g': 1.29, 'zd19mo': 1.30, '1yvlam8': 1.31, '8q48w0': 1.32, '188o9vk': 1.33, 'qhe9ds': 1.34, '1pzyadc': 1.35, 'd5xr0g': 1.36, '1cohs00': 1.37, 'ux7ri8': 1.38, '1ufrshs': 1.39, '4aaqrk': 1.40, '13surr4': 1.41, 'm1kr9c': 1.42, '1lk4s8w': 1.43, 'fdui2o': 1.44, '1ewej28': 1.45, 'x54ikg': 1.46, '1wnojk0': 1.47, '6i7hts': 1.48, '160ritc': 1.49, 'o9hibk': 1.50, '1ns1jb4': 1.51, 'ay0zy8': 1.52, '1agl0xs': 1.53, 'spb0g0': 1.54, '1s7v1fk': 1.55, '22dzpc': 1.56, '11ky0ow': 1.57, 'jto074': 1.58, '1jc816o': 1.59, 'ghsvls': 1.60, '1g0cwlc': 1.61, 'y92w3k': 1.62, '1xrmx34': 1.63, '7m5vcw': 1.64, '174pwcg': 1.65, 'pdfvuo': 1.66, '1ovzwu8': 1.67, 'c1zdhc': 1.68, '1bkjegw': 1.69, 'tt9dz4': 1.70, '1tbteyo': 1.71, '36cd8g': 1.72, '12owe80': 1.73, 'kxmdq8': 1.74, '1kg6eps': 1.75, 'e9w4jk': 1.76, '1dsg5j4': 1.77, 'w1651c': 1.78, '1vjq60w': 1.79, '5e94ao': 1.80, '14wt5a8': 1.81, 'n5j4sg': 1.82, '1mo35s0': 1.83, '9u2mf4': 1.84, '19cmneo': 1.85, 'rlcmww': 1.86, '1r3wnwg': 1.87, 'yfm68': 1.88, '10gzn5s': 1.89, 'ippmo0': 1.90, '1i89nnk': 1.91, 'h1s2dc': 1.92, '1gkc3cw': 1.93, 'yt22v4': 1.94, '1ybm3uo': 1.95, '86524g': 1.96, '17op340': 1.97, 'pxf2m8': 1.98, '1pfz3ls': 1.99, 'clyk8w': 2.00, '1c4il8g': 2.01, 'ud8kqo': 2.02, '1tvslq8': 2.03, '3qbk00': 2.04, '138vkzk': 2.05, 'lhlkhs': 2.06, '1l05lhc': 2.07, 'etvbb4': 2.08, '1ecfcao': 2.09, 'wl5bsw': 2.10, '1w3pcsg': 2.11, '5y8b28': 2.12, '15gsc1s': 2.13, 'npibk0': 2.14, '1n82cjk': 2.15, 'ae1t6o': 2.16, '19wlu68': 2.17, 's5btog': 2.18, '1rnvuo0': 2.19, '1iesxs': 2.20, '110ytxc': 2.21, 'j9otfk': 2.22, '1is8uf4': 2.23, 'fxtou8': 2.24, '1fgdpts': 2.25, 'xp3pc0': 2.26, '1x7nqbk': 2.27, '726olc': 2.28, '16kqpkw': 2.29, 'otgp34': 2.30, '1oc0q2o': 2.31, 'bi06ps': 2.32, '1b0k7pc': 2.33, 't9a77k': 2.34, '1sru874': 2.35, '2md6gw': 2.36, '124x7gg': 2.37, 'kdn6yo': 2.38, '1jw77y8': 2.39, 'dpwxs0': 2.40, '1d8gyrk': 2.41, 'vh6y9s': 2.42, '1uzqz9c': 2.43, '4u9xj4': 2.44, '14ctyio': 2.45, 'mljy0w': 2.46, '1m43z0g': 2.47, '9a3fnk': 2.48, '18sngn4': 2.49, 'r1dg5c': 2.50, '1qjxh4w': 2.51, 'egfeo': 2.52, 'zx0ge8': 2.53, 'i5qfwg': 2.54, '1hoagw0': 2.55, 'hgrgg0': 2.56, '1gzbhfk': 2.57, 'z81gxs': 2.58, '1yqlhxc': 2.59, '8l4g74': 2.60, '183oh6o': 2.61, 'qcegow': 2.62, '1puyhog': 2.63, 'd0xybk': 2.64, '1cjhzb4': 2.65, 'us7ytc': 2.66, '1uarzsw': 2.67, '45ay2o': 2.68, '13nuz28': 2.69, 'lwkykg': 2.70, '1lf4zk0': 2.71, 'f8upds': 2.72, '1ereqdc': 2.73, 'x04pvk': 2.74, '1wioqv4': 2.75, '6d7p4w': 2.76, '15vrq4g': 2.77, 'o4hpmo': 2.78, '1nn1qm8': 2.79, 'at179c': 2.80, '1abl88w': 2.81, 'skb7r4': 2.82, '1s2v8qo': 2.83, '1xe70g': 2.84, '11fy800': 2.85, 'joo7i8': 2.86, '1j788hs': 2.87, 'gct2ww': 2.88, '1fvd3wg': 2.89, 'y433eo': 2.90, '1xmn4e8': 2.91, '7h62o0': 2.92, '16zq3nk': 2.93, 'p8g35s': 2.94, '1or045c': 2.95, 'bwzksg': 2.96, '1bfjls0': 2.97, 'to9la8': 2.98, '1t6tm9s': 2.99, '31ckjk': 3.00, '1dngcu8': 3.05, 'n0jc3k': 3.10, '1qywv7k': 3.15, 'gws9og': 3.20, '17jpaf4': 3.25, 'u88s1s': 3.30, '1kv5ssg': 3.35, '5t8idc': 3.40, '19rm1hc': 3.45, 'j4p0qo': 3.50, '1x2nxmo': 3.55, 'bd0e0w': 3.60, '11zxerk': 3.65, 'vc75kw': 3.70, '1lz46bk': 3.75, '9gmps': 3.80, '1h9b2tc': 3.85, 'qme22o': 3.90, '1ukrl6o': 3.95, 'fiuark': 4.00, '165rbi8': 4.05, 'suat4w': 4.10, '1jh7tvk': 4.15, '7r5o1s': 4.20, '1bpj75s': 4.25, 'l2m6f4': 4.30, '1vopyps': 4.35, '9z2f40': 4.40, '10lzfuo': 4.45, 'yy1vk0': 4.50, '1pkywao': 4.55, '3vbcow': 4.60, '1ehf4zk': 4.65, 'nui48w': 4.70, '1rsvncw': 4.75, 'g2thj4': 4.80, '16pqi9s': 4.85, 'te9zwg': 4.90, '1k170n4': 4.95, '4z9q80': 5.00, '18xn9c0': 5.05, 'iaq8lc': 5.10, '1yj3sw0': 5.15, 'ctg9a8': 5.20, '13gda0w': 5.25, 'wsn0u8': 5.30, '1nfk1kw': 5.35, '1pwhz4': 5.40, '1fnvev4': 5.45, 'p0ye4g': 5.50, '1szbx8g': 5.55, 'dxemtc': 5.60, '14kbnk0': 5.65, 'r8v56o': 5.70, '1hvs5xc': 5.75, '7tnke8': 5.80, '1bs13i8': 5.85, 'l542rk': 5.90, '1vr7v28': 5.95, 'a1kbgg': 6.00, '10ohc74': 6.05, 'xcm7ls': 6.10, '1nzj8cg': 6.15, '29voqo': 6.20, '1cvzh1c': 6.25, 'm92gao': 6.30, '1q7fzeo': 6.35, 'hj9csg': 6.40, '1866dj4': 6.45, 'uupv5s': 6.50, '1lhmvwg': 6.55, '6fplhc': 6.60, '1ae34lc': 6.65, 'jr63uo': 6.70, '1xp50qo': 6.75, 'bzhh4w': 6.80, '12mehvk': 6.85, 'vyo8ow': 6.90, '1mll9fk': 6.95, 'vxpts': 7.00, '1ghu70g': 7.05, 'pux69s': 7.10, '1ttapds': 7.15, 'erdeyo': 7.20, '15eafpc': 7.25, 's2txc0': 7.30, '1ipqy2o': 7.35, '6zos8w': 7.40, '1ay2bcw': 7.45, 'kb5am8': 7.50, '1ux92ww': 7.55, '97ljb4': 7.60, 'zuik1s': 7.65, 'z5jklc': 7.70, '1psglc0': 7.75, '42t1q8': 7.80, '1eowu0w': 7.85, 'o1zta8': 7.90, '1s0dce8': 7.95, 'gab6kg': 8.00, 'wdnmrk': 8.50, '8sm58g': 9.00, 'n8114w': 9.50, 'bki328': 10.00, 'se2gw0': 10.50, '3f30g0': 11.00, 'huhwcg': 11.50, 'e8n6dc': 12.00, 'xnur5s': 12.50, '6byqyo': 13.00, 'pr6br4': 13.50, '93uosg': 14.00, 'tx08hs': 14.50, '1m5ngg': 15.00, 'lnubcw': 15.50, 'go1mgw': 16.00, 'v3gidc': 16.50, '7if0u8': 17.00, 'nlrh1c': 17.50, 'cx73sw': 18.00, 'rclzpc': 18.50, '2dmj9c': 19.00, 'juwydc': 19.50, 'ev49hc': 20.00, '53n1ts': 21.00, 'axeiv4': 22.00, 'dtybk': 23.00, 'fs7f28': 24.00, '8aidq8': 25.00, 'boveo0': 26.00, '476dc0': 27.00, 'dmskcg': 28.00, '5q44xs': 29.00, '9vy1og': 30.00, '1qiz28': 31.00, 'hjvtvk': 32.00, '70b9c0': 33.00, 'cf3cao': 34.00, '39gqo0': 35.00 },
        'video': {
            'v_1guboqo': 0.01, 'v_z31o8w': 0.02, 'v_1yllp8g': 0.03, 'v_8g4ni8': 0.04, 'v_17yoohs': 0.05, 'v_q7eo00': 0.06, 'v_1ppyozk': 0.07, 'v_cvy5mo': 0.08, 'v_1cei6m8': 0.09, 'v_un864g': 0.10, 'v_1u5s740': 0.11, 'v_40b5ds': 0.12, 'v_13iv6dc': 0.13, 'v_lrl5vk': 0.14, 'v_1la56v4': 0.15, 'v_f3uwow': 0.16, 'v_1emexog': 0.17, 'v_wv4x6o': 0.18, 'v_1wdoy68': 0.19, 'v_687wg0': 0.20, 'v_15qrxfk': 0.21, 'v_nzhwxs': 0.22, 'v_1ni1xxc': 0.23, 'v_ao1ekg': 0.24, 'v_1a6lfk0': 0.25, 'v_sfbf28': 0.26, 'v_1rxvg1s': 0.27, 'v_1seebk': 0.28, 'v_11ayfb4': 0.29, 'v_jjoetc': 0.30, 'v_1j28fsw': 0.31, 'v_g7ta80': 0.32, 'v_1fqdb7k': 0.33, 'v_xz3aps': 0.34, 'v_1xhnbpc': 0.35, 'v_7c69z4': 0.36, 'v_16uqayo': 0.37, 'v_p3gagw': 0.38, 'v_1om0bgg': 0.39, 'v_brzs3k': 0.40, 'v_1bajt34': 0.41, 'v_tj9slc': 0.42, 'v_1t1ttkw': 0.43, 'v_2wcruo': 0.44, 'v_12ewsu8': 0.45, 'v_knmscg': 0.46, 'v_1k66tc0': 0.47, 'v_dzwj5s': 0.48, 'v_1digk5c': 0.49, 'v_vr6jnk': 0.50, 'v_1v9qkn4': 0.51, 'v_549iww': 0.52, 'v_14mtjwg': 0.53, 'v_mvjjeo': 0.54, 'v_1me3ke8': 0.55, 'v_9k311c': 0.56, 'v_192n20w': 0.57, 'v_rbd1j4': 0.58, 'v_1qtx2io': 0.59, 'v_og0sg': 0.60, 'v_10701s0': 0.61, 'v_ifq1a8': 0.62, 'v_1hya29s': 0.63, 'v_grsgzk': 0.64, 'v_1gachz4': 0.65, 'v_yj2hhc': 0.66, 'v_1y1migw': 0.67, 'v_7w5gqo': 0.68, 'v_17ephq8': 0.69, 'v_pnfh8g': 0.70, 'v_1p5zi80': 0.71, 'v_cbyyv4': 0.72, 'v_1buizuo': 0.73, 'v_u38zcw': 0.74, 'v_1tlt0cg': 0.75, 'v_3gbym8': 0.76, 'v_12yvzls': 0.77, 'v_l7lz40': 0.78, 'v_1kq603k': 0.79, 'v_ejvpxc': 0.80, 'v_1e2fqww': 0.81, 'v_wb5qf4': 0.82, 'v_1vtpreo': 0.83, 'v_5o8pog': 0.84, 'v_156sqo0': 0.85, 'v_nfiq68': 0.86, 'v_1my2r5s': 0.87, 'v_a427sw': 0.88, 'v_19mm8sg': 0.89, 'v_rvc8ao': 0.90, 'v_1rdw9a8': 0.91, 'v_18f7k0': 0.92, 'v_10qz8jk': 0.93, 'v_izp81s': 0.94, 'v_1ii991c': 0.95, 'v_fnu3gg': 0.96, 'v_1f6e4g0': 0.97, 'v_xf43y8': 0.98, 'v_1wxo4xs': 0.99, 'v_6s737k': 1.00, 'v_16ar474': 1.01, 'v_ojh3pc': 1.02, 'v_1o214ow': 1.03, 'v_b80lc0': 1.04, 'v_1aqkmbk': 1.05, 'v_szalts': 1.06, 'v_1shumtc': 1.07, 'v_2cdl34': 1.08, 'v_11uxm2o': 1.09, 'v_k3nlkw': 1.10, 'v_1jm7mkg': 1.11, 'v_dfxce8': 1.12, 'v_1cyhdds': 1.13, 'v_v77cw0': 1.14, 'v_1uprdvk': 1.15, 'v_4kac5c': 1.16, 'v_142ud4w': 1.17, 'v_mbkcn4': 1.18, 'v_1lu4dmo': 1.19, 'v_903u9s': 1.20, 'v_18inv9c': 1.21, 'v_qrdurk': 1.22, 'v_1q9xvr4': 1.23, 'v_4gu0w': 1.24, 'v_zn0v0g': 1.25, 'v_hvquio': 1.26, 'v_1heavi8': 1.27, 'v_hlr94w': 1.28, 'v_1h4ba4g': 1.29, 'v_zd19mo': 1.30, 'v_1yvlam8': 1.31, 'v_8q48w0': 1.32, 'v_188o9vk': 1.33, 'v_qhe9ds': 1.34, 'v_1pzyadc': 1.35, 'v_d5xr0g': 1.36, 'v_1cohs00': 1.37, 'v_ux7ri8': 1.38, 'v_1ufrshs': 1.39, 'v_4aaqrk': 1.40, 'v_13surr4': 1.41, 'v_m1kr9c': 1.42, 'v_1lk4s8w': 1.43, 'v_fdui2o': 1.44, 'v_1ewej28': 1.45, 'v_x54ikg': 1.46, 'v_1wnojk0': 1.47, 'v_6i7hts': 1.48, 'v_160ritc': 1.49, 'v_o9hibk': 1.50, 'v_1ns1jb4': 1.51, 'v_ay0zy8': 1.52, 'v_1agl0xs': 1.53, 'v_spb0g0': 1.54, 'v_1s7v1fk': 1.55, 'v_22dzpc': 1.56, 'v_11ky0ow': 1.57, 'v_jto074': 1.58, 'v_1jc816o': 1.59, 'v_ghsvls': 1.60, 'v_1g0cwlc': 1.61, 'v_y92w3k': 1.62, 'v_1xrmx34': 1.63, 'v_7m5vcw': 1.64, 'v_174pwcg': 1.65, 'v_pdfvuo': 1.66, 'v_1ovzwu8': 1.67, 'v_c1zdhc': 1.68, 'v_1bkjegw': 1.69, 'v_tt9dz4': 1.70, 'v_1tbteyo': 1.71, 'v_36cd8g': 1.72, 'v_12owe80': 1.73, 'v_kxmdq8': 1.74, 'v_1kg6eps': 1.75, 'v_e9w4jk': 1.76, 'v_1dsg5j4': 1.77, 'v_w1651c': 1.78, 'v_1vjq60w': 1.79, 'v_5e94ao': 1.80, 'v_14wt5a8': 1.81, 'v_n5j4sg': 1.82, 'v_1mo35s0': 1.83, 'v_9u2mf4': 1.84, 'v_19cmneo': 1.85, 'v_rlcmww': 1.86, 'v_1r3wnwg': 1.87, 'v_yfm68': 1.88, 'v_10gzn5s': 1.89, 'v_ippmo0': 1.90, 'v_1i89nnk': 1.91, 'v_h1s2dc': 1.92, 'v_1gkc3cw': 1.93, 'v_yt22v4': 1.94, 'v_1ybm3uo': 1.95, 'v_86524g': 1.96, 'v_17op340': 1.97, 'v_pxf2m8': 1.98, 'v_1pfz3ls': 1.99, 'v_clyk8w': 2.00, 'v_1c4il8g': 2.01, 'v_ud8kqo': 2.02, 'v_1tvslq8': 2.03, 'v_3qbk00': 2.04, 'v_138vkzk': 2.05, 'v_lhlkhs': 2.06, 'v_1l05lhc': 2.07, 'v_etvbb4': 2.08, 'v_1ecfcao': 2.09, 'v_wl5bsw': 2.10, 'v_1w3pcsg': 2.11, 'v_5y8b28': 2.12, 'v_15gsc1s': 2.13, 'v_npibk0': 2.14, 'v_1n82cjk': 2.15, 'v_ae1t6o': 2.16, 'v_19wlu68': 2.17, 'v_s5btog': 2.18, 'v_1rnvuo0': 2.19, 'v_1iesxs': 2.20, 'v_110ytxc': 2.21, 'v_j9otfk': 2.22, 'v_1is8uf4': 2.23, 'v_fxtou8': 2.24, 'v_1fgdpts': 2.25, 'v_xp3pc0': 2.26, 'v_1x7nqbk': 2.27, 'v_726olc': 2.28, 'v_16kqpkw': 2.29, 'v_otgp34': 2.30, 'v_1oc0q2o': 2.31, 'v_bi06ps': 2.32, 'v_1b0k7pc': 2.33, 'v_t9a77k': 2.34, 'v_1sru874': 2.35, 'v_2md6gw': 2.36, 'v_124x7gg': 2.37, 'v_kdn6yo': 2.38, 'v_1jw77y8': 2.39, 'v_dpwxs0': 2.40, 'v_1d8gyrk': 2.41, 'v_vh6y9s': 2.42, 'v_1uzqz9c': 2.43, 'v_4u9xj4': 2.44, 'v_14ctyio': 2.45, 'v_mljy0w': 2.46, 'v_1m43z0g': 2.47, 'v_9a3fnk': 2.48, 'v_18sngn4': 2.49, 'v_r1dg5c': 2.50, 'v_1qjxh4w': 2.51, 'v_egfeo': 2.52, 'v_zx0ge8': 2.53, 'v_i5qfwg': 2.54, 'v_1hoagw0': 2.55, 'v_hgrgg0': 2.56, 'v_1gzbhfk': 2.57, 'v_z81gxs': 2.58, 'v_1yqlhxc': 2.59, 'v_8l4g74': 2.60, 'v_183oh6o': 2.61, 'v_qcegow': 2.62, 'v_1puyhog': 2.63, 'v_d0xybk': 2.64, 'v_1cjhzb4': 2.65, 'v_us7ytc': 2.66, 'v_1uarzsw': 2.67, 'v_45ay2o': 2.68, 'v_13nuz28': 2.69, 'v_lwkykg': 2.70, 'v_1lf4zk0': 2.71, 'v_f8upds': 2.72, 'v_1ereqdc': 2.73, 'v_x04pvk': 2.74, 'v_1wioqv4': 2.75, 'v_6d7p4w': 2.76, 'v_15vrq4g': 2.77, 'v_o4hpmo': 2.78, 'v_1nn1qm8': 2.79, 'v_at179c': 2.80, 'v_1abl88w': 2.81, 'v_skb7r4': 2.82, 'v_1s2v8qo': 2.83, 'v_1xe70g': 2.84, 'v_11fy800': 2.85, 'v_joo7i8': 2.86, 'v_1j788hs': 2.87, 'v_gct2ww': 2.88, 'v_1fvd3wg': 2.89, 'v_y433eo': 2.90, 'v_1xmn4e8': 2.91, 'v_7h62o0': 2.92, 'v_16zq3nk': 2.93, 'v_p8g35s': 2.94, 'v_1or045c': 2.95, 'v_bwzksg': 2.96, 'v_1bfjls0': 2.97, 'v_to9la8': 2.98, 'v_1t6tm9s': 2.99, 'v_31ckjk': 3.00, 'v_1dngcu8': 3.05, 'v_n0jc3k': 3.10, 'v_1qywv7k': 3.15, 'v_gws9og': 3.20, 'v_17jpaf4': 3.25, 'v_u88s1s': 3.30, 'v_1kv5ssg': 3.35, 'v_5t8idc': 3.40, 'v_19rm1hc': 3.45, 'v_j4p0qo': 3.50, 'v_1x2nxmo': 3.55, 'v_bd0e0w': 3.60, 'v_11zxerk': 3.65, 'v_vc75kw': 3.70, 'v_1lz46bk': 3.75, 'v_9gmps': 3.80, 'v_1h9b2tc': 3.85, 'v_qme22o': 3.90, 'v_1ukrl6o': 3.95, 'v_fiuark': 4.00, 'v_165rbi8': 4.05, 'v_suat4w': 4.10, 'v_1jh7tvk': 4.15, 'v_7r5o1s': 4.20, 'v_1bpj75s': 4.25, 'v_l2m6f4': 4.30, 'v_1vopyps': 4.35, 'v_9z2f40': 4.40, 'v_10lzfuo': 4.45, 'v_yy1vk0': 4.50, 'v_1pkywao': 4.55, 'v_3vbcow': 4.60, 'v_1ehf4zk': 4.65, 'v_nui48w': 4.70, 'v_1rsvncw': 4.75, 'v_g2thj4': 4.80, 'v_16pqi9s': 4.85, 'v_te9zwg': 4.90, 'v_1k170n4': 4.95, 'v_4z9q80': 5.00, 'v_18xn9c0': 5.05, 'v_iaq8lc': 5.10, 'v_1yj3sw0': 5.15, 'v_ctg9a8': 5.20, 'v_13gda0w': 5.25, 'v_wsn0u8': 5.30, 'v_1nfk1kw': 5.35, 'v_1pwhz4': 5.40, 'v_1fnvev4': 5.45, 'v_p0ye4g': 5.50, 'v_1szbx8g': 5.55, 'v_dxemtc': 5.60, 'v_14kbnk0': 5.65, 'v_r8v56o': 5.70, 'v_1hvs5xc': 5.75, 'v_7tnke8': 5.80, 'v_1bs13i8': 5.85, 'v_l542rk': 5.90, 'v_1vr7v28': 5.95, 'v_a1kbgg': 6.00, 'v_10ohc74': 6.05, 'v_xcm7ls': 6.10, 'v_1nzj8cg': 6.15, 'v_29voqo': 6.20, 'v_1cvzh1c': 6.25, 'v_m92gao': 6.30, 'v_1q7fzeo': 6.35, 'v_hj9csg': 6.40, 'v_1866dj4': 6.45, 'v_uupv5s': 6.50, 'v_1lhmvwg': 6.55, 'v_6fplhc': 6.60, 'v_1ae34lc': 6.65, 'v_jr63uo': 6.70, 'v_1xp50qo': 6.75, 'v_bzhh4w': 6.80, 'v_12mehvk': 6.85, 'v_vyo8ow': 6.90, 'v_1mll9fk': 6.95, 'v_vxpts': 7.00, 'v_1ghu70g': 7.05, 'v_pux69s': 7.10, 'v_1ttapds': 7.15, 'v_erdeyo': 7.20, 'v_15eafpc': 7.25, 'v_s2txc0': 7.30, 'v_1ipqy2o': 7.35, 'v_6zos8w': 7.40, 'v_1ay2bcw': 7.45, 'v_kb5am8': 7.50, 'v_1ux92ww': 7.55, 'v_97ljb4': 7.60, 'v_zuik1s': 7.65, 'v_z5jklc': 7.70, 'v_1psglc0': 7.75, 'v_42t1q8': 7.80, 'v_1eowu0w': 7.85, 'v_o1zta8': 7.90, 'v_1s0dce8': 7.95, 'v_gab6kg': 8.00, 'v_wdnmrk': 8.50, 'v_8sm58g': 9.00, 'v_n8114w': 9.50, 'v_bki328': 10.00, 'v_se2gw0': 10.50, 'v_3f30g0': 11.00, 'v_huhwcg': 11.50, 'v_e8n6dc': 12.00, 'v_xnur5s': 12.50, 'v_6byqyo': 13.00, 'v_pr6br4': 13.50, 'v_93uosg': 14.00, 'v_tx08hs': 14.50, 'v_1m5ngg': 15.00, 'v_lnubcw': 15.50, 'v_go1mgw': 16.00, 'v_v3gidc': 16.50, 'v_7if0u8': 17.00, 'v_nlrh1c': 17.50, 'v_cx73sw': 18.00, 'v_rclzpc': 18.50, 'v_2dmj9c': 19.00, 'v_juwydc': 19.50, 'v_ev49hc': 20.00, 'v_53n1ts': 21.00, 'v_axeiv4': 22.00, 'v_dtybk': 23.00, 'v_fs7f28': 24.00, 'v_8aidq8': 25.00, 'v_boveo0': 26.00, 'v_476dc0': 27.00, 'v_dmskcg': 28.00, 'v_5q44xs': 29.00, 'v_9vy1og': 30.00, 'v_1qiz28': 31.00, 'v_hjvtvk': 32.00, 'v_70b9c0': 33.00, 'v_cf3cao': 34.00, 'v_39gqo0': 35.00, 'v_ezhl34': 36.00, 'v_4fx0jk': 37.00, 'v_a9ohkw': 38.00, 'v_p2hvk': 39.00, 'v_gifcow': 40.00, 'v_8gfw1s': 41.00, 'v_b8btvk': 42.00, 'v_3qmsjk': 43.00, 'v_e57ke8': 44.00, 'v_6nij28': 45.00, 'v_9fegw0': 46.00, 'v_168jr4': 47.00, 'v_gzlekg': 48.00, 'v_7ezev4': 49.00, 'v_d8qvwg': 50.00
        }
    };

    var amzn_bidder_map = {
        "display": {
            "fiuark" : "a9", // amazon
            "1lmmolc": "pubmatic_tam",
            "fgcef4" : "openx_tam",
            "x7meww" : "rubicon_tam",
            "7onrpc" : "oath_tam" ,
            "1777sow": "adgeneration_tam",
            "pfxs74" : "dmx_tam",
            "l04a2o" : "rhythmone_tam",
            "n8114w" : "verizonmedia_tam",
            "b0iwao" : "sovrn_tam",
            "obzeo0" : "pulsepoint_tam",
            "rnuj9c" : "index_tam",
            "6kpe68" : "districtm_tam",
            "pfxs74" : "districtmdmx_tam",
            "jw5wjk" : "smaato_tam",
            "tvrabk" : "conversant_tam",
            "11nfx1c": "triplelift_tam"
        },
        "video": {
            "fiuark"  : "amazon_tam_instream", // amazon
            "x7meww"  : "magnite_tam_instream",
            "5gr0n4"  : "adobe_tam_instream",
            "19f4jr4" : "conversant_uam_instream",
            "b0iwao"  : "sovrn_tam_instream",
            "obzeo0"  : "pulsepoint_tam_instream",  
            "1r6ek8w" : "amobee_tam_instream",
            "jw5wjk"  : "smaato_tam_instream",
            "rnuj9c"  : "index_tam_instream",
            "1lmmolc" : "pubmatic_tam_instream",
            "fgcef4"  : "openx_tam_instream",
            "6kpe68"  : "districtm_tam_instream",
            "7onrpc"  : "verizon_media_tam_instream",
            "1777sow" : "adgeneration_tam_instream",
            "pfxs74"  : "dmx_tam_instream",
            "1tebbb4" : "yahoo_tam_instream",
            "l04a2o"  : "unruly_tam_instream", 
            "n8114w"  : "verizon_media_tam_instream",
            "1mql24g" : "gumgum_uam_instream"
            // "1vm82dc" : The Trade Desk  
        }
    };

    var amzn_ttl_map = {
        "sovrn_tam": 90000
    };

    var pub_id = "cb3b5777-430d-4622-b7fc-358cfa27d518";

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidderInfo) {
        var requestData = {
            'slots': {},
            'tag_sizes': {},
            'request_cnt': 0
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    var tag_id = data[size][i];
                    if(typeof requestData['slots'][tag_id] == 'undefined') {
                        // 
                        requestData['slots'][tag_id] = { 
                            'slotID': tag_id
                        }
                        // Array of sizes for tag ids. Used to map the reponse back to request
                        requestData['tag_sizes'][tag_id] = [];

                        // Set media type for video only
                        if(bidderInfo.demand_type == 'video') {
                            requestData['slots'][tag_id].mediaType = 'video';
                        // Set sizes for display only
                        } else {
                            requestData['slots'][tag_id].sizes = [];
                        }
                    }

                    // Only display slots have sizes in the request
                    if(bidderInfo.demand_type == 'display') {
                        requestData['slots'][tag_id].sizes.push(size.split("x").map(function(s) { return parseInt(s); }));
                    } 

                    requestData['tag_sizes'][tag_id].push(size);
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }

    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {
        // Set bidder
        var bidder = bidData.bidder;
	    // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidderInfo);

        //load or queue request
        if (amazon_ready == 1) { // Good to go, request ads
            a9Payload(requestData);
        } else {

            // queue request
            properPage.amazon_queue = requestData;

            // load library if not loaded
            if(amazon_loading == 0) loadA9();
        }

        function loadA9() {
            amazon_loading = 1;
            !function(a9,a,p,s,t,A,g) {

                if( a[a9] ) return;

                function q(c,r) {
                    a[a9]._Q.push([c,r])
                }

                a[a9] = {
                    init: function() {
                        q("i", arguments)
                    },
                    fetchBids: function() {
                        q("f", arguments)
                    },
                    _Q: []
                };

                var r = false;
                A = p.createElement(s);
                A.async = 1;
                A.src = t;
                A.addEventListener('load', TraceKit.wrap(function() {
                    try {
                        var params = {};

                        var initParams = {
                            "pubID": pub_id,
                            "params": params,
                            "bidTimeout": 2e3
                        };

                        // Supply chain object isset
                        if(initParams.schain) {
                            initParams.schain = properOps.schain
                        }

                        if (gdprConsent.cmpPresent && gdprConsent.gdprApplies) {
                            initParams.gdpr = {
                                "cmpTimeout": 25
                            }
                        }

                        if (bidderInfo.demand_type === 'video') {
                            initParams.videoAdServer = 'DFP';
                        }

                        window.apstag.init(initParams);
                        amazon_ready = 1;
                        a9Payload(properPage.amazon_queue);
                        
                    } catch(e) {
                        e.bidder = bidder;
                        throw e;
                    }

                }));
                g = p.getElementsByTagName(s)[0];
                g.parentNode.insertBefore(A,g)

            } ("apstag", window, document, "script", "https://c.amazon-adsystem.com/aax2/apstag.js");
        }

        function a9Payload(data) {

            // check debug mode
            if(typeof window.apstag.debug == 'function') {
                if(properOps.testing_mode.ids == true) {
                    window.apstag.debug('enable');
                } else {
                    window.apstag.debug('disable');
                }
            }

            var request_cnt = data['request_cnt'] || 0;
            var slots       = ProperMedia.utils.objectValues(data['slots']) || [];

            // If no requests to send 
            if(slots.length == 0 && request_cnt > 0) { 
                return false;
            }

            // logging
            properLog.mylog("Amazon bids sent", bidder);

            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();

            var astcallback = function(bids) {
                try {
                    //log bids
                    properLog.mylog('Amazon bids returned: ' + bids.length);

                    var bids_received_ts = ProperMedia.utils.getTimestampMs();
                    var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    for (var key = 0; key < bids.length; key++) {
                        var bid = bids[key];

                        //log bid
                        if(properOps.testing_mode.ids == 1) {
                            var price = 100;
                        } else {
                            var price = parseFloat(amzn_price_map[bidderInfo.demand_type][bid.amznbid]) || 0;
                        }

                        var amznp           = bid.amznp || 'fiuark',
                            mapped_bidder   = amzn_bidder_map[bidderInfo.demand_type][amznp] || bidder,
                            encodedQsParams = bid.encodedQsParams || '',
                            qsParams        = bid.qsParams || '';

                        var ttl = bid.ttl || amzn_ttl_map[mapped_bidder] || bidderInfo.default_bid_ttl;

                        var ad_details = {
                            'encodedQsParams': encodedQsParams,
                            'qsParams': qsParams
                        };

                        // New Ad object
                        var ad = new adObj({
                            'bidder'     : mapped_bidder,
                            'price'      : price,
                            'gross'      : price,
                            'size'       : bid.size,
                            'tag_id'     : bid.slotID,
                            'request_url': ENDPOINT_URL,
                            'response'   : bid,
                            'response_ms': bid_response_ms,
                            'received_ts': bids_received_ts,
                            'ad_details' : ad_details,
                            'ttl'        : ttl
                        });

                        // Video bid
                        if (bidderInfo.demand_type === 'video') {
                            ad.type       = 'video';
                            ad.vast_type  = 'url';
                            ad.vast_tag   = 'https://aax.amazon-adsystem.com/e/dtb/vast?b=' + bid.amzniid + '&pp=' + bid.amznbid + '&rnd=' + Math.round(new Date().getTime()) + '&cust_params=' + encodedQsParams;
                            ad.vpaid      = false;
                            ad.video_type = bidderInfo.video_type;
                            ad.size       = ( ProperMedia.utils.deepAccess(data, 'tag_sizes.' + ad.tag_id) || (properDevice.isMobile() ? ['400x300'] : ['640x480']) )[0];
                        // DIsplay bid    
                        } else {
                            ad.type   = 'display';
                            ad.adcode = '<script>var amzn_win=window,amzn_c=5,amzn_x=0;while(amzn_x<amzn_c){amzn_win=amzn_win.parent;if(amzn_win.apstag)try{amzn_win.apstag.renderImp(document,"'+bid.amzniid+'");amzn_x=amzn_c}catch(e){}amzn_x++};</script>';
                        }

                        bidData.logBidResponse(ad);
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) {
                    e.bidder = bidder;
                    throw e;
                }
            };

            // Wrap function with TraceKit
            if(typeof TraceKit !== 'undefined') {
                TraceKit.wrap(astcallback)
            }

            window.apstag.fetchBids({
                slots: slots,
                timeout: 2e3,
            }, astcallback);
        }
    }

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
})();

    bidAdapters.adyoulike = (function() {
	var bidderInfo = {
		"rev_share"      : 1,
		"demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000
	};

	var ENDPOINT_URL = "https://hb-api.omnitagjs.com/hb-api/prebid/v1";
	var VERSION      = '1.0';
    var bidder       = 'adyoulike';


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

    	var requestData = {
			'bids': {},
			'request_cnt': 0
		};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {

                	var tag_id = data[size][i];
                    if(typeof requestData['bids'][tag_id] == 'undefined') {

                    	var transactionID = ProperMedia.utils.makeid(10);
                    	var s = size.split('x');

						requestData['bids'][tag_id] = {
							'TransactionID' : transactionID,
							'PlacementID'   : tag_id,
							'Width'         : parseInt(s[0]),
							'Height'        : parseInt(s[1]),
							'AvailableSizes': ''
						};
					}
					requestData['bids'][tag_id]['AvailableSizes'] += (requestData['bids'][tag_id]['AvailableSizes'].length ? ',' : '') + size;
					requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	var requestData = formatRequest(bidData.requests);
    	var bids        = requestData['bids'] || {};
    	var request_cnt = requestData['request_cnt'];

		// build url
    	var request_url = ENDPOINT_URL + rquestQS(properPage); // API endpoint

		var payload = {
    		'Version': VERSION,
    		'PageRefreshed': ProperMedia.utils.getPageRefreshed(),
    		'Bids': bids
    	}

    	if (gdprConsent.cmpPresent) {
    		payload.gdprConsent = {
				consentString: gdprConsent.consentString,
				consentRequired: (typeof gdprConsent.gdprApplies === 'boolean') ? gdprConsent.gdprApplies : true
			};
		}

		// log requests
        bidData.incrementRequestsSent(request_cnt);	

		//logging
		properLog.mylog(request_url, bidder);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

		//send request
		$.ajax({
			url: request_url,
			method: "POST",
			requestType: "cors",
			withCredentials: true,
			data: JSON.stringify(payload),
			edge: edge,
			success: function(resp) {

				try {
					
					response = ProperMedia.utils.safeJsonParse(resp);

					//process response
			        if(!response || response.length == 0) {
		          		properLog.mylog("no adyoulike bids returned");

			        } else {

						var bids_received_ts = ProperMedia.utils.getTimestampMs();
						var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

						//logging
						properLog.mylog(response, bidder);

						for (var i = 0; i < response.length; i++) {

							var obj = response[i];

							var bid_ID  = obj.BidID  || '',
								price   = obj.Price  || 0,
								width   = obj.Width  || 1,
								height  = obj.Height || 1,
								adcode  = obj.Ad     || '',
								ttl     = bidderInfo.default_bid_ttl;

							if(price > 0) {
								// New Ad object
	                            var ad = new adObj({
	                                'bidder'      : bidder,
	                                'size'        : width + 'x' + height,
	                                'price'       : parseFloat(price),
	                                'gross'       : parseFloat(price),
	                                'adcode'      : adcode,
	                                'tag_id'      : bid_ID,
	                                'request_url' : request_url,
	                                'response'    : obj,
	                                'response_ms' : bid_response_ms,
	                                'received_ts' : bids_received_ts,
	                                'ttl'         : ttl
	                            });

	                            bidData.logBidResponse(ad);
	                        }
						}
					}
					
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);
				
				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}
			}
		});
    }

    function rquestQS(page) {
    	// Query String
    	var qs = [];
    	// Referrer
		if (page.referrer) {
			qs.push('RefererUrl='+encodeURIComponent(page.referrer));
		}
		// Canonical Url
		var can = ProperMedia.utils.getCanonicalUrl();
		if (can) {
			qs.push('CanonicalUrl='+encodeURIComponent(can));
		}
		return (qs.length) ? '?' + qs.join('&') : '';
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.aol = (function() {
	var bidderInfo = {
		"rev_share"      : 1,
		"demand_type"    : 'display',
		"bid_grouping"   : 'slot',
        "default_bid_ttl": 60000
	};

	var ENDPOINT_URL = "https://adserver-us.adtech.advertising.com";

	var bidder = 'aol';


	/** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
	function send(bidData) {

		var requestData = bidData.requests;

        Object.keys(requestData).forEach(function(size) {
        	for (var i = 0; i < requestData[size].length; i++) {
            	send_slot(size, requestData[size][i]);
            }
        });

        /**
         * Send slot level bid requests
         */
        function send_slot(size, tag_id) {

			var size_map = {
				"728x90" : 225,
				"160x600": 154,
				"300x600": 529,
				"300x250": 170,
				"320x50" : 3055
			};

			if(typeof size_map[size] == 'undefined') return false;

			var price_floor = getBidderFloor(bidder, size),
			    size_id     = size_map[size],
				alias       = tag_id,
				misc        = new Date().getTime();

			// Build Request URL
			var request_url = ENDPOINT_URL + "/pubapi/3.0/9857.1/" + tag_id + "/0/" + size_id + "/ADTECH;v=2;cmd=bid;cors=yes;alias=" + alias + ";misc=" + misc + ";bidfloor=" + price_floor;

			// GDPR Consent
			if (gdprConsent.cmpPresent) {
                if (typeof gdprConsent.gdprApplies === 'boolean') {
                    request_url += ";gdpr=" + Number(gdprConsent.gdprApplies);
                }
				if (gdprConsent.consentString) {
					request_url += ";euconsent=" + gdprConsent.consentString;
				}
            }

            // USP Consent
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            	request_url += ";us_privacy=" + uspConsent.usPrivacy;
			}

			properLog.mylog(request_url, bidder);

            bidData.incrementRequestsSent(1);

			var bid_sent_ts = ProperMedia.utils.getTimestampMs();

			// Check if request should be sent through edge bidder
        	var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

			//send request
			$.ajax({
				url: request_url,
				special: "aol",
				requestType: "cors",
				bidder: bidder,
            	edge: edge,
				success: function(resp){

					try {
						//logging
						properLog.mylog(resp, bidder);

						// Parse JSON
						resp = ProperMedia.utils.safeJsonParse(resp) || {};

						//handle response
						if(resp && resp.seatbid && resp.seatbid.length > 0) {

							var bids_received_ts = ProperMedia.utils.getTimestampMs();
							var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

							var obj = resp.seatbid[0]['bid'][0] || {};

							if(Object.keys(obj).length > 0) {

								//store identifiers to identifiy buyer/creative
								var ad_details = {};
								if(typeof obj.crid !== "undefined") ad_details = obj.crid;

								var width  = obj['w']     || 1,
									height = obj['h']     || 1,
									price  = obj['price'] || 0,
									adcode = obj['adm']   || '';

								// New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : width + 'x' + height,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : tag_id,
                                    'request_url' : request_url,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);

							}

						}

						//log request as received regardless
                        bidData.incrementBidResponseCount(1);

            			addUserSyncs(resp);

					} catch (e) {
						e.bidder = bidder;
						throw e;
					}

				},
				error: function(resp) {
					try {
						//log request as received regardless
                        bidData.incrementBidResponseCount(1);

					} catch (e) {
						e.bidder = bidder;
						throw e;
					}
				}
			});
		}
	}

	var EXTRACT_ITEMS = /(img|iframe)[\s\S]*?src\s*=\s*("|')(.*?)\2/gi,
		EXTRACT_TAG_NAME = /\w*(?=\s)/,
		EXTRACT_TAG_SRC = /src=("|')(.*?)\1/;

	function addUserSyncs(resp) {
		if (resp && resp.ext && resp.ext.pixels) {
			var items = resp.ext.pixels.match(EXTRACT_ITEMS);
			if (items) {
				var syncs = [];
				items.forEach(function(item) {
					var tagName = item.match(EXTRACT_TAG_NAME)[0];
					var tagSrc = item.match(EXTRACT_TAG_SRC)[2];

					if (tagName && tagSrc) {
						syncs.push({
							type: (tagName === 'img' ? 'image' : 'iframe'),
							url: tagSrc,
                            bidder: bidder
						});
					}
				});
				userSyncs.add(syncs);
			}
		}
	}

	return {
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.appnexus = (function() {
	var bidderInfo = {
		"rev_share"      : 1,
		"demand_type"    : 'display',
		"bid_grouping"   : 'page',
        "default_bid_ttl": 300000
	};

	var ENDPOINT_URL  = "https://ib.adnxs.com/ut/v3/prebid",
        SYNC_ENDPOINT = "https://acdn.adnxs.com/ib/static/usersync/v3/async_usersync.html",
        bidder        = "appnexus";

    var eIdAdapters = {
        "identityLink": {
            "adapter": userIdAdapters.identityLink,
            "valuePath": "idl_env"
        }
    };

	/**
	 * Parse size and format to object
	 * @param {string} size - size string: '728x90'
	 * @return {Object}
	 */
	function parseSize(size) {
		var s = size.split('x');
        return {
        	'width' : parseInt(s[0]),
        	'height': parseInt(s[1])
        };
	}

	/**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
	function formatRequest(data, bidder, bidderInfo) {
		var requestData = {
			'astTags': {},
			'request_cnt': 0
		};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['astTags'][tag_id] == 'undefined') {

                    	// Add converted size
				        var primary_size = parseSize(size);

				        //build unique identifier
						var uuid = astUID();

						// Need to figure this out
						/* var position = {
							'atf': 1,
							'btf': 2
						}[slot.position] || 0; */
						// var position = 0;

						var id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || tag_id;

                    	requestData['astTags'][tag_id] = {
							"sizes"               : [],
							"primary_size"        : primary_size,
							"uuid"                : uuid,
							"id"                  : parseInt(id),
							// "position"            : position,
							"prebid"              : true,
							"ad_types"            : [],
							"reserve"             : getBidderFloor(bidder, size),
							"hb_source"           : 1,
							"disable_psa"         : true,
							"allow_smaller_sizes" : false,
							"use_pmt_rule"        : false
						};
                    }

                    if (bidderInfo.demand_type == 'display') {
                        requestData['astTags'][tag_id]['ad_types'].push('banner');

                    } else if (bidderInfo.demand_type == 'video') {
						requestData['astTags'][tag_id]['ad_types'].push('video');
						if(bidderInfo.video_type == 'instream') {
							requestData['astTags'][tag_id]['require_asset_url'] = true;
						} else if(bidderInfo.video_type == 'outstream'){
							requestData['astTags'][tag_id]['require_asset_url'] = false;
						}

						requestData['astTags'][tag_id]['allow_smaller_sizes'] = true;
						requestData['astTags'][tag_id]['video_frameworks']    = [2];

						requestData['astTags'][tag_id]['video'] = {
                            'minduration'     : 1,
                            // "context"         : (bidderInfo.video_type == 'outstream') ? 4 : 1,                            
                            'playback_method' : 2,
	                        "mimes": [
	                            "video/mp4",
	                            "application/javascript"
	                        ],
	                        "custom_renderer_present":true
                        };

                    }

                    var floor = getBidderFloor(bidder, size);
                    if(floor < requestData['astTags'][tag_id]['reserve']) {
                    	requestData['astTags'][tag_id]['reserve'] = floor;
                    }

                    requestData['astTags'][tag_id]['sizes'].push(parseSize(size));
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
	}


	/** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
	function send(bidData) {

	    //build tags
	    var bidder = bidData.bidder;
	    // Update Bidder Info
	    var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

	    var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
    	var astTags     = ProperMedia.utils.objectValues(requestData['astTags']) || [];
    	var request_cnt = requestData['request_cnt'];

		if(astTags.length == 0) {
			return false;
		}

		//build request
		var data = {
			"tags" : astTags,
			"sdk"  : {
		      "source"  : "pbjs",
		      "version" : properOps.prebid_version
		   },
		   "referrer_detection":{
				"rd_ref": encodeURIComponent(properPage.url),
				"rd_top": true,
				"rd_ifs": 0,
				"rd_stk": encodeURIComponent(properPage.url)
		   },
		   "user": {}
		}

		var eids = [];
        Object.keys(eIdAdapters).forEach(function(name) {
            var obj = eIdAdapters[name];
            addUserId(eids, ProperMedia.utils.deepAccess(obj.adapter, 'idObj.' + obj.valuePath), obj.adapter.source, null);    
        });
        if(eids.length) {
        	data.eids = eids;
        }

		// Supply chain object isset
        if(properOps.schain) {
            data.schain = properOps.schain;
        }

        // GDPR Consent
		if (gdprConsent.cmpPresent) {
			data.gdpr_consent = {
				'consent_string': gdprConsent.consentString,
				'consent_required': gdprConsent.gdprApplies
			};
		}

		// USP Consent
		if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
			data.us_privacy = uspConsent.usPrivacy;
		}

		//logging
		properLog.mylog(ENDPOINT_URL, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		// Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

		//send request
		$.ajax({
			url: ENDPOINT_URL,
			requestType: "cors",
			method: "POST",
			bidder: bidder,
            edge: edge,
			data: JSON.stringify(data),
			success: function(resp) {

				//parse resposne
				try {

					//logging
					properLog.mylog(resp, bidder);

					var bids_received_ts = ProperMedia.utils.getTimestampMs();
					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

					var json = ProperMedia.utils.safeJsonParse(resp);

					if (json && json.error) {
						properLog.mylog('Error: ' + bidder +' adapter - ' + json.error);
						
					} else if(json && json.tags) {

						for(var i = 0; i < json.tags.length; i++) {

							var obj = json.tags[i];

							if(obj.ads && obj.ads[0] && obj.ads[0].cpm) {

								//variables
								var tag_id = obj.tag_id,
									adData = obj.ads[0];
								
								var price  = adData.cpm || 0;

								var rev_share = bidderInfo['rev_share'] || 1;

								// New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'price'       : parseFloat(price * rev_share),
                                    'gross'       : parseFloat(price),
                                    'tag_id'      : tag_id,
                                    'request_url' : ENDPOINT_URL,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                if (bidderInfo.demand_type == 'video') {

                                	var notify_url = ProperMedia.utils.deepAccess(adData, 'rtb.notify_url')          || '',
                                		asset_url  = ProperMedia.utils.deepAccess(adData, 'rtb.video.asset_url')     || '',
                                		vastImpUrl = ProperMedia.utils.deepAccess(adData, 'rtb.video.notify_url')    || '',
										adWidth    = ProperMedia.utils.deepAccess(adData, 'rtb.video.player_width')  || '',
										adHeight   = ProperMedia.utils.deepAccess(adData, 'rtb.video.player_height') || '';

									var vast_tag = '',
										vast_type = '';

									if(bidderInfo.video_type == 'instream') {
										vast_tag = notify_url + '&redir=' + encodeURIComponent(asset_url);
										vast_type = 'url';
									} else if(bidderInfo.video_type == 'outstream') {
										vast_tag = ProperMedia.utils.deepAccess(adData, 'rtb.video.content') || '';
										vast_type = 'tag';
									}

                                    ad.size       = adWidth + 'x' + adHeight;
                                    ad.type       = 'video';
                                    ad.vast_tag   = vast_tag;
                                    ad.vast_type  = vast_type;
                                    ad.vpaid      = true;
                                    ad.video_type = bidderInfo.video_type;

                                } else {

                                	var adcode   = ProperMedia.utils.deepAccess(adData, 'rtb.banner.content') || '',
										adWidth  = ProperMedia.utils.deepAccess(adData, 'rtb.banner.width')   || '',
										adHeight = ProperMedia.utils.deepAccess(adData, 'rtb.banner.height')  || '';

									// Add tracking pixel
									var tracking_url = '';
									try	{
										tracking_url = adData.rtb.trackers[0].impression_urls[0];
									} catch (e) {}

									adcode += '<div style="position:absolute;left:0px;top:0px;visibility:hidden;"><img src="' + encodeURI(tracking_url) + '"></div>';

									ad.size   = adWidth + 'x' + adHeight;
                                    ad.adcode = adcode;
                                }

                                bidData.logBidResponse(ad);

							}
						}
					}

					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}
			},
			error: function(resp) {
				try {
        			bidData.incrementBidResponseCount(request_cnt);
				} catch (e) {
					e.bidder = bidder;
					throw e;
				}
			}
		});
	}

	function addUserId(eids, id, source, rti) {
		if (id) {
			if (rti) {
				eids.push(
					{ 
						"source": source,
						"id": id,
						"rti_partner": rti
					}
				);
			} else {
				eids.push(
					{ 
						"source": source,
						"id": id
					}
				);
			}
		}
		return eids;
	}

	function astUID() {
        var e = (new Date).getTime(),
            t = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(t) {
                var n = (e + 16 * Math.random()) % 16 | 0;
                return e = Math.floor(e / 16), ("x" === t ? n : 3 & n | 8).toString(16)
            });
        t = t.split("-")[4];
        return t;
    }

	userSyncs.add({
		type: 'iframe',
		url: SYNC_ENDPOINT,
        bidder: bidder
	});

	return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.concert = (function() {
	var bidderInfo = {
        rev_share   : 1,
        bid_grouping: 'page',
        default_bid_ttl : 60000,
        native_sizes: {
            '1030x590': 'native_horizontal'
        }
	};

    var ENDPOINT_URL  = 'https://bids.concert.io/bids/prebid',
        USER_SYNC_URL = 'https://cdn.concert.io/lib/bids/sync.html',
        bidder        = 'concert';

    var sizes = [[1030, 590], [620, 366], [325, 204], [325, 508]];


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'bids': {},
            'request_cnt': 0
        };

        var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(!site_id) {
            properLog.mylog('Error: Concert Site ID is Required.');
            return requestData;
        }

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    if(size == 'native_horizontal') {
                        var tag_id = data[size][i];
                        if(typeof requestData['bids'][tag_id] == 'undefined') {
                            requestData['bids'][tag_id] = {
                                'name'         : tag_id,
                                'bidId'        : tag_id,
                                'transactionId': ProperMedia.utils.generateUUID(),
                                'sizes'        : sizes,
                                'partnerId'    : site_id,
                                'slotType'     : ''
                            };
                            requestData['request_cnt'] += 4;
                        }
                    }
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData = formatRequest(bidData.requests);
        var bids        = ProperMedia.utils.objectValues(requestData['bids']) || [];
        var request_cnt = requestData['request_cnt'];

        if(request_cnt == 0) return;

        var post_data = {
            'meta': {
                'prebidVersion' : properOps.prebid_version,
                'pageUrl'       : properPage.bidder_page_url, // append to url to get test bids "&concert_prebid_test"
                'screen'        : [window.screen.width, window.screen.height].join('x'),
                'debug'         : (properOps.testing_mode.ids == true) ? true : false,
                'uid'           : getUid(),
                'optedOut'      : hasOptedOutOfPersonalization(),
                'adapterVersion': '1.0.2'
            },
            'slots': bids
        }

        //logging
        properLog.mylog(ENDPOINT_URL, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            url: ENDPOINT_URL,
            method: "POST",
            requestType: "cors",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(post_data),
            success: function(resp) {

                try {

                    resp = ProperMedia.utils.safeJsonParse(resp);

                    //process response
                    if(!resp || !resp.bids || resp.bids.length == 0) {
                        properLog.mylog("no "+bidder+" bids returned");

                    } else {

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        //logging
                        properLog.mylog(resp, bidder);

                        Object.keys(resp.bids).forEach(function(i) {

                            var obj = resp.bids[i];
                            
                            if(typeof obj.ad !== 'undefined') {

                                var impid      = obj.bidId        || '',
                                    price      = obj.cpm          || 0,
                                    netRevenue = obj.netRevenue   || 0,
                                    currency   = obj.currency     || 'USD',
                                    width      = obj.width        || 1,
                                    height     = obj.height       || 1,
                                    adcode     = obj.ad           || '',
                                    ttl        = (obj.ttl * 1000) || bidderInfo.default_bid_ttl;

                                var ad_size = width+'x'+height;
                                if(bidderInfo.native_sizes[ad_size]) {
                                    ad_size = bidderInfo.native_sizes[ad_size];
                                }

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : ad_size,
                                    'price'       : parseFloat(price * bidderInfo.rev_share),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : impid,
                                    'request_url' : ENDPOINT_URL,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : ttl
                                });

                                bidData.logBidResponse(ad);
                            }
                        });
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }



    consentManager.ready(function() {
        if (!hasOptedOutOfPersonalization()) {
            userSyncs.add({
                type: 'iframe',
                url: USER_SYNC_URL,
                bidder: bidder
            });
        }
    });

   

    /**
     * Check or generate a UID for the current user.
     */
    function getUid() {
        if (hasOptedOutOfPersonalization()) {
            return false;
        }

        var CONCERT_UID_KEY = 'c_uid';

        var uid = ProperMedia.utils.getDataFromLocalStorage(CONCERT_UID_KEY);

        if (!uid) {
            uid = ProperMedia.utils.generateUUID();
            ProperMedia.utils.setDataInLocalStorage(CONCERT_UID_KEY, uid);
        }

        return uid;
    }

    /**
     * Whether the user has opted out of personalization.
     */
    function hasOptedOutOfPersonalization() {
        var CONCERT_NO_PERSONALIZATION_KEY = 'c_nap';

        return ProperMedia.utils.getDataFromLocalStorage(CONCERT_NO_PERSONALIZATION_KEY) === 'true';
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.consumable = (function() {
	var bidderInfo = {
        "rev_share"   : 1,
        "demand_type" : 'display',
        "bid_grouping": 'page',
        "default_bid_ttl" : 30000
	};

	var networkId = '9969',
		siteId    = '1030626',
		bidder    = 'consumable',
		bidId     = 1;

	var ENDPOINT_URL  = "https://e.serverbid.com/api/v2";

	var sizeMap = [
		null,
		'120x90',
		'120x90',
		'468x60',
		'728x90',
		'300x250',
		'160x600',
		'120x600',
		'300x100',
		'180x150',
		'336x280',
		'240x400',
		'234x60',
		'88x31',
		'120x60',
		'120x240',
		'125x125',
		'220x250',
		'250x250',
		'250x90',
		'0x0',
		'200x90',
		'300x50',
		'320x50',
		'320x480',
		'185x185',
		'620x45',
		'300x125',
		'800x250'
	];

	sizeMap[77]   = '970x90';
	sizeMap[123]  = '970x250';
	sizeMap[43]   = '300x600';
	sizeMap[286]  = '970x66';
	sizeMap[3230] = '970x280';
	sizeMap[429]  = '486x60';
	sizeMap[374]  = '700x500';
	sizeMap[934]  = '300x1050';
	sizeMap[1578] = '320x100';
	sizeMap[331]  = '320x250';
	sizeMap[3301] = '320x267';
	sizeMap[2730] = '728x250';

	function getSize(size) {
		var index = sizeMap.indexOf(size[0] + 'x' + size[1]);
		if (index >= 0) {
			return index;
		}
		return false;
	}

    function formatRequest(data) {

    	var requestData = {
			'imps': {},
			'request_cnt': 0
		};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
            	for (var i = 0; i < data[size].length; i++) {

            		var tagId = data[size][i];

            		var params   = tagId.split('|'),
						unitName = params[0] || '',
						unitId   = params[1] || '',
						zoneIds  = (params[2] || '').split(',');

                    if(typeof requestData['imps'][tagId] == 'undefined') {
                    	requestData['imps'][tagId] = {
                    		'networkId': networkId,
                    		'siteId'   : siteId,
                    		'divName'  : tagId,
			    			'unitName' : unitName,
							'unitId'   : unitId,
							'zoneIds'  : [],
							'adTypes'  : []
			    		};
                    }

                    // Append zone IDs to array
			    	if ( zoneIds instanceof Array ) {
			    		requestData['imps'][tagId]['zoneIds'].concat(zoneIds.map(function(x) { return parseInt(x); }) );
			    	} else {
			    		requestData['imps'][tagId]['zoneIds'].push(parseInt(zoneIds));
			    	}

			    	var mappedSize = getSize(size.split('x'));
			    	// Append size to array
			    	if(mappedSize) {
				    	requestData['imps'][tagId]['adTypes'].push(mappedSize);
				    	requestData['request_cnt']++;
				    }
            	}
            });
        }

        return requestData;
    }

    function send(bidData) {

    	siteId = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || siteId;

    	var requestData = formatRequest(bidData.requests);
    	var imps        = requestData['imps'] || {};
    	var request_cnt = requestData['request_cnt'];

    	if(request_cnt == 0) return false;

    	var post_data = {
    		'networkId' : networkId,
			'siteId'    : siteId,
			'placements': ProperMedia.utils.objectValues(imps) || [],
			'time': Date.now(),
			'url': page.bidder_page_url,
			'referrer': page.referrer,
			'source': [{
		        'name': 'prebidjs',
		        'version': properOps.prebid_version
  			}]
		};

		// GDPR Consent
        if (gdprConsent.cmpPresent) {
        	post_data.gdpr = {
				'consent': gdprConsent.consentString,
				'applies': (typeof gdprConsent.gdprApplies === 'boolean') ? gdprConsent.gdprApplies : true
			};
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
        	post_data.ccpa = uspConsent.usPrivacy;
        }

        addUserSyncs();

        //logging
		properLog.mylog(ENDPOINT_URL, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

    	// Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

    	//send request
    	$.ajax({
    		url: ENDPOINT_URL,
    		method: "POST",
    		requestType: "cors",
    		bidder: bidder,
            edge: edge,
			data: JSON.stringify(post_data),
    		success: function(resp) {

				try {

    				//handle response
    				if(resp) {

    					resp = ProperMedia.utils.safeJsonParse(resp);

    					var bids_received_ts = ProperMedia.utils.getTimestampMs();
    					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

    					var serverResponse = resp || {};

    					if(serverResponse && typeof serverResponse.decisions !== 'undefined') {
    						for(bidId in serverResponse.decisions) {

								if(
									typeof serverResponse.decisions[bidId] !== 'undefined' &&
									typeof serverResponse.decisions[bidId].pricing !== 'undefined' &&
									typeof serverResponse.decisions[bidId].pricing.clearPrice !== 'undefined'
								) {

									var decision = serverResponse.decisions[bidId],
										price    = decision.pricing.clearPrice,
										width    = decision.width,
										height   = decision.height,
										adcode   = retrieveAd(decision);

									// New Ad object
	                                var ad = new adObj({
	                                    'bidder'      : bidder,
	                                    'size'        : width + 'x' + height,
	                                    'price'       : parseFloat(price),
	                                    'gross'       : parseFloat(price),
	                                    'adcode'      : adcode,
	                                    'tag_id'      : bidId,
	                                    'request_url' : ENDPOINT_URL,
	                                    'response'    : resp,
	                                    'response_ms' : bid_response_ms,
	                                    'received_ts' : bids_received_ts,
	                                    'ttl'         : bidderInfo.default_bid_ttl
	                                });

	                                bidData.logBidResponse(ad);

								}
    						}
    					}
    				}
    				//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

				} catch(e) {
    				e.bidder = bidder;
					throw e;
    			}

    		},
    		error: function(resp) {
    			try {
					//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}
    		}
    	});

    }

    function createTrackPixelHtml(url) {
		if (!url) {
			return '';
		}

		var escapedUrl = encodeURI(url);
		var img = '<div style="position:absolute;left:0px;top:0px;visibility:hidden;">';
		img += '<img src="' + escapedUrl + '"></div>';
		return img;
	};

	function retrieveAd(decision) {
		var ad = decision.contents && decision.contents[0] && decision.contents[0].body + createTrackPixelHtml(decision.impressionUrl);
		return ad;
	}

	function addUserSyncs() {
		// user cookie matching
		userSyncs.add({
			type: 'iframe',
			url: "https://sync.serverbid.com/ss/" + siteId + ".html",
	        bidder: bidder
		});
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.conversant = (function() {
	var bidderInfo = {
        "rev_share"       : 1,
        "demand_type"     : 'display',
        "bid_grouping"    : 'page',
        "default_bid_ttl" : 300000
	};

	var ENDPOINT_URL = "https://web.hb.ad.cpe.dotomi.com/s2s/header/24";
    var bidder = 'conversant';

    /**
	 * Parse size and format to object
	 * @param {string} size - size string: '728x90'
	 * @return {Object}
	 */
	function parseSize(size) {
		var s = size.split('x');
        return {
        	'w': parseInt(s[0]),
        	'h': parseInt(s[1])
        };
	}


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

    	var requestData = {
			'imps': {},
			'request_cnt': 0
		};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {

				    	requestData['imps'][tag_id] = {
			    			'id': tag_id.toString(),
							'bidfloor': getBidderFloor(bidder, size),
			    			'secure': (properPage.use_ssl ? 1 : 0),
			    			'displaymanager': 'propermedia',
			    			'displaymanagerver': '2.2.4',
			    			'banner': {
			    				'format': [],
			    				'pos': 0 // {'atf': 1, 'btf': 2}[slot.position] || 0
			    			}
			    		}
			    	}

		    		var floor = getBidderFloor(bidder, size);
                	if(floor < requestData['imps'][tag_id]['bidfloor']) {
                    	requestData['imps'][tag_id]['bidfloor'] = floor;
                    }

                    requestData['imps'][tag_id]['banner']['format'].push(parseSize(size));
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(!site_id) {
            properLog.mylog('Error: Conversant Site ID is Required.');
            return false;
        }

    	var requestData = formatRequest(bidData.requests);
    	var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
    	var request_cnt = requestData['request_cnt'];

		var post_data = {
    		'id'  : Date.now().toString(),
    		'at'  : 1,
    		'imp' : imps,
    		'site': {
    			'id'    : site_id.toString(),
    			'mobile': (properDevice.isMobile() ? 1 : 0),
				'page'  : properPage.bidder_page_url
    		},
			'device' : getDevice(),
			'user': {
				'ext': {
					'fpc': properUser.pubcid
				}
			}
    	}


    	// Add Eids if available
		var eids = collectEids();
		if (eids.length > 0) {
			ProperMedia.utils.deepSetValue(post_data, 'user.ext.eids', eids);
		}

    	// Supply chain object isset
        if(properOps.schain) {
            post_data.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

        // GDPR Consent
    	if (gdprConsent.cmpPresent) {
			post_data.user.ext.consent = gdprConsent.consentString;
			if (typeof gdprConsent.gdprApplies === 'boolean') {
				post_data.regs = {
					ext: { gdpr: Number(gdprConsent.gdprApplies) }
				};
			}
		}

		// USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            post_data.regs = post_data.regs || {};
            post_data.regs.ext = post_data.regs.ext || {};
            post_data.regs.ext.us_privacy = uspConsent.usPrivacy;
        }

		//logging
		properLog.mylog(ENDPOINT_URL, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		//send request
		$.ajax({
			url: ENDPOINT_URL,
			method: "POST",
			requestType: "cors",
			data: JSON.stringify(post_data),
			success: function(resp) {

				try {
					
					resp = ProperMedia.utils.safeJsonParse(resp);

					//process response
			        if(!resp || !resp.seatbid || resp.seatbid.length == 0 || !resp.seatbid[0].bid) {
		          		properLog.mylog("no conversant bids returned");

			        } else {

						var bids_received_ts = ProperMedia.utils.getTimestampMs();
						var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

			        	//logging
						properLog.mylog(resp, bidder);

						Object.keys(resp.seatbid).forEach(function(x) {
							Object.keys(resp.seatbid[x].bid).forEach(function(i) {

								var obj = resp.seatbid[x].bid[i];

								if(typeof obj.adm !== 'undefined') {

									var id      = obj.id      || '',
										impid   = obj.impid   || '',
										price   = obj.price   || 0,
										width   = obj.w       || 1,
										height  = obj.h       || 1,
										adm     = obj.adm     || '',
										nurl    = obj.nurl    || '';
									
									var adcode  = (nurl) ? adm + '<img src="' + nurl + '" />' : adm;

									// New Ad object
	                                var ad = new adObj({
	                                    'bidder'      : bidder,
	                                    'size'        : width + 'x' + height,
	                                    'price'       : parseFloat(price),
	                                    'gross'       : parseFloat(price),
	                                    'adcode'      : adcode,
	                                    'tag_id'      : impid,
	                                    'request_url' : ENDPOINT_URL,
	                                    'response'    : obj,
	                                    'response_ms' : bid_response_ms,
	                                    'received_ts' : bids_received_ts,
	                                    'ttl'         : bidderInfo.default_bid_ttl
	                                });

	                                bidData.logBidResponse(ad);
								}
							});
						});
					}
					
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}
			}
		});
    }

	/**
	* Collect IDs and store them as an extended id array
	*/
	function collectEids() {
		var eids = userIds.getEidsArray();
		if (ProperMedia.utils.isArray(eids) && eids.length > 0) {
			// later following white-list can be converted to block-list if needed
			const requiredSourceValues = {
				'adserver.org': 1,
				'liveramp.com': 1,
				'criteo.com': 1,
				'id5-sync.com': 1,
				'parrable.com': 1,
				'digitru.st': 1,
				'liveintent.com': 1
			};
			eids.forEach(function(eid) {
				if (requiredSourceValues.hasOwnProperty(eid.source)) {
					eids.push(eid);
				}
			});
		}
		return eids;
	}


	function getDevice() {
		var language = navigator.language ? 'language' : 'userLanguage';
		return {
			h: screen.height,
			w: screen.width,
			dnt: ProperMedia.utils.getDNT() ? 1 : 0,
			language: navigator[language].split('-')[0],
			make: navigator.vendor ? navigator.vendor : '',
			ua: navigator.userAgent
		};
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.criteo = (function() {
	var bidderInfo = {
        "rev_share"       : 1,
        "demand_type"     : 'display',
        "bid_grouping"    : 'page',
        "default_bid_ttl" : 60000
	};

    var bidder = 'criteo';
    var networkId = 8388;
    var ENDPOINT_URL = 'https://bidder.criteo.com/cdb';

    var ADAPTER_VERSION   = 29,
        PROFILE_ID_INLINE = 207,
        INTEGRATION_MODES = {
          'amp': 1,
        };


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'slots': {},
            'request_cnt': 0
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['slots'][tag_id] == 'undefined') {
                        requestData['slots'][tag_id] = {
                            'impid' : tag_id,
                            'sizes' : []
                        };
                    }

                    requestData['slots'][tag_id]['sizes'].push(size);
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData = formatRequest(bidData.requests);
        var slots       = ProperMedia.utils.objectValues(requestData['slots']) || [];
        var request_cnt = requestData['request_cnt'];

    	var data = {
    		'publisher': {
    			'url': properPage.bidder_page_url,
                'networkid': parseInt(networkId)
    		},
    		'slots': slots
    	}

        if(data.slots.length == 0) return false;

        // GDPR Consent
		if (gdprConsent.cmpPresent) {
			data.gdprConsent = {};
			if (typeof gdprConsent.gdprApplies !== 'undefined') {
				data.gdprConsent.gdprApplies = !!gdprConsent.gdprApplies;
			}
			if (typeof gdprConsent.consentString !== 'undefined') {
				data.gdprConsent.consentData = gdprConsent.consentString;
			}
			if (gdprConsent.vendorData &&
				gdprConsent.vendorData.vendorConsents &&
				typeof gdprConsent.vendorData.vendorConsents['91'] !== 'undefined'
			) {
				data.gdprConsent.consentGiven = !!(gdprConsent.vendorData.vendorConsents['91']);
			}
		}

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            data.user = {
                uspIab: uspConsent.usPrivacy
            }
        }

        var request_url = ENDPOINT_URL;
        request_url += '?profileId=' + PROFILE_ID_INLINE;
        request_url += '&av=' + String(ADAPTER_VERSION);
        request_url += '&wv=' + encodeURIComponent(properOps.prebid_version);
        request_url += '&cb=' + String(Math.floor(Math.random() * 99999999999));
        request_url += '&im=' + INTEGRATION_MODES['amp'];

        // check debug mode
        if(properOps.testing_mode.ids == true) {
            request_url += '&debug=1';
        }

    	//logging
    	properLog.mylog(request_url, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();

    	//send request
    	$.ajax({
    		url: request_url,
    		requestType: "cors",
    		method: "POST",
    		data: JSON.stringify(data),
    		success: function(json) {

			    try {

    				//logging
    				properLog.mylog(json,bidder);

					var resp = ProperMedia.utils.safeJsonParse(json);

    				//handle response
    				if(resp) {

    					var bids_received_ts = ProperMedia.utils.getTimestampMs();
    					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

    					//process data
    					if(typeof resp['slots'] !== 'undefined') {
                            Object.keys(resp['slots']).forEach(function(key) {

    							var obj = resp['slots'][key];

    							//we got one!
    							var impid  = obj.impid,
                                    tagid  = obj.zoneid,
                                    price  = obj.cpm,
                                    width  = obj.width,
                                    height = obj.height,
                                    adcode = obj.creative,
                                    ttl    = (obj.ttl * 1000) || bidderInfo.default_bid_ttl;

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : width + 'x' + height,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : tagid,
                                    'request_url' : request_url,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : ttl
                                });

                                bidData.logBidResponse(ad);
    						});
    					}
    				}

        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) { 
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) { 
                    e.bidder = bidder;
                    throw e;
                }

    		}
    	});
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.districtmdmx = (function() {
	var bidderInfo = {
        "rev_share"       : 1,
        "demand_type"     : 'display',
        "bid_grouping"    : 'page',
        "default_bid_ttl" : 360000
	};

    var ENDPOINT_URL  = 'https://dmx.districtm.io/b/v1',
        TEST_ENDPOINT = 'https://demo.arrepiblik.com/dmx2',
        SYNC_ENDPOINT = 'https://cdn.districtm.io/ids/index.html',
        memberID      = 100275,
        bidder        = 'districtmdmx';

    var eIdAdapters = {
        "identityLink": {
            "adapter": userIdAdapters.identityLink,
            "valuePath": "idl_env"
        }, 
        "id5Id": {
            "adapter": userIdAdapters.id5Id,
            "valuePath": "id5id.uid"
        },
        "pubCommonId": {
            "adapter": userIdAdapters.pubCommonId,
            "valuePath": "pubcid"
        }
    };

    /**
     * Parse size and format to object
     * @param {string} size - size string: '728x90'
     * @return {Object}
     */
    function parseSize(size) {
        var s = size.split('x');
        return {
            'w': parseInt(s[0]),
            'h': parseInt(s[1])
        };
    }


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

        var requestData = {
            'imps': {},
            'request_cnt': 0
        };

        var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {

                        var s = size.split('x');

                        if(!site_id) site_id = tag_id;

                        requestData['imps'][tag_id] = {
                            'id'      : String(tag_id),
                            'tagid'   : String(site_id),
                            'secure'  : (properPage.use_ssl ? 1 : 0),
                            'bidfloor': getBidderFloor(bidder, size)
                        };

                        if (bidderInfo.demand_type == 'display') {
                            requestData['imps'][tag_id]['banner'] = {
                                'topframe': 1,
                                'w'       : parseInt(s[0]) || 0,
                                'h'       : parseInt(s[1]) || 0,
                                'format'  : []
                            };

                        } else if (bidderInfo.demand_type == 'video') {
                            requestData['imps'][tag_id]['video'] = {
                                'topframe'      : 1,
                                'skip'          : 1,
                                'linearity'     : (bidderInfo.video_type == 'outstream') ? 2 : 1,
                                'minduration'   : 10,
                                'maxduration'   : 30,
                                "playbackmethod": [2],
                                'api'           : [1, 2],
                                'mimes'         : ['video/mp4', "application/javascript"],
                                'protocols'     : [2, 3, 5, 6],
                                'w'             : parseInt(s[0]) || 0,
                                'h'             : parseInt(s[1]) || 0
                            };
                        }
                    }

                    var floor = getBidderFloor(bidder, size);
                    if(floor < requestData['imps'][tag_id]['bidfloor']) {
                        requestData['imps'][tag_id]['bidfloor'] = floor;
                    }

                    if (bidderInfo.demand_type == 'display') {
                        requestData['imps'][tag_id]['banner']['format'].push(parseSize(size));
                    }
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
        var request_cnt = requestData['request_cnt'];

        //build url
        var request_url = properOps.testing_mode.ids == true ? TEST_ENDPOINT : ENDPOINT_URL; // API endpoint

        var post_data = {
            'id'  : ProperMedia.utils.generateUUID(),
            'cur' : ['USD'],
            'tmax': 550,
            'site': {
                'publisher': {
                    'id': String(memberID)
                }
            },
            'imp': imps
        }

        var eids = [];
        Object.keys(eIdAdapters).forEach(function(name) {
            var obj = eIdAdapters[name];
            bindUserId(eids, ProperMedia.utils.deepAccess(obj.adapter, 'idObj.' + obj.valuePath), obj.adapter.source, obj.adapter.atype);    
        });

        if(eids) {
            ProperMedia.utils.deepSetValue(post_data, 'user.ext.eids', eids);
        }

        // Supply chain object isset
        if(properOps.schain) {
            post_data.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            post_data.user = {
                ext: {
                    consent: gdprConsent.consentString
                }
            };
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                post_data.regs = {
                    ext: {
                        gdpr: Number(gdprConsent.gdprApplies)
                    }
                };
            }
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            ProperMedia.utils.deepSetValue(post_data, 'regs.ext.us_privacy', uspConsent.usPrivacy);
        }

        // check debug mode
        if(properOps.testing_mode.ids == true) {
            post_data.test = 1;
        }

        //logging
        properLog.mylog(request_url, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            url: request_url,
            requestType: "cors",
            method: "POST",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(post_data),
            success: function(resp) {

                try {

                    resp = ProperMedia.utils.safeJsonParse(resp);

                    //process response
                    if(!resp || !resp.seatbid || resp.seatbid.length == 0 || !resp.seatbid[0].bid) {
                        properLog.mylog("No " + bidder + " bids returned");

                    } else {

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        //logging
                        properLog.mylog(resp, bidder);

                        Object.keys(resp.seatbid).forEach(function(x) {
                            Object.keys(resp.seatbid[x].bid).forEach(function(i) {

                                var obj = resp.seatbid[x].bid[i];

                                if(typeof obj.adm !== 'undefined') {

                                    var id      = obj.id      || '',
                                        impid   = obj.impid   || '',
                                        price   = obj.price   || 0,
                                        width   = obj.w       || 0,
                                        height  = obj.h       || 0,
                                        adm     = obj.adm     || '',
                                        nurl    = obj.nurl    || '';

                                    var adcode  = (nurl) ? adm + '<img src="' + nurl + '" />' : adm;

                                    // Dont log the bid if we dont know the size
                                    if(!width || !height) {
                                        var dtype = bidderInfo.demand_type == 'display' ? 'banner' : 'video';
                                        width  = ProperMedia.utils.deepAccess(requestData, 'imps.' + impid +  '.' + dtype + '.w');
                                        height = ProperMedia.utils.deepAccess(requestData, 'imps.' + impid +  '.' + dtype + '.h');
                                    }

                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'size'        : width + 'x' + height,
                                        'price'       : parseFloat(price),
                                        'gross'       : parseFloat(price),
                                        'tag_id'      : impid,
                                        'request_url' : request_url,
                                        'response'    : obj,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts,
                                        'ttl'         : bidderInfo.default_bid_ttl
                                    });

                                    if (bidderInfo.demand_type == 'video') {

                                        var vast_tag = cleanVast(adm, nurl),
                                            attr      = obj.attr     || [],
                                            api       = obj.api      || 0,
                                            protocol  = obj.protocol || 5;

                                        var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                            vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                        ad.type       = 'video';
                                        ad.vast_tag   = vast_tag;
                                        ad.vast_type  = vast_type;
                                        ad.vpaid      = vpaid;
                                        ad.video_type = bidderInfo.video_type;

                                    } else {
                                        ad.adcode = adcode;
                                    }
                                    
                                    bidData.logBidResponse(ad);
                                }
                            });
                        });
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    function bindUserId(eids, value, source, atype) {
        if (ProperMedia.utils.isStr(value) && Array.isArray(eids)) {
            eids.push({
                "source": source,
                "uids": [
                    {
                        "id": value,
                        "atype": atype
                    }
                ]
            })
        }
    }


    consentManager.ready(function() {
        var query = [];
        var url = SYNC_ENDPOINT;
        if (gdprConsent && gdprConsent.cmpPresent && gdprConsent.gdprApplies && typeof gdprConsent.consentString === 'string') {
            query.push(['gdpr', gdprConsent.consentString])
        }
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            query.push(['ccpa', uspConsent.usPrivacy])
        }
        if (query.length > 0) {
            url += '?' + query.map(function(q) { q.join('='); }).join('&');
        }
        userSyncs.add({
            type: 'iframe',
            url: url,
            bidder: bidder
        });
    });


    function cleanVast(str, nurl) {
        try {
            var toberemove = /<img\s[^>]*?src\s*=\s*['\"]([^'\"]*?)['\"][^>]*?>/;
            var matches = str.match(toberemove),
                img = matches[0] || '',
                url = matches[1] || '';

            str = str.replace(toberemove, '');
            if (img) {
                if (url) {
                    var insrt = "<Impression><![CDATA[" + url + "]]></Impression>";
                    str = str.replace('</Impression>', "</Impression>" + insrt);
                }
            }
            return str;
        } catch (e) {
            if (!nurl) {
                return str;
            }
            var insrt = "<Impression><![CDATA[" + nurl + "]]></Impression>";
            str = str.replace('</Impression>', "</Impression>" + insrt);
            return str;
        }
    }


    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.emx = (function() {
	var bidderInfo = {
        "rev_share"   : 1,
        "demand_type" : 'display',
        "bid_grouping": 'page'
	};

	var ENDPOINT_URL    = "https://hb.emxdgt.com",
		SYNC_ENDPOINT   = "https://biddr.brealtime.com/check.html",
		ADAPTER_VERSION = '1.5.1';

    var bidder = 'emx';
    
    /**
	 * Parse size and format to object
	 * @param {string} size - size string: '728x90'
	 * @return {Object}
	 */
	function parseSize(size) {
		var s = size.split('x');
        return {
        	'w': parseInt(s[0]),
        	'h': parseInt(s[1])
        };
	}


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

    	var requestData = {
			'imps': {},
			'request_cnt': 0
		};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {

                        var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || tag_id;
                    	var s = size.split('x');
                    	
				    	requestData['imps'][tag_id] = {
			    			'id': tag_id.toString(),
			    			'tid': ProperMedia.utils.generateUUID(),
			    			'tagid': site_id.toString(),
			    			'secure': properPage.use_ssl ? 1 : 0,
			    			'bidfloor': getBidderFloor(bidder, size),
			    			'bidfloorcur': 'USD',
			    			'banner': {
			    				'w': s[0],
			    				'h': s[1],
			    				'format': []
			    			}
			    		}

			    		if (bidderInfo.demand_type == 'display') {
                            requestData['imps'][tag_id]['banner'] = {
                                'w'       : parseInt(s[0]) || 0,
                                'h'       : parseInt(s[1]) || 0,
                                'format'  : []
                            };

                        } else if (bidderInfo.demand_type == 'video') {
                            requestData['imps'][tag_id]['video'] = {
                                'topframe'        : 1,
                                'skippable'       : 1,
                                'linearity'       : (bidderInfo.video_type == 'outstream') ? 2 : 1,
                                'minduration'     : 10,
                                'maxduration'     : 30,
                                'playback_methods': ['auto_play_sound_off'],
                                'api'             : [1, 2],
                                'mimes'           : ['video/mp4', "application/javascript"],
                                'protocols'       : [2, 3, 5, 6],
                                'w'               : parseInt(s[0]) || 0,
                                'h'               : parseInt(s[1]) || 0
                            };
                        }
                    }

                    var floor = getBidderFloor(bidder, size);
                    if(floor < requestData['imps'][tag_id]['bidfloor']) {
                    	requestData['imps'][tag_id]['bidfloor'] = floor;
                    }

                    if (bidderInfo.demand_type == 'display') {
                    	requestData['imps'][tag_id]['banner']['format'].push(parseSize(size));
                    }
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	//build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

    	var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
    	var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
    	var request_cnt = requestData['request_cnt'];

		//build url
    	var request_url = ENDPOINT_URL + ('?t=' + 1000 + '&ts=' + Date.now()); // API endpoint

		var post_data = {
    		'id'  : Date.now().toString(),
    		'imp' : imps,
    		'site': {
    			'domain': ProperMedia.utils.getPageDomain(),
				'page'  : properPage.bidder_page_url,
				'ref'   : properPage.referrer
    		},
    		'device': {
				'ua': navigator.userAgent,
				'js': 1,
				'dnt': ProperMedia.utils.getDNT() ? 1 : 0,
				'h': properPage.height,
				'w': properPage.width,
				'devicetype': properDevice.isMobile() ? 1 : 2,
				'language': (navigator.language || navigator.browserLanguage || navigator.userLanguage || navigator.systemLanguage),
			},
			'cur': 'USD',
			'version': ADAPTER_VERSION
    	}

    	// Supply chain object isset
        if(properOps.schain) {
            post_data.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

		// GDPR Consent
    	if (gdprConsent.cmpPresent) {
			post_data.user = {
				ext: {
					consent: gdprConsent.consentString
				}
			}
			if (typeof gdprConsent.gdprApplies === 'boolean') {
				post_data.regs = {
					ext: {
						gdpr: Number(gdprConsent.gdprApplies)
					}
				};
			}
		}

		// USP Consent
		if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
			post_data.us_privacy = uspConsent.usPrivacy;
	    }

		//logging
		properLog.mylog(request_url, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		// Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

		//send request
		$.ajax({
			url: request_url,
			method: "POST",
			requestType: "cors",
			bidder: bidder,
            edge: edge,
			data: JSON.stringify(post_data),
			success: function(resp) {

				try {

					resp = ProperMedia.utils.safeJsonParse(resp);

					//process response
			        if (resp.seatbid && resp.seatbid.length > 0 && resp.seatbid[0].bid) {

						var bids_received_ts = ProperMedia.utils.getTimestampMs();
						var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

			        	//logging
						properLog.mylog(resp, bidder);

						Object.keys(resp.seatbid).forEach(function(x) {

							var obj = resp.seatbid[x].bid[0];

							if(typeof obj.adm !== 'undefined') {

								var id     = obj.id    || '',
									impid  = obj.crid  || obj.id,
									price  = obj.price || 0,
									width  = obj.w     || 1,
									height = obj.h     || 1,
									adcode = obj.adm   || '',
									ttl    = (obj.ttl * 1000) || bidderInfo.default_bid_ttl;
								
                                if(width == 1 && height == 1) {
                                    width  = imps[0].banner.w;
                                    height = imps[0].banner.h;
                                }

								// New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : width + 'x' + height,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'tag_id'      : id,
                                    'request_url' : request_url,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : ttl
                                });

                                if (bidderInfo.demand_type == 'video') {

                                    var vast_tag  = adcode,
                                        attr      = obj.attr     || [],
                                        api       = obj.api      || 0,
                                        protocol  = obj.protocol || 5;

                                    var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                        vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                    ad.type       = 'video';
                                    ad.vast_tag   = vast_tag;
                                    ad.vast_type  = vast_type;
                                    ad.vpaid      = vpaid;
                                    ad.video_type = bidderInfo.video_type;

                                } else {

                                	try {
										adcode = decodeURIComponent(adcode) || '';
									} catch (e) {
										adcode = obj.adm || '';
									}

                                    ad.adcode = adcode;
                                }

                                bidData.logBidResponse(ad);
							}
						});
					}

					//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}
			}
		});
    }

    consentManager.ready(function() {
        var query = [];
        var url = SYNC_ENDPOINT;
        if (gdprConsent && gdprConsent.cmpPresent && typeof gdprConsent.consentString === 'string') {
        	if (typeof gdprConsent.gdprApplies === 'boolean') {
            	query.push(['gdpr', Number(gdprConsent.gdprApplies)], ['gdpr_consent', gdprConsent.consentString]);
        	} else {
        		query.push(['gdpr_consent', gdprConsent.consentString]);
        	}
        }
        if (query.length > 0) {
            url += '?' + query.map(function(q) { q.join('='); }).join('&');
        }
        userSyncs.add({
            type: 'iframe',
            url: url,
            bidder: bidder
        });
    });

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.facebook = (function() {
	var bidderInfo = {
        "rev_share"   : 1,
        "demand_type" : 'display',
        "bid_grouping": 'page'
	};

    var ENDPOINT_URL = "https://an.facebook.com/v2/placementbid.json?sdk=5.5.web";
    var bidder = 'facebook';


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'bids': {},
            'request_cnt': 0,
            'query_string': ''
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    // test for banner or native ads
                    var tag_id = data[size][i];
                    var format = "native";
                    var bidmod = 0.50; //default is 50%

                    if(tag_id.indexOf("-") != -1) {

                        var dt = tag_id.split("-");
                        tag_id = dt[0];

                        if(dt[1] == "banner") {
                            format = "banner";
                        } else if (dt[1] == 'fullwidth') {
                            format = "fullwidth"
                        } else if(dt[1] != "native") {
                            bidmod = (dt[1]/100);
                        }

                        if(typeof dt[2] != 'undefined') bidmod = (dt[1]/100);

                    }

                    //build array
                    requestData['bids'][tag_id] = { 
                        "size"   : size, 
                        "format" : format, 
                        "bidmod" : bidmod 
                    };

                    // check for native/banner type
                    var adformats = (requestData['bids'][tag_id].format == "banner") ? requestData['bids'][tag_id].size : requestData['bids'][tag_id].format;

                    //build url
                    requestData['query_string'] += "&placementids[]=" + tag_id + "&adformats[]=" + adformats;
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;

    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData  = formatRequest(bidData.requests);
        var query_string = requestData['query_string'] || '';
        var request_cnt  = requestData['request_cnt'];

        if(request_cnt == 0) {
            return false;
        }

        //facebook endpoint
        var request_url = ENDPOINT_URL + query_string;

        //test mode
        var testmode = false;
        if(properOps.testing_mode.ids == true) {
            testmode = true;
            properLog.mylog('Facebook debug mode');
        }

        request_url += "&testmode=" + testmode;

        //logging
        properLog.mylog(request_url, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            url: request_url,
            requestType: "cors",
            bidder: bidder,
            edge: edge,
            success: function(resp){

                //handle response
                try {

                    //logging
                    properLog.mylog(resp, bidder);

                    var data = ProperMedia.utils.safeJsonParse(resp);

                    if(data && typeof data.bids !== 'undefined') {

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        // process data
                        Object.keys(data.bids).forEach(function(key) {
                            for (var i = 0; i < data.bids[key].length; i++) {
                                var obj = data.bids[key][i];

                                var price    = parseFloat(obj.bid_price_cents / 100) || 0,
                                    tagid    = obj.placement_id       || '',
                                    bidid    = obj.bid_id             || '',
                                    currency = obj.bid_price_currency || '',
                                    ad_type  = obj.bid_price_model    || '';

                                if(currency !== "usd" || ad_type !== "cpm") {
                                    //logging error
                                    properLog.mylog("We don't know how they are paying us. currency: " + currency + " bid_price_model: " + ad_type);
                                    continue;
                                }

                                //figure out what slot/size we got back
                                if(typeof requestData['bids'][tagid] == "undefined" || price == 0) continue;

                                var size   = requestData['bids'][tagid].size,
                                    format = requestData['bids'][tagid].format,
                                    bidmod = requestData['bids'][tagid].bidmod;

                                // if(bidmod < 1) cpm = (cpm * bidmod); // multiply by view-ability percentage

                                //build ad creative
                                var adcode = '<html>';
                                        adcode += '<body>';
                                            adcode += '<div style="display:none; position: relative;">';
                                                adcode += '<script type="text/javascript">';
                                                    adcode += 'var data = {';
                                                            adcode += 'placementid: "'+tagid+'",';
                                                            adcode += 'format: "'+(format == 'fullwidth' ? format : size)+'",';
                                                            adcode += 'bidid: "'+bidid+'",';
                                                            adcode += 'testmode: false,';
                                                            adcode += 'onAdLoaded: function(element) {';
                                                                adcode += 'element.style.display = "block";';
                                                            adcode += '},';
                                                            adcode += 'onAdError: function(errorCode, errorMessage) {';
                                                                adcode += 'console.log("Audience Network '+tagid+' error (" + errorCode + ") " + errorMessage);';
                                                            adcode += '}';
                                                    adcode += '};';
                                                adcode += '</script>';
                                                adcode += '<script>';
                                                    adcode += '(function(a,b,c){var d="https://www.facebook.com",e="https://connect.facebook.net/en_US/fbadnw55.js",f={iframeLoaded:true,xhrLoaded:true},g=a.data,h=function(){if(Date.now){return Date.now();}else return +new Date();},i=function(aa){var ba=d+"/audience_network/client_event",ca={cb:h(),event_name:"ADNW_ADERROR",ad_pivot_type:"audience_network_mobile_web",sdk_version:"5.5.web",app_id:g.placementid.split("_")[0],publisher_id:g.placementid.split("_")[1],error_message:aa},da=[];for(var ea in ca)da.push(encodeURIComponent(ea)+"="+encodeURIComponent(ca[ea]));var fa=ba+"?"+da.join("&"),ga=new XMLHttpRequest();ga.open("GET",fa,true);ga.send();if(g.onAdError)g.onAdError("1000","Internal error.");},j=function(){if(b.currentScript){return b.currentScript;}else{var aa=b.getElementsByTagName("script");return aa[aa.length-1];}},k=function(aa){try{return aa.document.referrer;}catch(ba){}return "";},l=function(){var aa=a,ba=[aa];try{while(aa!==aa.parent&&aa.parent.document)ba.push(aa=aa.parent);}catch(ca){}return ba.reverse();},m=function(){var aa=l();for(var ba=0;ba<aa.length;ba++){var ca=aa[ba],da=ca.ADNW||{};ca.ADNW=da;if(!ca.ADNW)continue;return da.v55=da.v55||{ads:[],window:ca};}throw new Error("no_writable_global");},n=function(aa){var ba=aa.indexOf("/",aa.indexOf("://")+3);if(ba===-1)return aa;return aa.substring(0,ba);},o=function(aa){return aa.location.href||k(aa);},p=function(aa){if(aa.sdkLoaded)return;var ba=aa.window.document,ca=ba.createElement("iframe");ca.name="fbadnw";ca.style.display="none";ba.body.appendChild(ca);var da=ca.contentDocument.createElement("script");da.src=e;da.async=true;ca.contentDocument.body.appendChild(da);aa.sdkLoaded=true;},q=function(aa){var ba=/^https?:\\/\\/www\\.google(\\.com?)?.\\w{2,3}$/;return !!aa.match(ba);},r=function(aa){return !!aa.match(/cdn\\.ampproject\\.org$/);},s=function(){var aa=c.ancestorOrigins||[],ba=aa[aa.length-1]||c.origin,ca=aa[aa.length-2]||c.origin;if(q(ba)&&r(ca)){return n(ca);}else return n(ba);},t=function(aa){try{return JSON.parse(aa);}catch(ba){i(ba.message);throw ba;}},u=function(aa,ba,ca){if(!aa.iframe){var da=ca.createElement("iframe");da.src=d+"/audiencenetwork/iframe/";da.style.display="none";ca.body.appendChild(da);aa.iframe=da;aa.iframeAppendedTime=h();aa.iframeData={};}ba.iframe=aa.iframe;ba.iframeData=aa.iframeData;ba.tagJsIframeAppendedTime=aa.iframeAppendedTime||0;},v=function(aa){var ba=d+"/audiencenetwork/xhr/?sdk=5.5.web";for(var ca in aa)if(typeof aa[ca]!=="function")ba+="&"+ca+"="+encodeURIComponent(aa[ca]);var da=new XMLHttpRequest();da.open("GET",ba,true);da.withCredentials=true;da.onreadystatechange=function(){if(da.readyState===4){var ea=t(da.response);aa.events.push({name:"xhrLoaded",source:aa.iframe.contentWindow,data:ea,postMessageTimestamp:h(),receivedTimestamp:h()});}};da.send();},w=function(aa,ba){var ca=d+"/audiencenetwork/xhriframe/?sdk=5.5.web";for(var da in ba)if(typeof ba[da]!=="function")ca+="&"+da+"="+encodeURIComponent(ba[da]);var ea=b.createElement("iframe");ea.src=ca;ea.style.display="none";b.body.appendChild(ea);ba.iframe=ea;ba.iframeData={};ba.tagJsIframeAppendedTime=h();},x=function(aa){var ba=function(event){try{var da=event.data;if(da.name in f)aa.events.push({name:da.name,source:event.source,data:da.data});}catch(ea){}},ca=aa.iframe.contentWindow.parent;ca.addEventListener("message",ba,false);},y=function(aa){if(aa.context&&aa.context.sourceUrl)return true;try{return !!JSON.parse(decodeURI(aa.name)).ampcontextVersion;}catch(ba){return false;}},z=function(aa){var ba=h(),ca=l()[0],da=j().parentElement,ea=ca!=a.top,fa=ca.$sf&&ca.$sf.ext,ga=o(ca),ha=m();p(ha);var ia={amp:y(ca),events:[],tagJsInitTime:ba,rootElement:da,iframe:null,tagJsIframeAppendedTime:ha.iframeAppendedTime||0,url:ga,domain:s(),channel:n(o(ca)),width:screen.width,height:screen.height,pixelratio:a.devicePixelRatio,placementindex:ha.ads.length,crossdomain:ea,safeframe:!!fa,placementid:g.placementid,format:g.format||"300x250",testmode:!!g.testmode,onAdLoaded:g.onAdLoaded,onAdError:g.onAdError};if(g.bidid)ia.bidid=g.bidid;if(ea){w(ha,ia);}else{u(ha,ia,ca.document);v(ia);}x(ia);ia.rootElement.dataset.placementid=ia.placementid;ha.ads.push(ia);};try{z();}catch(aa){i(aa.message||aa);throw aa;}})(window,document,location);';
                                                adcode += '</script>';
                                            adcode += '</div>';
                                        adcode += '</body>';
                                    adcode += '</html>';


                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : size,
                                    'price'       : price,
                                    'gross'       : price,
                                    'adcode'      : adcode,
                                    'tag_id'      : tagid,
                                    'request_url' : request_url,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts
                                });

                                bidData.logBidResponse(ad);
                            }
                        });
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) { 
                    e.bidder = bidder;
                    throw e;
                }
            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                } catch (e) { 
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.index = (function() {
	var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000
	};

    var bidder  = 'index',
        properID = 161112;

    var eIdAdapters = {
        "identityLink": {
            "adapter": userIdAdapters.identityLink,
            "valuePath": "idl_env",
            "ixlPartnerName": "LiveRampIp", 
            "rtiPartner": "idl"
        }
    };

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'data':[],
            'index_bids': {}
        };

        var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(!site_id) {
            properLog.mylog('Error: Index Excnahge Site ID is Required.');
            return requestData;
        }
        
        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    var tag_id = data[size][i];
                    if(typeof requestData[tag_id] == 'undefined') {

                        var id = tag_id + '-' + ProperMedia.utils.makeid(5);
                        var sizeArr = size.split("x");

                        var floor = getBidderFloor(bidder, size);;

                        requestData['data'].push( 
                            {
                                "id"          : id, 
                                "width"       : parseInt(sizeArr[0]), 
                                "height"      : parseInt(sizeArr[1]), 
                                "siteID"      : parseInt(site_id), 
                                "bidfloorcur" : "USD", 
                                "bidfloor"    : floor 
                            } 
                        )

                        requestData['index_bids'][id] = { 
                            'width'  : parseInt(sizeArr[0]), 
                            'height' : parseInt(sizeArr[1]), 
                            "tag_id" : tag_id, 
                            "floor"  : floor 
                        }
                    }
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData = formatRequest(bidData.requests);
    	var request_cnt = requestData.data.length;
		var request_url = buildRequestUrl(properID, requestData.data);

        if(request_cnt == 0) return false;

    	//logging
    	properLog.mylog(request_url, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        $.ajax({
        	url: request_url,
        	special : bidder,
        	requestType: "jsonp",
        	success: function(resp) {

                try {
    				//process response
        	        if(!resp || !resp.seatbid || resp.seatbid.length == 0 || !resp.seatbid[0].bid) {
        	          properLog.mylog("No " + bidder + " bids found");

        	        } else {

        	        	var bids_received_ts = ProperMedia.utils.getTimestampMs();
        				var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

        	        	//logging
        				properLog.mylog(resp, bidder);

                        for (var x = 0; x < resp.seatbid.length; x++) {
                            for (var i = 0; i < resp.seatbid[x].bid.length; i++) {

                                //grab variables
                                var seat     = resp.seatbid[x].seat;
                                    obj      = resp.seatbid[x].bid[i],
                                    impid    = obj.impid,
                                    adcode   = obj.adm;

                                var price = ProperMedia.utils.deepAccess(obj, 'ext.pricelevel') || 0;

                                // parse price
                                price = parseFloat(price.replace("_","") / 100);

                                //log bid
                                var bid_data = requestData.index_bids[impid];

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : bid_data.width + 'x' + bid_data.height,
                                    'price'       : price,
                                    'gross'       : price,
                                    'adcode'      : adcode,
                                    'tag_id'      : bid_data.tag_id,
                                    'request_url' : request_url,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);

                            } //end loop
                        } //end loop
                    } //end if

        	        //log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
    		},
    		error: function(resp) {
                try {
        			bidData.incrementBidResponseCount(request_cnt);
                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
    		}
    	});
    }

	function buildRequestUrl(siteID, slots) {
		var jsonURI = encodeURIComponent(JSON.stringify(buildRTBRequest(slots)));
		var scriptSrc = window.location.protocol === 'https:' ? 'https://as-sec.casalemedia.com' : 'http://as.casalemedia.com';

		//special fix: historyinorbit's account requires an old endpoint version
		if(siteID == 259845) {
            scriptSrc += '/cygnus?v=7&s=' + siteID + '&r=' + jsonURI;
        } else {
            scriptSrc += '/headertag?v=9&s=' + siteID + '&r=' + jsonURI;
        }

		scriptSrc += '&t=300';
		return scriptSrc;
	};

	var requestCounter = Math.floor(Math.random() * 256);

	function buildRTBRequest(slots) {

		var sitePage = location.href;
		var topframe = 1;

		if (top !== self) {
			sitePage = document.referrer;
			topframe = 0;
		}

		var requestID = String(
			(new Date().getTime() % 2592000) * 256 +
			(requestCounter = (requestCounter + 1) % 256) + 256
		);

		var json = {
			id: requestID,
			site: { page: sitePage },
			imp: []
		};

		if (typeof document.referrer === 'string') {
			json.site.ref = document.referrer;
		}

		for (var i = 0; i < slots.length; i++) {
			var slot = slots[i];

			if (typeof slot.width !== 'number' || slot.width <= 1) {
    			continue;
    		}
    		if (typeof slot.height !== 'number' || slot.height <= 1) {
    			continue;
    		}

			var imp = {
				id: slot.id,
				banner: {
					w: slot.width,
					h: slot.height,
					topframe: topframe
				},
				ext: {}
			};

			if (typeof slot.bidfloor === 'number') {
				imp.bidfloor = slot.bidfloor;
				if (typeof slot.bidfloorcur === 'string') {
					imp.bidfloorcur = slot.bidfloorcur;
				}
			}

			if (typeof slot.id === 'string' || typeof slot.id === 'number') {
				var sid = String(slot.id);
				if (sid.length <= 50 && !sid.match(/^\s*$/)) {
					imp.ext.sid = sid;
				}
			}

			if (typeof slot.siteID !== 'undefined') {
				imp.ext.siteID = slot.siteID;
			}

			json.imp.push(imp);
		}

        // Supply chain object
        if(properOps.schain) {
            json.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

        var eids = [];
        Object.keys(eIdAdapters).forEach(function(name) {
            var obj = eIdAdapters[name];
            addUserEids(eids, ProperMedia.utils.deepAccess(obj.adapter, 'idObj.' + obj.valuePath), obj.adapter.source, obj.ixlPartnerName, obj.rtiPartner);    
        });

        if (eids.length > 0) {
            ProperMedia.utils.deepSetValue(json, 'user.eids', eids);
        }

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                json.regs = {
                    ext: {
                        gdpr: Number(gdprConsent.gdprApplies)
                    }
                };
            }

            if (typeof gdprConsent.consentString !== 'undefined') {
                json.user = {
                    ext: {
                        consent: gdprConsent.consentString || ''
                    }
                };
            }
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            json.regs = json.regs || {};
            json.regs.ext = json.regs.ext || {};
            json.regs.ext.us_privacy = uspConsent.usPrivacy;
        }

		return json;
	}

    /**
     * Adds a User ID module's response into user Eids array.
     *
     * @param  {array}  eids           An array of objects containing user ids,
     *                                 will be attached to bid request later.
     * @param  {*}      id             The id obtained from User ID module.
     * @param  {string} source         The URL of the User ID module.
     * @param  {string} ixlPartnerName The name of the Identity Partner in IX Library.
     * @param  {string} rtiPartner     The name of the User ID provider in Prebid.
     * @return {boolean}               True if successfully added the ID to the userEids, false otherwise.
     */
    function addUserEids(eids, id, source, ixlPartnerName, rtiPartner) {
        if (id) {
            eids.push({
                "source": source,
                "uids": [{
                    "id": id,
                    "ext": {
                        "rtiPartner": rtiPartner
                    }
                }]
            });
            return true;
        }

        properLog.mylog('Tried to add a user ID from Prebid, the ID received was null');
        return false;
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.ix = (function() {
	var bidderInfo = {
        "rev_share"       : 1,
        "demand_type"     : 'display',
        "bid_grouping"    : 'page',
        "default_bid_ttl" : 300000
	};

    var ENDPOINT_URL  = 'https://htlb.casalemedia.com/cygnus',
        USER_SYNC_URL = 'https://js-sec.indexww.com/um/ixmatch.html',
        bidder        = 'ix',
        site_id       = null;

    var BANNER_ENDPOINT_VERSION = 7.2,
        VIDEO_ENDPOINT_VERSION = 8.1,
        CENT_TO_DOLLAR_FACTOR = 100;

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

        var requestData = {
            'imps': [],
            'index_bids': {},
            'request_cnt': 0
        };        

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {

                        var id = tag_id + '-' + ProperMedia.utils.makeid(5);
                        var s = size.split('x');

                        var imp = {
                            'id'         : String(id),
                            'bidfloor'   : getBidderFloor(bidder, size),
                            'bidfloorcur': 'USD',
                            'ext': {
                                'sid': id,
                                'siteID': String(site_id)
                            }
                        };

                        if (bidderInfo.demand_type == 'display') {
                            imp['banner'] = {
                                'topframe': 1,
                                'w'       : parseInt(s[0]) || 0,
                                'h'       : parseInt(s[1]) || 0,
                            };

                        } else if (bidderInfo.demand_type == 'video') {
                            imp['video'] = {
                                'placement'     : 1,
                                'topframe'      : 1,
                                'skip'          : 1,
                                'linearity'     : 1,
                                'minduration'   : 10,
                                'maxduration'   : 30,
                                "playbackmethod": [2],
                                'api'           : [1, 2],
                                'mimes'         : ['video/mp4', "application/javascript"],
                                'protocols'     : [2, 3, 5, 6],
                                'w'             : parseInt(s[0]) || 0,
                                'h'             : parseInt(s[1]) || 0
                            };
                        }

                        if(bidderInfo.video_type == 'outstream') {
                            imp['video']['placement'] = 4;
                        }

                        requestData['imps'].push(imp);

                        requestData['index_bids'][id] = { 
                            'width'  : parseInt(s[0]), 
                            'height' : parseInt(s[1]), 
                            "tag_id" : tag_id
                        }
                    }
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        // Site IDs: {Desktop}-{Mobile}
        var siteIds = (ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || '').toString().split('-') || ['',''];
        site_id = (properDevice.isMobile() && siteIds.length == 2) ? siteIds[1] : siteIds[0];

        if(!site_id) {
            properLog.mylog('Error: ' + bidder + ' Site ID is Required.');
            return false;
        }

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        var imps        = requestData['imps'] || [];
        var request_cnt = requestData['request_cnt'];

        var r = {
            'id'  : ProperMedia.utils.generateUUID(),
            'site': {
                'ref': properPage.referrer,
                'page': properPage.bidder_page_url
            },
            'ext': {
                'source': 'prebid',
                'ixdiag': {
                    'msd': 0,
                    'msi': 0,
                    'sn': 0
                }
            },
            'imp': imps
        }


        var allEids = userIds.getEidsArray();
        var eidInfo = getEidInfo(allEids);
        var userEids = eidInfo.toSend;

        // RTI ids will be included in the bid request if the function getIdentityInfo() is loaded
        // and if the data for the partner exist
        if (window.headertag && typeof window.headertag.getIdentityInfo === 'function') {
            var identityInfo = window.headertag.getIdentityInfo();
            if (identityInfo && typeof identityInfo === 'object') {
                for (var partnerName in identityInfo) {
                    if (identityInfo.hasOwnProperty(partnerName)) {
                        var response = identityInfo[partnerName];
                        if (!response.responsePending && response.data && typeof response.data === 'object' &&
                            Object.keys(response.data).length && !eidInfo.seenSources[response.data.source]) {
                            userEids.push(response.data);
                        }
                    }
                }
            }
        }

        if (userEids.length > 0) {
            ProperMedia.utils.deepSetValue(r, 'user.eids', userEids);
        }

        // Supply chain object isset
        if(properOps.schain) {
            ProperMedia.utils.deepSetValue(r, 'source.ext.schain', properOps.schain);
        }

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            if(gdprConsent.consentString) {
                ProperMedia.utils.deepSetValue(r, 'user.ext.consent', gdprConsent.consentString);
            }

            if (typeof gdprConsent.gdprApplies === 'boolean') {
                ProperMedia.utils.deepSetValue(r, 'regs.ext.gdpr', Number(gdprConsent.gdprApplies));
            }
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            ProperMedia.utils.deepSetValue(r, 'regs.ext.us_privacy', uspConsent.usPrivacy);
        }

        var payload = {
            's'  : site_id,
            'v'  : (bidderInfo.demand_type == 'display') ? BANNER_ENDPOINT_VERSION : VIDEO_ENDPOINT_VERSION,
            'ac' : 'j',
            'sd' : 1,
            'sn' : 0,
            'r'  : JSON.stringify(r)
        }

        if((bidderInfo.demand_type == 'video')) {
            payload.nf = 1;
        }

        // Format Query string
        var qs = ProperMedia.utils.formatQueryString(payload, true);

        // request url
        var request_url = ENDPOINT_URL + '?' + qs;

        //logging
        properLog.mylog(request_url, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            url: request_url,
            method: "GET",
            bidder: bidder,
            edge: edge,
            success: function(resp) {

                try {

                    if(resp) {
                        resp = ProperMedia.utils.safeJsonParse(resp);

                        //process response
                        if(!resp || !resp.seatbid || resp.seatbid.length == 0 || !resp.seatbid[0].bid) {
                            properLog.mylog("No " + bidder + " bids returned");

                        } else {

                            var bids_received_ts = ProperMedia.utils.getTimestampMs();
                            var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                            //logging
                            properLog.mylog(resp, bidder);
                            
                            for (var x = 0; x < resp.seatbid.length; x++) {
                                for (var i = 0; i < resp.seatbid[x].bid.length; i++) {

                                    //grab variables
                                    var obj    = resp.seatbid[x].bid[i],
                                        impid  = obj.impid,
                                        adcode = obj.adm;

                                    var price = parseFloat(obj.price / CENT_TO_DOLLAR_FACTOR) || 0;

                                    //log bid
                                    var bid_data = requestData.index_bids[impid];

                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'price'       : price,
                                        'gross'       : price,
                                        'tag_id'      : bid_data.tag_id,
                                        'request_url' : request_url,
                                        'response'    : obj,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts,
                                        'ttl'         : bidderInfo.default_bid_ttl
                                    });

                                    if (bidderInfo.demand_type == 'video') {
                                        ad.type       = 'video';
                                        ad.size       = bid_data.width + 'x' + bid_data.height;
                                        ad.vast_tag   = ProperMedia.utils.deepAccess(obj, 'ext.vasturl');
                                        ad.vast_type  = 'url';
                                        ad.vpaid      = false;
                                        ad.video_type = bidderInfo.video_type;

                                    } else {
                                        ad.size   = obj.w + 'x' + obj.h;
                                        ad.adcode = adcode;
                                    }
                                    
                                    bidData.logBidResponse(ad);
                                }
                            }
                        }

                        //log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    }

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    /**
     * From the userIdAsEids array, filter for the ones our adserver can use, and modify them
     * for our purposes, e.g. add rtiPartner
     * @param {array} allEids userIdAsEids passed in by prebid
     * @return {object} contains toSend (eids to send to the adserver) and seenSources (used to filter
     *                  identity info from IX Library)
     */
    function getEidInfo(allEids) {
        // determines which eids we send and the rtiPartner field in ext
        var sourceRTIMapping = {
            'liveramp.com': 'idl',
            'netid.de': 'NETID',
            'neustar.biz': 'fabrickId',
            'zeotap.com': 'zeotapIdPlus'
        };
        var toSend = [];
        var seenSources = {};
        if (Array.isArray(allEids)) {
            for (var i = 0; i < allEids.length; i++) {
                if (sourceRTIMapping[allEids[i].source] && ProperMedia.utils.deepAccess(allEids[i], 'uids.0')) {
                    seenSources[allEids[i].source] = 1;
                    allEids[i].uids[0].ext = {
                        "rtiPartner": sourceRTIMapping[allEids[i].source]
                    };
                    delete allEids[i].uids[0].atype;
                    toSend.push(allEids[i]);
                }
            }
        }
        return { "toSend": toSend, "seenSources": seenSources };
    }


    userSyncs.add({
        type: 'iframe',
        url: USER_SYNC_URL,
        bidder: bidder
    });

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    /**
 * JustPremium Bidder Integration.
 *
 * @author Tanner Mckenney <tanner@proper.io>
 */
bidAdapters.justpremium = (function() {
	var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 60000,
        "dont_refresh"   : 1,
        "native_sizes": {
            "desktop": {
                'sticky_horizontal': '728x90',
                'native_horizontal': '728x90'
            },
            "mobile": {
                'sticky_horizontal': '320x50',
                'native_horizontal': '320x50'
            }
        }
	};

	var ENDPOINT_URL  = "https://pre.ads.justpremium.com/v/2.0/t/xhr",
		SYNC_ENDPOINT = "https://pre.ads.justpremium.com/v/1.0/t/sync",
		JP_ADAPTER_VERSION = '1.7';

	var bidder = 'justpremium';

	/**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
	function formatRequest(data) {

		var requestData = {
			'imps': {},
			'JPbids': {},
			'request_cnt': 0
		};

		var device = properDevice.isMobile() ? 'mobile' : 'desktop';

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {

						requestData['imps'][tag_id] = {
							'tag_id': parseInt(tag_id),
							'sizes':[],
							'slot_types': [[],{}]
						}
					}

					requestData['JPbids'][tag_id] = size;
					var ad_size = ProperMedia.utils.deepAccess(bidderInfo, 'native_sizes.' + device + '.' + size) || size;
					var s = ad_size.split("x").map(function(x) {
						return parseInt(x);
					});

					if(s[0] == '728' && s[1] == '90') {
						requestData['imps'][tag_id]['slot_types'][0] = requestData['imps'][tag_id]['slot_types'][0].concat(["cf", "pu", "as"]);
						requestData['imps'][tag_id]['sizes'].push([s[0],s[1]]);
						requestData['request_cnt']++;

					} else if(s[0] == '160' && s[1] == '600') {
						requestData['imps'][tag_id]['slot_types'][0] = requestData['imps'][tag_id]['slot_types'][0].concat(["sa"]);
						requestData['imps'][tag_id]['sizes'].push([s[0],s[1]]);
						requestData['request_cnt']++;

					} else if(s[0] == '320' && s[1] == '50') {
						requestData['imps'][tag_id]['slot_types'][0] = requestData['imps'][tag_id]['slot_types'][0].concat(["ms"]);
						requestData['imps'][tag_id]['sizes'].push([s[0],s[1]]);
						requestData['request_cnt']++;

					} else {
						// JustPremium is Sticky only, and with only those two sizes atm.
						return requestData;
					}
                }
            });
        }
		return requestData;
	}


	/** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
	function send(bidData) {
		
		var requestData = formatRequest(bidData.requests);
    	var request_cnt = requestData['request_cnt'];

    	if(request_cnt == 0) {
    		return false;
    	}

		var send_struct = {
			zone: Object.keys(requestData['imps']).map(function(x) {
				return parseInt(x);
			}), // array [123,456,789],
			hostname: window.top.location.hostname,
			protocol: window.top.location.protocol.replace(':', ''),
			sw: window.top.screen.width,
			sh: window.top.screen.height,
			ww: window.top.innerWidth,
			wh: window.top.innerHeight,
			c: (function(reqs) {
				var ret = {};
				Object.keys(reqs).forEach(function(x) {
					ret[reqs[x].tag_id] = reqs[x].slot_types;
				});
				return ret;
			})(requestData['imps']), // { '45524': [[], {}] }, // Object with Zone ID as Key. Value is ?
			id: parseInt(Object.keys(requestData['imps']).shift()),
			sizes: (function(reqs) {
				var ret = {};
				Object.keys(reqs).forEach(function(x) {
					ret[reqs[x].tag_id] = reqs[x].sizes;
				});
				return ret;
			})(requestData['imps']), // { '45524': [[ 728, 90 ]]	}
			version: {
				prebid: properOps.prebid_version,
      			jp_adapter: JP_ADAPTER_VERSION
			}
		};

		send_struct.pubcid = properUser.pubcid;
		send_struct.uids   = userIds.getUIdsObj();

		// GDPR Consent
		if (gdprConsent.cmpPresent) {
			send_struct.gdpr_consent = {
				consent_string: gdprConsent.consentString,
				consent_required: (typeof gdprConsent.gdprApplies === 'boolean') ? gdprConsent.gdprApplies : true
			};
		}

		// USP Consent
		if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
			send_struct.us_privacy = uspConsent.usPrivacy;
		}

		var request_string = JSON.stringify(send_struct);
		var ajax_url_final = ENDPOINT_URL + '?i=' + (+new Date());

		//logging
		properLog.mylog(ajax_url_final, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		// Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

		// Fire off Ajax Request. Testing 123.
		$.ajax({
			method: 'POST',
			url: ajax_url_final,
			requestType: "cors",
			bidder: bidder,
            edge: edge,
			data: request_string,
			success: function (resp) {
				try {
					//handle response
					resp = ProperMedia.utils.safeJsonParse(resp);

					properLog.mylog(resp, bidder);

					if(resp.bid) {

						var bids_received_ts = ProperMedia.utils.getTimestampMs();
						var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

						for (var key in resp.bid) {
							if(resp.bid[key] && resp.bid[key].length > 0) {

								var bidResp = resp.bid[key].pop();

								var tagid  = key,
    								price  = bidResp.price || 0,
    								width  = bidResp.width || 1,
    								height = bidResp.height|| 1,
    								adcode = bidResp.adm   || '',
    								ttl    = (bidResp.ttl * 1000) || bidderInfo.default_bid_ttl;

    							var ad_size = ProperMedia.utils.deepAccess(requestData, 'JPbids.' + tagid) || width + 'x' + height;

								// New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : ad_size,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : tagid,
                                    'request_url' : ajax_url_final,
                                    'response'    : bidResp,
                                    'ttl'         : ttl,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts
                                });

                                bidData.logBidResponse(ad);
							}
						}
					}

	    			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

				} catch(e) {
					e.bidder = bidder;
					throw e;
				}
			},
			error: function(resp) {
				try {
					//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

				} catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
			}
		});
	}

	consentManager.ready(function() {
		var params = '?_c=' + 'a' + Math.random().toString(36).substring(7) + Date.now();

		// GDPR Consent
		if (gdprConsent.cmpPresent && typeof gdprConsent.gdprApplies === 'boolean') {
			params += '&consentString=' + encodeURIComponent(gdprConsent.consentString);
		}

		// USP Consent
		if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
			params += '&usPrivacy=' + encodeURIComponent(uspConsent.usPrivacy)
		}

		userSyncs.add({
			type: 'iframe',
			url: SYNC_ENDPOINT + params,
            bidder: bidder
		});
    });

	// Export for use.

	return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    /**
 * Kargo
 * 
 * @see https://github.com/prebid/Prebid.js/blob/master/modules/kargoBidAdapter.js
 * @see https://github.com/prebid/Prebid.js/blob/master/modules/kargoBidAdapter.md
 */
bidAdapters.kargo = (function() {
    var bidderInfo = {
        rev_share      : 1,
        bid_grouping   : 'page',
        default_bid_ttl: 300000,
        native_sizes: {
            'native_vertical': '300x250',
            'native_horizontal': '300x250',
            'sticky_horizontal': '300x50'
        }
    };

    var bidder             = 'kargo',
        ENDPOINT_URL       = 'https://krk.kargo.com/api/v2/bid',
        SYNCURL            = 'https://crb.kargo.com/api/v1/initsyncrnd/{UUID}?seed={SEED}&idx={INDEX}',
        SYNC_COUNT         = 5,
        lastPageUrl        = '',
        dummyCpmUpperBound = 999999;


    /**
     * Parse size and format to object
     * @param {string} size - size string: '728x90'
     * @return {Object}
     */
    function parseSize(size) {
        // Check for special sticky size
        size = ProperMedia.utils.deepAccess(bidderInfo, 'native_sizes.' + size) || size;

        var s = size.split('x');
        return [parseInt(s[0]), parseInt(s[1])];
    }

    /**
    * Format request data
    * @param {Object} data - Bidder request data to be formatted
    * @return {Object} requestData - Formatted data
    */
    function formatRequest(data) {
        var requestData = {
            'bidIDs': {},
            'bidSizes': {},
            'prebidRawBidRequests': [],
            'request_cnt': 0,
            'tag_sizes': {},
            'floor': dummyCpmUpperBound
        };

        Object.keys(data).forEach(function(size) {
        
            var thisfloor = getBidderFloor(bidder, size);
            if(thisfloor < requestData['floor']) {
                requestData['floor'] = thisfloor;
            }

            var size_array = parseSize(size);
            requestData['bidIDs'][data[size]] = data[size][0];
            requestData['bidSizes'][data[size]] = [size_array];
            requestData['prebidRawBidRequests'].push({
                bidId: data[size],
                userId: {}
            });
            requestData['request_cnt']++;

            if(ProperMedia.utils.deepAccess(bidderInfo, 'native_sizes.' + size)) {
                requestData['tag_sizes'][data[size]] = size;
            }

        });

        return requestData;
    }

    /** 
    * Send Ad Request
    * @param {bidObject} bid - Bid object
    */
    function send(bidData) {
        var requestData = formatRequest(bidData.requests);
        var request_cnt = requestData['request_cnt'];

        var payload = {
            sessionId: properSession.sessionData.uuid,
            requestCount: getRequestCount(),
            timeout: 550,
            currency: 'USD',
            cpmGranularity: 1,
            timestamp: (new Date()).getTime(),
            bidIDs: requestData['bidIDs'], // BID_ID => PLACEMENT_ID
            bidSizes: requestData['bidSizes'], // BID_ID => SIZES
            cpmRange: {
                floor: requestData['floor'],
                ceil: dummyCpmUpperBound // we don't set ceilings
            },
            prebidRawBidRequests: requestData['prebidRawBidRequests'],
            userIDs: {},
            pageURL: window.location.href
        };

        var tdid = false;
        var usp  = (uspConsent.cmpPresent && uspConsent.usPrivacy) ? uspConsent.usPrivacy : '1---';
        var meta = _getAllMetadata(tdid, usp);

        // Add Meta Data
        ProperMedia.utils.mergeObject(payload, meta);

        //logging
        properLog.mylog(ENDPOINT_URL, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();
        
        // send request
        $.ajax({
            url: ENDPOINT_URL+'?json='+encodeURIComponent(JSON.stringify(payload)),
            method: "GET",
            requestType: "cors",
            success: function(resp) {
                try {
                    resp = ProperMedia.utils.safeJsonParse(resp);

                    var bids_received_ts = ProperMedia.utils.getTimestampMs();
                    var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    //process response
                    if(resp && typeof resp == 'object') {

                        //logging
                        properLog.mylog(resp, bidder);

                        Object.keys(resp).forEach(function(bidId) {
                            var adUnit = resp[bidId];
                            var meta   = null,
                                size   = adUnit.width + 'x' + adUnit.height,
                                price  = Number(adUnit.cpm) || 0,
                                adcode = adUnit.adm         || '';

                            if (adUnit.metadata && adUnit.metadata.landingPageDomain) {
                                meta = {
                                    clickUrl: adUnit.metadata.landingPageDomain
                                };
                            }

                            if(ProperMedia.utils.deepAccess(requestData, 'tag_sizes.' + bidId)) {
                                size = ProperMedia.utils.deepAccess(requestData, 'tag_sizes.' + bidId);
                            }

                            // New Ad object
                            var ad = new adObj({
                                'bidder'      : bidder,
                                'size'        : size,
                                'price'       : parseFloat(price),
                                'gross'       : parseFloat(price),
                                'adcode'      : adcode,
                                'tag_id'      : bidId,
                                'request_url' : ENDPOINT_URL,
                                'response'    : adUnit,
                                'response_ms' : bid_response_ms,
                                'received_ts' : bids_received_ts,
                                'ttl'         : bidderInfo.default_bid_ttl
                            });

                            bidData.logBidResponse(ad);
                        });

                        // user syncs
                        addUserSyncs();

                        //log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    } else {
                        properLog.mylog("no kargo bids returned");
                    }
                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    function getRequestCount() {
        if (!window.location) {
            return 0;
        }
        if (lastPageUrl === window.location.pathname) {
            return ++requestCounter;
        }
        lastPageUrl = window.location.pathname;
        return requestCounter = 0;
    }

    function _getCrbFromCookie() {
        try {
            var crb = JSON.parse(decodeURIComponent(ProperMedia.utils.getCookieValue('krg_crb')));
            if (crb && crb.v) {
                var vParsed = JSON.parse(atob(crb.v));
                if (vParsed) {
                    return vParsed;
                }
            }
            return {};
        } catch (e) {
            return {};
        }
    }

	function addUserSyncs() {
        var seed = ProperMedia.utils.generateUUID();
        var clientId = _getClientId();
        if (seed && clientId) {
            for (var i = 0; i < SYNC_COUNT; i++) {
                userSyncs.add({
                    "type": 'image',
                    "url": SYNCURL.replace('{UUID}', clientId).replace('{SEED}', seed).replace('{INDEX}', i),
                    "bidder": bidder
                });
            }
        }
	}

    function _getCrbFromLocalStorage() {
        try {
            return JSON.parse(atob(_getLocalStorageSafely('krg_crb')));
        } catch (e) {
            return {};
        }
    }

    function _getCrb() {
        var localStorageCrb = _getCrbFromLocalStorage();
        if (Object.keys(localStorageCrb).length) {
            return localStorageCrb;
        }
        return _getCrbFromCookie();
    }

    function _getLocalStorageSafely(key) {
        try {
            return ProperMedia.utils.getDataFromLocalStorage(key);
        } catch (e) {
            return null;
        }
    }

    function _getUserIds(tdid, usp) {
        var crb = _getCrb();
        var userIds = {
            kargoID: crb.userId,
            clientID: crb.clientId,
            crbIDs: crb.syncIds || {},
            optOut: crb.optOut,
            usp: usp
        };
        if (tdid) {
            userIds.tdID = tdid;
        }
        return userIds;
    }

    function _getClientId() {
        var crb = _getCrb();
        if (crb) {
            return crb.clientId;
        }
        return null;
    }

    function _getAllMetadata(tdid, usp) {
        return {
            userIDs: _getUserIds(tdid, usp),
            pageURL: window.location.href,
            rawCRB: ProperMedia.utils.getCookieValue('krg_crb'),
            rawCRBLocalStorage: _getLocalStorageSafely('krg_crb')
        };
    }

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
}());

    bidAdapters.lockerdome = (function() {
	var bidderInfo = {
        "rev_share"   : 1,
        "demand_type" : 'display',
        "bid_grouping": 'page'
	};

    var bidder       = 'lockerdome',
		// Lockerdome requires https. http requests are redirected, breaking CORS support.
        ENDPOINT_URL = 'https://lockerdome.com/ladbid/prebid';


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'bidRequests': {},
            'request_cnt': 0
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['bidRequests'][tag_id] == 'undefined') {
                        var bidData = requestData[tag_id];

                        requestData['bidRequests'][tag_id] = {
                            'requestId' : tag_id,
                            'adUnitCode': tag_id, // bidData.slot_div,
                            'adUnitId'  : tag_id,
                            'sizes'     : []
                        };
                    }
                    requestData['bidRequests'][tag_id]['sizes'].push(size);
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	var requestData = formatRequest(bidData.requests);
        var bidRequests = ProperMedia.utils.objectValues(requestData['bidRequests']) || [];
        var request_cnt = requestData['request_cnt'];

        var postData = {
            'bidRequests': bidRequests,
            'referrer': properPage.referrer,
            'url': properPage.bidder_page_url
        };

        if(postData.bidRequests.length == 0) return false;

        // GDPR Consent
		if (gdprConsent.cmpPresent) {
			postData.gdpr = {
				applies: gdprConsent.gdprApplies,
				consent: gdprConsent.consentString
			};
		}

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            postData.us_privacy = {
                consent: uspConsent.usPrivacy
            }
        }

    	// log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        properLog.mylog(ENDPOINT_URL, bidder); // logging

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

    	//send request
    	$.ajax({
            method: "POST",
    		url: ENDPOINT_URL,
    		requestType: "cors",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(postData),
    		success: function(resp) {

                try {

        			//logging
        			properLog.mylog(resp,bidder);

                    var resp = ProperMedia.utils.safeJsonParse(resp);

                    var bids_received_ts = ProperMedia.utils.getTimestampMs();
                    var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    if(resp && resp.bids) {

                        Object.keys(resp.bids).forEach(function(x) {

                            var bid = resp.bids[x];

                            var requestId  = bid.requestId    || '',
                                price      = bid.cpm          || 0.00,
                                width      = bid.width        || 1,
                                height     = bid.height       || 1,
                                creativeId = bid.creativeId   || '',
                                currency   = bid.currency     || 'USD',
                                netRevenue = bid.netRevenue   || 0.00,
                                adcode     = bid.ad           || '',
                                ttl        = (bid.ttl * 1000) || 120000;


                            // New Ad object
                            var ad = new adObj({
                                'bidder'      : bidder,
                                'size'        : width + 'x' + height,
                                'price'       : parseFloat(price),
                                'gross'       : parseFloat(price),
                                'adcode'      : adcode,
                                'tag_id'      : requestId,
                                'request_url' : ENDPOINT_URL,
                                'response'    : bid,
                                'response_ms' : bid_response_ms,
                                'received_ts' : bids_received_ts,
                                'ttl'         : ttl
                            });

                            bidData.logBidResponse(ad);

    					});
    				}

        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

    		}
    	});

    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.mantis = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 1800000
    };

    var bidder = 'mantis';
    var SITE_ID = '5b32cf14d866814de2efe8c2';
    // Mantis requires https. http requests are redirected, breaking CORS support.
    var ENDPOINT_URL = 'https://mantodea.mantisadnetwork.com';


    /**
     * Parse size and format to object
     * @param {string} size - size string: '728x90'
     * @return {Object}
     */
    function parseSize(size) {
        var s = size.split('x');
        return {
            'width': parseInt(s[0]),
            'height': parseInt(s[1])
        };
    }


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'bids': {},
            'request_cnt': 0
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['bids'][tag_id] == 'undefined') {
                        requestData['bids'][tag_id] = {
                            "bidId" : tag_id,
                            "sizes" : []
                        };
                    }

                    requestData['bids'][tag_id]['sizes'].push(parseSize(size));
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;

    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData = formatRequest(bidData.requests);
        var bids        = ProperMedia.utils.objectValues(requestData['bids']) || [];
        var request_cnt = requestData['request_cnt'];

        var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || SITE_ID;
    	// build script url
    	if(properOps.testing_mode.ids == true) {
    		site_id = 'demo';
    	}

    	var json = {
            "measurable": true,
    		"property"  : site_id,
    		"bids"      : bids
    	}

        if(request_cnt['total'] == 0) return false;

        var request_url = buildMantisUrl('/prebid/display', json) + '&foo';

    	//logging
    	properLog.mylog(request_url,bidder);

    	// log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

    	//send request
    	$.ajax({
    		url: request_url,
    		requestType: "cors",
            bidder: bidder,
            edge: edge,
    		success: function(resp) {

                try {

        			//logging
        			properLog.mylog(resp,bidder);

                    // Parse response
                    resp = ProperMedia.utils.safeJsonParse(resp);

    				//handle response
    				if(resp) {

    					var bids_received_ts = ProperMedia.utils.getTimestampMs();
    					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        // Store unique user id
                        if(typeof resp['uuid'] !== 'undefined') {
                            storeUuid(resp['uuid']);
                        }

    					//process data
    					if(typeof resp['ads'] !== 'undefined') {

                            for (var i = 0; i < resp['ads'].length; i++) {

    							var obj = resp['ads'][i];

    							//we got one!
    							var tagid  = obj.bid;
    							var price  = obj.cpm;
    							var width  = obj.width;
    							var height = obj.height;
    							var adcode = obj.html;

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : width + 'x' + height,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : tagid,
                                    'request_url' : request_url,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);
        					}
                        }
    				}

        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) {
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) {
                    e.bidder = bidder;
                    throw e;
                }
    		}
    	});
    }

    function buildMantisUrl(path, data, domain) {
        var params = {
            'referrer': document.referrer,
            'tz'      : new Date().getTimezoneOffset(),
            'buster'  : new Date().getTime(),
            'secure'  : isSecure(),
            'version' : 9
        };
        
        if (!inIframe() || isAmp()) {
            params.mobile = !isAmp() && isDesktop(true) ? 'false' : 'true';
        }
        if (window.mantis_uuid) {
            params.uuid = window.mantis_uuid;
        } else if (window.localStorage) {
            var localUuid = window.localStorage.getItem('mantis:uuid');
            if (localUuid) {
                params.uuid = localUuid;
            }
        }
        if (!inIframe()) {
            try {
                params.title = window.top.document.title;
                params.referrer = window.top.document.referrer;
                params.url = window.top.document.location.href;
            } catch (ex) { }
        } else {
            params.iframe = true;
        }
        if (isAmp()) {
            params.amp = true;
            if (!params.url && window.context.canonicalUrl) {
                params.url = window.context.canonicalUrl;
            }
            if (!params.url && window.context.location) {
                params.url = window.context.location.href;
            }
            if (!params.referrer && window.context.referrer) {
                params.referrer = window.context.referrer;
            }
        }
        Object.keys(data || {}).forEach(function (key) {
            params[key] = data[key];
        });
        var query = jsonToQuery(params);
        return (window.mantis_domain === undefined ? domain || ENDPOINT_URL : window.mantis_domain) + path + '?' + query;
    }

    function inIframe() {
        try {
            return window.self !== window.top && !window.mantis_link;
        } catch (e) {
            return true;
        }
    }

    function isDesktop(ignoreTouch) {
        var supportsTouch = !ignoreTouch && ('ontouchstart' in window || navigator.msMaxTouchPoints);
        if (inIframe()) {
            return !supportsTouch;
        }
        var width = window.innerWidth || window.document.documentElement.clientWidth || window.document.body.clientWidth;
        return !supportsTouch && (!width || width >= (window.mantis_breakpoint || 768));
    }

    function getUuid() {
        var uuid = false;
        if (window.mantis_uuid) {
            uuid = window.mantis_uuid;
        } else if (window.localStorage) {
            var localUuid = window.localStorage.getItem('mantis:uuid');
            if (localUuid) {
                uuid = localUuid;
            }
        }
        return uuid;
    }

    function storeUuid(uuid) {
        if (window.mantis_uuid) {
            return false;
        }
        window.mantis_uuid = uuid;
        if (window.localStorage) {
           try {
                window.localStorage.setItem('mantis:uuid', uuid);
            } catch (ex) {}
        }
    }

    function jsonToQuery(data, chain, form) {
        if (!data) {
            return null;
        }

        var parts = form || [];

        for (var key in data) {
            var queryKey = key;

            if (chain) {
                queryKey = chain + '[' + key + ']';
            }

            var val = data[key];

            if (isArray(val)) {
                for (var index = 0; index < val.length; index++) {
                    var akey = queryKey + '[' + index + ']';
                    var aval = val[index];

                    if (isObject(aval)) {
                        jsonToQuery(aval, akey, parts);
                    } else if (isSendable(aval)) {
                        parts.push(akey + '=' + encodeURIComponent(aval));
                    }
                }
            } else if (isObject(val)) {
                jsonToQuery(val, queryKey, parts);
            } else if (isSendable(val)) {
                parts.push(queryKey + '=' + encodeURIComponent(val));
            }
        }

        return parts.join('&');
    }

    function isSendable(val) {
        if (val === null || val === undefined) {
            return false;
        }

        if (typeof val === 'string') {
            return !(!val || /^\s*$/.test(val));
        }

        if (typeof val === 'number') {
            return !isNaN(val);
        }

        return true;
    }

    function isAmp() {
      return typeof window.context === 'object' && (window.context.tagName === 'AMP-AD' || window.context.tagName === 'AMP-EMBED');
    }

    function isSecure() {
      return document.location.protocol === 'https:';
    }

    function isArray(value) {
        return Object.prototype.toString.call(value) === '[object Array]';
    }

    function isObject(value) {
        return Object.prototype.toString.call(value) === '[object Object]';
    }

    function onMessage(type, callback) {
        window.addEventListener('message', TraceKit.wrap(function (event) {
            if (event.data.mantis && event.data.type == type) {
                callback(event.data.data);
            }
        }), false);
    }

    function onVisible(element, doOnVisible, time, pct) {
        var started = null;
        var notified = false;
        var onNotVisible = null;
        var whenNotVisible = function () {
            if (notified && onNotVisible) {
                onNotVisible();
            }
            notified = false;
        };
        var interval;
        var listener;
        var doCheck = function (winWidth, winHeight, rect) {
            var hidden = typeof document.hidden !== 'undefined' && document.hidden;
            if (rect.width == 0 || rect.height == 0 || hidden) {
                return whenNotVisible();
            }
            var minHeight = (rect.height * pct);
            var minWidth = (rect.width * pct);
            var inView = (
                (
                    (rect.top < 0 && rect.bottom >= minHeight) ||
                    (rect.top > 0 && (winHeight - rect.top) >= minHeight)
                ) &&
                (
                    (rect.left < 0 && rect.right >= minWidth) ||
                    (rect.left > 0 && (winWidth - rect.left) >= minWidth)
                )
            );
            if (!inView) {
                return whenNotVisible();
            }
            if (!started && time) {
                started = Date.now();
                return whenNotVisible();
            }
            if (time && Date.now() - started < time) {
                return whenNotVisible();
            }
            if (notified) {
                return;
            }
            doOnVisible(function (ack) {
                if (ack) {
                    notified = true;
                } else {
                    interval && clearInterval(interval);
                    listener && listener();
                }
            }, function (onHidden) {
                onNotVisible = onHidden;
            });
        };
        if (isAmp()) {
            listener = window.context.observeIntersection(function (changes) {
                changes.forEach(function (change) {
                    doCheck(change.rootBounds.width, change.rootBounds.height, change.boundingClientRect);
                });
            });
        }
        interval = setInterval(function () {
            var winHeight = (window.innerHeight || document.documentElement.clientHeight);
            var winWidth = (window.innerWidth || document.documentElement.clientWidth);
            doCheck(winWidth, winHeight, element.getBoundingClientRect());
        }, 100);
    }

    function pixel(url, parent) {
        var img = document.createElement('img');
        img.src = url;
        img.style.cssText = 'display:none !important;';
        (parent || document.body).appendChild(img);
    }

    onMessage('iframe', function (data) {
        if (window.$sf) {
            var viewed = false;
            $sf.ext.register(data.width, data.height, function () {
                if ($sf.ext.inViewPercentage() < 50 || viewed) {
                    return;
                }
                viewed = true;
                pixel(data.pixel);
            });
        } else {
            var frames = document.getElementsByTagName('iframe');
            for (var i = 0; i < frames.length; i++) {
                var frame = frames[i];
                if (frame.name == data.frame) {
                    onVisible(frame, function (stop) {
                        pixel(data.pixel);
                        stop();
                    }, 1000, 0.50);
                }
            }
        }
    });
    
    userSyncs.add({
        type: 'iframe',
        url: buildMantisUrl('/prebid/iframe'),
        bidder: bidder
    });

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
})();

    bidAdapters.mediaforce = (function() {
	var bidderInfo = {
        "rev_share"       : 1,
        "demand_type"     : 'display',
        "bid_grouping"    : 'slot',
        "default_bid_ttl" : 300000
	};

	var ENDPOINT_URL = "https://rtb.mfadsrvr.com/header_bid",
		TEST_ENDPOINT_URL = "https://rtb.mfadsrvr.com/header_bid?debug_key=abcdefghijklmnop";

    var bidder = 'mediaforce';

    /**
	 * Parse size and format to object
	 * @param {string} size - size string: '728x90'
	 * @return {Object}
	 */
	function parseSize(size) {
		var s = size.split('x');
        return {
        	'w': parseInt(s[0]),
        	'h': parseInt(s[1])
        };
	}

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

    	var requestData = {
			'imps': {},
			'request_cnt': 0
		};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {
                    	var s = size.split('x').map(function(w_h) { return parseInt(w_h); })
				    	requestData['imps'][tag_id] = {
			    			'id': tag_id.toString(),
			    			'tagid': tag_id,
			    			'secure': (properPage.use_ssl ? 1 : 0),
							'bidfloor': getBidderFloor(bidder, size),
							'banner': {
								'w': s[0],
								'h': s[1],
								'format': []
							}
			    		}
			    	} else {

			    	}

		    		var floor = getBidderFloor(bidder, size);
                	if(floor < requestData['imps'][tag_id]['bidfloor']) {
                    	requestData['imps'][tag_id]['bidfloor'] = floor;
                    }

                    requestData['imps'][tag_id]['banner']['format'].push(parseSize(size));
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(!site_id) {
            properLog.mylog('Error: MediaForce Site ID is Required.');
            return false;
        }

    	var requestData = formatRequest(bidData.requests);
    	var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
    	var request_cnt = requestData['request_cnt'];

		var post_data = {
    		'id'  : Date.now().toString(),
    		'site': {
    			'id'  : site_id.toString(),
				'page': properPage.bidder_page_url,
				'ref' : properPage.bidder_page_url,
				'publisher': {
					'id': site_id.toString(),
				}
    		},
			'device': getDevice(),
			'imp': imps
    	}

    	var request_url = (properOps.testing_mode.ids == true) ? TEST_ENDPOINT_URL : ENDPOINT_URL;

		//logging
		properLog.mylog(request_url, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		//send request
		$.ajax({
			url: request_url,
			method: "POST",
			requestType: "cors",
			data: JSON.stringify(post_data),
			success: function(resp) {

				try {
					
					resp = ProperMedia.utils.safeJsonParse(resp);

					//process response
			        if(!resp || !resp.seatbid || resp.seatbid.length == 0 || !resp.seatbid[0].bid) {
		          		properLog.mylog("no MediaForce bids returned");

			        } else {

						var bids_received_ts = ProperMedia.utils.getTimestampMs();
						var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

			        	//logging
						properLog.mylog(resp, bidder);

						Object.keys(resp.seatbid).forEach(function(x) {
							Object.keys(resp.seatbid[x].bid).forEach(function(i) {

								var obj = resp.seatbid[x].bid[i];

								if(typeof obj.adm !== 'undefined') {

									var id      = obj.id      || '',
										impid   = obj.impid   || '',
										price   = obj.price   || 0,
										width   = obj.w       || 1,
										height  = obj.h       || 1,
										adcode  = obj.adm     || '',
										burl    = obj.burl    || '';

									var cpm = ProperMedia.utils.deepAccess(obj, 'adserverTargeting.hb_pb') || price;
									if (ProperMedia.utils.isStr(burl) && burl !== '') {
										burl = burl.replace(/\$\{AUCTION_PRICE\}/g, cpm);
										adcode = adcode + '<img src="' + burl + '" />';
								    }

									// New Ad object
	                                var ad = new adObj({
	                                    'bidder'      : bidder,
	                                    'size'        : width + 'x' + height,
	                                    'price'       : parseFloat(price),
	                                    'gross'       : parseFloat(price),
	                                    'adcode'      : adcode,
	                                    'tag_id'      : impid,
	                                    'request_url' : request_url,
	                                    'response'    : obj,
	                                    'response_ms' : bid_response_ms,
	                                    'received_ts' : bids_received_ts,
	                                    'ttl'         : (obj.ttl * 1000) || bidderInfo.default_bid_ttl
	                                });

	                                bidData.logBidResponse(ad);
								}
							});
						});
					}
					
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}
			}
		});
    }


	function getDevice() {
		var language = navigator.language ? 'language' : 'userLanguage';
		return {
			js: 1,
			ua: navigator.userAgent,
			dnt: ProperMedia.utils.getDNT() ? 1 : 0,
			language: navigator[language].split('-')[0]
		};
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.medianet = (function() {
	var bidderInfo = {
        "rev_share"       : 1,
        "demand_type"     : 'display',
        "bid_grouping"    : 'page',
        "default_bid_ttl" : 300000
	};

	var ENDPOINT_URL = "https://prebid.media.net/rtb/prebid";
    var bidder = 'medianet';


    /**
	 * Parse size and format to object
	 * @param {string} size - size string: '728x90'
	 * @return {Object}
	 */
	function parseSize(size) {
		var s = size.split('x');
        return {
        	'w': parseInt(s[0]),
        	'h': parseInt(s[1])
        };
	}


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

    	var requestData = {
			'imps': {},
			'request_cnt': 0
		};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];

                    if(typeof requestData['imps'][tag_id] == 'undefined') {

				    	requestData['imps'][tag_id] = {
			    			'id': tag_id.toString(),
			    			'tagid': tag_id.toString(),
			    			'bidfloor': getBidderFloor(bidder, size),
    						'banner': [],
    						'ext': {
    							'visibility': 0
    						}
			    		}
			    	}

		    		var floor = getBidderFloor(bidder, size);
                	if(floor < requestData['imps'][tag_id]['bidfloor']) {
                    	requestData['imps'][tag_id]['bidfloor'] = floor;
                    }

                    requestData['imps'][tag_id]['banner'].push(parseSize(size));
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	var site_id = properDevice.isMobile() ? 506882127 : 515514711;

        var request_url = ENDPOINT_URL + '?cid=' + encodeURIComponent(site_id);

    	var requestData = formatRequest(bidData.requests);
    	var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
    	var request_cnt = requestData['request_cnt'];

    	var page_meta = getPageMeta();
    	var site =  ProperMedia.utils.mergeObject({
				'domain'       : properPage.domain,
				'page'         : properPage.bidder_page_url,
				'ref'          : properPage.referrer,
				'canonical_url': properPage.canonical_url,
				'isTop'        : true
			},
			page_meta
		);

		var post_data = {
    		'id'  : Date.now().toString(),
    		'site': site,
    		'imp' : imps,
    		'ext' : {
    			'customer_id': site_id.toString(),
    			'prebid_version': properOps.prebid_version,
    			'screen': {
    				'w': window.innerWidth,
    				'h': window.innerHeight
    			}
    		},
			'tmax': 1000
    	};

    	// Supply chain object isset
        if(properOps.schain) {
            post_data.ext.schain = properOps.schain;
        }

        var user_id = userIds.getUIdsObj();
        if(user_id && Object.keys(user_id).length) {
        	ProperMedia.utils.deepSetValue(post_data, 'ext.user_id', user_id);
        }

        // GDPR Consent
    	if (gdprConsent.cmpPresent) {
			post_data.ext.consentString = gdprConsent.consentString;
			if (typeof gdprConsent.gdprApplies === 'boolean') {
				post_data.ext.gdpr_applies = Number(gdprConsent.gdprApplies);
			}
		}

		// USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
        	post_data.ext.usp_applies = uspConsent.cmpApplies;
            post_data.ext.usp_consent_string  = uspConsent.usPrivacy;
        }

		//logging
		properLog.mylog(request_url, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		//send request
		$.ajax({
			url: request_url,
			method: "POST",
			requestType: "cors",
			data: JSON.stringify(post_data),
			success: function(resp) {

				try {
					
					resp = ProperMedia.utils.safeJsonParse(resp);

					//process response
			        if(!resp || !resp.bidList || resp.bidList.length == 0) {
		          		properLog.mylog("no medianet bids returned");

			        } else {

						var bids_received_ts = ProperMedia.utils.getTimestampMs();
						var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

			        	//logging
						properLog.mylog(resp, bidder);

						resp.bidList.map(function(obj) {
							if(obj.ad) {

								var impid   = obj.requestId    || '',
									price   = obj.cpm          || 0,
									width   = obj.width        || 1,
									height  = obj.height       || 1,
									adm     = obj.ad           || '',
									nurl    = obj.nurl         || false,
									ttl     = (obj.ttl * 1000) || bidderInfo.default_bid_ttl;

								var adcode  = (nurl) ? adm + '<img src="' + nurl + '" />' : adm;

								// New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : width + 'x' + height,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : impid,
                                    'request_url' : request_url,
                                    'response'    : obj,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : ttl
                                });

                                bidData.logBidResponse(ad);
							}
						});
					}
					
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
        			bidData.incrementBidResponseCount(request_cnt);

				} catch (e) { 
					e.bidder = bidder;
					throw e;
				}
			}
		});
    }


	function getPageMeta() {
		var pageMeta = {
			'canonicalUrl': getUrlFromSelector('link[rel="canonical"]', 'href'),
			'twitterUrl'  : getUrlFromSelector('meta[property="og:url"]', 'content'),
			'ogUrl'       : getUrlFromSelector('meta[name="twitter:url"]', 'content')
		}

		return pageMeta;
	}

	function getUrlFromSelector(selector, attribute) {
		var attr = getAttributeFromSelector(selector, attribute);
		return attr && getAbsoluteUrl(attr);
	}

	function getAttributeFromSelector(selector, attribute) {
		try {
			var element = window.top.document.querySelector(selector);
			if (element !== null && element[attribute]) {
				return element[attribute];
			}
		} catch (e) {}
	}

	function getAbsoluteUrl(url) {
		var aTag = window.top.document.createElement('a');
		aTag.href = url;

		return aTag.href;
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.openx = (function() {
	var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000
	};

    var bidder = 'openx';
    var shouldSendBoPixel = true;
    var ENDPOINT_URL = 'https://propermedia-d.openx.net/w/1.0/arj';

    var eIdAdapters = {
        "identityLink": {
            "adapter": userIdAdapters.identityLink,
            "valuePath": "idl_env"
        }, 
        "id5Id": {
            "adapter": userIdAdapters.id5Id,
            "valuePath": "id5id.uid"
        },
        "pubCommonId": {
            "adapter": userIdAdapters.pubCommonId,
            "valuePath": "pubcid"
        }
    };

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'data': {},
            'request_cnt': 0
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['data'][tag_id] == 'undefined') {

                        var div_id = "openx-" + ProperMedia.utils.generateUUID();

                        requestData['data'][tag_id] = {
                            'price_floor' : getBidderFloor(bidder, size),
                            'slot_div'    : div_id,
                            'tag_id'      : tag_id,
                            'sizes'       : []
                        };

                    }

                    var floor = getBidderFloor(bidder, size);
                    if(floor < requestData['data'][tag_id]['price_floor']) {
                        requestData['data'][tag_id]['price_floor'] = floor;
                    }

                    requestData['data'][tag_id]['sizes'].push(size);
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData = formatRequest(bidData.requests);
        var request_cnt = requestData['request_cnt'];

        var isInIframe = true,

        // Default Parameters
    	data = {
            'ju'     : properPage.bidder_page_url,
            'jr'     : properPage.referrer,
            'ch'     : document.charSet || document.characterSet,
            'res'    : screen.width+'x'+screen.height+'x'+screen.colorDepth,
            'ifr'    : isInIframe,
            'tz'     : new Date().getTimezoneOffset(),
            'tws'    : getViewportDimensions(isInIframe),
            'aus'    : '',
            'auid'   : '',
            'aumfs'  : '',
            'dddid'  : '',
            'divIds' : '',            
            'be'     : 1,
            'bc'     : 'hb_pb_3.0.1',
            'nocache': new Date().getTime()
        };

        var aus    = [], // slot sizes 
            auid   = [], // tag ids
            aumfs  = [], // price floors
            dddid  = [], // transaction ids
            divIds = []; // div ids


        Object.keys(requestData['data']).forEach(function(impid) {
            var obj = requestData['data'][impid];

            aus.push(obj.sizes.join(','));
            auid.push(obj.tag_id);
            aumfs.push(obj.price_floor * 1000);
            dddid.push(ProperMedia.utils.generateUUID());
            divIds.push(encodeURIComponent(obj.slot_div));
        });

        data.aus = aus.join('|');
        data.auid = auid.join(',');
        data.aumfs = aumfs.join(',');
        data.dddid = dddid.join(',');
        data.divIds = divIds.join(',');

        // Check Do Not Tack
        if(ProperMedia.utils.getDNT()) {
            data.ns = 1
        }

        // Supply chain object isset
        if(properOps.schain) {
            data.schain = ProperMedia.utils.formatSupplyChainString(properOps.schain);
        }

        // Check GDPR
		if (gdprConsent.cmpPresent) {
			if (gdprConsent.consentString !== undefined) {
                data.gdpr_consent = gdprConsent.consentString;
			}
			if (gdprConsent.gdprApplies !== undefined) {
				data.gdpr = Number(gdprConsent.gdprApplies);
			}
            data.x_gdpr_f = 1;
		}

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            data.us_privacy = uspConsent.usPrivacy;
        }

        data = appendUserIdsToQueryParams(data);

        // Format Query string
        var qs = ProperMedia.utils.formatQueryString(data, true);

        // request url
        var request_url = ENDPOINT_URL + '?' + qs;

    	//logging
    	properLog.mylog(request_url,bidder);

    	// log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();
        var startTime = new Date();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

    	//send request
    	$.ajax({
    		url: request_url,
    		requestType: "cors",
            bidder: bidder,
            edge: edge,
            cache: true,
            data: data,
    		success: function(resp) {

                try {

        			//logging
        			properLog.mylog(resp,bidder);

					var respObj = ProperMedia.utils.safeJsonParse(resp) || {};
                    if(respObj && typeof respObj == 'object' && respObj.ads && typeof respObj.ads == 'object') {

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        var ads = respObj.ads.ad || [];
                        if (Array.isArray(ads) && ads.length > 0) {

                            for(var i = 0; i < ads.length; i++) {

                                var adUnit = ads[i] || {};

                                //log bid
                                var creative = adUnit.creative[0] || {},
                                    price    = Number(adUnit.pub_rev) / 1000 || 0,
                                    adcode   = adUnit.html     || '',
                                    width    = creative.width  || 1,
                                    height   = creative.height || 1,
                                    tag_id   = adUnit.adunitid || 0,
                                    size     = width + 'x' + height;

                                registerBeacon(adUnit, startTime);

                                var price_floor = requestData['data'][tag_id]['price_floor'] || 0;

                                var ad_code_prepend =  "<div id=\"" + requestData['data'][tag_id]['slot_div'] + "\"></div>";
                                adcode = ad_code_prepend + adcode;

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : width + 'x' + height,
                                    'price'       : price,
                                    'gross'       : price,
                                    'adcode'      : adcode,
                                    'tag_id'      : tag_id,
                                    'request_url' : request_url,
                                    'response'    : adUnit,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);

                            }
                        }
                        addUserSyncs(respObj);
                    }

        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) { 
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
                    bidData.incrementBidResponseCount(request_cnt);
                } catch(e) { 
                    e.bidder = bidder;
                    throw e;
                }
    		}
    	});
    }

    function getViewportDimensions(isIfr) {
        var body,
            width,
            height,
            tWin  = window,
            tDoc  = document,
            docEl = tDoc.documentElement;

        if (isIfr) {
            try {
                tWin = window.top;
                tDoc = window.top.document;
            } catch (e) {
                return;
            }
            docEl = tDoc.documentElement;
            body  = tDoc.body;

            width  = tWin.innerWidth || docEl.clientWidth || body.clientWidth;
            height = tWin.innerHeight || docEl.clientHeight || body.clientHeight;
        } else {
            docEl  = tDoc.documentElement;
            width  = tWin.innerWidth || docEl.clientWidth;
            height = tWin.innerHeight || docEl.clientHeight;
        }

        return width + 'x' + height;
    }

    function registerBeacon(adUnit, startTime) {
        // only register beacon once
        if (!shouldSendBoPixel) {
            return;
        }
        shouldSendBoPixel = false;

        var bt = 3000;
        var beaconUrl;

        var beaconParams = {
            bd: +(new Date()) - startTime,
            bp: adUnit.pub_rev,
            br: '0', // may be 0, t, or p
            bs: ProperMedia.utils.getPageDomain(),
            bt: bt,
            ts: adUnit.ts
        };

        beaconParams.br = beaconParams.bt < beaconParams.bd ? 't' : 'p';

        var recordPixel = (adUnit && adUnit.creative && adUnit.creative[0] && adUnit.creative[0].tracking && adUnit.creative[0].tracking.impression) || '';
        var boBase = recordPixel.match(/([^?]+\/)ri\?/);

        if (boBase && boBase.length > 1) {
            beaconUrl = boBase[1] + 'bo?' + ProperMedia.utils.formatQueryString(beaconParams, true);
        }

        if (beaconUrl) {
            userSyncs.add({
                type: 'image',
                url: beaconUrl,
                bidder: bidder + '_registerBeacon'
            });
        }
    }

    function appendUserIdsToQueryParams(data) {
        Object.keys(eIdAdapters).forEach(function(name) {
            var obj = eIdAdapters[name];
            if(ProperMedia.utils.deepAccess(obj.adapter, 'storage.name')) {
                data[obj.adapter.storage.name] = ProperMedia.utils.deepAccess(obj.adapter, 'idObj.' + obj.valuePath);
            }
        });
        return data;
    }

	function addUserSyncs(resp) {
		var url = '//u.openx.net/w/1.0/pd';
		if (resp) {
			if (resp.ads && resp.ads.pixels) {
				url = resp.ads.pixels;
			} else if (resp.pixels) {
				url = resp.pixels;
			}
		}

        var queryString = '';

        // Check GDPR
        if (gdprConsent.cmpPresent) {
            queryString += '?gdpr=' + (gdprConsent.gdprApplies ? 1 : 0);
            queryString += '&gdpr_consent=' + encodeURIComponent(gdprConsent.consentString || '');
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            queryString += (queryString.length > 0 ? '&' : '?') + 'us_privacy=' + encodeURIComponent(uspConsent.usPrivacy);
        }

		userSyncs.add({
            type: 'iframe',
            url: url + queryString,
            bidder: bidder
        });
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.pubmatic = (function() {
    /*
      IMPORTANT: when updating this rev_share, you MUST also update
      the value of 'const REVSHARE'.
      This value can be found in the pubmatic_stats.php file in the proper-io project:
      https://github.com/proper-media/proper-io/blob/develop/site/proper_data/advertiser_apis/pubmatic_stats.php
    */
    var bidderInfo = {
        "rev_share"      : 0.81,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000
    };

    var bidder = 'pubmatic';

    //url endpoint
    var ENDPOINT = 'https://hbopenbid.pubmatic.com/translator?source=prebid-client';
    var USYNCURL = 'https://ads.pubmatic.com/AdServer/js/showad.js#PIX&kdntuid=1&p=';

    // Publisher ID
    var pubId = 109126;


    /**
     * Parse size and format to object
     * @param {string} size - size string: '728x90'
     * @return {Object}
     */
    function parseSize(size) {
        var s = size.split('x');
        return {
            'w': parseInt(s[0]),
            'h': parseInt(s[1])
        };
    }


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'imps': {},
            'request_cnt': 0
        };

        var impid = 1;

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];

                    if(tag_id == 1) {
                        tag_id = ProperMedia.utils.makeid(10);
                    }

                    if(typeof requestData['imps'][tag_id] == 'undefined') {

                        var ids = tag_id.split('-');
                        var tagid = ids[0];

                        var s = size.split('x');

                        requestData['imps'][tag_id] = {
                            'id': impid.toString(),
                            'tagid' : tagid.toString(),
                            'bidfloor' : 0,
                            'bidfloorcur' : 'USD',
                            'secure' : 1,
                            'banner' : {
                                'w': parseInt(s[0]),
                                'h': parseInt(s[1]),
                                'pos': 0,
                                'format': [],
                                'topframe': 1
                            },
                            'ext': {}
                        };

                        impid++;

                    } else {
                        requestData['imps'][tag_id]['banner']['format'].push(parseSize(size));
                    }

                    var floor = getBidderFloor(bidder, size);
                    // Average floors toogether
                    if(requestData['imps'][tag_id]['bidfloor'] && requestData['imps'][tag_id]['banner']['format'].length) {
                        requestData['imps'][tag_id]['bidfloor'] = ((requestData['imps'][tag_id]['bidfloor'] * requestData['imps'][tag_id]['banner']['format'].length) + floor) / (requestData['imps'][tag_id]['banner']['format'].length + 1);
                    } else {
                        requestData['imps'][tag_id]['bidfloor'] = floor;
                    }

                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData = formatRequest(bidData.requests);
        var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
        var request_cnt = requestData['request_cnt'];


        if(imps.length == 0) {
            return false;
        }

        var payload = {
            'id': '' + new Date().getTime(),
            'at': 1,
            'cur': ['USD'],
            'imp': imps,
            'site': {
                'page': properPage.bidder_page_url,
                'domain': properPage.domain,
                'ref': properPage.referrer,
                'publisher': {
                    'id' : pubId.toString()
                }
            },
            'device': {
                'ua': navigator.userAgent,
                'js': 1,
                'h' : parseInt(properPage.height),
                'w' : parseInt(properPage.width),
                'dnt': (navigator.doNotTrack == 'yes' || navigator.doNotTrack == '1' || navigator.msDoNotTrack == '1') ? 1 : 0,
                'language': navigator.language,
                "geo": {}
            },
            'user': {
                "geo": {}
            },
            'ext': {
                'wrapper': {
                    'wp': 'pbjs',
                    'wv': "prebid_prebid_" + properOps.prebid_version,
                    'transactionId': ProperMedia.utils.generateUUID()
                }
            }
        };

        if(properOps.testing_mode.ids == true) {
            payload.test = 1;
        }

        // User Ids
        var eids = userIds.getEidsArray();
        if (eids && eids.length) {
            ProperMedia.utils.deepSetValue(payload, 'user.eids', eids);
        }

        // Supply chain object
        if(properOps.schain) {
            payload.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

        if (gdprConsent.cmpPresent) {
            payload.user.ext = {
                consent: (gdprConsent.consentString || '')
            }

            payload.regs = {
                ext: {
                    gdpr: (gdprConsent.gdprApplies ? 1 : 0)
                }
            }
        }

        // CCPA
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            payload.regs = payload.regs || {};
            payload.regs.ext = payload.regs.ext || {};
            payload.regs.ext.us_privacy = uspConsent.usPrivacy;
        }

        //logging
        properLog.mylog(ENDPOINT, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            method: "POST",
            url: ENDPOINT,
            requestType: "cors",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(payload),
            success: function(resp) {

                try {

                    resp = ProperMedia.utils.safeJsonParse(resp);

                    var bids_received_ts = ProperMedia.utils.getTimestampMs();
                    var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    //check result
                    if(resp && resp.seatbid && resp.seatbid.length > 0) {
                        for (var key = 0; key < resp.seatbid.length; key++) {
                            if(resp.seatbid[key].bid) {
                                for (var key2 = 0; key2 < resp.seatbid[key].bid.length; key2++) {

                                    var bid = resp.seatbid[key].bid[key2];

                                    var requestId  = bid.impid,
                                        price      = (parseFloat(bid.price) || 0).toFixed(2),
                                        width      = bid.w,
                                        height     = bid.h,
                                        creativeId = bid.crid || bid.id,
                                        adcode     = bid.adm;

                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'size'        : width + 'x' + height,
                                        'price'       : parseFloat(price * bidderInfo.rev_share),
                                        'gross'       : parseFloat(price),
                                        'adcode'      : adcode,
                                        'tag_id'      : requestId,
                                        'request_url' : ENDPOINT,
                                        'response'    : bid,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts,
                                        'ttl'         : bidderInfo.default_bid_ttl
                                    });

                                    bidData.logBidResponse(ad);
                                }
                            }
                        }
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    consentManager.ready(function() {
        var syncurl = USYNCURL + pubId;

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            syncurl += '&gdpr=' + (gdprConsent.gdprApplies ? 1 : 0);
            syncurl += '&gdpr_consent=' + encodeURIComponent(gdprConsent.consentString || '');
        }

        // CCPA
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            syncurl += '&us_privacy=' + encodeURIComponent(uspConsent.usPrivacy);
        }

        userSyncs.add({
            type: 'iframe',
            url: syncurl,
            bidder: bidder
        });
    });

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
})();

    bidAdapters.rhythmone = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 350000
    };

    var bidder      = 'rhythmone',
        version     = '2.1',
        defaultZone = '1r',
        defaultPath = 'mvo',
        loadStart   = Date.now(),
        site_id     = null;
        
    var ENDPOINT_URL  = 'https://tag.1rx.io/rmp/{placementId}/0/{path}?z={zone}',
        SYNC_ENDPOINT = 'https://hbevents.1rx.io/audit';

    var SUPPORTED_VIDEO_PROTOCOLS = [2, 3, 5, 6],
        SUPPORTED_VIDEO_MIMES = ['video/mp4', "application/javascript"],
        SUPPORTED_VIDEO_PLAYBACK_METHODS = [1, 2, 3, 4],
        SUPPORTED_VIDEO_DELIVERY = [1, 2],
        SUPPORTED_VIDEO_API = [1, 2];

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

        var requestData = {
            'imps': []
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var s    = size.split('x');
                    var uuid = ProperMedia.utils.makeid(10);

                    var imp = {
                        'id': uuid,
                        'bidfloor': getBidderFloor(bidder, size),
                        'secure': properPage.use_ssl ? 1 : 0,
                        'ext': {
                            'bidder': {
                                'placementId': site_id,
                                'zone': '1r',
                                'path': 'mvo'
                            }
                        }
                    };

                    if (bidderInfo.demand_type == 'display') {
                        imp['banner'] = {
                            'format': [
                                {
                                    'w': s[0],
                                    'h': s[1]
                                }
                            ]
                        }
                    } else if (bidderInfo.demand_type == 'video') {
                        imp['video'] =  {
                            'mimes'         : SUPPORTED_VIDEO_MIMES,
                            'protocols'     : SUPPORTED_VIDEO_PROTOCOLS,
                            'w'             : parseInt(s[0]),
                            'h'             : parseInt(s[1]),
                            'startdelay'    : 0,
                            'skip'          : 0,
                            'playbackmethod': SUPPORTED_VIDEO_PLAYBACK_METHODS,
                            'delivery'      : SUPPORTED_VIDEO_DELIVERY,
                            'api'           : SUPPORTED_VIDEO_API,
                        }
                    }

                    requestData['imps'].push(imp);
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        // Site IDs: {Desktop}-{Mobile}
        var siteIds = (ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || '').toString().split('-') || ['',''];
        site_id = (properDevice.isMobile() && siteIds.length == 2) ? siteIds[1] : siteIds[0];

        if(!site_id) {
            properLog.mylog('Error: RhythmOne Site ID is Required.');
            return false;
        }

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        var imps        = requestData['imps'] || [];
        var request_cnt = requestData['imps'].length;

        var fat = /(^v|(\.0)+$)/gi;

        var request_url = ENDPOINT_URL;
        request_url = request_url.replace(/\{placementId\}/i, site_id);
        request_url = request_url.replace(/\{zone\}/i, defaultZone);
        request_url = request_url.replace(/\{path\}/i, defaultPath);
        request_url += '&hbv=' + properOps.prebid_version.replace(fat, '') + ',' + version.replace(fat, '');

        var post_data = {
            'id': ProperMedia.utils.generateUUID(),
            'imp': imps,
            'site': {
                'domain': properPage.domain,
                'page': properPage.bidder_page_url,
                'ref': properPage.referrer
            },
            'device': {
                'ua': navigator.userAgent,
                'ip': '', // Empty Ip string is required, server gets the ip from HTTP header
                'dnt': ProperMedia.utils.getDNT() ? 1 : 0
            },
            'at': 1,
            'tmax': 550
        };

        // Supply chain object
        if(properOps.schain) {
            post_data.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

         // GDPR Consent
        if (gdprConsent.cmpPresent) {
            post_data.user = {
                ext: {
                    consent: gdprConsent.consentString
                }
            };
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                post_data.regs = {
                    ext: {
                        gdpr: Number(gdprConsent.gdprApplies)
                    }
                };
            }
        }

        // logging
        properLog.mylog(request_url,bidder); //logging

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        loadStart = Date.now();
        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            url: request_url,
            method: "POST",
            requestType: "cors",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(post_data),
            success: function(resp) {

                try {

                    //logging
                    properLog.mylog(resp,bidder);

                    resp = ProperMedia.utils.safeJsonParse(resp);

                    var bids_received_ts = ProperMedia.utils.getTimestampMs();
                    var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    //handle response
                    if(resp && resp.seatbid && resp.seatbid.length > 0) {
                        for (var i = 0; i < resp.seatbid.length; i++) {
                            for (var j = 0; j < resp.seatbid[i].bid.length; j++) {

                                var bid = resp.seatbid[i]['bid'][j];

                                var impid  = bid['impid'],
                                    width  = bid['w'],
                                    height = bid['h'],
                                    price  = bid['price'] || 0,
                                    adcode = bid['adm']   || '';

                                if(width == 1 && height == 1) {
                                    try{
                                        width  = (bidderInfo.demand_type == 'display') ? imps[0].banner.format[0].w : imps[0].video.w;
                                        height = (bidderInfo.demand_type == 'display') ? imps[0].banner.format[0].h : imps[0].video.h;
                                    } catch(e) {}
                                // TEMP: Overwirte 1280x760 bid responses
                                } else if(parseInt(width) == 1280 && parseInt(height) == 760) {
                                    width  = 640;
                                    height = 480;
                                }

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : width + 'x' + height,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'tag_id'      : width + 'x' + height,
                                    'request_url' : request_url,
                                    'response'    : bid,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                if (bidderInfo.demand_type == 'video') {

                                    var vast_tag  = bid['nurl']     || '',
                                        attr      = bid['attr']     || [],
                                        api       = bid['api']      || 0,
                                        protocol  = bid['protocol'] || 2;
                                    
                                    var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                        vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                    ad.type       = 'video';
                                    ad.vast_tag   = vast_tag;
                                    ad.vast_type  = vast_type;
                                    ad.vpaid      = vpaid;
                                    ad.video_type = bidderInfo.video_type;

                                } else {
                                    ad.adcode = adcode;
                                }

                                bidData.logBidResponse(ad);
                            }
                        }
                        addUserSyncs(resp, requestData, bidder);
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    function addUserSyncs(resp, requestData, bidder) {

        var slots        = [];
        var placementIds = [];
        var site_uuid    = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id');

        Object.keys(requestData).forEach(function(key) {
            slots.push(key);
            placementIds.push(site_uuid);
        });

        var data = {
            doc_version: 1,
            doc_type: 'Prebid Audit',
            placement_id: placementIds.join(',').replace(/[,]+/g, ',').replace(/^,|,$/g, '')
        };
        var w = typeof (window) !== 'undefined' ? window : {document: {location: {href: ''}}};
        var ao = w.document.location.ancestorOrigins;
        var q = [];
        var u = SYNC_ENDPOINT + '?';

        if (ao && ao.length > 0) {
            data.ancestor_origins = ao[ao.length - 1];
        }

        data.popped = w.opener !== null ? 1 : 0;
        data.framed = w.top === w ? 0 : 1;

        try {
            data.url = w.top.document.location.href.toString();
        } catch (ex) {
            data.url = w.document.location.href.toString();
        }

        try {
            data.prebid_version = properOps.prebid_version.toString();
            data.prebid_timeout = 1200;
        } catch (ex) { }

        data.response_ms = Date.now() - loadStart;
        data.placement_codes = slots.join(',');
        data.bidder_version = version;
        if (gdprConsent.cmpPresent) {
            data.gdpr_consent = gdprConsent.consentString;
            data.gdpr = (typeof gdprConsent.gdprApplies === 'boolean') ? gdprConsent.gdprApplies : false;
        }

        Object.keys(data).forEach(function(k) {
            q.push(encodeURIComponent(k) + '=' + encodeURIComponent((typeof data[k] === 'object' ? JSON.stringify(data[k]) : data[k])));
        });

        q.sort();

        userSyncs.add({
            type: 'image',
            url: u + q.join('&'),
            bidder: bidder
        });
    }

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
})();

    bidAdapters.rubicon = (function() {
	/*
	  IMPORTANT: when updating this rev_share, you MUST also update
	  the value of 'var RUBICON_REVSHARE'.
	  This value can be found in the rubicon_stats.php file in the proper-io project:
	  https://github.com/proper-media/proper-io/blob/develop/site/proper_data/advertiser_apis/rubicon_stats.php
	*/
	var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000
	};

    var bidder = 'rubicon',
        accountId = 8777;

    var ENDPOINT_URL  = 'https://fastlane.rubiconproject.com/a/api/fastlane.json',
        SYNC_ENDPOINT = 'https://eus.rubiconproject.com/usync.html';

    var sizeMap = {
        '468x60': 1,
        '728x90': 2,
        '120x90': 5,
        '120x600': 8,
        '160x600': 9,
        '300x600': 10,
        '200x200': 13,
        '250x250': 14,
        '300x250': 15,
        '336x280': 16,
        '300x100': 19,
        '980x120': 31,
        '250x360': 32,
        '180x500': 33,
        '980x150': 35,
        '468x400': 37,
        '930x180': 38,
        '750x100': 39,
        '750x200': 40,
        '750x300': 41,
        '320x50': 43,
        '300x50': 44,
        '300x300': 48,
        '1024x768': 53,
        '300x1050': 54,
        '970x90': 55,
        '970x250': 57,
        '1000x90': 58,
        '320x80': 59,
        '320x150': 60,
        '1000x1000': 61,
        '580x500': 64,
        '640x480': 65,
        '930x600': 66,
        '320x480': 67,
        '1800x1000': 68,
        '320x320': 72,
        '320x160': 73,
        '980x240': 78,
        '980x300': 79,
        '980x400': 80,
        '480x300': 83,
        '970x310': 94,
        '970x210': 96,
        '480x320': 101,
        '768x1024': 102,
        '480x280': 103,
        '250x800': 105,
        '320x240': 108,
        '1000x300': 113,
        '320x100': 117,
        '800x250': 125,
        '200x600': 126,
        '980x600': 144,
        '980x150': 145,
        '320x250': 159,
        '250x600': 179,
        '600x300': 195,
        '640x360': 198,
        '640x200': 199,
        '1030x590': 213,
        '980x360': 214,
        '320x180': 229,
        '580x400': 232,
        '400x600': 257
    };

    Object.keys(sizeMap).forEach(function(x) {
        sizeMap[sizeMap[x]] = x;
    });


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder) {

        var requestData = {
            'imps': {},
            'request_cnt': 0
        };

        var rubicon_sizes = {};

        var siteId = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(!siteId) {
            properLog.mylog('Error: Rubicon Site ID is Required.');
            return requestData;
        }

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {

                        var ids = tag_id.split('-');
                        var zoneId = ids[0];

                        // Order sizes by priority
                        rubicon_sizes[tag_id] = [];

                        requestData['imps'][tag_id] = {
                            'account_id'     : parseInt(accountId),
                            'site_id'        : parseInt(siteId),
                            'zone_id'        : parseInt(zoneId),
                            'size_id'        : undefined, 
                            'alt_size_ids'   : '',
                            'rp_floor'       : getBidderFloor(bidder, size),
                            'rp_secure'      : (properPage.use_ssl == true) ? '1' : '0',
                            'tk_flint'       : 'pbjs_lite_v3.2.0',
                            'x_source.tid'   : ProperMedia.utils.generateUUID(),
                            'p_screen_res'   : properPage.width+'x'+properPage.height,
                            'kw'             : '',
                            'tk_user_key'    : '',
                            'p_geo.latitude' : undefined,
                            'p_geo.longitude': undefined,
                            'tg_fl.eid'      : tag_id,
                            'rf'             : properPage.bidder_page_url
                        };

                        if(properOps.schain && properOps.schain.nodes && properOps.schain.nodes[0] && properOps.schain.nodes[0].sid) {
                            requestData['imps'][tag_id]['x_source.pchain'] = 'proper.io:' + properOps.schain.nodes[0].sid;
                        }

                        // don't let buyers filter us out if position is not atf (above the fold)
                        // if(obj['position'] === 'atf') {
                        //     requestData['imps'][tag_id]['p_pos'] = obj['position'];
                        // }
                        
                    }

                    if(typeof sizeMap[size] !== 'undefined') {

                        var floor = getBidderFloor(bidder, size);
                        if(floor < requestData['imps'][tag_id]['rp_floor']) {
                            requestData['imps'][tag_id]['rp_floor'] = floor;
                        }

                        rubicon_sizes[tag_id].push(sizeMap[size]);
                        rubicon_sizes[tag_id] = masSizeOrdering(rubicon_sizes[tag_id]);

                        requestData['imps'][tag_id]['size_id'] = rubicon_sizes[tag_id][0];
                        requestData['imps'][tag_id]['alt_size_ids'] = rubicon_sizes[tag_id].slice(1).join(',');

                        requestData['request_cnt']++;
                    }
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidder);
        var data        = ProperMedia.utils.objectValues(requestData['imps']) || [];
        var request_cnt = requestData['request_cnt'];

        if(request_cnt == 0) {
            return false;
        }

        var combined_data = combineSlotUrlParams(data);

        if (properUser.pubcid) {
            combined_data['ppuid'] = properUser.pubcid;
        }

        // User Ids
        var eids = userIds.getEidsArray();
        if (eids && eids.length) {
            eids.forEach(function(eid) {
                try {
                    // special cases
                    if (eid.source === 'adserver.org') {
                        combined_data['tpid_tdid'] = eid.uids[0].id;
                        combined_data['eid_adserver.org'] = eid.uids[0].id;
                    } else if (eid.source === 'liveintent.com') {
                        combined_data['tpid_liveintent.com'] = eid.uids[0].id;
                        combined_data['eid_liveintent.com'] = eid.uids[0].id;
                        if (eid.ext && Array.isArray(eid.ext.segments) && eid.ext.segments.length) {
                            combined_data['tg_v.LIseg'] = eid.ext.segments.join(',');
                        }
                    } else if (eid.source === 'liveramp.com') {
                        combined_data['x_liverampidl'] = eid.uids[0].id;
                    } else if (eid.source === 'sharedid.org') {
                        combined_data['eid_sharedid.org'] = eid.uids[0].id + '^' + eid.uids[0].atype + '^' + ((eid.uids[0].ext && eid.uids[0].ext.third) || '');
                    } else if (eid.source === 'id5-sync.com') {
                        combined_data['eid_id5-sync.com'] = eid.uids[0].id + '^' + eid.uids[0].atype + '^' + ((eid.uids[0].ext && eid.uids[0].ext.linkType) || '');
                    } else {
                        // add anything else with this generic format
                        combined_data['eid_' + eid.source] = eid.uids[0].id + '^' + (eid.uids[0].atype || '');
                    }                    
                } catch (e) {
                    properLog.mylog('Rubicon: error reading eid:' + eid + '. ' + JSON.stringify(e));
                }
            });
        }

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                combined_data['gdpr'] = Number(gdprConsent.gdprApplies);
            }
            combined_data['gdpr_consent'] = gdprConsent.consentString;
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            combined_data['us_privacy'] =  encodeURIComponent(uspConsent.usPrivacy);
        }

        // Supply chain object isset
        if(properOps.schain) {
            combined_data['rp_schain'] = ProperMedia.utils.formatSupplyChainString(properOps.schain);
        }

        combined_data['slots'] = data.length;
        combined_data['rand']  = Math.random();

        var orderedParams = getOrderedParams(combined_data);

        // Query String
        var qs = ProperMedia.utils.formatQueryString(combined_data, true);

        var request_url = ENDPOINT_URL + '?' + qs;

        //logging
        properLog.mylog(request_url,bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            url: request_url,
            requestType: "cors",
            bidder: bidder,
            edge: edge,
            success: function(resp) {

                //parse resposne
                try {

        			//logging
        			properLog.mylog(resp,bidder);

    				var responseObj = ProperMedia.utils.safeJsonParse(resp) || {};
    				if(
                        responseObj &&
                        typeof responseObj == 'object'
                    ) {

    					var bids_received_ts = ProperMedia.utils.getTimestampMs();
    					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        var ads = responseObj.ads || [];
                        if (Array.isArray(ads) && ads.length > 0) {

        					for(var i = 0; i < ads.length; i++) {

                                var ad = ads[i];

                                var impid = (data && data[i] && data[i]['tg_fl.eid']) ? data[i]['tg_fl.eid'] : '';

        						//check status
        						if(ad.status !== "ok") {
                                    if(typeof ad.reason !== 'undefined') {
                                        properLog.mylog("rubicon resposne status: " + ad.reason);
                                    }
                                    continue;
                                }

        						//log bid
        						var price   = ad.cpm,
        						    status  = ad.status,
        						    adcode  = ad.script,
        						    adtype  = ad.type,
                                    size_id = ad.size_id,
                                    tag_id  = responseObj.zoneId;

                                var size = sizeMap[size_id] || 'unknown';

        						if(adtype == "script") adcode="<script>"+adcode+"</script>";

        						//identify ad
        						var ad_details = {};
        						if(typeof ad.advertiser  !== "undefined") ad_details.advertiser  = ad.advertiser;
        						if(typeof ad.seat        !== "undefined") ad_details.seat        = ad.seat;
        						if(typeof ad.creative_id !== "undefined") ad_details.creative_id = ad.creative_id;
        						if(typeof ad.campaign_id !== "undefined") ad_details.campaign_id = ad.campaign_id;
        						if(typeof ad.ad_id       !== "undefined") ad_details.ad_id       = ad.ad_id;

        						// New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : size,
                                    'price'       : parseFloat(price * bidderInfo.rev_share),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : impid,
                                    'request_url' : request_url,
                                    'response'    : ad,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);
        					}
        				}
                    }
        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    /**
    * @summary combines param values from an array of slots into a single semicolon delineated value
    * or just one value if they are all the same.
    * @param {Object[]} aSlotUrlParams - example [{p1: 'foo', p2: 'test'}, {p2: 'test'}, {p1: 'bar', p2: 'test'}]
    * @return {Object} - example {p1: 'foo;;bar', p2: 'test'}
    */
    function combineSlotUrlParams(aSlotUrlParams) {
        // if only have params for one slot, return those params
        if (aSlotUrlParams.length === 1) {
            return aSlotUrlParams[0];
        }

        // reduce param values from all slot objects into an array of values in a single object
        var oCombinedSlotUrlParams = aSlotUrlParams.reduce(function(oCombinedParams, oSlotUrlParams, iIndex) {
            Object.keys(oSlotUrlParams).forEach(function(param) {
                if (!oCombinedParams.hasOwnProperty(param)) {
                    oCombinedParams[param] = new Array(aSlotUrlParams.length); // initialize array;
                }
                // insert into the proper element of the array
                oCombinedParams[param].splice(iIndex, 1, oSlotUrlParams[param]);
            });

            return oCombinedParams;
        }, {});

        // convert arrays into semicolon delimited strings
        var re = new RegExp('^([^;]*)(;\\1)+$'); // regex to test for duplication

        Object.keys(oCombinedSlotUrlParams).forEach(function(param) {
            var sValues = oCombinedSlotUrlParams[param].join(';');
            // consolidate param values into one value if they are all the same
            var match = sValues.match(re);
            oCombinedSlotUrlParams[param] = match ? match[1] : sValues;
        });

        return oCombinedSlotUrlParams;
    }


    function getOrderedParams(params) {
        var containsTgV = /^tg_v/
        var containsTgI = /^tg_i/

        var orderedParams = [
            'account_id',
            'site_id',
            'zone_id',
            'size_id',
            'alt_size_ids',
            'p_pos',
            'gdpr',
            'gdpr_consent',
            'rf',
            'dt.id',
            'dt.keyv',
            'dt.pref',
            'p_geo.latitude',
            'p_geo.longitude',
            'kw'
        ].concat(Object.keys(params).filter(function(item) { return containsTgV.test(item) }))
        .concat(Object.keys(params).filter(function(item) { return containsTgI.test(item) }))
        .concat([
            'tk_flint',
            'x_source.tid',
            'p_screen_res',
            'rp_floor',
            'rp_secure',
            'tk_user_key'
        ]);

        return orderedParams.concat(Object.keys(params).filter(function(item) { return (orderedParams.indexOf(item) === -1) }));
    }

    function masSizeOrdering(sizes) {
        var MAS_SIZE_PRIORITY = [15, 2, 9];

        return sizes.sort(function(first, second) {
            // sort by MAS_SIZE_PRIORITY priority order
            var firstPriority = MAS_SIZE_PRIORITY.indexOf(first);
            var secondPriority = MAS_SIZE_PRIORITY.indexOf(second);

            if (firstPriority > -1 || secondPriority > -1) {
                if (firstPriority === -1) {
                    return 1;
                }
                if (secondPriority === -1) {
                    return -1;
                }
                return firstPriority - secondPriority;
            }

            // and finally ascending order
            return first - second;
        });
    }

	consentManager.ready(function() {
		var params = '';

		// GDPR Consent
		if (gdprConsent.cmpPresent) {
			if (typeof gdprConsent.gdprApplies === 'boolean') {
				params += '?gdpr='+Number(gdprConsent.gdprApplies)+'&gdpr_consent='+gdprConsent.consentString;
			} else {
				params += '?gdpr_consent='+gdprConsent.consentString;
			}
		}

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            params += (params.length > 0 ? '&' : '?') + 'us_privacy=' + encodeURIComponent(uspConsent.usPrivacy);
        }

		userSyncs.add({
			type: 'iframe',
			url: SYNC_ENDPOINT + params,
            bidder: bidder
		});
    });

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.sharethrough = (function() {
	var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'slot',
        "default_bid_ttl": 360000
	};

    var bidder = 'sharethrough';
    var ENDPOINT_URL = 'https://btlr.sharethrough.com/WYu2BXv1/v1';
    

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData[tag_id] == 'undefined') {
                        requestData[tag_id] = {
                            'tag_id': tag_id,
                            'pkey'  : tag_id,
                            'size'  : size
                        };
                    }
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var requestData = formatRequest(bidData.requests);

        // request count
        Object.keys(requestData).forEach(function(tag_id) {
            send_slot(requestData[tag_id]);
        });

        function send_slot(request_data) {

            var pkey        = request_data['pkey'];
            var size        = request_data['size'];
            var request_cnt = 1;

            var data = {
                'placement_key'       : pkey,
                'bidId'               : pkey,
                'bidfloor'            : getBidderFloor(bidder, size),
                'consent_required'    : false,
                'instant_play_capable': canAutoPlayHTML5Video(),
                'hbSource'            : 'prebid',
                'hbVersion'           : '3.0.0',
                'strVersion'          : '3.2.0'
            };

            ProperMedia.utils.mergeObject(data, handleUniversalIds());

            if (gdprConsent.cmpPresent) {
                if (gdprConsent.consentString) {
                    data.consent_string = gdprConsent.consentString;
                }
                data.consent_required = !!gdprConsent.gdprApplies;
            }

            // USP Consent
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                data.us_privacy = uspConsent.usPrivacy;
            }

            if(properOps.schain) {
                data.schain = JSON.stringify(properOps.schain);
            }

            // Format Query string
            var query = ProperMedia.utils.formatQueryString(data, true);

            // build request url
            var request_url = ENDPOINT_URL+'?'+query;

            //logging
            properLog.mylog(request_url, bidder);

            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();

            // Check if request should be sent through edge bidder
            var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        	//send request
        	$.ajax({
        		url: request_url,
                method: "GET",
        		requestType: "cors",
                bidder: bidder,
                edge: edge,
        		success: function(json) {

    				try {

    					//logging
        				properLog.mylog(json,bidder);

    					var resp = ProperMedia.utils.safeJsonParse(json);

        				//handle response
        				if(resp && resp.creatives.length > 0) {

        					var bids_received_ts = ProperMedia.utils.getTimestampMs();
        					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

        					var creative = resp.creatives[0];

        					var bidId  = resp.bidId   || '';
        					var price  = creative.cpm || 0;

        					var windowLocation = 'str_response_'+bidId;
        					var bidJsonString = ProperMedia.utils.b64EncodeUnicode(JSON.stringify(resp));

        					var adcode = '<div data-str-native-key="'+pkey+'" data-stx-response-name="'+windowLocation+'"></div>';
                        		adcode += '<script>var '+windowLocation+' = "'+bidJsonString+'"</script>';
                                // Don't break out of iframe
                                adcode += '<script src="//native.sharethrough.com/assets/sfp.js"></script>';

        					   // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : size,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'adcode'      : adcode,
                                    'tag_id'      : bidId,
                                    'request_url' : request_url,
                                    'response'    : resp,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);
        				}

                        // user syncs
                        addUserSyncs(resp);

            			//log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);

                    } catch(e) { 
                        e.bidder = bidder;
                        throw e;
                    }

        		},
        		error: function(resp) {
                    try { 
            			//log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    } catch(e) { 
                        e.bidder = bidder;
                        throw e;
                    }
        		}
        	});
        }
    }


    function canAutoPlayHTML5Video() {
        var userAgent = navigator.userAgent;
        if (!userAgent) return false;

        var isAndroid = /Android/i.test(userAgent);
        var isiOS = /iPhone|iPad|iPod/i.test(userAgent);
        var chromeVersion = parseInt((/Chrome\/([0-9]+)/.exec(userAgent) || [0, 0])[1]);
        var chromeiOSVersion = parseInt((/CriOS\/([0-9]+)/.exec(userAgent) || [0, 0])[1]);
        var safariVersion = parseInt((/Version\/([0-9]+)/.exec(userAgent) || [0, 0])[1]);

        if (
            (isAndroid && chromeVersion >= 53) ||
            (isiOS && (safariVersion >= 10 || chromeiOSVersion >= 53)) ||
            !(isAndroid || isiOS)
        ) {
            return true;
        } else {
            return false;
        }
    }

    function handleUniversalIds() {
        var universalIds = {};

        var idl = ProperMedia.utils.deepAccess(userIdAdapters.identityLink, 'idObj.idl_env');
        if (idl) universalIds.idluid = idl;

        var id5 = ProperMedia.utils.deepAccess(userIdAdapters.identityLink, 'idObj.id5id.uid');
        if (id5) {
            universalIds.id5uid = { "id": id5 };
            var id5link = ProperMedia.utils.deepAccess(userIdAdapters.identityLink, 'idObj.id5id.ext.linkType');
            if (id5link) universalIds.id5uid.linkType = id5link;
        }

        var pubc = properUser.pubcid;
        if (pubc) universalIds.pubcid = pubc;

        return universalIds;
    }

	function addUserSyncs(resp) {
		if (resp && resp.cookieSyncUrls) {
			var syncs = resp.cookieSyncUrls.map(function(url) {
				return {
                    type: 'image',
                    url: url,
                    bidder: bidder
                };
			});
			userSyncs.add(syncs);
		}
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.smart_adserver = (function() {
	var bidderInfo = {
        "rev_share"       : 1,
        "demand_type"     : 'display',
        "bid_grouping"    : 'slot',
        "default_bid_ttl" : 120000
	};

	var ENDPOINT_URL = "https://prg.smartadserver.com/prebid/v1";
    var bidder = 'smart_adserver';


    /**
	 * Parse size and format to object
	 * @param {string} size - size string: '728x90'
	 * @return {Object}
	 */
	function parseSize(size) {
		var s = size.split('x');
        return {
        	'w': parseInt(s[0]),
        	'h': parseInt(s[1])
        };
	}


	/**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

    	var requestData = {};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];
                    if(typeof requestData[tag_id] == 'undefined') {
                    	var ids = tag_id.split('-');

                    	if(ids.length < 2 || !ids[0] || !ids[1]) {
							properLog.mylog('Error: Smart Ad Server missing id for tag_id. Tag ID needs to be in format: {pageid}-{formatid}');           		
                    	}

				    	requestData[tag_id] = {
			    			'pageid'       : ids[0],
		        			'formatid'     : ids[1],
		        			'sizes'        : [],
							'bidfloor'     : getBidderFloor(bidder, size),
							'tagId'        : ProperMedia.utils.generateUUID(),
					        'transactionId': ProperMedia.utils.generateUUID(),
					        'bidId'        : ProperMedia.utils.generateUUID()
			    		}
			    	}

		    		var floor = getBidderFloor(bidder, size);
                	if(floor < requestData[tag_id]['bidfloor']) {
                    	requestData[tag_id]['bidfloor'] = floor;
                    }

                    if (bidderInfo.demand_type == 'video') {
						var playerSize = size.split('x');
					    requestData[tag_id].isVideo = (bidderInfo.video_type == 'outstream') ? false : true;
					    requestData[tag_id].videoData = {
							'videoProtocol': 6,
							'playerWidth'  : playerSize[0],
							'playerHeight' : playerSize[1],
							'adBreak'      : 1
					    };
					} else {
						requestData[tag_id].sizes.push(parseSize(size));
					}
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	// Get bidder
        var bidder = bidData.bidder;
    	// Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

    	var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || '';

        if(!site_id) {
            properLog.mylog('Error: Smart Ad Server site is required.');
            return false;
        }

        var post_data = {
    		'siteid'       : site_id,
	        'currencyCode' : 'USD',
	        'ckid'         : 0,		        
	        'pageDomain'   : properPage.domain, 
	        'prebidVersion': properOps.prebid_version,
	        'timeout'      : 1000,
	        'schain'       : ProperMedia.utils.formatSupplyChainString(properOps.schain)
    	}

    	// User Ids
        var eids = userIds.getEidsArray();
        if (eids && eids.length) {
        	post_data.eids = eids;
        }

        // GDPR Consent
    	if (gdprConsent.cmpPresent) {
			post_data.gdpr_consent = gdprConsent.consentString;
			post_data.gdpr = gdprConsent.gdprApplies;
		}

		// USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            post_data.us_privacy = uspConsent.usPrivacy
        }

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        var slots       = ProperMedia.utils.objectValues(requestData) || [];

        slots.forEach(function(slot) {
        	send_slot(slot);
        });

        /**
         * Send slot level bid requests
         */
        function send_slot(slot) {

        	var payload = ProperMedia.utils.mergeObject({}, post_data, slot);

			//logging
			properLog.mylog(ENDPOINT_URL, bidder);

			var request_cnt = (bidderInfo.demand_type == 'video') ? 1 : payload.sizes.length;
			// log requests
	        bidData.incrementRequestsSent(request_cnt);

			var bid_sent_ts = ProperMedia.utils.getTimestampMs();

			//send request
			$.ajax({
				url: ENDPOINT_URL,
				method: "POST",
				requestType: "cors",
				data: JSON.stringify(payload),
				success: function(resp) {

					try {

						//process response
				        if(!resp) {
			          		properLog.mylog("No Smart Ad Server bids returned");

				        } else {
				        	resp = ProperMedia.utils.safeJsonParse(resp);

							var bids_received_ts = ProperMedia.utils.getTimestampMs();
							var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

				        	//logging
							properLog.mylog(resp, bidder);

							if(typeof resp.ad !== 'undefined') {

								var impid   = resp.tag_id || '',
									price   = resp.cpm    || 0,
									width   = resp.width  || 1,
									height  = resp.height || 1,
									ttl     = (resp.ttl * 1000) || bidderInfo.default_bid_ttl;

								// New Ad object
	                            var ad = new adObj({
	                                'bidder'      : bidder,
	                                'size'        : width + 'x' + height,
	                                'price'       : parseFloat(price),
	                                'gross'       : parseFloat(price),
	                                'tag_id'      : impid,
	                                'request_url' : ENDPOINT_URL,
	                                'response'    : resp,
	                                'response_ms' : bid_response_ms,
	                                'received_ts' : bids_received_ts,
	                                'ttl'         : ttl
	                            });


	                            if (bidderInfo.demand_type == 'video') {
                                    ad.type       = 'video';
                                    ad.vast_tag   = resp.adUrl;
                                    ad.vast_type  = 'url';
                                    ad.vpaid      = false;
                                    ad.video_type = bidderInfo.video_type;
                                } else {
                                    ad.adcode = resp.ad;
                                }

	                            bidData.logBidResponse(ad);
							}
						}
						
						//log request as received regardless
	        			bidData.incrementBidResponseCount(request_cnt);

					} catch (e) { 
						e.bidder = bidder;
						throw e;
					}

				},
				error: function(resp) {
					try {
						//log request as received regardless
	        			bidData.incrementBidResponseCount(request_cnt);

					} catch (e) { 
						e.bidder = bidder;
						throw e;
					}
				}
			});
		}
    }


	function getDevice() {
		var language = navigator.language ? 'language' : 'userLanguage';
		return {
			h: screen.height,
			w: screen.width,
			dnt: ProperMedia.utils.getDNT() ? 1 : 0,
			language: navigator[language].split('-')[0],
			make: navigator.vendor ? navigator.vendor : '',
			ua: navigator.userAgent
		};
	}

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    // Put in test mode: http://tester.go.sonobi.com/cookie.html?sbi_mouse=15; 
// Set session cookie: sbi_test={"sbi_mouse":5}; domain=.go.sonobi.com; path=/; SameSite=none;
bidAdapters.sonobi = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 120000 // Prebid ttl => 500000
    };

    var bidder = 'sonobi',
        ENDPOINT_URL = 'https://apex.go.sonobi.com/trinity.json',
        SONOBI_DIGITRUST_KEY = 'fhnS5drwmH';


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder) {

        var requestData = {
            'imps': {},
            'request_cnt': 0
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
          
                    var tag_id = data[size][i];
                    if(typeof requestData['imps'][tag_id] == 'undefined') {

                        var siteId = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || tag_id;

                        requestData['imps'][tag_id] = {
                            'bidId': siteId,
                            'floor': getBidderFloor(bidder, size),
                            'sizes': []
                        }
                    }

                    var floor = getBidderFloor(bidder, size);
                    if(floor < requestData['imps'][tag_id]['floor']) {
                        requestData['imps'][tag_id]['floor'] = floor;
                    }

                    requestData['imps'][tag_id]['sizes'].push(size);
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidder);
        var request_cnt = requestData['request_cnt'];

        if(request_cnt == 0) return false;

        var payload = {
            'key_maker': '',
            'ref'      : properPage.bidder_page_url,
            's'        : ProperMedia.utils.generateUUID(),
            'pv'       : ProperMedia.utils.generateUUID(),
            'vp'       : properDevice.device_type,
            'lib_name' : 'prebid',
            'lib_v'    : properOps.prebid_version,
            'us'       : 1,
            'ius'      : 1,
        };        

        var data = {};
        Object.keys(requestData['imps']).forEach(function(key) {

            var obj = requestData['imps'][key];

            var bidId = obj['bidId'];
            var floor = obj['floor'];
            var sizes = (bidderInfo.demand_type == 'display') ? obj['sizes'].join(',') : '';

            data[key] = bidId + '|' + sizes + '|' + floor;
        });

        // Set Key Maker
        payload['key_maker'] = JSON.stringify(data);

        var user_id = userIds.getUIdsObj();
        if(user_id && Object.keys(user_id).length) {
            payload['userid'] = JSON.stringify(user_id);
        }

        // Supply chain object
        if(properOps.schain) {
            payload['schain'] = JSON.stringify(properOps.schain);
        }

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            payload['gdpr'] = gdprConsent.gdprApplies.toString();
            if (gdprConsent.consentString) {
                payload['consent_string'] = gdprConsent.consentString;
            }
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            payload['us_privacy'] = uspConsent.usPrivacy;
        }

        // Format Query string
        var qs = ProperMedia.utils.formatQueryString(payload, true);

        var request_url = ENDPOINT_URL + '?' + qs;

        properLog.mylog(request_url, bidder); //logging

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
            url: request_url,
            method: "GET",
            requestType: "cors",
            bidder: bidder,
            edge: edge,
            success: function(resp) {

                try {

                    //logging
                    properLog.mylog(resp,bidder);

                    //handle response
                    if(resp) {
                        resp = ProperMedia.utils.safeJsonParse(resp) || {};

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        var sbi_dc = resp.sbi_dc || '';

                        //process data
                        if(typeof resp.slots !== 'undefined') {

                            Object.keys(resp.slots).forEach(function(key) {
                                var obj = resp.slots[key];

                                if(Object.keys(obj).length > 0) {

                                    var dealId  = obj.sbi_dozer || '',
                                        sbi_aid = obj.sbi_aid   || '',
                                        sbi_ct  = obj.sbi_ct    || '';

                                    var tagid  = key,
                                        price  = obj.sbi_mouse,
                                        size   = obj.sbi_size;

                                    if(bidderInfo.demand_type == 'video') {
                                        var reqObj = requestData['imps'][key];
                                        size = reqObj.sizes[0];
                                    }

                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'size'        : size,
                                        'price'       : parseFloat(price),
                                        'gross'       : parseFloat(price),
                                        'tag_id'      : tagid,
                                        'request_url' : request_url,
                                        'response'    : obj,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts,
                                        'ttl'         : bidderInfo.default_bid_ttl
                                    });

                                    if (bidderInfo.demand_type == 'video') {

                                        ad.type       = 'video';
                                        ad.vast_tag   = 'https://' + sbi_dc + 'apex.go.sonobi.com/vast.xml?vid=' + sbi_aid + '&ref=' + encodeURIComponent(properPage.bidder_page_url);
                                        ad.vast_type  = 'url';
                                        ad.vpaid      = false;
                                        ad.video_type = bidderInfo.video_type;

                                    } else {
                                        ad.adcode = '<script type="text/javascript" src="https://' + sbi_dc + 'apex.go.sonobi.com/sbi.js?aid=' + sbi_aid + '&as=null&ref=' + encodeURIComponent(properPage.bidder_page_url) + '"></script>';
                                    }

                                    bidData.logBidResponse(ad);
                                }
                            });
                        }
                        addUserSyncs(resp, bidder);
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) {
                    e.bidder = bidder;
                    throw e;
                }

            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) {
                    e.bidder = bidder;
                    throw e;
                }

            }
        });

    }

	function addUserSyncs(resp, bidder) {
        if(resp && resp.sbi_px) {
    		var syncs = resp.sbi_px.map(function(entry) {
    			return { 
                    type: entry.type, 
                    url: entry.url,
                    bidder: bidder
                };
    		});
    		userSyncs.add(syncs);
        }
	}

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
})();

    bidAdapters.sovrn = (function() {
	var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 90000
	};

    var bidder = 'sovrn';
    var ENDPOINT_URL = 'https://ap.lijit.com/rtb/bid?src=prebid_prebid_' + properOps.prebid_version;


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

        var requestData = {
            'imps': []
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                var s = size.split("x");

                for (var i = 0; i < data[size].length; i++) {
                    var tag_id = data[size][i];

                    requestData['imps'].push({
                        "id": tag_id+'|'+size,
                        "banner": {
                            "format": [{
                                "w": parseInt(s[0]),
                                "h": parseInt(s[1])
                            }],
                            "w": 1,
                            "h": 1
                        },
                        "tagid": tag_id,
                        "bidfloor": getBidderFloor(bidder, size)
                    });
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	var requestData = formatRequest(bidData.requests);
        var imps        = requestData['imps'] || [];
        var request_cnt = requestData['request_cnt'];

        if(imps.length == 0) return false;

    	//create bid request
    	var br = {
            "id": ProperMedia.utils.generateUUID(),
            "imp" : imps,
            "site": {
                "domain": properPage.domain,
                "page": properPage.bidder_page_url
            }
        };

        var criteoId;
        var tpid = [];
        var eids = userIds.getEidsArray();
        if (eids && eids.length) {
            eids.forEach(function (id) {
                if (id.uids && id.uids[0]) {
                    if (id.source === 'criteo.com') {
                        criteoId = id.uids[0].id
                    }
                    tpid.push(
                        {
                            "source": id.source, 
                            "uid": id.uids[0].id
                        }
                    );
                }
            });
            ProperMedia.utils.deepSetValue(br, 'user.ext.eids', eids);
            ProperMedia.utils.deepSetValue(br, 'user.ext.tpid', tpid);
            if (criteoId) {
                ProperMedia.utils.deepSetValue(br, 'user.ext.prebid_criteoid', criteoId);
            }
        }

        // Supply chain object
        if(properOps.schain) {
            br.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

		if (gdprConsent.cmpPresent) {
			br.regs = {
                ext: {
                    gdpr: Number(gdprConsent.gdprApplies)
                }
            };
			br.user = {
                ext: {
                    consent: gdprConsent.consentString
                }
            };
		}

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            br.regs = br.regs || {};
            br.regs.ext = br.regs.ext || {};
            br.regs.ext.us_privacy = uspConsent.usPrivacy;
        }

    	properLog.mylog(ENDPOINT_URL, bidder); //logging

    	// log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

    	//send request
    	$.ajax({
    		url: ENDPOINT_URL,
            method: "POST",
    		requestType: "cors",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(br),
    		success: function(resp) {

                try {
                    
        			//logging
        			properLog.mylog(resp, bidder);

                    resp = ProperMedia.utils.safeJsonParse(resp) || {};

    				//process response
    				if(typeof resp.seatbid == 'undefined' || resp.seatbid.length == 0 || !resp.seatbid[0].bid) {
    					properLog.mylog("no sovrn bids found");

    				} else {

    					var bids_received_ts = ProperMedia.utils.getTimestampMs();
    					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

    					var bids = resp.seatbid[0].bid;

                        Object.keys(bids).forEach(function(x) { //log bids

    						var obj    = bids[x],
                                impid  = obj.impid.split("|"),
                                tag_id = impid[0],
                                size   = impid[1],
                                price  = obj.price,
                                adcode = decodeURIComponent(obj.adm)+"<img src=\""+obj.nurl+"\" width=1 height=1>",
                                nurl   = obj.nurl,
                                ttl    = (ProperMedia.utils.deepAccess(obj, 'ext.ttl') * 1000) || bidderInfo.default_bid_ttl;

    						//ad identifier
    						var ad_details = {};
    						var n = ProperMedia.utils.getUrlParameters(nurl);
    						if(typeof n.seatid     != "undefined") ad_details.seatid     = n.seatid;
    						if(typeof n.campaignid != "undefined") ad_details.campaignid = n.campaignid;
    						if(typeof n.bannerid   != "undefined") ad_details.bannerid   = n.bannerid;
    						if(typeof n.cb         != "undefined") ad_details.cb         = n.cb;
    						if(typeof n.rpid       != "undefined") ad_details.rpid       = n.rpid;

                            // New Ad object
                            var ad = new adObj({
                                'bidder'      : bidder,
                                'size'        : size,
                                'price'       : parseFloat(price),
                                'gross'       : parseFloat(price),
                                'adcode'      : adcode,
                                'tag_id'      : tag_id,
                                'request_url' : ENDPOINT_URL,
                                'response'    : obj,
                                'response_ms' : bid_response_ms,
                                'received_ts' : bids_received_ts,
                                'ttl'         : ttl
                            });

                            bidData.logBidResponse(ad);
    						
    					});
                        addUserSyncs(resp);
    				}

        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
    		}
    	});

    }
    

    function addUserSyncs(serverResponse) {
        try {
            if (serverResponse && serverResponse.ext && serverResponse.ext.iid) {
                var consentString = '';
                if (gdprConsent && gdprConsent.cmpPresent && gdprConsent.gdprApplies && typeof gdprConsent.consentString === 'string') {
                    consentString += '&gdpr_consent=' + gdprConsent.consentString
                }
                if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                    consentString += '&us_privacy=' + uspConsent.usPrivacy
                }

                userSyncs.add({
                    type: 'iframe',
                    url: '//ap.lijit.com/beacon?informer=' + serverResponse.ext.iid + consentString,
                    bidder: bidder
                });
            }
        } catch (e) { 
            e.bidder = bidder;
            throw e;
        }
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.teads = (function() {
	var bidderInfo = {
        "rev_share"    : 1,
        "demand_type"  : 'display',
        "bid_grouping" : 'page',
        "div_insertion": 1,
        "native_sizes" : {
	        'native_horizontal': '300x250',
	        'native_vertical'  : '300x250'
		}
	};

	var ENDPOINT = "https://a.teads.tv/hb/bid-request",
		USYNCURL = "https://sync.teads.tv/iframe";
	
	var bidder = 'teads';

	var gdprStatus = {
		GDPR_APPLIES_PUBLISHER: 12,
		GDPR_APPLIES_GLOBAL: 11,
		GDPR_DOESNT_APPLY: 0,
		CMP_NOT_FOUND_OR_ERROR: 22
	}


	/**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data) {

    	var requestData = {
            'data': {},
            'sizes': {},
            'request_cnt': 0
        };

        var site_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(!site_id) {
            properLog.mylog('Error: Teads Site ID is Required.');
            return requestData;
        }

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
				for (var i = 0; i < data[size].length; i++) {
                    var tag_id = data[size][i];

                    // tag_id = {placementId}-{groupId}
                    // groupId is optional
			    	var ids = tag_id.split('-');

		    		placementId = parseInt(ids[0]);

                    if(typeof requestData['data'][tag_id] == 'undefined') {

                        var div_id = "teads-" + ProperMedia.utils.generateUUID();

                        requestData['data'][tag_id] = {
				    		'bidId'           : tag_id,
				    		'placementId'     : placementId,
				    		'pageId'          : site_id,
				    		'adUnitCode'      : div_id,
				    		'bidderRequestId' : ProperMedia.utils.generateUUID(),
				    		'transactionId'   : ProperMedia.utils.generateUUID(),
				    		'auctionId'       : ProperMedia.utils.generateUUID(),
				    		'sizes'           : []
				    	}

				    	requestData['sizes'][tag_id] = [];
                    }

                    // Override native sizes
                    var tmp_size = bidderInfo.native_sizes[size] || size;

                    requestData['data'][tag_id]['sizes'].push(tmp_size);
                    requestData['sizes'][tag_id].push(size);
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

    	var requestData = formatRequest(bidData.requests);
        var bids        = ProperMedia.utils.objectValues(requestData['data']) || [];
        var request_cnt = requestData['request_cnt'];

    	var postData = {
    		'referrer'   : properPage.bidder_page_url,
    		'data'       : bids,
    		'deviceWidth': properPage.width
    	}

    	// Supply chain object isset
        if(properOps.schain) {
            postData.schain = properOps.schain;
        }

        // GDPR Consent
		if (gdprConsent) {
			var isCmp = (typeof gdprConsent.gdprApplies === 'boolean')
			var isConsentString = (typeof gdprConsent.consentString === 'string')
			var status = isCmp
				? findGdprStatus(gdprConsent.gdprApplies, gdprConsent.vendorData, gdprConsent.apiVersion)
				: gdprStatus.CMP_NOT_FOUND_OR_ERROR
			postData.gdpr_iab = {
				consent: isConsentString ? gdprConsent.consentString : '',
				status: status,
				apiVersion: gdprConsent.apiVersion
			};
		}

    	// USP Consent
		if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
			postData.us_privacy = uspConsent.usPrivacy;
		}

		//logging
		properLog.mylog(ENDPOINT, bidder);

		// log requests
        bidData.incrementRequestsSent(request_cnt);

		var bid_sent_ts = ProperMedia.utils.getTimestampMs();

		// Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

		//send request
		$.ajax({
			url: ENDPOINT,
			method: "POST",
			requestType: "cors",
			bidder: bidder,
            edge: edge,
			data: JSON.stringify(postData),
			success: function(resp) {
				try {

					resp = ProperMedia.utils.safeJsonParse(resp);

					var bids_received_ts = ProperMedia.utils.getTimestampMs();
					var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

					//process response
			        if(resp && resp.responses && resp.responses.length > 0) {

			        	//logging
						properLog.mylog(resp, bidder);

						for(var i = 0; i < resp.responses.length; i++) {

							var respObj = resp.responses[i];

							var bidId  = respObj.bidId  || '',
								width  = respObj.width  || 1,
								height = respObj.height || 1,
								price  = respObj.cpm    || 0,
								adcode = respObj.ad     || '',
								ttl    = (respObj.ttl   || 120) * 1000;

							// Set Size
	                        var size = '1x1';
	                        if( requestData['data'][bidId]['sizes'].indexOf(width + 'x' + height) !== -1 ) {
	                            size = width + 'x' + height;
	                        }

	                       	if(size == '1x1') {
	                       		size = requestData['sizes'][bidId].pop() || size;
	                       	}

	                       	var ad_code_prepend = '';
	                       	if(properOps.dfp_per_slot == 1 && properPage.isolated == 0) {
	                       		ad_code_prepend = "<script>try { var slot_div = window.top.document.getElementById(\"{PROPER_SLOT_DIV_ID}-iframe\").contentWindow.document.getElementById(\"{PROPER_SLOT_DIV_ID}\"); var div = document.createElement('div'); div.setAttribute(\"id\", \""+requestData['data'][bidId]['adUnitCode']+"\"); slot_div.appendChild(div); } catch(e) { console.error(e); }<\/script>";
	                       	} else {
	                       		ad_code_prepend = "<script>try { var slot_div = window.top.document.getElementById(\"{PROPER_SLOT_DIV_ID}\"); var div = document.createElement('div'); div.setAttribute(\"id\", \""+requestData['data'][bidId]['adUnitCode']+"\"); slot_div.appendChild(div); } catch(e) { console.error(e); }<\/script>";
	                       	}

							adcode = ad_code_prepend + adcode;

							// New Ad object
                            var ad = new adObj({
                                'bidder'      : bidder,
                                'size'        : size,
                                'price'       : parseFloat(price),
                                'gross'       : parseFloat(price),
                                'adcode'      : adcode,
                                'tag_id'      : bidId,
                                'request_url' : ENDPOINT,
                                'response'    : respObj,
                                'response_ms' : bid_response_ms,
                                'received_ts' : bids_received_ts,
                                'ttl'         : ttl
                            });

                            bidData.logBidResponse(ad);
						}

			        } else {
			        	properLog.mylog("no teads bids returned");
					}

					//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

				} catch (e) {
					e.bidder = bidder;
					throw e;
				}

			},
			error: function(resp) {
				try {
					//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
				} catch (e) {
					e.bidder = bidder;
					throw e;
				}

			}
		});
    }

	function findGdprStatus(gdprApplies, gdprData, apiVersion) {
		var status = gdprStatus.GDPR_APPLIES_PUBLISHER
		if (gdprApplies) {
			if (isGlobalConsent(gdprData, apiVersion)) status = gdprStatus.GDPR_APPLIES_GLOBAL
		} else status = gdprStatus.GDPR_DOESNT_APPLY
		return status;
	}

	function isGlobalConsent(gdprData, apiVersion) {
		return gdprData && apiVersion === 1
			? (gdprData.hasGlobalScope || gdprData.hasGlobalConsent)
			: gdprData && apiVersion === 2
			? !gdprData.isServiceSpecific
			: false
	}


	consentManager.ready(function() {
		var params = '';
		if (gdprConsent) {
			var gdprIab = {
				status: findGdprStatus(gdprConsent.gdprApplies, gdprConsent.vendorData),
				consent: gdprConsent.consentString
			};
			params = '?gdprIab=' + encodeURIComponent(JSON.stringify(gdprIab))
		}

		userSyncs.add({
			type: 'iframe',
			url: USYNCURL + params,
            bidder: bidder
		});
	});

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    bidAdapters.triplelift = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000,
        "native_sizes": {
            'native_horizontal': '300x250',
            'native_vertical'  : '300x250'
        }
    };

    var bidder        = "triplelift";
    var ENDPOINT_URL  = "https://tlx.3lift.com/header/auction",
        SYNC_ENDPOINT = "https://eb2.3lift.com/sync?";

    var eIdAdapters = {
        "identityLink": {
            "adapter": userIdAdapters.identityLink,
            "valuePath": "idl_env",
            "rtiPartner": "idl"
        }
    };

    /**
     * Parse size and format to object
     * @param {string} size - size string: '728x90'
     * @return {Object}
     */
    function parseSize(size) {
        var s = size.split('x');
        return {
            'w': parseInt(s[0]),
            'h': parseInt(s[1])
        };
    }


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

        var requestData = {
            'imps': {},
            'tag_sizes': {},
            'request_cnt': 0
        };

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];

                    // groupId is optional
                    // tag_id: {placementId}-{groupId}
                    var ids = tag_id.split('-');
                    // Override native sizes
                    var sizeObj = parseSize(ProperMedia.utils.deepAccess(bidderInfo, 'native_sizes. ' + size) || size);

                    placementId = ids[0];

                    if(typeof requestData['imps'][tag_id] == 'undefined') {

                        var imp = {
                            'id': tag_id,
                            'tagid': placementId,
                            'floor': getBidderFloor(bidder, size)
                        };

                        if (bidderInfo.demand_type == 'display') {
                            imp['banner'] = {
                                'format': [sizeObj]
                            }
                        } else if (bidderInfo.demand_type == 'video') {
                            imp['video'] =  {
                                'mimes'   : ['video/mp4', "application/javascript"],
                                'w'       : sizeObj['w'],
                                'h'       : sizeObj['h'],
                                'context' : bidderInfo.video_type
                            }

                            if(bidderInfo.video_type == 'instream') {
                                imp['video']['placement'] = 1;
                            }
                        }

                        requestData['imps'][tag_id] = imp;
                        requestData['tag_sizes'][tag_id] = [];
                    }

                    var floor = getBidderFloor(bidder, size);
                    if(floor < requestData['imps'][tag_id]['floor']) {
                        requestData['imps'][tag_id]['floor'] = floor;
                    }

                    requestData['tag_sizes'][tag_id].push(size);
                    requestData['request_cnt']++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
        var request_cnt = requestData['request_cnt'];

        if(imps.length == 0) {
            return false;
        }

        var data = {
            'imp': imps
        };

        var eids = [];
        Object.keys(eIdAdapters).forEach(function(name) {
            var obj = eIdAdapters[name];
            addUserId(eids, ProperMedia.utils.deepAccess(obj.adapter, 'idObj.' + obj.valuePath), obj.adapter.source, obj.rtiPartner);    
        });

        if (eids.length > 0) {
            ProperMedia.utils.deepSetValue(data, 'user.ext.eids', eids);
        }

        //build url
        var request_url = ENDPOINT_URL;

        request_url += "?lib=prebid";
        request_url += "&v=" + properOps.prebid_version;
        request_url += "&referrer=" + encodeURIComponent(properPage.bidder_page_url);
        request_url += "&tmax=1200";

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            if (typeof gdprConsent.gdprApplies !== 'undefined') {
                request_url += '&gdpr=' + !!gdprConsent.gdprApplies;
            }
            if (typeof gdprConsent.consentString !== 'undefined') {
                request_url += '&cmp_cs=' + gdprConsent.consentString;
            }
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            request_url += '&us_privacy=' + uspConsent.usPrivacy;
        }

        // Supply chain object isset
        if(properOps.schain) {
            data.ext = { 
                'schain': properOps.schain
            }
        }

        //logging
        properLog.mylog(request_url, bidder);

        // log requests
        bidData.incrementRequestsSent(request_cnt);

    	var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        //send request
        $.ajax({
    		url: request_url,
            requestType: "cors",
            method: "POST",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(data),
    		success: function(resp) {

                try {
        			//logging
        			properLog.mylog(resp,bidder);

                    var responseObj = ProperMedia.utils.safeJsonParse(resp) || {};

    				var bids_received_ts = ProperMedia.utils.getTimestampMs();
    				var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    if(responseObj && responseObj.bids && responseObj.bids.length > 0) {

                        for (var i = 0; i < responseObj.bids.length; i++) {

                            var bid = responseObj.bids[i];

            				var imp_id = bid.imp_id || 0,
                                cpm    = bid.cpm    || 0,
            				    adcode = bid.ad     ||'',
                                width  = bid.width  || 1,
                                height = bid.height || 1,
                                iurl   = bid.iurl   ||'';

                            // Set Size
                            var size = '1x1';
                            if( requestData['tag_sizes'][imp_id].indexOf(width + 'x' + height) !== -1 ) {
                                size = width + 'x' + height;
                            }

                            if(size == '1x1') {
                                size = requestData['tag_sizes'][imp_id].pop() || size;
                            }

                            if(adcode && cpm > 0) {

                                var price = parseFloat(cpm);

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : size,
                                    'price'       : price,
                                    'gross'       : price,
                                    'tag_id'      : imp_id,
                                    'request_url' : ENDPOINT_URL,
                                    'response'    : bid,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                if (bidderInfo.demand_type == 'video') {

                                    ad.type       = 'video';
                                    ad.vast_tag   = adcode;
                                    ad.vast_type  = 'tag';
                                    ad.vpaid      = false;
                                    ad.video_type = bidderInfo.video_type;

                                } else {
                                    ad.adcode = adcode;
                                }

                                bidData.logBidResponse(ad);
                            }
                        }
                    }

        			//log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }

    		},
    		error: function(resp) {
                try {
                    bidData.incrementBidResponseCount(request_cnt);
                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
    		}
        });
    }

    function addUserId(eids, id, source, rtiPartner) {
        if (id) {
            eids.push({
                "source": source,
                "uids": [{
                    "id": id,
                    "ext": { 
                        "rtiPartner": rtiPartner 
                    }
                }]
            });
        }
        return eids;
    }

    consentManager.ready(function() {
        var endpoint = SYNC_ENDPOINT;
        var params = [];

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            if (gdprConsent.gdprApplies) {
                params.push('gdpr=' + encodeURIComponent(gdprConsent.gdprApplies));
            }
            if (gdprConsent.consentString) {
                params.push('cmp_cs=' + encodeURIComponent(gdprConsent.consentString));
            }
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            params.push('us_privacy=' + encodeURIComponent(uspConsent.usPrivacy));
        }

        userSyncs.add({
            type: 'iframe',
            url: (endpoint + params.join('&')),
            bidder: bidder
        });
    });

    function removeCreative(slot) {
        try {
            if(properOps.dfp_per_slot == 1) {
                // Get Elements on page from query selector
                var elements = window.top.document.querySelectorAll('#' + slot.div_id + ' .tlod');
                if(elements && elements.length > 0) {
                    for (var i = 0; i < elements.length; i++) {
                        var element = elements[i];
                        element.parentNode.removeChild(element);
                    }
                }
            }
        } catch(e) {
            console.error(e);
        }
    }

    return {
        send: send,
        bidderInfo: bidderInfo,
        formatRequest: formatRequest,
        removeCreative: removeCreative
    };
})();

    bidAdapters.thirtythreeacross = (function() {
	var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'slot',
        "default_bid_ttl": 60000
	};

    var bidder         = 'thirtythreeacross', 
        ENDPOINT_URL   = 'https://ssc.33across.com/api/v1/hb'
        SYNC_ENDPOINT  = 'https://de.tynt.com/deb/v2?m=xch&rt=html'
        NON_MEASURABLE = 'nm';


    var special_sizes = {
        'sticky_horizontal': '1x1'
    }


    /**
     * Parse size and format to object
     * @param {string} size - size string: '728x90'
     * @return {Object}
     */
    function parseSize(size) {
        // Check for special sticky size
        size = special_sizes[size] || size;

        var s = size.split('x');
        return {
            'w': parseInt(s[0]),
            'h': parseInt(s[1]),
            'ext': {
                'ttx': {
                    'bidfloors': [ getBidderFloor(bidder, size) ]
                }
            }
        };
    }


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

        var requestData = {};

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var tag_id = data[size][i];

                    if(typeof requestData[tag_id] == 'undefined') {
                        requestData[tag_id] = {};

                        if (bidderInfo.demand_type == 'display') {
                            requestData[tag_id]['banner'] = {
                                'format': [],
                            }
                            requestData[tag_id]['product'] = 'siab';

                        } else if (bidderInfo.demand_type == 'video') {
                            var s = size.split('x');
                            requestData[tag_id]['video'] = {
                                'skip'            : 1,
                                'skipafter'       : 5,
                                'linearity'       : (bidderInfo.video_type == 'outstream') ? 2 : 1,
                                'placement'       : 1,
                                'startdelay'      : 0,
                                'minduration'     : 15,
                                'maxduration'     : 30,
                                'playback_methods': [2, 3, 6],
                                'api'             : [1, 2],
                                'mimes'           : ['video/mp4', "application/javascript"],
                                'protocols'       : [2, 3, 5, 6],
                                'w'               : parseInt(s[0]) || 0,
                                'h'               : parseInt(s[1]) || 0,
                                'ext': {
                                    'ttx': {
                                        'bidfloors': [ getBidderFloor(bidder, size) ]
                                    }
                                }
                            };

                            requestData[tag_id]['product'] = bidderInfo.video_type;
                            if(bidderInfo.video_type == 'outstream') {
                                requestData[tag_id]['placement'] = 2;
                            }
                        }
                    }

                    if (bidderInfo.demand_type == 'display') {
                        requestData[tag_id]['banner']['format'].push(parseSize(size));

                        if(size == 'sticky_horizontal') {
                            requestData[tag_id]['product'] = 'inview';
                            requestData[tag_id]['special_size'] = size;
                        }
                    }
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        
        // request count
        Object.keys(requestData).forEach(function(tag_id) {
            send_slot(requestData[tag_id], tag_id);
        });

        /**
         * Send slot level bid requests
         */
        function send_slot(request_data, tag_id) { 

            var request_cnt = (bidderInfo.demand_type == 'display') ? request_data['banner']['format'].length : 1;
            
            // Product detection
            var product = request_data['product'];

            // Calculate the Viewability
            // var viewability = ProperMedia.utils.isIFrame() ? NON_MEASURABLE : ViewabilityTracker.calculateViewablePercentage(slot);
            var viewability = (product == 'inview') ? 100 : NON_MEASURABLE;

            var request = {
                'id': ProperMedia.utils.generateUUID(),
                'site': {
                    'id': tag_id 
                },
                'imp': [],
                'ext': {
                    'ttx': {
                        'caller': [
                            {
                                'name': 'proper.io',
                                'version': '1.0'
                            }
                        ]
                    }
                }
            };

            if(bidderInfo.demand_type == 'display') {
                request.imp.push({
                    'banner': request_data.banner
                });
            } else if(bidderInfo.demand_type == 'video') {
                request.imp.push({
                    'video': request_data.video
                });
            }

            if(request.imp[0]) {
                request.imp[0].ext = {
                    'ttx': {
                        'prod': product, // Product Type. 
                        'viewability': {
                            'amount': isNaN(viewability) ? viewability : Math.round(viewability)
                        }
                    }
                };
            }

            // Supply chain object isset
            if(properOps.schain) {
                request.source = {
                    'ext': {
                        'schain': properOps.schain
                    }
                };
            }

            if (gdprConsent.cmpPresent) {

                request.regs = {
                    'ext': {
                        'gdpr': (gdprConsent.gdprApplies === true) ? 1 : 0
                    }
                };
                
                if (gdprConsent.consentString) {
                    // GDPR Stuff
                    request.user = {
                        'ext': {
                            'consent': gdprConsent.consentString
                        }
                    };
                }
            }    

            // USP Consent
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                ProperMedia.utils.deepSetValue(request, 'regs.ext.us_privacy', uspConsent.usPrivacy);
            }    

            if(properOps.testing_mode.ids == true) {
                request.test = 1;
            }

            // Log the bid request.
            properLog.mylog(ENDPOINT_URL, bidder);

            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();

            // Check if request should be sent through edge bidder
            var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        	//send request
        	$.ajax({
                method: "POST",
        		url: ENDPOINT_URL,
        		requestType: "cors",
                bidder: bidder,
                edge: edge,
                data: JSON.stringify(request),
        		success: function(resp) {
                    try {
            			//logging
            			properLog.mylog(resp, bidder);

                        var resp = ProperMedia.utils.safeJsonParse(resp);

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        if(resp && resp.seatbid && resp.seatbid.length > 0) {

                            Object.keys(resp.seatbid).forEach(function(y) {

                                var bids = resp.seatbid[y].bid;

                                Object.keys(bids).forEach(function(x) {

                                    var bid = bids[x];

                                    var requestId  = resp.bidid || '',
                                        price      = bid.price  || 0.00,
                                        width      = bid.w      || 1,
                                        height     = bid.h      || 1,
                                        creativeId = bid.crid   || '',
                                        currency   = resp.cur   || 'USD',
                                        adcode     = bid.adm    || '',
                                        ttl        = bid.ttl    || bidderInfo.default_bid_ttl,
                                        size       = width + 'x' + height;

                                    if(product == 'inview' && size == '1x1') {
                                        size = request_data['special_size'] || size;
                                    }

                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'size'        : size,
                                        'price'       : parseFloat(price),
                                        'gross'       : parseFloat(price),
                                        'tag_id'      : request_data['tag_id'],
                                        'request_url' : ENDPOINT_URL,
                                        'response'    : bid,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts,
                                        'ttl'         : ttl
                                    });

                                    if (bidderInfo.demand_type == 'video') {

                                        var vast_tag  = adcode,
                                            attr      = bid.attr     || [],
                                            api       = bid.api      || 0,
                                            protocol  = bid.protocol || 6;

                                        var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                            vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                        ad.type       = 'video';
                                        ad.vast_tag   = vast_tag;
                                        ad.vast_type  = vast_type;
                                        ad.vpaid      = vpaid;
                                        ad.video_type = bidderInfo.video_type;

                                    } else {
                                        ad.adcode = adcode;
                                    }

                                    bidData.logBidResponse(ad);
                                });
        					});
                        }
                        
            			//log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);

                        // Sync User
                        addUserSyncs(request, resp);
                            
                    } catch (e) {
                        e.bidder = bidder;
                        throw e;
                    }
        		},
        		error: function(resp) {
                    try {
            			//log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    } catch (e) {
                        e.bidder = bidder;
                        throw e;
                    }

        		}
        	});
        }
    }


    function addUserSyncs(req, resp) {

        var sync = [
            {
                type: 'iframe',
                url: SYNC_ENDPOINT + '&id=' + req.site.id + '&gdpr_consent=' + encodeURIComponent(gdprConsent.consentString) + '&us_privacy=' + encodeURIComponent(uspConsent.usPrivacy),
                bidder: bidder
            }
        ];

        if (typeof gdprApplies === 'boolean') {
            sync[0].url += '&gdpr=' + Number(gdprConsent.gdprApplies);
        }

        userSyncs.add(sync);
    }

    return {
		formatRequest: formatRequest,
		send: send,
		bidderInfo: bidderInfo
	};
})();

    /**
 * Undertone
 *
 * @see https://github.com/prebid/Prebid.js/blob/master/modules/undertoneBidAdapter.js
 * @see https://github.com/prebid/Prebid.js/blob/master/modules/undertoneBidAdapter.md
 * @see http://prebid.org/dev-docs/bidders/undertone.html
 */
bidAdapters.undertone = (function() {
    var bidderInfo = {
        rev_share      : 1,
        bid_grouping   : 'page',
        demand_type    : 'display',
        default_bid_ttl: 360000,
        native_sizes: {
            desktop: {
                'sticky_horizontal': [[1,1]],
                'native_horizontal': [[1,2]]
            },
            mobile: {
                'sticky_horizontal': [[1,1], [320, 50]],
                'native_horizontal': [[1,2]]
            }
        }
    };

    var bidder          = 'undertone',
        ENDPOINT_URL    = 'https://hb.undertone.com/hb',
        FRAME_USER_SYNC = 'https://cdn.undertone.com/js/usersync.html',
        publisher_id    = 0;

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data
     */
    function formatRequest(data, bidderInfo) {

    	var requestData = {
			'imps': {},
            'tag_sizes': {},
			'request_cnt': 0
        };

        var device = properDevice.isMobile() ? 'mobile' : 'desktop';

        Object.keys(data).forEach(function(size) {
            for (var i = 0; i < data[size].length; i++) {
                
                var placementId = data[size][i];
                if(typeof requestData['imps'][placementId] == 'undefined') {
                    var bidRequestId = ProperMedia.utils.generateUUID()
                    var bid = {
                        'bidRequestId': bidRequestId,
                        'hbadaptor'   : 'prebid',
                        'url'         : properPage.bidder_page_url,
                        'domain'      : properPage.domain,
                        'placementId' : typeof placementId !== 'undefined' ? placementId.toString() : null,
                        'publisherId' : parseInt(publisher_id),
                        'sizes'       : ProperMedia.utils.deepAccess(bidderInfo, 'native_sizes.' + device + '.' + size) || [ size.split('x').map(function(s){ return parseInt(s); }) ],
                        'params': {
                            'placementId': placementId.toString(), // string // unique per placement
                            'publisherId': parseInt(publisher_id) // number
                        }
                    };

                    if (bidderInfo.demand_type == 'video') {
                        bid.video = {
                            "streamType": bidderInfo.video_type,
                            "playbackmethod": [ 2 ],
                            'maxDuration': 30,
                            'skippable': true
                        };
                        bid.mediaType = 'video';
                    }

                    if(bid.sizes.length > 0) {
                        requestData['request_cnt']++;
                        requestData['imps'][placementId] = bid;
                        if(ProperMedia.utils.deepAccess(bidderInfo, 'native_sizes.' + device + '.' + size)) {
                            requestData['tag_sizes'][bidRequestId] = size;
                        }
                    }
                }
            }
        });

        return requestData;
    }

    /**
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        publisher_id = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        if(!publisher_id) {
            properLog.mylog('Error: Undertone Site ID is Required.');
            return false;
        }

        var url = ENDPOINT_URL+"?pid="+publisher_id+"&domain="+properPage.domain;
        var requestData = formatRequest(bidData.requests, bidderInfo);
        var imps        = ProperMedia.utils.objectValues(requestData['imps']) || [];
        var request_cnt = requestData['request_cnt'];

        if(request_cnt == 0) {
            return false;
        }

        var vw = Math.max(document.documentElement.clientWidth , window.innerWidth  || 0);
        var vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

        var payload = {
            'x-ut-hb-params': imps,
            'commons': {
                'adapterVersion': properOps.prebid_version,
                'uids': userIds.getEidsArray() || [],
                'pageSize': vw == 0 || vh == 0 ? null : [vw, vh]
            }
        };

        // GDPR Consent
        var gdprParams = getGdprQueryParams(gdprConsent.cmpPresent);
        if (gdprParams) {
            url += "&"+gdprParams;
        }

        // CCPA
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            url += "&ccpa="+uspConsent.usPrivacy;
        }

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        // Check if request should be sent through edge bidder
        var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

        // send request
        $.ajax({
            url: url,
            method: "POST",
            requestType: "cors",
            bidder: bidder,
            edge: edge,
            data: JSON.stringify(payload),
            success: function(resp) {
                try {
                    //logging
                    properLog.mylog(resp, bidder);

                    var resp = ProperMedia.utils.safeJsonParse(resp);

                    var bids_received_ts = ProperMedia.utils.getTimestampMs();
                    var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    if(resp && Array.isArray(resp) && resp.length > 0) {
                        resp.forEach(function(bidRes) {
                            if (bidRes.ad && bidRes.cpm > 0) {
                                // Set Size
                                var size = '1x1';
                                if(ProperMedia.utils.deepAccess(requestData, 'tag_sizes.' + bidRes.bidRequestId)) {
                                    size = ProperMedia.utils.deepAccess(requestData, 'tag_sizes.' + bidRes.bidRequestId);
                                } else if(bidRes.width && bidRes.height) {
                                    size = bidRes.width + 'x' + bidRes.height;
                                }

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'size'        : size,
                                    'price'       : parseFloat(bidRes.cpm),
                                    'gross'       : parseFloat(bidRes.cpm),
                                    'tag_id'      : bidRes.bidRequestId,
                                    'ttl'         : (bidRes.ttl * 1000) || bidderInfo.default_bid_ttl,
                                    'request_url' : url,
                                    'response'    : bidRes,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts
                                });

                                if (bidderInfo.demand_type == 'video') {
                                    ad.type       = 'video';
                                    ad.vast_tag   = bidRes.ad;
                                    ad.vast_type  = 'tag';
                                    ad.vpaid      = false;
                                    ad.video_type = bidderInfo.video_type;
                                } else {
                                    ad.adcode = bidRes.ad;
                                }

                                bidData.logBidResponse(ad);
                            }
                        });
                    }

          			// Log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            },
            error: function(resp) {
                try {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                } catch (e) {
                    e.bidder = bidder;
                    throw e;
                }
            }
        });
    }

    // Params for GDPR
    function getGdprQueryParams(cmpPresent)
    {
        if (!cmpPresent) {
            return null;
        }

        var gdpr    = gdprConsent.gdprApplies ? '1' : '0';
        var gdprstr = gdprConsent.consentString ? gdprConsent.consentString : '';
        return "gdpr="+gdpr+"&gdprstr="+gdprstr;
    }

    // Sync User
    consentManager.ready(function() {
        var iframePrivacyParams = '';

        // GDPR
        var gdprParams = getGdprQueryParams(gdprConsent.cmpPresent);
        if (gdprParams) {
            iframePrivacyParams += "?"+gdprParams;
        }

        // CCPA
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            iframePrivacyParams += (iframePrivacyParams.length > 0 ? '&' : '?') + "ccpa="+uspConsent.usPrivacy;
        }

        userSyncs.add({
            type: 'iframe',
            url: FRAME_USER_SYNC + iframePrivacyParams,
            bidder: bidder
        });
    });

    return {
        formatRequest: formatRequest,
        send: send,
        bidderInfo: bidderInfo
    };
}());

    /**
 * Vidazoo
 *
 * The Vidazoo adapter only responds to 300x250 size requests.
 *
 * @see https://github.com/prebid/Prebid.js/blob/master/modules/vidazooBidAdapter.js
 * @see https://github.com/prebid/Prebid.js/blob/master/modules/vidazooBidAdapter.md
 * @see https://github.com/prebid/prebid.github.io/blob/master/dev-docs/bidders/vidazoo.md
 * @see https://vidazoo.gitbook.io/milkshake/milkshake-widget-integration/prebid-integration
 * @see http://prebid.org/dev-docs/bidders/vidazoo.html
 */
bidAdapters.vidazoo = (function() {
    var bidderInfo = {
        rev_share      : 1,
        bid_grouping   : 'slot',
        default_bid_ttl: 300000
    };

    var bidder          = 'vidazoo',
        size            = '300x250',
        sizes           = ['300x250'],
        VERSION         = '1.0.0',
        ENDPOINT_URL    = 'https://prebidnp.cootlogix.com/prebid/multi/';
        ENDPOINT_TEST   = 'https://demoad.cootlogix.com/prebid/multi/';
    
    var pId = '59ac17c192832d0011283fe3';

    var SUPPORTED_ID_SYSTEMS = {
        'britepoolid': 1,
        'criteoId': 1,
        'digitrustid': 1,
        'id5id': 1,
        'idl_env': 1,
        'lipb': 1,
        'netId': 1,
        'parrableId': 1,
        'pubcid': 1,
        'tdid': 1,
    };

    /**
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        var widgetId = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;
        if(!widgetId) {
            properLog.mylog('Error: Vidazoo Site ID (Widget ID) is Required.');
            return false;
        }
        
        var requestData = bidData.requests;
        
        Object.keys(requestData).forEach(function(dataSize) {
            for (var i = 0; i < requestData[dataSize].length; i++) {
                send_slot(dataSize, requestData[dataSize][i]);
            }
        });

        /**
         * Send slot level bid requests
         */
        function send_slot(dataSize, cId) {

            var request_cnt = 1;

            // only one size allowed
            if (dataSize !== size || !cId) {
                return false;
            }

            var hashUrl = hashCode(properPage.bidder_page_url);
            var dealId = getNextDealId(hashUrl);

            var payload = {
                "url": encodeURIComponent(properPage.url),
                "cb": Date.now(),
                "bidFloor": getBidderFloor(bidder, size),
                "bidId": ProperMedia.utils.generateUUID(),
                "publisherId": pId,
                "sizes": sizes,
                "dealId": dealId,
                "bidderVersion": VERSION,
                "prebidVersion": properOps.prebid_version,
                "res": screen.width + 'x' + screen.height
            };

            appendUserIdsToRequestPayload(payload);

            // GDPR Consent
            if (gdprConsent.cmpPresent) {
                if (typeof gdprConsent.gdprApplies === 'boolean') {
                    payload.gdpr = gdprConsent.gdprApplies ? 1 : 0;
                }
                payload.gdprConsent = gdprConsent.consentString;
            }

            // USP Consent
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                payload.usPrivacy = uspConsent.usPrivacy;
            }

            var url = ENDPOINT_URL + cId;
            if(properOps.testing_mode.ids == true) {
                cId = '5e7b4eac063c510017ca44ef';
                url = ENDPOINT_TEST + cId;
            }

            //logging
            properLog.mylog(url, bidder);

            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();

            // Check if request should be sent through edge bidder
            var edge = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.edge') || false;

            // send request
            $.ajax({
                url: url,
                method: "POST",
                requestType: "cors",
                bidder: bidder,
                edge: edge,
                data: JSON.stringify(payload),
                success: function(resp) {
                    try {
                        //logging
                        properLog.mylog(resp, bidder);

                        var resp = ProperMedia.utils.safeJsonParse(resp);

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        if(resp.results && Array.isArray(resp.results) && resp.results.length > 0) {
                            resp.results.forEach(function(bidRes) {
                                if(bidRes['ad'] && bidRes['price']) {
                                    
                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'size'        : size,
                                        'price'       : parseFloat(bidRes['price']),
                                        'gross'       : parseFloat(bidRes['price']),
                                        'adcode'      : bidRes['ad'],
                                        'tag_id'      : cId,
                                        'ttl'         : (bidRes['exp'] || bidderInfo.default_bid_ttl) * 1000,
                                        'request_url' : url,
                                        'response'    : bidRes,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts
                                    });

                                    bidData.logBidResponse(ad);
                                }
                            });

                            addUserSyncs(resp);
                        }

                        // Log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    } catch (e) {
                        e.bidder = bidder;
                        throw e;
                    }
                },
                error: function(resp) {
                    try {
                        //log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    } catch (e) {
                        e.bidder = bidder;
                        throw e;
                    }
                }
            });
        }
    }

    function hashCode(s, prefix) {
        prefix = prefix || '_';
        var l = s.length,
            h = 0,
            i = 0;

        if (l > 0) {
            while (i < l) {
                h = (h << 5) - h + s.charCodeAt(i++) | 0; 
            }
        }
        return prefix + h;
    }

    function getNextDealId(key) {
        try {
            var currentValue = Number(getStorageItem(key) || 0);
            var nextValue = currentValue + 1;
            setStorageItem(key, nextValue);
            return nextValue;
        } catch (e) {
            return 0;
        }
    }

    function getStorage() {
        return window['sessionStorage'];
    }

    function getStorageItem(key) {
        try {
            return getStorage().getItem(key);
        } catch (e) {
            return null;
        }
    }

    function setStorageItem(key, value) {
        try {
            getStorage().setItem(key, String(value));
        } catch (e) { }
    }

    function appendUserIdsToRequestPayload(payloadRef) {
        var user_ids = userIds.getUIdsObj();
        var key;
        Object.keys(user_ids).forEach(function(idSystemProviderName) {
            if (SUPPORTED_ID_SYSTEMS[idSystemProviderName]) {
                var userId = user_ids[idSystemProviderName]; 
                key = 'uid.' + idSystemProviderName;

                switch (idSystemProviderName) {
                    case 'digitrustid':
                        payloadRef[key] = ProperMedia.utils.deepAccess(userId, 'data.id');
                        break;
                    case 'lipb':
                        payloadRef[key] = userId.lipbid;
                        break;
                    case 'parrableId':
                        payloadRef[key] = userId.eid;
                        break;
                    case 'id5id':
                        payloadRef[key] = userId.uid;
                        break;
                    default:
                        payloadRef[key] = userId;
                }
            }
        });
    }

    function addUserSyncs(serverResponse) {
        try {
            userSyncs.add({
                type: 'iframe',
                url: 'https://static.cootlogix.com/basev/sync/user_sync.html',
                bidder: bidder
            });
        } catch (e) {
            e.bidder = bidder;
            throw e;
        }
    }

    return {
        send: send,
        bidderInfo: bidderInfo
    };
}());

    // S2S bidders
    // Adapter for interacting with S2S as a client
bidAdapters.s2s = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'display',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 120000
    };

    // our CloudFlare End Point for S2S (aka. the S2S server)
    var ENDPOINT_URL = properOps.eb_endpoint; 

    /**
     * Returns the BidRequest object formatted according to OpenRTB specifications
     * This is a template which will be filled in the S2S server
     */
    function getOpenRTBBidRequest() {
        var openRTBObj = {
            id: null,  // ( * will be populated in the S2S server * )
            at: 1,     // auction type (1 = first price; 2 = second price)
            tmax: 550, // bid timeout in milliseconds
            site: { // details about publisher's website
                id: '',                     // exchange-specific site ID
                //name: '',                 // site name
                page: properPage.bidder_page_url, // URL of the page where the impression will be shown
                ref: properPage.referrer,         // Referrer URL
                domain: properPage.domain,        // Site's domain
                publisher: {                // Details about the publisher
                    id: properOps.site_name,       // exchange-specific publisher ID
                    name: properPage.domain,       // publisher name
                    domain: properPage.domain      // publisher's domain
                }
            },
            device: { // details about user's device
                connectiontype: getConnectionType(),       // Newtork connection type
                ua: navigator.userAgent,                   // Browser user agent string
                ip: null,                                  // IPv4 IP Address ( * will be populated in the S2S server * )
                //ipv6: null,                              // IPv6 IP Address ( * will be populated in the S2S server * )
                dnt: ProperMedia.utils.getDNT() ? 1 : 0,   // "Do Not Track" flag set in the header ( 0 = unrestricted tracking ; 1 = limited per commercial guidelines )
                js: 1,                                     // Support for JavaScript ( 0 = no ; 1 = yes )
                geo: null,                                 // Details about device's current location ( * will be populated in the S2S server * )
                os: window.device.os_group,                // Devide OS
                h: properPage.height,                      // Physical height of the screen in pixels
                w: properPage.width,                       // Physical width of the screen in pixels
                language: navigator.language.split('-')[0] // Browser language
            },
            user: { // details about user
                // id: null,                // Exchange-specific ID for the user. At least one of id or buyeruid is recommended.

                //TODO: get from cookie in the S2S server <<---------------------------------
                // < --- this.data.cookies.get(this.bidder)
                buyeruid: null,             // Buyer-specific ID for the user as mapped by the exchange for the buyer.
                geo: null                   // Details about device's current location ( * will be populated in the S2S server * )
            },
            source: { // details about inventory source and which entity makes the final decision
                pchain: 0 // Payment ID chain string
            },
            regs: { // details about industry, legal or governmental regulations in force for this request
                ext: {}
            },
            ext: {}, // exchange specifix extensions to OpenRTB
            test: properOps.testing_mode.ids == true ? 1 : 0, // test mode (0 = live ; 1 = test)
            imp: [] // impressions offered ( * will be populated in the S2S server * )
        };

        // User Ids
        var eids = userIds.getEidsArray();
        if (eids && eids.length) {
            ProperMedia.utils.deepSetValue(openRTBObj, 'user.eids', eids);
        }

        // Supply chain object
        if(properOps.schain) {
            openRTBObj.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                ProperMedia.utils.deepSetValue(openRTBObj, 'regs.ext.gdpr', Number(gdprConsent.gdprApplies));
            }
            ProperMedia.utils.deepSetValue(openRTBObj, 'user.ext.consent', gdprConsent.consentString);
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            ProperMedia.utils.deepSetValue(openRTBObj, 'regs.ext.us_privacy', uspConsent.usPrivacy);
        }

        return openRTBObj;
    }

    /**
     * Returns one of the following:
     *  0 - Unknown
     *  1 - Ethernet
     *  2 - WIFI
     *  3 - Cellular Network – Unknown Generation
     *  4 - Cellular Network – 2G
     *  5 - Cellular Network – 3G
     *  6 - Cellular Network – 4G
     * 
     * @see https://developer.mozilla.org/en-US/docs/Web/API/Network_Information_API
     */
    function getConnectionType() {
        //TODO:
        return 0;
    }

    /**
     * Send request to s2s end point
     */
    function send(bidData) {
        if (!bidData || !bidData.requests) {
            return false;
        }

        var device = properDevice.isMobile() ? 'mobile' : 'desktop';
        var floors = properOps.floors[device] || {};

        // bidder data to be sent to S2S server
        var postData = {
            'openRTBBidRequest': getOpenRTBBidRequest(),
            'bidder_ids': bidData.requests,
            'is_secure' : properPage.use_ssl ? 1 : 0,
            'floors'    : floors,
            'cookies'   : {}
        };

        // Set bidder cookie values
        Object.keys(postData.bidder_ids).forEach(function(bidder) {
            bidder = bidder.replace('_s2s', '');
            if(cookieMatching.supported_bidders[bidder]) {
                var cookie = ProperMedia.utils.getCookieValue(bidder + '_cookie');
                if(cookie) {
                    postData.cookies[bidder] = cookie;
                }
            }
        })

        var request_url = ENDPOINT_URL + "?proper_uid=" + cookieMatching.proper_tracker_cookie.proper_uid;

        // add debug flag
        if(properOps.testing_mode.ids == true) {
            request_url += '&d=1';
        }

        //logging
        properLog.mylog(request_url,'s2s');

        // counts all requests for all bidders
        var request_cnt = 0;
        Object.keys(bidData.requests).forEach(function(bidder) {
            if(bidData.requests[bidder] && bidData.requests[bidder].tag_ids) {
                request_cnt += bidData.requests[bidder].tag_ids.length;
            }
        });

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        //send request
        $.ajax({
            url: request_url,
			method: "POST",
            requestType: 'cors',
            data: JSON.stringify(postData),
            success: function(resp) {

                try {
                    var resp = ProperMedia.utils.safeJsonParse(resp);

                    //logging
                    properLog.mylog(resp,'s2s');

                    var bids_received_ts = ProperMedia.utils.getTimestampMs();
                    var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                    if(resp && resp.bids) {

                        var device = properDevice.isMobile() ? 'mobile' : 'desktop';

                        // loop through bids
                        for (var key = 0; key < resp.bids.length; key++) {

                            var ad        = resp.bids[key],
                                adcode    = ad.adcode || '',
                                vast_tag  = ad.vast_tag || '',
                                vast_type = ad.vast_type || '',
                                vpaid     = ad.vpaid || false,
                                bidder    = ad.bidder + '_s2s',
                                type      = ad.media_type,
                                price     = ad.price || 0,
                                impid     = ad.impid || '',
                                burl      = ad.burl  || '',
                                nurl      = ad.nurl  || '',
                                w         = parseInt((ad.w || 0)),
                                h         = parseInt((ad.h || 0));

                            var bidderInfo = ProperMedia.utils.deepAccess(properOps, 'bidder_info.' + bidder) || bidderInfo;

                            //pixel
                            if(nurl) {
                                adcode += "<img src=\"" + ad.nurl + "\" width=1 height=1>";
                            }

                            //parse ImpID
                            var slot = impid.split("@"); // Example: "classiccars_sticky_1@1x1" or "classiccars_sticky_1@1x1-123"
                            var size = (w && h) ? (w + 'x' + h) : slot[1].replace(/\-\d+$/, '');
                            
                            // Check for native size overwrite
                            size = ProperMedia.utils.deepAccess(bidderInfo, 'native_sizes.' + device + '.' + size) || size;

                            // New Ad object
                            var ad = new adObj({
                                'bidder'      : bidder,
                                'type'        : type,
                                'size'        : size,
                                'burl'        : burl,
                                'nurl'        : nurl,
                                'price'       : parseFloat(price * bidderInfo.rev_share),
                                'gross'       : parseFloat(price),
                                'tag_id'      : impid,
                                'request_url' : ENDPOINT_URL,
                                'response'    : ad,
                                'response_ms' : bid_response_ms,
                                'received_ts' : bids_received_ts,
                                'ttl'         : bidderInfo.default_bid_ttl || 120000
                            });

                            if (type == 'video') {
                                ad.vast_tag   = vast_tag;
                                ad.vast_type  = vast_type;
                                ad.vpaid      = vpaid;
                                ad.video_type = bidderInfo.video_type;
                            } else {
                                ad.adcode = adcode;
                            }

                            //log bid
                            bidData.logBidResponse(ad);
                        }

                        //log request as received regardless
                        bidData.incrementBidResponseCount('s2s',request_cnt);
                    }

                    // Update the uesr cookie sync
                    if(resp && resp.cookies) {
                        Object.keys(resp.cookies).map(function(bidder) {
                            if(resp.cookies[bidder]) {
                                cookieMatching.updateBidderCookieData(bidder, resp.cookies[bidder]);
                            }
                        });
                    }

                } catch (e) {
                    e.bidder = 's2s';
                    throw e;
                }
            },
            error: function(resp) {
                try {
                    bidData.incrementBidResponseCount('s2s',request_cnt);
                } catch (e) {
                    e.bidder = 's2s';
                    throw e;
                }
            }
        });
    }

    function removeCreative(slot) {
        if(slot.displayed_ad.bidder == 'gumgum_s2s') {
            removeGumGumCreative();
        }
    }

    function removeGumGumCreative() {
        try {
            // Get Elements on page from query selector
            var element = window.top.document.getElementById('GG_PXS');
            if(element) {
                var gumgum_top_elem = element.parentNode;
                if(gumgum_top_elem) {
                    gumgum_top_elem.parentNode.removeChild(gumgum_top_elem);
                }
            }
        } catch(e) {
            console.error(e);
        }
    }

    function onBidWon(bid) {
        if(bid.burl) {
            // send request
            $.ajax({
                url: bid.burl,
                method: "GET",
                withCredentials: true
            });
        }
        return true;
    }

    return {
        send: send,
        onBidWon: onBidWon,
        bidderInfo: bidderInfo,
        removeCreative: removeCreative
    };
})();


    // VIDEO BIDDERS
    bidAdapters.aol_instream = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'video',
        "video_type"     : 'instream',
        "bid_grouping"   : 'slot',
        "default_bid_ttl": 3600000
    };

    //vars
    var bidder       = "aol_instream",
        ENDPOINT_URL = "https://ads.adaptv.advertising.com/rtb/openrtb",
        SYNC_URLS    = [
            'https://cm.g.doubleclick.net/pixel?google_nid=adaptv_dbm&google_cm&google_sc',
            'https://pr-bh.ybp.yahoo.com/sync/adaptv_ortb/{combo_uid}',
            'https://sync-tm.everesttech.net/upi/pid/m7y5t93k?redir=https%3A%2F%2Fsync.adap.tv%2Fsync%3Ftype%3Dgif%26key%3Dtubemogul%26uid%3D%24%7BUSER_ID%7D',
            'https://match.adsrvr.org/track/cmf/generic?ttd_pid=adaptv&ttd_tpi=1'
        ];

    var SUPPORTED_USER_ID_SOURCES = [
        'adserver.org',
        'criteo.com',
        'id5-sync.com',
        'intentiq.com',
        'liveintent.com',
        'quantcast.com',
        'verizonmedia.com',
        'liveramp.com'
    ];

    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        // Site IDs: {Desktop}-{Mobile}
        var siteIds = (ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || '').toString().split('-') || ['',''];
        var pubId   = (properDevice.isMobile() && siteIds.length == 2) ? siteIds[1] : siteIds[0];

        //testing mode
        if(properOps.testing_mode.ids == true) {
            pubId = "HBExchange";
        }

        if(!pubId) {
            properLog.mylog('Error: AOL Video Site ID is Required.');
            return false;
        }

        var requestData = bidData.requests;
        var request_url = ENDPOINT_URL + '?ext_id=' + pubId;

        Object.keys(requestData).forEach(function(size) {
            for (var i = 0; i < requestData[size].length; i++) {
                send_slot(size, requestData[size][i], i);
            }
        });

        function send_slot(size, tag_id, imp_id) {

            var ad_size = size.split('x');
            var request_cnt = 1;

            var post_data =  {
                'id': ProperMedia.utils.generateUUID(),
                'at': 2,
                'cur': 'USD',
                'imp': [{
                    'id': parseInt(imp_id + 1).toString(),
                    'secure': (properPage.use_ssl ? 1 : 0),
                    'bidfloor': getBidderFloor(bidder, size),
                    'video': {
                        'mimes': ['video/mp4', 'application/javascript'],
                        'w': parseInt(ad_size[0]),
                        'h': parseInt(ad_size[1]),
                        'linearity': (bidderInfo.video_type == 'outstream') ? 2 : 1,
                        'protocols': [ 2, 5 ],
                        "api": [ 2 ],
                        "delivery": [ 2 ],
                        "playbackmethod": [ 2 ],
                        "minduration": 1,
                        "maxduration": 15
                    },
                    'ext': {
                        'hb': 1,
                    }
                }],
                'site': {
                    'page': properPage.url,
                    'ref': properPage.referrer
                },
                'device': {
                    'ua': navigator.userAgent,
                    "js": 1
                },
                'tmax': 550
            };

            // User Ids
            var eids = getSupportedEids();
            if (eids && eids.length) {
                ProperMedia.utils.deepSetValue(post_data, 'user.ext.eids', eids);
            }

            // Supply chain object isset
            if(properOps.schain) {
                ProperMedia.utils.deepSetValue(post_data, 'source.ext.schain', properOps.schain);
            }

            // GDPR Consent
            if (gdprConsent.cmpPresent) {
                if (typeof gdprConsent.gdprApplies === 'boolean') {
                    ProperMedia.utils.deepSetValue(post_data, 'regs.ext.gdpr', gdprConsent.gdprApplies);
                }
                ProperMedia.utils.deepSetValue(post_data, 'user.ext.consent', gdprConsent.consentString);
            }

            // USP Consent
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                ProperMedia.utils.deepSetValue(post_data, 'regs.ext.us_privacy', uspConsent.usPrivacy);
            }

            //logging
            properLog.mylog(request_url, bidder);
            properLog.mylog(bidder+": sending bid request");
            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();

            $.ajax({
                method: "POST",
                requestType: "cors",
                data: JSON.stringify(post_data),
                url: request_url, 
                success: function(data) {

                    properLog.mylog("AOL Video: parsing response");
                    try {
                        
                        data = ProperMedia.utils.safeJsonParse(data);

                        if (data && data.seatbid) {

                            var bids_received_ts = ProperMedia.utils.getTimestampMs();
                            var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                            //logging
                            properLog.mylog(data, bidder);

                            data.seatbid.forEach(function(seatbid) {
                                (seatbid.bid || []).forEach(function(bid) {
                                    
                                    var width     = bid['w']        || ad_size[0],
                                        height    = bid['h']        || ad_size[1],
                                        price     = bid['price']    || 0,
                                        vast_tag  = bid['adm']      || '',
                                        attr      = bid['attr']     || [],
                                        api       = bid['api']      || 0,
                                        protocol  = bid['protocol'] || 5;
                                        
                                    var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                        vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                    //log bid response
                                    if(vast_tag && price > 0) {
                                        // New Ad object
                                        var ad = new adObj({
                                            'bidder'      : bidder,
                                            'type'        : 'video',
                                            'size'        : width + 'x' + height,
                                            'price'       : parseFloat(price),
                                            'gross'       : parseFloat(price),
                                            'vast_tag'    : vast_tag,
                                            'vast_type'   : vast_type,
                                            'vpaid'       : vpaid,
                                            'video_type'  : bidderInfo.video_type,
                                            'tag_id'      : tag_id,
                                            'request_url' : request_url,
                                            'response'    : bid,
                                            'response_ms' : bid_response_ms,
                                            'received_ts' : bids_received_ts,
                                            'ttl'         : bidderInfo.default_bid_ttl
                                        });

                                        bidData.logBidResponse(ad);

                                    } else {
                                       properLog.mylog(bidder + ": can't parse bid response");
                                    }

                                });
                            });
                        } else {
                            properLog.mylog(bidder+": no bid returned");
                        }
                        //log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    }
                    catch(e) {
                        properLog.mylog(bidder + ": unknown error with parsing response - " + e);
                        e.bidder = bidder;
                        throw e;
                    }

                },
                error: function(resp) {
                    properLog.mylog(bidder + ": unknown error - "+resp);
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                }

            }); 
            
            // User syncs
            addUserSyncs();
        }

        function getSupportedEids() {
            userIdAsEids = userIds.getEidsArray();
            return userIdAsEids.filter(function(eid) {
                return SUPPORTED_USER_ID_SOURCES.indexOf(eid.source) !== -1
            });
        }

        function addUserSyncs() {
            var syncs = SYNC_URLS.map(function(url) {
                return {
                    "type": 'image',
                    "url": url,
                    "demand_type": 'video',
                    'bidder': bidder
                };
            });
            userSyncs.add(syncs);
        }

    }

    return {
        send: send,
        bidderInfo: bidderInfo
    };
})();


    bidAdapters.beachfront_instream = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'video',
        "video_type"     : 'instream',
        "bid_grouping"   : 'slot',
        "default_bid_ttl": 300000
    };

    //variables
    var bidder        = "beachfront_instream",
        ENDPOINT_URL  = "https://reachms.bfmio.com/bid.json",
        SYNC_ENDPOINT = "https://sync.bfmio.com/sync_iframe",
        pubId         = "",
        adpos         = 1;


    var eIdAdapters = {
        "identityLink": {
            "adapter": userIdAdapters.identityLink,
            "valuePath": "idl_env",
            "rtiPartner": 'idl'
        }
    };

    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {  

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;
        
        pubId = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || 0;

        //testing mode
        if(properOps.testing_mode.ids == true) {
            pubId = "11bc5dd5-7421-4dd8-c926-40fa653bec76";
        }

        if(!pubId) {
            properLog.mylog('Error: Beachfront Video Site ID is Required.');
            return false;
        }

        var requestData = bidData.requests;
        var request_url = ENDPOINT_URL + '?exchange_id=' + pubId;

        Object.keys(requestData).forEach(function(size) {
            for (var i = 0; i < requestData[size].length; i++) {
                send_slot(size, requestData[size][i]);
            }
        });

        function send_slot(size, tag_id) {

            var ad_size = size.split('x');
            var request_cnt = 1;

            //format request
            var post_data = {
                "isPrebid": true,
                "appId": pubId,
                "domain": properPage.domain,
                "id": ProperMedia.utils.generateUUID(),
                "imp": [{
                    "video": {
                        "w": parseInt(ad_size[0]),
                        "h": parseInt(ad_size[1]),
                        "mimes": [
                            "video/mp4",
                            "application/javascript"
                        ]
                    },
                    "bidfloor": getBidderFloor(bidder, size),
                    "secure": (properPage.use_ssl ? 1 : 0)
                }],
                "site": {
                    "page": properPage.url,
                    "domain": properPage.domain
                },
                "device": {
                    "ua": navigator.userAgent,
                    "language": navigator.language,
                    "devicetype": properDevice.isMobile() ? 1 : isConnectedTV() ? 3 : 2,
                    "dnt": (ProperMedia.utils.getDNT()) ? 1 : 0,
                    "js": 1,
                    "geo": { }
                },
                "regs": {
                    "ext": { }
                },
                "user": {
                    "ext": { }
                },
                "cur": ["USD"]
            };

            var eids = getEids();
            if(eids) {
                ProperMedia.utils.deepSetValue(post_data, 'user.ext.eids', eids);
            }

            // GDPR Consent
            if (gdprConsent.cmpPresent) {
                if (typeof gdprConsent.gdprApplies === 'boolean') {
                    ProperMedia.utils.deepSetValue(post_data, 'regs.ext.gdpr', gdprConsent.gdprApplies);
                }
                ProperMedia.utils.deepSetValue(post_data, 'user.ext.consent', gdprConsent.consentString);
            }

            // USP Consent
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                ProperMedia.utils.deepSetValue(post_data, 'regs.ext.us_privacy', uspConsent.usPrivacy);
            }

            // logging
            properLog.mylog(request_url, bidder);
            properLog.mylog(bidder+": sending bid request");
            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();

            //test post data (has proven to return an ad)
            //post_data = '{"isPrebid":true,"appId":"11bc5dd5-7421-4dd8-c926-40fa653bec76","domain":"salon.com","id":"3b4d7eaa499aae","imp":[{"video":{"w":640,"h":480,"mimes":["video/mp4","application/javascript"]},"bidfloor":floor,"secure":0}],"site":{"page":"https://salon.com/propervideo/prebid_test.htm","domain":"salon.com"},"device":{"ua":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36","language":"en-US","devicetype":2,"dnt":0,"js":1,"geo":{}},"regs":{"ext":{}},"user":{"ext":{}},"cur":["USD"]}';
            //post_data = JSON.parse(post_data);
            
            //send bid request
            $.ajax({
                method: "POST",
                requestType: "cors",
                data: JSON.stringify(post_data),
                url: request_url, 
                success: function(data){

                    properLog.mylog(bidder + ": parsing response");

                    try {

                        data = ProperMedia.utils.safeJsonParse(data);

                        if (data && data.url && data.url != "") {

                            var bids_received_ts = ProperMedia.utils.getTimestampMs();
                            var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                            var price    = data.bidPrice || 0,
                                vast_tag = data.url      || '',
                                attr     = data.attr     || [],
                                api      = data.api      || 0,
                                protocol = data.protocol || 2;
                                
                            var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                            //log bid response
                            if(vast_tag && price > 0) {

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'type'        : 'video',
                                    'size'        : size,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'vast_tag'    : vast_tag,
                                    'vast_type'   : vast_type,
                                    'vpaid'       : vpaid,
                                    'video_type'  : bidderInfo.video_type,
                                    'tag_id'      : tag_id,
                                    'request_url' : request_url,
                                    'response'    : data,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);
                            }
                            else {

                                properLog.mylog(bidder+": can't parse bid response");
                            }
                        } else {
                            properLog.mylog(bidder+": no bid returned");
                        }
                        //log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);

                    } catch(e) {
                        properLog.mylog(bidder + ": unknown error with parsing response - " + e);
                        e.bidder = bidder;
                        throw e;
                    }

                },
                error: function(resp) {
                    properLog.mylog(bidder + ": unknown error - "+resp);
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                }

            });        
        }
    }


    function getEids() {
        var eids = [];
        Object.keys(eIdAdapters).forEach(function(name) {
            var obj = eIdAdapters[name];
            var eid = formatEid(ProperMedia.utils.deepAccess(obj.adapter, 'idObj.' + obj.valuePath), obj.adapter.source, obj.rtiPartner);
            eids.push(eid);
        });
        return eids;
    }

    function formatEid(id, source, rtiPartner) {
        return {
            "source": source,
            "uids": [{
                "id": id,
                "ext": { 
                    "rtiPartner": rtiPartner 
                }
            }]
        };
    }


    /**
     * User syncs
     */
    consentManager.ready(function() {
        var gdpr = 0,
            gc   = '',
            gce  = 1,
            uspc = '1---';

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            gdpr = (gdprConsent.gdprApplies ? 1 : 0);
            gc   = encodeURIComponent(gdprConsent.consentString || '');
        }

        // CCPA
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            uspc = encodeURIComponent(uspConsent.usPrivacy);
        }

        var syncurl = SYNC_ENDPOINT + '?ifg=1&id=' + pubId + '&gdpr=' + gdpr + '&gc=' + gc + '&gce=' + gce + '&us_privacy=' + uspc;
        userSyncs.add({ 
            type: 'iframe', 
            url: syncurl,
            demand_type: 'video',
            bidder: bidder
        });
    });
    

    function isConnectedTV(){
        return (/(smart[-]?tv|hbbtv|appletv|googletv|hdmi|netcast\.tv|viera|nettv|roku|\bdtv\b|sonydtv|inettvbrowser|\btv\b)/i).test(navigator.userAgent);
    }
    
    return {        
        send: send,
        bidderInfo: bidderInfo
    };

})();


    bidAdapters.openx_instream = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'video',
        "video_type"     : 'instream',
        "bid_grouping"   : 'slot',
        "default_bid_ttl": 300000
    };

    // vars
    var bidder         = "openx_instream",
        BIDDER_VERSION = '3.0.3',
        ENDPOINT_URL   = 'https://propermedia-d.openx.net/v/1.0/avjp',
        SYNC_URL       = 'https://u.openx.net/w/1.0/pd';

    var shouldSendBoPixel = true;
    
    var eIdAdapters = {
        "identityLink": {
            "adapter": userIdAdapters.identityLink,
            "valuePath": "idl_env"
        }, 
        "id5Id": {
            "adapter": userIdAdapters.id5Id,
            "valuePath": "id5id.uid"
        },
        "pubCommonId": {
            "adapter": userIdAdapters.pubCommonId,
            "valuePath": "pubcid"
        }
    };

    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = bidData.requests;

        Object.keys(requestData).forEach(function(size) {
            for (var i = 0; i < requestData[size].length; i++) {
                send_slot(size, requestData[size][i]);
            }
        });

        function send_slot(size, tagId) {    

            var request_cnt = 1,
                isInIframe  = false,
                ad_size     = size.split('x');
                tag_id      = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || tagId;

            var imp = [
                {
                    "video":{
                        "mimes":[
                            "video/mp4",
                            "application/javascript"
                        ],
                        "w":parseInt(ad_size[0]),
                        "h":parseInt(ad_size[1])
                    },
                    "w": parseInt(ad_size[0]),
                    "v": parseInt(ad_size[1])
                }
            ]

            var post_data = {
                'ju'         : properPage.bidder_page_url,
                'jr'         : properPage.referrer,
                'ch'         : document.charSet || document.characterSet,
                'res'        : screen.width+'x'+screen.height+'x'+screen.colorDepth,
                'ifr'        : isInIframe,
                'tz'         : new Date().getTimezoneOffset(),
                'tws'        : window.top.innerWidth + 'x' + window.top.innerHeight,
                'be'         : 1,
                'bc'         : 'hb_pb_'+BIDDER_VERSION,
                "dddid"      : ProperMedia.utils.generateUUID(),
                "pubcid"     : properUser.pubcid,
                "nocache"    : new Date().getTime(),
                "auid"       : tag_id,
                "vwd"        : parseInt(ad_size[0]),
                "vht"        : parseInt(ad_size[1]),
                "vmimes"     : [
                    "video/mp4",
                    "application/javascript"
                ],
                "openrtb": imp
            }

            if(bidderInfo.video_type == 'outstream') {
                post_data.vos = '101';
            }

            // Supply chain object
            if(properOps.schain) {
                post_data.schain = ProperMedia.utils.formatSupplyChainString(properOps.schain);
            }

            if (gdprConsent.cmpPresent) {

                post_data.gdpr_consent = (gdprConsent.consentString || '')

                if (typeof gdprConsent.gdprApplies === 'boolean') {
                    post_data.gdpr = gdprConsent.gdprApplies ? 1 : 0;
                }
                post_data.x_gdpr_f = 1;
            }

            // CCPA
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                post_data.us_privacy = uspConsent.usPrivacy;
            }

            post_data = appendUserIdsToQueryParams(post_data);

            //testing mode
            if(properOps.testing_mode.ids == true) {
                post_data['vtest'] = "1"; 
            }

            // Format Query string
            var qs = ProperMedia.utils.formatQueryString(post_data, true);

            // request url
            var request_url = ENDPOINT_URL + '?' + qs;

            // logging
            properLog.mylog(request_url, bidder);
            properLog.mylog(bidder+": sending bid request");
            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();
            var startTime = new Date();

            $.ajax({
                method: "GET",
                requestType: "cors",
                url: request_url, 
                success: function(data){

                    properLog.mylog(bidder + ": parsing response");

                    try {

                        data = ProperMedia.utils.safeJsonParse(data);

                        //parse response
                        if (data && data.vastUrl && data.pub_rev) {

                            var bids_received_ts = ProperMedia.utils.getTimestampMs();
                            var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                            var price    = Number(data.pub_rev) / 1000 || 0,
                                vast_tag = data.vastUrl  || '',
                                width    = ad_size[0]    || data.width,
                                height   = ad_size[1]    || data.height,
                                attr     = data.attr     || [],
                                api      = data.api      || 0,
                                protocol = data.protocol || 2;
                                
                            var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;
                            
                            //log bid response
                            if(vast_tag && price > 0) {

                                registerBeacon(data, startTime);

                                // New Ad object
                                var ad = new adObj({
                                    'bidder'      : bidder,
                                    'type'        : 'video',
                                    'size'        : width + 'x' + height,
                                    'price'       : parseFloat(price),
                                    'gross'       : parseFloat(price),
                                    'vast_tag'    : vast_tag,
                                    'vast_type'   : vast_type,
                                    'vpaid'       : vpaid,
                                    'video_type'  : bidderInfo.video_type,
                                    'tag_id'      : tagId,
                                    'request_url' : request_url,
                                    'response'    : data,
                                    'response_ms' : bid_response_ms,
                                    'received_ts' : bids_received_ts,
                                    'ttl'         : (data.ttl * 1000) || bidderInfo.default_bid_ttl
                                });

                                bidData.logBidResponse(ad);

                            } else {
                               properLog.mylog(bidder + ": can't parse bid response");
                            }
                            addUserSyncs(data);
                        } else{
                            properLog.mylog(bidder + ": no bid returned");
                        }
                        //log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    } catch(e) {
                        properLog.mylog(bidder + ": unknown error with parsing response - " + e);
                    }
                    
                },
                error: function(resp) {
                    properLog.mylog(bidder + ": unknown error - "+resp);
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                }
            });
        }
    }


    function registerBeacon(adUnit, startTime) {
        // only register beacon once
        if (!shouldSendBoPixel) {
            return;
        }
        shouldSendBoPixel = false;

        var bt = 3000;
        var beaconUrl;

        var beaconParams = {
            bd: +(new Date()) - startTime,
            bp: adUnit.pub_rev,
            br: '0', // may be 0, t, or p
            bs: ProperMedia.utils.getPageDomain(),
            bt: bt,
            ts: adUnit.ts
        };

        beaconParams.br = beaconParams.bt < beaconParams.bd ? 't' : 'p';

        var recordPixel = (adUnit && adUnit.creative && adUnit.creative[0] && adUnit.creative[0].tracking && adUnit.creative[0].tracking.impression) || '';
        var boBase = recordPixel.match(/([^?]+\/)ri\?/);

        if (boBase && boBase.length > 1) {
            beaconUrl = boBase[1] + 'bo?' + ProperMedia.utils.formatQueryString(beaconParams, true);
        }

        if (beaconUrl) {
            userSyncs.add({
                type: 'image',
                url: beaconUrl,
                bidder: bidder
            });
        }
    }

    function appendUserIdsToQueryParams(post_data) {
        Object.keys(eIdAdapters).forEach(function(name) {
            var obj = eIdAdapters[name];
            if(ProperMedia.utils.deepAccess(obj.adapter, 'storage.name')) {
                post_data[obj.adapter.storage.name] = ProperMedia.utils.deepAccess(obj.adapter, 'idObj.' + obj.valuePath);
            }
        });
        return post_data;
    }

    function addUserSyncs(resp) {
        var url = '//u.openx.net/w/1.0/pd';
        if (resp) {
            if (resp.ads && resp.ads.pixels) {
                url = resp.ads.pixels;
            } else if (resp.pixels) {
                url = resp.pixels;
            }
        }

        var queryString = '';

        // Check GDPR
        if (gdprConsent.cmpPresent) {
            queryString += '?gdpr=' + (gdprConsent.gdprApplies ? 1 : 0);
            queryString += '&gdpr_consent=' + encodeURIComponent(gdprConsent.consentString || '');
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            queryString += (queryString.length > 0 ? '&' : '?') + 'us_privacy=' + encodeURIComponent(uspConsent.usPrivacy);
        }

        userSyncs.add({ 
            type: 'iframe', 
            url: url + queryString,
            demand_type: 'video',
            bidder: bidder
        });
    }
    
    return {
        send: send,
        bidderInfo: bidderInfo
    };
})();


    bidAdapters.pubmatic_instream = (function() {
    var bidderInfo = {
        "rev_share"      : 0.81,
        "demand_type"    : 'video',
        "video_type"     : 'instream',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000
    };


    // vars
    var bidder = "pubmatic_instream";

    //url endpoint
    var ENDPOINT_URL = 'https://hbopenbid.pubmatic.com/translator?source=prebid-client';
    var SYNC_URL     = 'https://ads.pubmatic.com/AdServer/js/showad.js#PIX&kdntuid=1&p=';

    // Publisher ID
    var pubId  = "109126";
    

    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

        var requestData = {
            'imps': []
        };

        var impid = 1;

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    var tag_id = data[size][i];
                    
                    //testing mode
                    if(properOps.testing_mode.ids == true) {
                        tag_id = properDevice.isMobile() ? "2124083" : "2124082"; // desktop / mobile ID
                    }

                    var ad_size = size.split('x');

                    requestData['imps'].push({
                        "id": impid.toString(),
                        "tagid": tag_id,
                        "secure": (properPage.use_ssl ? 1 : 0),
                        "ext": { },
                        "bidfloor": getBidderFloor(bidder, size),
                        "bidfloorcur": "USD",
                        "video": {
                            "mimes": [
                                "video/mp4",
                                "application/javascript"
                            ],
                            "minduration": 1,
                            "maxduration": 15,
                            "startdelay": 0,
                            "playbackmethod": [2],
                            "api": [2],
                            "protocols": [2, 3, 5, 6],
                            "w": parseInt(ad_size[0]),
                            "h": parseInt(ad_size[1]),
                            "linearity": 1,
                            "placement": (bidderInfo.video_type == 'outstream') ? 3 : 1,
                            "ext": {
                                "video_skippable": 1
                            }
                        }
                    });

                    impid++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        var imps        = requestData['imps'] || [];
        var request_cnt = requestData['imps'].length;
        
        //testing mode
        if(properOps.testing_mode.ids == 1) {
            pubId = "157593";
        }

        if(request_cnt == 0) {
            return false;
        }

        //setup post data
        var payload = {
            "id": '' + new Date().getTime(),
            "at": 1,
            "cur": ["USD"],
            "imp": imps,
            "site": {
                "page": properPage.url,
                "ref": document.referrer,
                "publisher": {
                    "id": pubId
                },
                "domain": properPage.domain
            },
            "device": {
                "ua": navigator.userAgent,
                "js": 1,
                "dnt": (ProperMedia.utils.getDNT()) ? 1 : 0,
                "h": screen.height,
                "w": screen.width,
                "language": navigator.language,
                "geo": {}
            },
            "user": {
                "geo": { }
            },
            "ext": {
                "wrapper": {
                    "wv": "prebid_prebid_" + properOps.prebid_version,
                    "transactionId": ProperMedia.utils.generateUUID(),
                    "wp": "pbjs"
                }
            }
        };

        if(properOps.testing_mode.enabled) {
            payload.test = 1;
        }

        // User Ids
        var eids = userIds.getEidsArray();
        if (eids && eids.length) {
            ProperMedia.utils.deepSetValue(payload, 'user.eids', eids);
        }

        // Supply chain object
        if(properOps.schain) {
            payload.source = {
                ext: {
                    schain: properOps.schain
                }
            };
        }

        if (gdprConsent.cmpPresent) {
            payload.user.ext = {
                consent: (gdprConsent.consentString || '')
            }

            payload.regs = {
                ext: {
                    gdpr: (gdprConsent.gdprApplies ? 1 : 0)
                }
            }
        }

        // CCPA
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            payload.regs = payload.regs || {};
            payload.regs.ext = payload.regs.ext || {};
            payload.regs.ext.us_privacy = uspConsent.usPrivacy;
        }

        //logging
        properLog.mylog(ENDPOINT_URL, bidder);
        properLog.mylog(bidder+": sending bid request");
        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        //test post data (has proven to return an ad)
        //payload = '{"id":"1559153925413","at":1,"cur":["USD"],"imp":[{"id":"2d17700fddbf35","tagid":"2124082","secure":1,"ext":{},"bidfloorcur":"USD","video":{"mimes":["video/mp4","video/webm","application/javascript"," video/ogg"],"minduration":1,"maxduration":30,"startdelay":0,"playbackmethod":[2],"api":[2],"protocols":[2,3,5,6],"w":640,"h":480,"linearity":1,"placement":1,"ext":{"video_skippable":1}}}],"site":{"page":"https://www.salon.com/propervideo/prebid_test.htm?pbjs_debug=true","ref":"https://www.salon.com/propervideo/prebid_test.htm?pbjs_debug=true","publisher":{"id":"157593"},"domain":"www.salon.com"},"device":{"ua":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36","js":1,"dnt":0,"h":1440,"w":3440,"language":"en-US","geo":{}},"user":{"geo":{}},"ext":{"wrapper":{"wv":"prebid_prebid_2.16.0","transactionId":"18eff903-48e9-447f-bf5b-058f0fb8bd63","wp":"pbjs"}}}';
        //payload = JSON.parse(payload);

        $.ajax({
            method: "POST",
            requestType: "cors",
            data: JSON.stringify(payload),
            url: ENDPOINT_URL, 
            success: function(data){

                properLog.mylog(bidder + ": parsing response");

                try {

                    data = ProperMedia.utils.safeJsonParse(data);

                    if (data && data.seatbid) {

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        data.seatbid.forEach(function(seatbid) {
                            (seatbid.bid || []).forEach(function(bid) {

                                var requestId  = bid.impid,
                                    vast_tag   = bid.adm,
                                    price      = (parseFloat(bid.price) || 0).toFixed(2),
                                    width      = bid.w        || (properDevice.isMobile() ? 400 : 640),
                                    height     = bid.h        || (properDevice.isMobile() ? 300 : 480),
                                    creativeId = bid.crid     || bid.id,
                                    attr       = bid.attr     || [],
                                    api        = bid.api      || 0,
                                    protocol   = bid.protocol || 5;
                                    
                                var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                    vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                //log bid response
                                if(vast_tag && price > 0) {
                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'type'        : 'video',
                                        'size'        : width + 'x' + height,
                                        'price'       : parseFloat(price * bidderInfo.rev_share),
                                        'gross'       : parseFloat(price),
                                        'vast_tag'    : vast_tag,
                                        'vast_type'   : vast_type,
                                        'vpaid'       : vpaid,
                                        'video_type'  : bidderInfo.video_type,
                                        'tag_id'      : requestId,
                                        'request_url' : ENDPOINT_URL,
                                        'response'    : bid,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts,
                                        'ttl'         : bidderInfo.default_bid_ttl
                                    });

                                    bidData.logBidResponse(ad);
                                } else {
                                   properLog.mylog(bidder + ": can't parse bid response");
                                }
                            });
                        });
                    } else {
                        properLog.mylog(bidder + ": no bid returned");
                    }
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                } catch(e) {
                    properLog.mylog(bidder + ": unknown error with parsing response - "+e);
                }
            },
            error: function(resp) {
                properLog.mylog(bidder + ": unknown error - "+resp);
                //log request as received regardless
                bidData.incrementBidResponseCount(request_cnt);
            }              
        });        
    }

    consentManager.ready(function() {
        var syncurl = SYNC_URL + pubId;

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            syncurl += '&gdpr=' + (gdprConsent.gdprApplies ? 1 : 0);
            syncurl += '&gdpr_consent=' + encodeURIComponent(gdprConsent.consentString || '');
        }

        // CCPA
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            syncurl += '&us_privacy=' + encodeURIComponent(uspConsent.usPrivacy);
        }

        userSyncs.add({ 
            type: 'iframe', 
            url: syncurl,
            demand_type: 'video',
            bidder: bidder
        });
    });

    return {
        send: send,
        bidderInfo: bidderInfo,
        formatRequest: formatRequest
    };
})();


    bidAdapters.rubicon_instream = (function() {    
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'video',
        "video_type"     : 'instream',
        "bid_grouping"   : 'page',
        "default_bid_ttl": 300000
    };


    //variables
    var bidder = "rubicon_instream";
        accountId = 8777;
    
    var player_size = [640, 480];

    //build url
    var ENDPOINT_URL = 'https://prebid-server.rubiconproject.com/openrtb2/auction';
    var SYNC_URL     = 'https://eus.rubiconproject.com/usync.html';


    /**
     * Format request data
     * @param {Object} data - Bidder request data to be formatted
     * @return {Object} requestData - Formatted data 
     */
    function formatRequest(data, bidder, bidderInfo) {

        var requestData = {
            'imps': []
        };

        // Site IDs: {Desktop}-{Mobile} 
        var siteIds = (ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id') || '').toString().split('-') || ['',''];
        var siteId  = (properDevice.isMobile() && siteIds.length == 2) ? siteIds[1] : siteIds[0];

        if(!siteId) {
            properLog.mylog('Error: Rubicon Video Site ID is Required.');
            return requestData;
        }

        var impid = 1;

        if(Object.keys(data).length > 0) {
            Object.keys(data).forEach(function(size) {
                for (var i = 0; i < data[size].length; i++) {
                    
                    var zoneId  = data[size][i];
                    var ad_size = size.split('x');
                    var floor   = getBidderFloor(bidder, size);

                    requestData['imps'].push({
                        "id": impid.toString(),
                        "secure": properPage.use_ssl ? 1 : 0,
                        "bidfloor": floor,
                        "ext": {
                            "rubicon": {
                                "accountId": parseInt(accountId),
                                "siteId": parseInt(siteId),
                                "zoneId": parseInt(zoneId),
                                "position":"btf",
                                "floor": floor,
                                "video": {
                                    "language": 'en',
                                    "size_id" : (bidderInfo.video_type == 'outstream') ? 203 : 201,
                                    "playerWidth": parseInt(ad_size[0]),
                                    "playerHeight": parseInt(ad_size[1]),
                                },
                                "prebid":{
                                   "auctiontimestamp": new Date().getTime()
                                }
                            }
                        },
                        "video": {
                            "playerSize": [
                                parseInt(ad_size[0]), 
                                parseInt(ad_size[1])
                            ],
                            "context": bidderInfo.video_type,
                            "mimes": ['video/mp4', 'application/javascript'],
                            "protocols": [2,5],
                            "w": parseInt(ad_size[0]),
                            "h": parseInt(ad_size[1]),
                            "maxduration": 60,
                            "linearity": 1,
                            "api": [2],
                            "pos": 3
                        }
                    });

                    impid++;
                }
            });
        }
        return requestData;
    }


    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        var requestData = formatRequest(bidData.requests, bidder, bidderInfo);
        var imps        = requestData['imps'] || [];
        var request_cnt = requestData['imps'].length;

        if(request_cnt == 0) {
            return false;
        }

        //format request
        var post_data = {
            "id": ProperMedia.utils.generateUUID(),
            "test": (properOps.testing_mode.ids == true) ? 1 : 0,
            "cur": ['USD'],
            "source": {
                "tid": ProperMedia.utils.generateUUID()
            },
            "tmax": 550,
            "imp": imps,
            "ext":{
                "prebid":{  
                    "cache":{  
                        "vastxml":{  
                            "returnCreative": false
                        }
                    },
                    "targeting":{  
                        "includewinners": true,
                        "includebidderkeys": false,
                        "pricegranularity": {  
                            "ranges":[
                                {
                                    "max":20,
                                    "increment":0.01
                                }
                            ]
                        }
                    },
                    "bidders": {
                        "rubicon": {
                            "integration": "pbjs"
                        }
                    }
                }
            },
            "site":{  
                "page": properPage.url,
                "content": {  
                    "language":"en"
                }
            }
        };

        // User Ids
        var eids = userIds.getEidsArray();
        if (eids && eids.length) {
            ProperMedia.utils.deepSetValue(post_data, 'user.ext.eids', eids);
        }

        // Supply chain object isset
        if(properOps.schain) {
            ProperMedia.utils.deepSetValue(post_data, 'source.ext.schain', properOps.schain);
        }

        // GDPR Consent
        if (gdprConsent.cmpPresent) {
            ProperMedia.utils.deepSetValue(post_data, 'user.ext.consent', gdprConsent.consentString);
            if (typeof gdprConsent.gdprApplies === 'boolean') {
                ProperMedia.utils.deepSetValue(post_data, 'regs.ext.gdpr', Number(gdprConsent.gdprApplies));
            }
        }

        // USP Consent
        if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
            ProperMedia.utils.deepSetValue(post_data, 'regs.ext.us_privacy', uspConsent.usPrivacy);
        }

        //logging
        properLog.mylog(ENDPOINT_URL, bidder);
        properLog.mylog(bidder+": sending bid request");

        // log requests
        bidData.incrementRequestsSent(request_cnt);

        var bid_sent_ts = ProperMedia.utils.getTimestampMs();

        //test post data (has proven to return an ad)
        //post_data = '{"id":"93e17a00-a800-4c35-b50a-56beb2fe518a","test":1,"cur":["USD"],"source":{"tid":"93e17a00-a800-4c35-b50a-56beb2fe518a"},"tmax":1000,"imp":[{"exp":300,"id":"video1","secure":1,"ext":{"rubicon":{"accountId":8777,"siteId":125272,"zoneId":1301254,"video":{"language":"en","size_id":201}}},"video":{"playerSize":[[640,480]],"context":"instream","mimes":["video/mp4"],"protocols":[2,5],"maxduration":30,"linearity":1,"api":[2],"pos":0,"w":640,"h":480}}],"ext":{"prebid":{"cache":{"vastxml":{"returnCreative":false}},"targeting":{"includewinners":true,"includebidderkeys":false,"pricegranularity":{"ranges":[{"max":20,"increment":0.1}]}}}},"site":{"page":"https://salon.com/propervideo/prebid_test.htm","content":{"language":"en"}}}';
        //post_data = JSON.parse(post_data);

        $.ajax({
            method: "POST",
            requestType: "cors",
            data: JSON.stringify(post_data),
            url: ENDPOINT_URL, 
            success: function(data){

                properLog.mylog(bidder+": parsing response");

                try {

                    data = ProperMedia.utils.safeJsonParse(data);

                    if (data && data.seatbid && data.seatbid.length > 0) {

                        var bids_received_ts = ProperMedia.utils.getTimestampMs();
                        var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                        //logging
                        properLog.mylog(data, bidder);

                        data.seatbid.forEach(function(seatbid) {
                            (seatbid.bid || []).forEach(function(bid) {
                                //get bid
                                var price    = bid.price    || 0,
                                    width    = bid.w        || (properDevice.isMobile() ? 400 : 640),
                                    height   = bid.h        || (properDevice.isMobile() ? 300 : 480),
                                    attr     = bid.attr     || [],
                                    api      = bid.api      || 0,
                                    protocol = bid.protocol || 2;
                                    
                                var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                    vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                //get VAST url
                                var vast_xml = '',
                                    vast_tag = '',
                                    nurl     = '';

                                var extPrebidTargeting = ProperMedia.utils.deepAccess(bid, 'ext.prebid.targeting') || {};

                                if(ProperMedia.utils.deepAccess(bid, 'ext.prebid.cache.vastXml.url')) {
                                    vast_tag = ProperMedia.utils.deepAccess(bid, 'ext.prebid.cache.vastXml.url');
                                
                                // if we don't have the vast url try to get it other ways
                                } else if (extPrebidTargeting && extPrebidTargeting.hb_uuid && extPrebidTargeting.hb_cache_host && extPrebidTargeting.hb_cache_path) {
                                    // build url using key and cache host
                                    vast_tag = 'https://' + extPrebidTargeting.hb_cache_host + extPrebidTargeting.hb_cache_path + '?uuid=' + extPrebidTargeting.hb_uuid;
                                }

                                if (bid.adm) { 
                                    vast_type = 'tag';
                                    vast_tag  = bid.adm;
                                }
                                if (bid.nurl) { 
                                    nurl = bid.nurl; 
                                }
                                if (!vast_tag && bid.nurl) { 
                                    vast_tag = bid.nurl; 
                                }

                                //log bid response
                                if(vast_tag && price > 0) {

                                    // New Ad object
                                    var ad = new adObj({
                                        'bidder'      : bidder,
                                        'type'        : 'video',
                                        'size'        : width + 'x' + height,
                                        'price'       : parseFloat(price * bidderInfo.rev_share),
                                        'gross'       : parseFloat(price),
                                        'vast_tag'    : vast_tag,
                                        'vast_type'   : vast_type,
                                        'vpaid'       : vpaid,
                                        'video_type'  : bidderInfo.video_type,
                                        'nurl'        : nurl,
                                        'tag_id'      : width + 'x' + height,
                                        'request_url' : ENDPOINT_URL,
                                        'response'    : bid,
                                        'response_ms' : bid_response_ms,
                                        'received_ts' : bids_received_ts,
                                        'ttl'         : (bid.ttl * 1000) || bidderInfo.default_bid_ttl
                                    });

                                    bidData.logBidResponse(ad);

                                } else {
                                    properLog.mylog(bidder+": can't parse bid response");
                                }

                            });
                        });
                    } else {
                        properLog.mylog(bidder+": no bid returned");
                    }

                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);

                } catch(e) {
                    properLog.mylog(bidder+": can't parse bid response - "+e);
                }
            },
            error: function(resp) {
                properLog.mylog(bidder+": unknown error - "+resp);
                //log request as received regardless
                bidData.incrementBidResponseCount(request_cnt);
            }
        });

        // user cookie matching
        userSyncs.add({
            "type": 'iframe',
            "url": SYNC_URL,
            "demand_type": 'video',
            "bidder": bidder
        });
    }
    
    return {
        send: send,
        bidderInfo: bidderInfo,
        formatRequest: formatRequest
    };
})();


    bidAdapters.spotx_instream = (function() {
    var bidderInfo = {
        "rev_share"      : 1,
        "demand_type"    : 'video',
        "video_type"     : 'instream',
        "bid_grouping"   : 'slot',
        "default_bid_ttl": 360000
    };

    //vars
    var bidder = "spotx_instream";

    //build url
    var ENDPOINT_URL = "https://search.spotxchange.com/openrtb/2.3/dados/";

    /** 
     * Send Ad Request
     * @param {bidObject} bid - Bid object
     */
    function send(bidData) {

        //build tags
        var bidder = bidData.bidder;
        // Update Bidder Info
        var bidderInfo = properOps.bidder_info[bidder] || bidderInfo;

        // Site IDs: {Desktop}-{Mobile} 
        var siteIds = ProperMedia.utils.deepAccess(properOps, 'bidders.header.' + bidder + '.site_id').split('-') || ['',''];
        var pubId  = (properDevice.isMobile() && siteIds.length == 2) ? siteIds[1] : siteIds[0];

        //testing mode
        if(properOps.testing_mode.ids == true) {
            pubId = "79391";
        }

        if(!pubId) {
            properLog.mylog('Error: SpotX Site ID is Required.');
            return false;
        }

        var request_url = ENDPOINT_URL + pubId;

        var requestData = bidData.requests;

        Object.keys(requestData).forEach(function(size) {
            for (var i = 0; i < requestData[size].length; i++) {
                send_slot(size, requestData[size][i]);
            }
        });

        function send_slot(size, tagId) {

            var request_cnt = 1;
            var ad_size = size.split('x');

            var post_data = {
                "id": pubId,
                "imp": {
                    "id": ProperMedia.utils.generateUUID(), //will be returned in response to keep bids straight
                    "secure": (properPage.use_ssl ? true : false),
                    "bidfloor": getBidderFloor(bidder, size),
                    "video": {
                        "w": parseInt(ad_size[0]),
                        "h": parseInt(ad_size[1]),
                        "ext": {
                            "sdk_name": "Prebid 1+",
                            "versionOrtb": properOps.prebid_version,
                            "ad_unit": bidderInfo.video_type
                        },
                        "mimes": [
                            "video/mp4",
                            "application/javascript"
                        ]
                    }
                },
                "site": {
                    "id": "",
                    "page": properPage.url,
                    "content": "content"
                },
                "device": {
                    "h": parseInt(properPage.height),
                    "w": parseInt(properPage.width),
                    "dnt": (ProperMedia.utils.getDNT()) ? 1 : 0,
                    "language": 'en',
                    "make": navigator.vendor ? navigator.vendor : '',
                    "ua": navigator.userAgent
                },
                "ext": {
                    "wrap_response": 1
                },
                "user": {
                    "ext": {}
                }
            };

            // ID5 fied
            var eids = userIds.getEidsArray();
            if (ProperMedia.utils.deepAccess(eids, 'id5id.uid')) {
                var eidsArr = [];
                eidsArr.push(
                    {
                        "source": 'id5-sync.com',
                        "uids": [{
                            "id": eids.id5id.uid,
                            "ext": eids.id5id.ext || {}
                        }]
                    }
                );
                ProperMedia.utils.deepSetValue(post_data, 'user.ext.eids', eidsArr);
            }

            // Add common id if available
            if (properUser.pubcid) {
                ProperMedia.utils.deepSetValue(post_data, 'user.ext.fpc', properUser.pubcid);
            }

            // Supply chain object
            if(properOps.schain) {
                post_data.source = {
                    ext: {
                        schain: properOps.schain
                    }
                };
            }

            // GDPR Consent
            if (gdprConsent.cmpPresent) {
                if (typeof gdprConsent.gdprApplies === 'boolean') {
                    ProperMedia.utils.deepSetValue(post_data, 'regs.ext.gdpr', gdprConsent.gdprApplies);
                }
                ProperMedia.utils.deepSetValue(post_data, 'user.ext.consent', gdprConsent.consentString);
            }

            // USP Consent
            if (uspConsent.cmpPresent && uspConsent.usPrivacy) {
                ProperMedia.utils.deepSetValue(post_data, 'regs.ext.us_privacy', uspConsent.usPrivacy);
            }

            // logging
            properLog.mylog(request_url, bidder);
            properLog.mylog(bidder + ": sending bid request");
            // log requests
            bidData.incrementRequestsSent(request_cnt);

            var bid_sent_ts = ProperMedia.utils.getTimestampMs();
            var startTime = new Date();

            //test post data (has proven to return an ad)
            //post_data = '{"id":79391,"imp":{"id":"86fb8ea0c7c9b8","secure":true,"video":{"w":640,"h":480,"ext":{"sdk_name":"Prebid 1+","versionOrtb":"2.3","ad_unit":"instream"},"mimes":["application/javascript","video/mp4","video/webm"]}},"site":{"id":"","page":"https://salon.com/propervideo/prebid_test.htm","content":"content"},"device":{"h":1440,"w":3440,"dnt":0,"language":"en","make":"Google Inc.","ua":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"},"ext":{"wrap_response":1},"user":{"ext":{"fpc":"384a0c64-2d01-4fc2-a854-cbb558701f89"}}}';
            //post_data = JSON.parse(post_data);

            $.ajax({
                method: "POST",
                requestType: "cors",
                data: JSON.stringify(post_data),
                url: request_url, 
                success: function(data){

                    properLog.mylog(bidder + ": parsing response");

                    try {

                        data = ProperMedia.utils.safeJsonParse(data);

                        if (data && data.seatbid) {

                            var bids_received_ts = ProperMedia.utils.getTimestampMs();
                            var bid_response_ms  = ProperMedia.utils.calcResponseMs(bid_sent_ts, bids_received_ts);

                            data.seatbid.forEach(function(seatbid) {
                                (seatbid.bid || []).forEach(function(bid) {
                                    var price     = bid.price    || 0,
                                        width     = ad_size[0]   || (properDevice.isMobile() ? 400 : 640),
                                        height    = ad_size[1]   || (properDevice.isMobile() ? 300 : 480),
                                        attr      = bid.attr     || [],
                                        api       = bid.api      || 0,
                                        protocol  = bid.protocol || 2,
                                        cache_key = ProperMedia.utils.deepAccess(bid,'ext.cache_key');
                                        
                                    var vast_type = ([1,2,3,7].indexOf(protocol) !== -1) ? 'url' : 'tag',
                                        vpaid     = (attr.indexOf(16) !== -1 || [1,2].indexOf(api) !== -1) ? true : false;

                                    //log bid response
                                    if(cache_key) {
                                        var vast_tag = "https://search.spotxchange.com/ad/vast.html?key="+cache_key;

                                        // New Ad object
                                        var ad = new adObj({
                                            'bidder'      : bidder,
                                            'type'        : 'video',
                                            'size'        : width + 'x' + height,
                                            'price'       : parseFloat(price * bidderInfo.rev_share),
                                            'gross'       : parseFloat(price),
                                            'vast_tag'    : vast_tag,
                                            'vast_type'   : vast_type,
                                            'vpaid'       : vpaid,
                                            'video_type'  : bidderInfo.video_type,
                                            'tag_id'      : bid.impid,
                                            'request_url' : request_url,
                                            'response'    : bid,
                                            'response_ms' : bid_response_ms,
                                            'received_ts' : bids_received_ts,
                                            'ttl'         : bidderInfo.default_bid_ttl
                                        });

                                        bidData.logBidResponse(ad);

                                    } else {
                                        properLog.mylog(bidder + ": can't parse bid response");
                                    }
                                });
                            });
                        } else {
                            properLog.mylog(bidder+": no bid returned");
                        }
                        //log request as received regardless
                        bidData.incrementBidResponseCount(request_cnt);
                    } catch(e) {
                        properLog.mylog(bidder + ": unknown error with parsing response - " + e);
                    }
                },
                error: function(resp) {
                    //log request as received regardless
                    bidData.incrementBidResponseCount(request_cnt);
                    properLog.mylog(bidder + ": unknown error - " + resp);
                }
            });
        }
    }

    return {
        send: send,
        bidderInfo: bidderInfo
    };
})();




    // Add Event Listener for page unload
    window.addEventListener('unload', function() {
        // Log pending bids before unloading
        properLog.proper_tracker();
    });

    /**
     * Init script and run queued function calls
     */
    function init() {
        // GDPR has returned
        consentManager.ready(
            function() {
                // async support for catching up
                propertag.cmd.push = function (cmd) {
                    cmd.call();
                }
                // async support for catching up
                propertag.cmd.unshift = function (cmd) {
                    cmd.call();
                }
                while(propertag.cmd.length) {
                    propertag.cmd.shift().call();
                }
            }
        );
    }

    /**
     * Initialize script
     *
     * @param {Object} settings - Definition object for site config
     */
    function set_options(settings) {
        // Run extra js code
        if (settings.extra_js) {
            // remove strings '\r' and '\n' added by new dashboard
            Function('"use strict"; ' + settings.extra_js.replace(/\\n|\\r/g, " "))();
        }
        // Set bid adapter settings
        setbidAdapterSettings();
        // Sort ad slots by set priority
        settings = sortAdSlotsByNumber(settings);
        // 3rd Party Ad Manager Settings
        setThirdPartyAdManagerSettings(settings);
        // Set sites config settings
        setConfigSettings(settings);
        // Set Audience pixels
        audiencePixels.init(properOps.audience_pixels);
        // Add styles
        addStyleSheet();
        // Set page variables
        properPage.setPageVariables();
        // Init PubCommonId
        userIdAdapters.pubCommonId.init();
        // Init User Obj
        properUser.init();
        // Init S2S cookie matching
        cookieMatching.init();
        // Start s2s cookie matching
        cookieMatching.cookieMatch();
        // Start User Id matching
        userIds.init();
        // Init page object
        properPage.init();
        // Proper Code has loaded event
        var properLoadEvent = new Event('proper-has-been-loaded');
        window.dispatchEvent(properLoadEvent);
    }


    /**
     * Set bidAdapter settings
     */
    function setbidAdapterSettings() {
        if (typeof bidAdapters !== 'undefined') {
            for (var bidder in bidAdapters) {
                properOps.bidder_info[bidder] = bidAdapters[bidder].bidderInfo;
            }
        }
    }

    /**
     * Set config settings based on RTP definition file
     *
     * @param {Object} settings - Definition object for site config
     */
    function setConfigSettings(settings) {
        ProperMedia.utils.mergeObject(properOps, settings);
    }


    /**
     * Set bidAdapter settings
     */
    function setThirdPartyAdManagerSettings(settings) {
        // Set DFP ID
        if(properSpecialOps.dfp_id) {
            settings.dfp_id = properSpecialOps.dfp_id;
            settings.thirdPartyAdManager = true;
        }
        // Set Google Advertiser ID
        if(properSpecialOps.google_advertiser) { 
            settings.google_advertiser = properSpecialOps.google_advertiser;
            settings.thirdPartyAdManager = true;
        }
        // Set Proper Advertiser ID
        if(properSpecialOps.proper_advertiser) {
            settings.proper_advertiser = properSpecialOps.proper_advertiser;
            settings.thirdPartyAdManager = true;
        }
    }


    /**
     * Sort ad slots by set priority
     *
     * @param {Object} settings - Definition object for site config
     */
    function sortAdSlotsByNumber(settings) {
        Object.keys(settings.ad_slots).forEach(function(slot_type) {
            settings.ad_slots[slot_type] = ProperMedia.utils.sortProperties(settings.ad_slots[slot_type], 'number', true, false);
        });
        return settings;
    }


    /**
     * Add css for proper ad units
     */
    function addStyleSheet() {
        var style = document.createElement('style');
        style.type = 'text/css';

        var css = ".proper-ad-unit{margin:auto;position:relative;display:block;width:100%;min-width:100px;text-align:center;box-sizing:border-box !important}.proper-ad-unit *{box-sizing:border-box !important}.proper-ad-unit>div:first-of-type:not(.sticky-inner){position:relative;margin:auto}.proper-ad-unit>div.active-highlight:first-of-type:not(.sticky-inner):after{content:\'\';margin:auto;position:absolute;top:0;right:0;bottom:0;left:0;pointer-events:none;background:none;border:5px solid rgba(218,48,48,0.85)}.proper-ad-unit>div:first-of-type:not(.sticky-inner)>.noad{background-color:#c2c2c2}.proper-ad-unit .report-ad{position:relative !important;display:block !important;font-family:sans-serif;left:0;right:0;color:#999 !important;font-size:12px;line-height:23px;white-space:nowrap;text-decoration:none !important;-webkit-font-smoothing:antialiased}.proper-ad-unit .report-ad:hover{color:black;text-decoration:underline !important}.proper-ad-unit.ad-sticky{width:100%;text-align:center;z-index:10000000;pointer-events:none;position:fixed}.proper-ad-unit.ad-sticky.close{display:none !important}.proper-ad-unit.ad-sticky,.proper-ad-unit.ad-sticky .sticky-inner{pointer-events:none}.proper-ad-unit.ad-sticky .sticky-inner>*{pointer-events:all}.proper-ad-unit.ad-sticky .close{pointer-events:all;cursor:pointer}.proper-ad-unit.ad-sticky .close::after{content:\"\\00d7\";color:black;font-size:21px !important;font-family:\'Futura\', sans-serif !important;line-height:31px !important;border-radius:500px;display:block;width:32px;height:32px;margin:9px 0 0 9px;box-shadow:inset 0 0 0 2px #ccc}.proper-ad-unit.ad-sticky.close:not(.for-mobile):hover:after{box-shadow:inset 0 0 0 2px #333}.proper-ad-unit.ad-sticky iframe{background-color:white;pointer-events:all;vertical-align:bottom;position:relative;cursor:pointer;z-index:2}.proper-ad-unit.ad-sticky .brand{display:none;cursor:pointer;pointer-events:all;position:absolute;width:100%;height:100%;top:0;left:0}.proper-ad-unit.ad-sticky .brand:after{content:\'\';position:relative;width:100%;height:15px;display:block;background:no-repeat center;background-size:42px 15px;background-image:url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAAAgCAYAAADtwH1UAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3VpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDAyIDc5LjE2NDQ2MCwgMjAyMC8wNS8xMi0xNjowNDoxNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyNjViYzk1Ny05OWIxLTRiNGMtYmVhMy05ZmExOGNlZjJjMTAiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OTk0MzY2N0FCRjBFMTFFQUJBOTU5NzBBQTVBNDdDOEIiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OTk0MzY2NzlCRjBFMTFFQUJBOTU5NzBBQTVBNDdDOEIiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIxLjIgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo3YzBmYWQ1Ny1jNzQ3LTRjM2EtYTY4MC0zN2U1MWFhMzE1MDciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MjY1YmM5NTctOTliMS00YjRjLWJlYTMtOWZhMThjZWYyYzEwIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+rPgLLAAAAsFJREFUeNrsWjFLHEEU9uQQDUm4wjaCJGKQNJIygjaCkl+gZRp/QEoRE7AULIKghVUgYGEhGvIX4iE2IRA0CYiNIYXERMzF080beSdvh5mdfTs3u8K+Dz4OZt7Mvbffzbw3c1uJoqhDUBw65REUi0rRDpR9BcoKEAFEAEGBqDLtHwHvA0+BX+Xx5bcCasBF4GdgHfgF+AbbBYEFegE8VgWLgT+wX7ayABgF7mkP/B/wyCCEshuzVZoW/gJuAAc87Vu4B1zArfEcPxewPZRPOn1juEYf8B3wShv8wTWQKUCLJ8BBD3uFB8B9i/0B9of0Ka0ASTFYB6t9f8Ji+yrBCY7zGx72qpD46LDf0QqOED5FHvMbH5hS6SU6XsMKyLRaPjEEoBgh7b897KdJewM4BbyDnw3SNxXApzQ/4jTzx9AELgN7SdsStr8G9iBngX+YK4DiGTNYm/170j6njZkjfVsBfLq5TtGuVLjzxzBsKD8vyMBvwENDct4taAuiFVq/9t39pO84kE8uAdhbEC0/fzomuQS+BT4kOSFLEn7sYU9/HFVDHK2+i0A+ZRFAnz+GMUP5GeEBjG45m8AnCavH5cwp/goGPe3buQK4PnEFsM0fg15+HmICq2DCU2XduDZG5Ys1XBFpcwAnge2StueafdocsB0gqXJyQFIM1i9bxYRrQxdWSicZknDMeRKAyX6GtH0HdmeogqZtPlEfDP60S7CkGKyDz7DaMYkwiashaxXEEeAuVg2t9nntHFB3bBP1hHMAVwDuOSBNDDGsO7ahITwV0/4rPD33BRJAYYW0n2v7vc9JOC8BXDE474EivAdqMu6B2inAU61vO+Eu6C/jLihPAVwx5H8Tagk4V6QQoFDU8O6/iWzg4awWMviykPNWRJB/w8r+VoS8lnIL/vESiADlRVXeDZUVIAIIRIDS4r8AAwBeGBwdcC4MwQAAAABJRU5ErkJggg==\")}.proper-ad-unit.ad-sticky .sticky-inner>div:last-of-type{display:inline-block}.proper-ad-unit.sticky-btm{bottom:0;left:0}.proper-ad-unit.sticky-btm:before{content:\'\';position:absolute;width:100%;height:50%;top:50%;left:0;background:rgba(255,255,255,0.79);pointer-events:all;box-shadow:0 0 4px 0 rgba(0,0,0,0.3)}.proper-ad-unit.sticky-btm .sticky-inner{height:inherit;display:inline-block}.proper-ad-unit.sticky-btm .inner-left,.proper-ad-unit.sticky-btm .inner-right{height:100%;width:48px;display:block}.proper-ad-unit.sticky-btm .inner-left{float:left}.proper-ad-unit.sticky-btm .inner-right{float:right;position:inherit}.proper-ad-unit.sticky-btm .brand{position:absolute;width:48px;height:16px;left:0;top:50%}.proper-ad-unit.sticky-btm .close{display:none;position:absolute;bottom:0;right:0;width:48px;height:48px}.proper-ad-unit[class*=\"sticky-corner-\"]:before,.proper-ad-unit.sticky-right:before,.proper-ad-unit.sticky-left:before,.proper-ad-unit.sticky-btm.for-mobile:before{top:-2px;left:0;height:200%;background:white;box-shadow:0 0 0 2px #ccc}.proper-ad-unit[class*=\"sticky-corner-\"] .inner-left,.proper-ad-unit[class*=\"sticky-corner-\"] .inner-right,.proper-ad-unit.sticky-right .inner-left,.proper-ad-unit.sticky-right .inner-right,.proper-ad-unit.sticky-left .inner-left,.proper-ad-unit.sticky-left .inner-right,.proper-ad-unit.sticky-btm.for-mobile .inner-left,.proper-ad-unit.sticky-btm.for-mobile .inner-right{height:0;position:initial}.proper-ad-unit[class*=\"sticky-corner-\"] .brand,.proper-ad-unit[class*=\"sticky-corner-\"] .close,.proper-ad-unit.sticky-right .brand,.proper-ad-unit.sticky-right .close,.proper-ad-unit.sticky-left .brand,.proper-ad-unit.sticky-left .close,.proper-ad-unit.sticky-btm.for-mobile .brand,.proper-ad-unit.sticky-btm.for-mobile .close{bottom:100%;top:auto}.proper-ad-unit[class*=\"sticky-corner-\"] .brand,.proper-ad-unit.sticky-right .brand,.proper-ad-unit.sticky-left .brand,.proper-ad-unit.sticky-btm.for-mobile .brand{top:-18px;width:48px;background-color:white;border-radius:0 6px 0 0;border:solid 2px #ccc;border-left:none;border-bottom:none}.proper-ad-unit[class*=\"sticky-corner-\"] .brand:after,.proper-ad-unit.sticky-right .brand:after,.proper-ad-unit.sticky-left .brand:after,.proper-ad-unit.sticky-btm.for-mobile .brand:after{background-position:1px 0px}.proper-ad-unit[class*=\"sticky-corner-\"] .close:after,.proper-ad-unit.sticky-right .close:after,.proper-ad-unit.sticky-left .close:after,.proper-ad-unit.sticky-btm.for-mobile .close:after{position:absolute;bottom:2px;right:0;box-shadow:none;border-radius:11px 0 0 0;background:#ffffff;border:solid 2px #ccc;border-right:none;border-bottom:none}.proper-ad-unit[class*=\"sticky-corner-\"],.proper-ad-unit.sticky-left,.proper-ad-unit.sticky-right{right:0;width:auto;top:0;height:100% !important;display:table}.proper-ad-unit[class*=\"sticky-corner-\"] .sticky-inner,.proper-ad-unit.sticky-left .sticky-inner,.proper-ad-unit.sticky-right .sticky-inner{display:table-cell;vertical-align:middle}.proper-ad-unit[class*=\"sticky-corner-\"] .inner-left,.proper-ad-unit[class*=\"sticky-corner-\"] .inner-right,.proper-ad-unit.sticky-left .inner-left,.proper-ad-unit.sticky-left .inner-right,.proper-ad-unit.sticky-right .inner-left,.proper-ad-unit.sticky-right .inner-right{position:relative}.proper-ad-unit[class*=\"sticky-corner-\"] .brand,.proper-ad-unit.sticky-left .brand,.proper-ad-unit.sticky-right .brand{height:14px;width:52px;top:-12px;border-left:solid 2px #ccc;border-radius:4px 4px 0 0}.proper-ad-unit[class*=\"sticky-corner-\"] .brand:after,.proper-ad-unit.sticky-left .brand:after,.proper-ad-unit.sticky-right .brand:after{background-position:2px 0px}.proper-ad-unit[class*=\"sticky-corner-\"] .close:after,.proper-ad-unit.sticky-left .close:after,.proper-ad-unit.sticky-right .close:after{bottom:-2px}.proper-ad-unit[class*=\"sticky-corner-\"] .sticky-inner>div:last-of-type,.proper-ad-unit.sticky-left .sticky-inner>div:last-of-type,.proper-ad-unit.sticky-right .sticky-inner>div:last-of-type{border:solid 2px #ccc;border-right:none;padding:4px;padding-right:0;background:white;border-radius:0 0 0 4px}.proper-ad-unit.sticky-corner-left,.proper-ad-unit.sticky-left{right:auto;left:0}.proper-ad-unit.sticky-corner-left .close:after,.proper-ad-unit.sticky-left .close:after{border-radius:6px 6px 0 0;border-right:solid 2px #ccc}.proper-ad-unit.sticky-corner-left .sticky-inner>div:last-of-type,.proper-ad-unit.sticky-left .sticky-inner>div:last-of-type{border-left:none;padding:4px;padding-left:0;border-right:solid 2px #ccc;border-radius:0 0 4px 0}.proper-ad-unit.sticky-left .brand{border-left:none;border-radius:0 4px 0 0;width:48px}.proper-ad-unit.sticky-left .brand:after{background-position:1px 0px}.proper-ad-unit[class*=\"sticky-corner-\"]{padding:15px}.proper-ad-unit[class*=\"sticky-corner-\"] .sticky-inner{vertical-align:bottom}.proper-ad-unit[class*=\"sticky-corner-\"] .brand{border-left:solid 2px #ccc}.proper-ad-unit[class*=\"sticky-corner-\"] .brand:after{background-position:2px 0px}.proper-ad-unit[class*=\"sticky-corner-\"] .close:after{border-radius:6px 6px 0 0;border-right:solid 2px #ccc}.proper-ad-unit[class*=\"sticky-corner-\"] .sticky-inner>div:last-of-type{padding:4px;border:solid 2px #ccc;border-radius:3px}";

        // Add extra css
        if(properOps.extra_css) {
            css += properOps.extra_css;
        }

        if (style.styleSheet) {
            style.styleSheet.cssText = css;
        } else {
            style.appendChild(document.createTextNode(css));
        }
        document.getElementsByTagName('head')[0].appendChild(style);
    }


    /**
     * Chech get variables if debug console should be enabled
     */
    function checkProperDebugConsole() {
        // Show debug console
        if(typeof properPage.get_vars.proper_debug_console !== 'undefined' || window.location.hash.includes('proper_debug_console')) {
            debugObj.createDebugConsole();
        } else if(typeof properPage.get_vars.proper_debug_console !== 'undefined' || window.location.hash.includes('proper_overlay')) {
            debugObj.createDebugConsole('overlay');
        }

    }
    window.addEventListener("hashchange", checkProperDebugConsole, false);

    /**
     * Check if ads should be shown on this page
     */
    function checkKillAllAds() {
        // Kill all ads
        if((typeof properSpecialOps.kill_all_ads !== 'undefined' && properSpecialOps.kill_all_ads == "yes") || properPage.dont_send_bids) {
            properLog.mylog("Kill All Ads enabled! Good bye!");
            return true;
        }
        return false;
    }


    /**
     * Get bid adapter name
     */
    function bidderToAdapterName(bidder) {

        var bidderAdapterName = bidder;

        if(properOps.bidder_info[bidder] && properOps.bidder_info[bidder].adapter_name) {
            bidderAdapterName = properOps.bidder_info[bidder].adapter_name;
        }

        return bidderAdapterName;
    }


    /**
     * Get the floor for the bidder/slot/sizeList combo
     * @param {String} bidder
     * @param {String/Array} sizeList
     * @param {Boolean} s2s
     */
    function getBidderFloor(bidder, sizeList, s2s) {

        try {

            // If testing mode is enabled
            if(properOps.testing_mode.enabled) return 0.01;
            var type = s2s ? 's2s' : 'header';
            var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
            var bidder_floors = ProperMedia.utils.deepAccess(properOps, 'bidders.' + type + '.' + bidder + '.floors.' + device_type) || {};
            var floors = properOps.floors[device_type] || {};

            // Start with backup floor
            var floor = bidder_floors.backup || floors.backup || 0;
            var sizes = [];

            //get floor for the size/slot
            if(ProperMedia.utils.isStr(sizeList)) {
                sizes = sizeList.split(",");
            } else if(ProperMedia.utils.isArray(sizeList)) {
                sizes = sizeList;
            }

            // Multiple sizes in one request, use lowest floor
            if(sizes.length > 0) {
                var floorList = new Array();
                for (var x = 0; x < sizes.length; x++) {
                    if(bidder_floors.sizes && bidder_floors.sizes[sizes[x]]) {
                        floorList.push(bidder_floors.sizes[sizes[x]]);
                    } else if(floors.sizes && floors.sizes[sizes[x]]) {
                        floorList.push(floors.sizes[sizes[x]]);
                    }
                }

                if(floorList.length > 0) {
                    floor = Math.min.apply(null, floorList);
                }
            }

            // Add rev share
            if( ProperMedia.utils.deepAccess(properOps, 'bidder_info.' + bidder + '.rev_share') ) {
                floor = parseFloat((floor / ProperMedia.utils.deepAccess(properOps, 'bidder_info.' + bidder + '.rev_share')).toFixed(2));
            }

        } catch(e) {
            console.error(e);
            floor = bidder_floors.backup || floors.backup || 0;
            sendError(TraceKit.computeStackTrace(e));
        }

        // Return result
        return parseFloat(floor);
    }


    /**
     * Round to match line items
     */
    function roundPriceToDfpBucket(price) {
        if(properOps.thirdPartyAdManager) {
            if(price > 40.00) {
                price = 40.00; // max of $40
            } else {
                price = (Math.ceil(price * 20)/20).toFixed(2); //round up to nearest 5 cent bucket
            }
        } else {
            if(price > 800.00) {
                price = 800.00; // max of $800
            } else if(price > 100) {
                price = Math.ceil(price).toFixed(2); //round up to nearest dollar
            } else {
                price = (Math.ceil(price * 20)/20).toFixed(2); //round up to nearest 5 cent bucket
            }
        }
        return price;
    }


    /**
     * round using this scale (these are the price floor tiers we have in our dynamic DFP order)
     *    0.10
     *    0.25
     *    0.40
     *    0.50 (every 25 cents)
     *    0.75
     *    1.00
     *    1.25
     *    1.50
     *    1.75
     *    2.00 (every 50 cents)
     *    2.50
     *    3.00
     *    3.50
     *    4.00
     *    4.50
     *    5.00
     */
    function round_floor(val) {

        val = parseFloat(val);

        var device_type = properDevice.isMobile() ? 'mobile' : 'desktop';
        var floors = properOps.floors[device_type] || {};

        // round based on scale
        if(!val || val == "") val = floors.backup;
        else if(val <= 0.10) val = 0.10;
        else if(val <= 0.25) val = 0.25;
        else if(val <= 0.40) val = 0.40;
        else if(val <= 2.00) val = (Math.ceil(val * 4) / 4).toFixed(2); //every 25 cents (1/4 dollar)
        else if(val <= 5.00) val = (Math.ceil(val * 2) / 2).toFixed(2); //every 50 cents (1/2 dollar)
        else val = 5.00;

        return ProperMedia.utils.round(val, 2);
    }


    function proper_display(id, slot_options) {
        // kill everything!
        if(checkKillAllAds()) {
            properLog.mylog("Kill All Ads enabled! Goodbye!");
            return false;
        }

        // Missing id (try to get it from div above this script)
        if(typeof id == "undefined") {
            try {
                //get last script called
                var scriptTag = document.scripts[document.scripts.length - 1];
                var id = scriptTag.parentNode.id;
                if(typeof scriptTag.parentNode == "undefined" || typeof id == "undefined" || id.indexOf("proper-ad-") < 0) return;

                //parse ad name
                id = id.replace("proper-ad-","");
            }
            catch(e) {
                console.error(e);
                sendError(TraceKit.computeStackTrace(e));
            }

            if(typeof id == "undefined") {
                return false;
            }
        }

        var slot_name = ProperMedia.utils.extractSlotName(id);
        if(slot_name) {
            var slot = properPage.buildSlot('display', slot_name);
        } else {
            properLog.mylog("Couldn't find slot from id: " + id);
            return false;
        }
    }


    /**
     * Function to display the winning ad when dfp is excluded
     * @param {slotObj} slot - Slot where to display ad
     */
    function showWinningAd(slot) {

        // Check if slot exists on page
        if(!slot.getElement()) {
            return false;
        }

        var isEmpty = 1;
        if(slot.hasWinningBid()) { // we have a winner!
            isEmpty = 0;
        } else if(properOps.testing_mode.enabled == true) { // testing mode (no ad found)

            // Check that a default size is defined
            if(typeof slot.default_size == "undefined" || slot.default_size == "0x0") {
                return false;
            }

            isEmpty = 0;

            // Create AD Placeholder
            var test_ad = new adObj({
                "bidder": "unfilled",
                "size"  : slot.default_size.join('x'),
                "adcode": "<div style=\"text-align:center;width:"+slot.default_size[0]+"px;height:"+slot.default_size[1]+"px;background:#ccc;color:#000;padding-top:10px;\">-- no ad found --</div>"
            });

            slot.winning_ad = test_ad;
        }

        if(isEmpty == 0) {
            proper_render(slot.getElement(), slot.number, 1);
        } else { // Log unfilled impression
            log_unfilled(slot);
        }

        return true;
    }


    /**
     * Render ad code with no DFP
     * @param {doc} doc                - Page document where to write ad code
     * @param {sloObj} slot            - Slot object to render ad into
     * @param {Array[int]} render_size - Size to render ad
     */
    function proper_render_isolated(doc, slot, render_size) {

        // Clear doc html
        doc.innerHTML = "";
        // Build iframe
        var iframe = document.createElement('iframe');
        // Set iframe attr
        iframe.frameBorder         = 0;
        iframe.scrolling           = "no";
        iframe.marginWidth         = "0";
        iframe.marginHeight        = "0";
        iframe.width               = render_size[0];
        iframe.height              = render_size[1];
        iframe.style.overflow      = "hidden";
        iframe.style.border        = "0px";
        iframe.style.verticalAlign = "bottom";

        iframe.onload = function() {
            console.log('Proper isolated slotOnload: ' + slot.name);
            if(
                properOps.testing_mode.enabled == true &&
                properOps.testing_mode.bidder == 'unfilled' && 
                slot.winning_ad.bidder == 'unfilled') {
                slot.dispatchCustomEvent('proper-unfilled');
            } else {
                slot.dispatchCustomEvent('proper-ads-fired', 
                    {
                        'cpm': ProperMedia.utils.deepAccess(slot, 'displayed_ad.price'),
                        'size': ProperMedia.utils.deepAccess(slot, 'displayed_ad.size'),
                        'ad_type': 'display'
                    }
                );
                if(slot.hasWinningBid() && slot.winning_ad.displayed == 1) {
                    slot.winning_ad.onBidWon();
                }
            }
            // Resize iframe on load
            if(iframe.height == "auto") {
                this.style.height = this.contentWindow.document.body.scrollHeight + 'px';
            }
        }

        // Sandbox iframe
        if(properOps.sandbox_iframe) iframe.sandbox = properOps.sandbox_options.join(' ') || '';
        // Set iframe src
        iframe.src = "javascript:\"<html><body style='background:transparent'></body></html>\"";
        // Add iframe elem to DOM
        doc.appendChild(iframe);

        // Ad code html
        var html = "<html><body>" + slot.winning_ad.adcode + "</body></html>";

        // run ad through confiant redirect check
        if(properOps.confiant == 1) {
            confiantWrapper.wrapTag(slot, iframe.contentWindow.document, ProperMedia.utils.mergeObject({}, slot.winning_ad, {adcode: html}));
        } else { // Write html to iframe document
            iframe.contentWindow.document.open();
            iframe.contentWindow.document.write(html);
            iframe.contentWindow.document.close();
        }

        if(render_size[1] == "auto") {
            ProperMedia.utils.onElementHeightChange(iframe, function (newHeight) {
                iframe.style.height = newHeight + 'px';
            });
        }
    }

    /**
     * Render ad code through DFP bidder order
     * @param {doc} doc                - Page document where to write ad code
     * @param {sloObj} slot            - Slot object to render ad into
     * @param {Array[int]} render_size - Size to render ad
     */
    function proper_render_bidder_order(doc, slot, render_size) {

        // Resize outer iframe container
        var iobj = window.top.document.getElementById(slot.div_id+"-iframe");
        if(iobj) {
            iobj.style.width  = formatCssSize(render_size[0]);
            iobj.style.height = formatCssSize(render_size[1]);
        }

        if (doc.defaultView && doc.defaultView.frameElement) {
            var elementWidth  = render_size[0],
                elementHeight = render_size[1];

            doc.defaultView.frameElement.width  = elementWidth;
            doc.defaultView.frameElement.height = elementHeight;
        }

        // Run ad through confiant redirect check
        if(properOps.confiant == 1) {
            confiantWrapper.wrapTag(slot, doc, slot.winning_ad);
        } else { // Write html to document
            doc.write(slot.winning_ad.adcode);
        }

        // Resize iframes if height is set to auto
        if(render_size[1] == "auto") {
            if(iobj) {
                var iobj2 = iobj.contentWindow.document.getElementById(slot.dfpIframeId)
                if(iobj2) {
                    ProperMedia.utils.onElementHeightChange(iobj2, function (newHeight) {
                        iobj2.style.height = newHeight + 'px';
                        iobj.style.height  = newHeight + 'px';
                    });
                } else {
                    ProperMedia.utils.onElementHeightChange(iobj, function (newHeight) {
                        iobj.style.height = newHeight + 'px';
                    });
                }
            } else {
                iobj = window.top.document.getElementById(slot.dfpIframeId)
                if(iobj) {
                    ProperMedia.utils.onElementHeightChange(iobj, function (newHeight) {
                        iobj.style.height = newHeight + 'px';
                    });
                }
            }
        }
    }

    /**
     * Render ad on page
     * @param {doc} doc - Page document where to write ad code
     * @param {Int} id - Slot number
     * @param {Int} type: 0 = proper bidder, 1 = isolated page (No DFP)
     * @param {Foat} price - Price that the bid won at
     */
    function proper_render(doc, id, type, price) {

        var slot = properPage.getSlotByNumber(id, ['display']);
        if(!slot) {
            properLog.mylog("Couldn't find slot with number: " + id);
            return false;
        }

        // Default type
        type = type || 0;

        var render_size = [0,0];

        // Have a winning header bid
        if(slot.hasWinningBid() || (properOps.testing_mode.enabled && slot.winning_ad instanceof adObj)) {

            // Check if a higher bid has come back
            slot.getWinningBid(['display']);
            // Mark bid as displayed
            slot.winning_ad.displayed = 1;

            render_size = slot.winning_ad.size.split("x");

            // Check for native size
            if(slot.winning_ad.size == '1x1' || properOps.native_sizes[slot.winning_ad.size]) {
                render_size = ["100%","auto"];
            }

            // Teads code for ad pooling. Insert custom div element
            if( ProperMedia.utils.deepAccess(bidAdapters, slot.winning_ad.bidder + '.bidderInfo.div_insertion') ) {
                // replace macro with slot div id
                slot.winning_ad.adcode = slot.winning_ad.adcode.replace(/{PROPER_SLOT_DIV_ID}/g, slot.div_id);
            }

            // Check if old creative needs to be removed from DOM. Ex: Triplelift, GumGum S2S
            slot.removeCreative();

            // Render isolated mode (Not DFP)
            if(type == 1) {
                proper_render_isolated(doc, slot, render_size);
            // Proper bidder order
            } else if(type == 0) {
                proper_render_bidder_order(doc, slot, render_size);
            }

            // Send confirmation to our tracker
            properLog.mylog("displayed! (" + slot.name + ", bidder=" + slot.winning_ad.bidder + ", size=" + slot.winning_ad.size + ", price=" + slot.winning_ad.price + ")");

            // update auction time
            var auction_ms = ProperMedia.utils.getTimePassed(slot.auction_started_ts);

            // Validate the price
            var corrected_price = ProperMedia.utils.validateValue(slot.winning_ad.price, {'type': 'number', 'max':999, 'max_len':15});

            properSession.setSessionRevenue(corrected_price);

            // data for report ad tool
            properLog.saved_data[slot.name] = {
                "bidder"          : slot.winning_ad.bidder,
                "cpm"             : corrected_price,
                "size"            : slot.winning_ad.size,
                "slot"            : slot.dfp_name,
                "request_url"     : slot.winning_ad.request_url,
                "request_response": slot.winning_ad.response,
                "adcode"          : slot.winning_ad.adcode,
                "ad_details"      : slot.winning_ad.ad_details
            };

            // bid data
            properLog.bid_data.ad_slots[slot.name] = {
                "slot_name"          : ProperMedia.utils.validateValue(slot.dfp_name, {'type':'string','max_len':50}),
                "bidder"             : ProperMedia.utils.validateValue(slot.winning_ad.bidder, {'type':'string','max_len':30}),
                "gross"              : ProperMedia.utils.validateValue(slot.winning_ad.gross, {'type': 'number', 'max':999, 'max_len':15}),
                "price"              : corrected_price,
                "size"               : ProperMedia.utils.validateValue(slot.winning_ad.size, {'type':'string','max_len':10}),
                "refresh_cnt"        : ProperMedia.utils.validateValue(slot.refresh.count, {'type':'number','max':999}),
                "line_item_id"       : "",
                "response_ms"        : ProperMedia.utils.validateValue(slot.winning_ad.response_ms, {'type':'number','max':999999}),
                "auction_duration"   : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
                "precent_bids_ready" : ProperMedia.utils.validateValue(100, {'type':'number','max':100}),
                "tag_id"             : ProperMedia.utils.validateValue(slot.winning_ad.tag_id, {'type':'string','max_len':50})
            };

            // Set what ad was displayed
            slot.displayed_ad = ProperMedia.utils.deepCopy(slot.winning_ad);
            properAdPool.displayed_ads.push(ProperMedia.utils.deepCopy(slot.displayed_ad));

            proper_inview(0, slot.name, slot.winning_ad.size, 0, 0, 0);

            // track data after 500ms (wait for more ad units to finish)
            clearTimeout(properLog.tracker_timeout);
            properLog.tracker_timeout = null;
            properLog.tracker_timeout = properSetTimeout.setTimeout.call(properPage, function() { properLog.proper_tracker(); }, properLog.tracker_wait);

        } else {
            log_unfilled(slot);
        }

    }

    /**
     * DFP order won over bidder
     *
     * @param {String} slot_name
     * @param {Array} size
     * @param {Int} advertiserId
     * @param {Int} lineItemId
     * @param {Int} yieldGroupIds
     */
    function proper_render_dfp(slot_name, size, advertiserId, lineItemId, yieldGroupIds) {

        //get page and slot
        var slot = properPage.getSlotFromPageObject(slot_name, ['display']);

        if(!slot) {
            return;
        }

        // Check if old creative needs to be removed from DOM. Ex: Triplelift
        slot.removeCreative();

        //resize iframe
        var iobj = window.top.document.getElementById(slot.div_id+"-iframe");
        if(iobj) {
            iobj.style.width  = formatCssSize(size[0]);
            iobj.style.height = formatCssSize(size[1]);
        }

        //parse size
        var creative_size = size[0]+"x"+size[1];

        //parse bidder
        var tagId  = advertiserId;
        var bidder = "dfp";
        if(advertiserId == properOps.amazon_advertiser) {
            bidder = "a9";
        } else if(advertiserId == properOps.adsense_advertiser) {
            bidder = "adsense";
        } else if(advertiserId == properOps.google_advertiser || advertiserId == 1 || advertiserId == null || yieldGroupIds != null) {
            bidder = "adx";
        }
        slot.advertiserId = advertiserId;

        //parse price
        var cpm = 0.00;
        if(bidder == "adx" || bidder == "adsense") { // Dynamic allocation
            var floor = slot.getFloor(creative_size);
            if(typeof slot.winning_ad !== "undefined" && typeof slot.winning_ad.dfp_price !== "undefined" && slot.winning_ad.dfp_price > floor) {
                cpm = parseFloat(slot.winning_ad.dfp_price) + 0.01;
            } else {
                cpm = parseFloat(floor) + 0.01; // if not winning ad, it must have beat the floor at least
            }
        }

        //send confirmation to our tracker
        properLog.mylog("displayed! DFP (" + slot.name + ", bidder=" + bidder + ", size=" + creative_size + ", price: " + cpm + ")");

        // track time to win ad
        var auction_ms = ProperMedia.utils.getTimePassed(slot.auction_started_ts);

        properSession.setSessionRevenue(cpm);

        // bid data
        properLog.bid_data.ad_slots[slot.name] = {
            "slot_name"         : ProperMedia.utils.validateValue(slot.dfp_name, {'type':'string','max_len':50}),
            "bidder"            : ProperMedia.utils.validateValue(bidder, {'type':'string','max_len':30}),
            "price"             : ProperMedia.utils.validateValue(cpm, {'type': 'number', 'max':1000, 'max_len':15}),
            "gross"             : ProperMedia.utils.validateValue(cpm, {'type': 'number', 'max':1000, 'max_len':15}),
            "size"              : ProperMedia.utils.validateValue(creative_size, {'type':'string','max_len':10}),
            "refresh_cnt"       : ProperMedia.utils.validateValue(slot.refresh.count, {'type':'number','max':999}),
            "line_item_id"      : ProperMedia.utils.validateValue(lineItemId, {'type':'string','max_len':15}),
            "response_ms"       : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
            "auction_duration"  : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
            "precent_bids_ready": ProperMedia.utils.validateValue(100, {'type':'number','max':100}),
            "tag_id"            : ProperMedia.utils.validateValue(tagId, {'type':'string','max_len':50})
        };

        slot.displayed_ad = {
            "type"       : 'display',
            "price"      : cpm,
            "gross"      : cpm,
            "dfp_price"  : cpm,
            "bidder"     : bidder,
            "size"       : creative_size,
            "adCode"     : '',
            "tag_id"     : tagId,
            "response_ms": auction_ms,
            "displayed"  : 1
        };
        properAdPool.displayed_ads.push(ProperMedia.utils.deepCopy(slot.displayed_ad));

        // data for report ad tool
        properLog.saved_data[slot.name] = {
            "bidder"          : bidder,
            "cpm"             : cpm,
            "size"            : creative_size,
            "slot"            : slot.dfp_name,
            "request_url"     : "",
            "request_response": "",
            "adcode"          : "",
            "ad_details"      : {}
        };

        // track data after 500ms (wait for more ad units to finish)
        clearTimeout(properLog.tracker_timeout);
        properLog.tracker_timeout = null;
        properLog.tracker_timeout = properSetTimeout.setTimeout.call(properPage, function() { properLog.proper_tracker(); }, properLog.tracker_wait);

    }



    /**
     * If In-View ad returned, create ad slot
     * @param {Int} isEmpty - If an ad won or not
     * @param {String} slot_name - Slot name
     * @param {Array} size -  Size of ad
     * @param {Int} creativeId - DFP creative ID
     * @param {Int} lineItemId - DFP line item ID
     * @param {Int} advertiserId - Advertiser ID
     */
    function proper_inview(isEmpty, slot_name, size, creativeId, lineItemId, advertiserId){

        // start injecting user sync pixels/frames after 3 seconds
        setTimeout(userSyncs.start, 3000);

        var sticky_class = ".ad-sticky[class*='" + slot_name + "']";

        var slot = properPage.getSlotFromPageObject(slot_name, ['display']);
        if(slot) {

            // Store creative and line item id
            if(!isEmpty) {
                // Set slot size
                slot.size = size;
                // Log ad info
                properLog.ad_info[slot.name] = {
                    "creative_id" : creativeId,
                    "line_item_id": lineItemId,
                    "size"        : size
                };
            }

            size = properOps.native_sizes[size] || size;

            // stickies
            if(slot.sticky) {

                if (isEmpty) {
                    // Hide sticky if no ad to display
                    if(slot.refresh.count == 0) {
                        $(sticky_class).hide();
                    }

                    // We have a sticky
                } else {

                    // Store creative and line item id
                    slot.displayed = 1;

                    // Increment unit impression for sticky slot
                    if(properOps.enable_sticky_freq_cap && slot.refresh.count == 0) {
                        properUser.stickyFreqCapHandler.incrementStickyUnitImps();
                    }

                    if(
                        typeof slot.winning_ad.bidder == 'undefined' ||
                        slot.winning_ad.displayed == 0 ||
                        (
                            slot.winning_ad.displayed == 1 &&
                            typeof properOps.native_sizes[slot.winning_ad.size] == 'undefined'
                        )
                    ) {

                        //add 'close' and 'report ad' buttons
                        if( typeof $(sticky_class + " .sticky-inner .inner-left").obj == "undefined" && size !== '1x1') {

                            // Show proper.io brand on our properties
                            var left_html  = '<div class="inner-left">'
                            left_html      +=     '<a href="https://proper.io?from=sticky" target="_blank" class="brand"></a>'
                            left_html      += '</div>'

                            var right_html =  '<div class="inner-right">'
                            right_html     +=     '<div class="close"></div>'
                            right_html     += '</div>'

                            // add buttons and css
                            $(sticky_class + " .sticky-inner").insideBefore(right_html);
                            $(sticky_class + " .sticky-inner").insideBefore(left_html);

                            // Close on click
                            $(sticky_class + ' .close').on('click', function (e) {
                                e.preventDefault();

                                $(sticky_class).removeStyle();
                                $(sticky_class).removeClass('isOpen');
                                $(sticky_class).addClass('close');

                                // log that sticky has been closed
                                if(slot.sticky_settings.disable_on_close) {
                                    properUser.stickyFreqCapHandler.setStickyClosedCookie();
                                }

                                // disable refresh if sticky slot is closed
                                disableSlotRefresh(slot.name);
                            });

                        }

                        // Remove sticky classes
                        $(sticky_class).removeClass("sticky-right");
                        $(sticky_class).removeClass("sticky-left");
                        $(sticky_class).removeClass("sticky-btm");
                        $(sticky_class).attr('style','');
                        $(sticky_class + " .sticky-inner").attr('style','')

                        var size_wh = size.split('x');

                        var w = parseInt(size_wh[0]);
                        var h = parseInt(size_wh[1]);

                        if(size !== '1x1') {
                            $(sticky_class).attr('style', "height: "+h+"px");
                        }

                        // Corner Sticky
                        if( (w == 300 && h == 250) ||
                            (w == 336 && h == 280) 
                        ){
                            $(sticky_class).addClass("sticky-corner-"+slot.sticky_settings.position);

                        // Side Sticky
                        } else if(w < h) {
                            $(sticky_class).addClass("sticky-"+slot.sticky_settings.position);

                        // Bottom Sticky
                        } else {
                            $(sticky_class).addClass("sticky-btm");
                        }

                        //slide in (assuming we now have a real size)
                        if(size !== '1x1') {
                            onStickyLoad($(sticky_class));
                        } else {
                            $(sticky_class).hide();
                        }

                        //add .mobile class if window is skinnier than ad
                        if( !window.innerWidth ||
                            window.innerWidth <= 720 ||
                            window.innerWidth <= (w - 96)
                        ){
                            $(sticky_class).addClass("for-mobile")
                        }

                    } else if(slot.winning_ad.bidder == 'gumgum' || slot.winning_ad.bidder == 'gumgum_s2s') {

                        $(sticky_class).addClass('sticky-btm');
                        $(sticky_class).obj.style.background = 'none';
                        onStickyLoad($(sticky_class));

                    } else {
                        $(sticky_class).hide();
                    }

                }

                // Non-sticky slots
            } else if (!isEmpty) {

                if(slot.min_width > 1 && slot.min_height > 1) {
                    $("#" + slot.div_id).obj.style.width     = "";
                    $("#" + slot.div_id).obj.style.height    = "";
                    $("#" + slot.div_id).obj.style.minWidth  = slot.min_width+"px";
                    $("#" + slot.div_id).obj.style.minHeight = slot.min_height+"px";
                }

                //display 'report this ad' button (for our properties only)
                if(slot.report_ad_tool == 1 && slot.displayed == 0) {
                    $("#"+slot.div_id).after('<a href="#report-ad" data-aid="'+slot.div_id+'" class="call-modal report-ad">Report Advertisement</a>');
                }
                slot.displayed = 1;
            }

            // set displayed ts
            if(slot.displayed == 1 && !isEmpty) {
                slot.last_displayed_ts = ProperMedia.utils.getTimestampMs();
                slot.tracking_times.creative_on_page = ProperMedia.utils.getTimestampMs();

                if( // Check if refresh should be disabled
                    ProperMedia.utils.deepAccess(slot, 'winning_ad.displayed') == 1 &&
                    ProperMedia.utils.deepAccess(properOps, 'bidder_info.'+slot.winning_ad.bidder+'.dont_refresh') == 1
                ) {
                    slot.refresh.enabled == 0;
                }

                var eventType = (slot.refresh.count == 0) ? 'displayed' : 'refreshed' ;
            }

            // Set refresh interval
            if(slot.refresh.enabled == 1 && slot.refresh.count < slot.refresh.max) {
                slot.setRefreshInterval();
            }

            if(debugObj.enabled == true) {
                debugObj.addSlotOverlay(slot);
            }

            slot.recycleBid();
        }
    }


    // Setup sticky transition
    function onStickyLoad(el) {

        /* Modernizr function */
        function whichTransitionEvent() {
            var t;
            var f = document.createElement('fakeelement');
            var transitions = {
              'transition':'transitionend',
              'OTransition':'oTransitionEnd',
              'MozTransition':'transitionend',
              'WebkitTransition':'webkitTransitionEnd'
            }

            for(t in transitions){
                if( f.style[t] !== undefined ){
                    return transitions[t];
                }
            }
        }

        var transitionEvent = whichTransitionEvent();
        if(transitionEvent) {
            el.on(transitionEvent, function(e) {
                if (el.hasClass('open')) { el.addClass('isOpen'); el.removeClass('open'); }
                else if (el.hasClass('close')) { el.addClass('isClosed'); el.removeClass('close'); }
            });
        }
        el.addClass("open");
    }


    // log default/unfilled impression
    function log_unfilled(slot) {

        proper_inview(1, slot.name, '0x0', 0, 0, 0);

        // Dont log unfilled refresh impressions for display slots
        if(slot.type == 'display' && slot.refresh.count > 0) return;

        //track time to win ad
        var auction_ms = ProperMedia.utils.getTimePassed(slot.auction_started_ts);

        // bid data
        properLog.bid_data.ad_slots[slot.name] = {
            slot_name         : ProperMedia.utils.validateValue(slot.dfp_name, {'type':'string','max_len':50}),
            bidder            : 'unfilled',
            price             : 0,
            gross             : 0,
            size              : ProperMedia.utils.validateValue(slot.default_size, {'type':'string','max_len':10}),
            refresh_cnt       : ProperMedia.utils.validateValue(slot.refresh.count, {'type':'number','max':999}),
            line_item_id      : '',
            response_ms       : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
            auction_duration  : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
            precent_bids_ready: ProperMedia.utils.validateValue(100, {'type':'number','max':100}),
            tag_id            : ''
        };

        slot.displayed_ad = {
            "price"      : 0,
            "gross"      : 0,
            "dfp_price"  : 0,
            "bidder"     : 'unfilled',
            "size"       : slot.default_size.join('x'),
            "adCode"     : '',
            "tag_id"     : '',
            "response_ms": auction_ms
        };
        properAdPool.displayed_ads.push(ProperMedia.utils.deepCopy(slot.displayed_ad));

        slot.dispatchCustomEvent('proper-unfilled');

        // track data after 500ms (wait for more ad units to finish)
        clearTimeout(properLog.tracker_timeout);
        properLog.tracker_timeout = null;
        properLog.tracker_timeout = properSetTimeout.setTimeout.call(properPage, function() { properLog.proper_tracker(); }, properLog.tracker_wait);

    }


    function proper_debug_console() {
        debugObj.createDebugConsole();
    }

    function proper_debug_overlay() {
        debugObj.createDebugConsole('overlay');
    }


    function formatCssSize(size) {
        return (typeof size == "string" && (size.indexOf("%") !== -1 || size == 'auto')) ? size : size + "px";
    }

    // Get Data for Report Ad tool
    function getReportAdInfo(obj) {

        var retData = {};

        // get site name
        if(typeof obj.site_name !== 'undefined' && obj.site_name == 1) {
            retData.site_name = properOps.site_name;
        }

        // get split version
        if(typeof obj.split_version !== 'undefined' && obj.rtp_file_version == 1) {
            retData.split_version = properOps.rtp_file_version;
        }

        if(typeof obj.slot_id !== 'undefined') {
            var slot_name = ProperMedia.utils.extractSlotName(obj.slot_id);

            // autoplay html
            if(properLog.autoplay_html[obj.slot_id]) {
                retData.autoplay_html = properLog.autoplay_html[obj.slot_id];
            }

            // log lines
            if(typeof properLog.log_lines !== 'undefined') {
                retData.log_lines = properLog.log_lines;
            }

            // saved data
            if(typeof properLog.saved_data[slot_name] !== 'undefined') {
                retData.saved_data = properLog.saved_data[slot_name];
            }

            // saved data
            if(typeof properLog.ad_info[slot_name] !== 'undefined') {
                retData.ad_info = properLog.ad_info[slot_name];
            }
        }
        return retData;
    }

    function logMatchingResponse(bidder, proper_uid, bidder_uid) {
        cookieMatching.logMatchingResponse(bidder, proper_uid, bidder_uid);
    }

    function getAdSlots() {
        return Object.keys(properPage.slots['display']).concat(properPage.slots['video']);
    }

    function refreshSlotByName(slot_name, forceRefresh) {
        var slot = properPage.getSlotFromPageObject(slot_name, ['display']);
        if(slot) {
            slot.removeRefreshTimeout();
            slot.refreshSlot(forceRefresh);
            return true;
        }
        return false;
    }

    // disable refresh for slot
    function disableSlotRefresh(slot_name) {
        var slot = properPage.getSlotFromPageObject(slot_name, ['display']);
        if(slot) {
            slot.refresh.enabled = 0;
            slot.removeRefreshTimeout();
            return true;
        }
        return false;
    }

    // Next page in single-page application
    function spaNewPage() {
        // Setup for next page
        properPage.SpaNextPage();
    }

    // Next page in infinite scroll page
    function infScrollNewPage() {
        // Setup for next page
        properPage.InfScrollNextPage();
    }

    // Build slots on page. Called when layout has changed or new slots have been added
    function buildSlots() {
        properPage.buildSlots();
    }


    /* Used to destroy slot object in page
     * @param {String} Name of slot
     * @param {Int} Page number
     */
    function deleteSlot(slot_name) {
        var slot = properPage.getSlotFromPageObject(slot_name, ['display']);
        if(slot) {
            slot.deleteSlot(true);
            return true;
        }
        return false;
    }


    /* Used to destroy googletag record of slot
     * @param {String} Name of slot
     * @param {Int} Page number
     */
    function destroyDfpSlot(slot_name) {
        var slot = properPage.getSlotFromPageObject(slot_name, ['display']);
        if(slot) {
            slot.destroyDfpSlot();
            return true;
        }
        return false;
    }


    /**
     * Get Video Player Options
     * @param {string} slot_name
     * @return {Object} video player settings
     */
    function getVideoPlayerOps(slot_name) {
        var slot = properPage.getSlotFromPageObject(slot_name);
        if(slot && slot.video_player instanceof videoPlayer) {
            return slot.video_player.player_settings || {};
        }
        return {};
    }


    /**
     * Create video slot object
     * @param {string} slot_name
     * @return {Boolean}
     */
    function createVideoSlot(slot_name) {
        try {
            properLog.mylog('Create video slot for: ' + slot_name);
            // Set video enabled 
            properPage.video_enabled = true;

            propertag.cmd.push(function() {
                var slot = (properPage.getSlotFromPageObject(slot_name, ['video'])) ? properPage.getSlotFromPageObject(slot_name, ['video']) : properPage.buildSlot('video', slot_name);
                // Run Video Auction if none ran yet
                if(properAdPool.vid_auction_count == 0) {
                    properAdPool.sendVideoAuction(slot.video_player.player_settings.video_type);
                }
            });
            return true;
        } catch(e) {
            return false;
        }
    }


    /**
     * Run a  new video auction
     * @param {string} slot_name
     * @return {Boolean}
     */
    function runVideoAuction(slot_name) {
        propertag.cmd.push(function() {
            var slot = properPage.getSlotFromPageObject(slot_name);
            if(slot && slot.video_player instanceof videoPlayer) {
                properAdPool.sendVideoAuction(slot.video_player.player_settings.video_type);
                return true;
            } else {
                return false;
            }
        });
    }


    /**
     * Get the highest video ad
     * @param {string} slot_name
     * @return {Object} Ad code to display. false on fail.
     */
    function getVideoAd(slot_name) {
        var slot = properPage.getSlotFromPageObject(slot_name);
        if(slot && slot.video_player instanceof videoPlayer) {

            var video_type = slot.video_player.player_settings.video_type;
            var auciton_times = properAdPool.getTimeLeftOnRunningAuctions();
            var auction_finished = !!(properAdPool.auction_count > 0 && auciton_times.length == 0);
            var auction_time_remaining = (!auction_finished && auciton_times.length > 0) ? Math.min(auciton_times) : 0;
            if(slot.getWinningBid(['video'], video_type)) {
                slot.tracking_times.dfp_sent_ts = ProperMedia.utils.getTimestampMs();
                return {
                    'auction': {
                        'finished': auction_finished,
                        'time_remaining': auction_time_remaining
                    },
                    'ad':{
                        'price'     : slot.winning_ad.price,
                        'bidder'    : slot.winning_ad.bidder,
                        'vast_tag'  : slot.winning_ad.vast_tag,
                        'vast_type' : slot.winning_ad.vast_type,
                        'vpaid'     : slot.winning_ad.vpaid,
                        'video_type': slot.winning_ad.video_type,
                        'ad_details': slot.winning_ad.ad_details
                    }
                };

            } else if(slot.type == 'video') {
                slot.tracking_times.dfp_sent_ts = ProperMedia.utils.getTimestampMs();
                return {
                    'auction': {
                        'finished': auction_finished,
                        'time_remaining': auction_time_remaining
                    },
                    'ad': {
                        'price'     : slot.getFloor('dfp_floor'),
                        'bidder'    : 'dfp_floor',
                        'vast_tag'  : '',
                        'vast_type' : '',
                        'vpaid'     : '',
                        'video_type': video_type,
                        'ad_details': ''
                    }
                };

            // Fallback to display ad. Only if no ads have played already
            } else if(slot.displayed !== 1 && slot.type == 'display' && auction_finished) {
                // Reset refresh settings
                var slot_settings = ProperMedia.utils.deepAccess(properOps, 'ad_slots' + '.' + slot.type + '.' + slot.name) || {};
                slot.setRefresh(slot_settings);
                // Get next best display bid
                slot.getWinningBid(['display'])
                showWinningAd(slot);
            }
        }
        return false;
    }


    function destroyVideoPlayer(slot_name) {
        var slot = properPage.getSlotFromPageObject(slot_name);
        if(slot && slot.video_player instanceof videoPlayer) {
            slot.video_player.destroyVideoPlayer();
        }
    }


    /**
     * Video Ad successfully played
     * @param {String} slot_name
     * @param {Boolean} dfp_won - Price that dfp won at else false if header bidder won
     * @return {Boolean}
     */
    function logVideoAdSuccess(slot_name, dfp_won) {
        var slot = properPage.getSlotFromPageObject(slot_name);
        if(slot && slot.video_player instanceof videoPlayer) {

            // update auction time
            var auction_ms = ProperMedia.utils.getTimePassed(slot.auction_started_ts);
            var size       = properDevice.isMobile() ? '640x480' : '400x300';
            var video_ad   = null;

            if(dfp_won) {
                var bidder = 'dfp_video';
                var cpm    = parseFloat(dfp_won) + 0.01;
                // bid data
                video_ad = {
                    "slot_name"          : ProperMedia.utils.validateValue(slot.dfp_name, {'type':'string','max_len':50}),
                    "bidder"             : ProperMedia.utils.validateValue(bidder, {'type':'string','max_len':30}),
                    "gross"              : ProperMedia.utils.validateValue(cpm, {'type': 'number', 'max':999, 'max_len':15}),
                    "price"              : ProperMedia.utils.validateValue(cpm, {'type': 'number', 'max':999, 'max_len':15}),
                    "size"               : ProperMedia.utils.validateValue(size, {'type':'string','max_len':10}),
                    "refresh_cnt"        : ProperMedia.utils.validateValue(slot.refresh.count, {'type':'number','max':999}),
                    "line_item_id"       : "",
                    "response_ms"        : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
                    "auction_duration"   : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
                    "precent_bids_ready" : ProperMedia.utils.validateValue(100, {'type':'number','max':100}),
                    "tag_id"             : ProperMedia.utils.validateValue('', {'type':'string','max_len':50})
                };

                slot.displayed_ad = {
                    "type"       : 'video',
                    "price"      : cpm,
                    "gross"      : cpm,
                    "dfp_price"  : cpm,
                    "bidder"     : bidder,
                    "size"       : size,
                    "adCode"     : '',
                    "tag_id"     : '',
                    "response_ms": auction_ms,
                    "displayed"  : 1,
                    'video_type' : slot.video_type
                };

                slot.recycleBid();

            } else if(slot.hasWinningBid()) {
                // bid data
                video_ad  = {
                    "slot_name"          : ProperMedia.utils.validateValue(slot.dfp_name, {'type':'string','max_len':50}),
                    "bidder"             : ProperMedia.utils.validateValue(slot.winning_ad.bidder, {'type':'string','max_len':30}),
                    "gross"              : ProperMedia.utils.validateValue(slot.winning_ad.gross, {'type': 'number', 'max':999, 'max_len':15}),
                    "price"              : ProperMedia.utils.validateValue(slot.winning_ad.price, {'type': 'number', 'max':999, 'max_len':15}),
                    "size"               : ProperMedia.utils.validateValue(slot.winning_ad.size, {'type':'string','max_len':10}),
                    "refresh_cnt"        : ProperMedia.utils.validateValue(slot.refresh.count, {'type':'number','max':999}),
                    "line_item_id"       : "",
                    "response_ms"        : ProperMedia.utils.validateValue(slot.winning_ad.response_ms, {'type':'number','max':999999}),
                    "auction_duration"   : ProperMedia.utils.validateValue(auction_ms, {'type':'number','max':999999}),
                    "precent_bids_ready" : ProperMedia.utils.validateValue(100, {'type':'number','max':100}),
                    "tag_id"             : ProperMedia.utils.validateValue(slot.winning_ad.tag_id, {'type':'string','max_len':50})
                };
                slot.winning_ad.displayed = 1;
                slot.size = slot.winning_ad.size;
                slot.displayed_ad = ProperMedia.utils.deepCopy(slot.winning_ad);
                slot.winning_ad.onBidWon();
            }

            if(video_ad) {
                // Slot displayed
                slot.displayed = 1;
                slot.refresh.count++;
                slot.last_displayed_ts = ProperMedia.utils.getTimestampMs();
                slot.tracking_times.dfp_returned_ts = ProperMedia.utils.getTimestampMs();
                slot.tracking_times.creative_on_page = ProperMedia.utils.getTimestampMs();
                slot.dispatchCustomEvent('video-ad-played');

                slot.dispatchCustomEvent('proper-ads-fired', {
                    'cpm': video_ad.price, 
                    'size': video_ad.size,
                    'ad_type': ProperMedia.utils.deepAccess(slot, 'displayed_ad.video_type')
                });

                properSession.setSessionRevenue(video_ad.price);

                properAdPool.displayed_ads.push(ProperMedia.utils.deepCopy(slot.displayed_ad));

                properLog.bid_data.ad_slots[slot.dfp_name] = video_ad;
                // track data after 500ms (wait for more ad units to finish)
                clearTimeout(properLog.tracker_timeout);
                properLog.tracker_timeout = null;
                properLog.tracker_timeout = properSetTimeout.setTimeout.call(properPage, function() { properLog.proper_tracker(); }, properLog.tracker_wait);

                properLog.mylog("displayed! (" + slot.name + ", bidder=" + video_ad.bidder + ", size=" + video_ad.size + ", price=" + video_ad.price + ")");

            }
        }
        return true;
    }


    /**
     * Video slot unfilled
     * @param {String} slot_name
     */
    function logVideoUnfilled(slot_name) {
        var slot = properPage.getSlotFromPageObject(slot_name);
        if(slot) {
            log_unfilled(slot);
        }
    }


    /**
     * Video Ad errored out
     * @param {String} slot_name
     * @param {Object} error_obj
     * @param {Boolean} error_msg
     * @return {Boolean} max_fails_reached
     */
    function logVideoAdError(slot_name, error_obj, max_fails_reached) {
        var error = new Error(JSON.stringify(error_obj.msg))
        error.bidder = error_obj.bidder;
        error.event_type = 'video_exception';
        sendError(error);

        var slot = properPage.getSlotFromPageObject(slot_name);
        if(slot) {
            if(
                slot.hasWinningBid() &&
                error_obj.bidder !== 'dfp'
            ) {
                // Reset winning ad
                delete slot.winning_ad;
                slot.winning_ad = {};
            }

            // Fallback to display ad
            if(
                max_fails_reached === true &&
                slot.type == 'display'
            ) {
                // Reset refresh settings
                var slot_settings = ProperMedia.utils.deepAccess(properOps, 'ad_slots' + '.' + slot.type + '.' + slot.name) || {};
                slot.setRefresh(slot_settings);
                slot.refreshSlot();
            }
        }
    }


    /**
     * TEMP remnant
     * Remnant Passbacks!
     */
    function proper_remnant(doc, id) {
        var slot = properPage.getSlotByNumber(id, ['display']);
        if(!slot) {
            properLog.mylog("Couldn't find slot with number: " + id);
            return false;
        }
        log_unfilled(slot);
        return;
    }


    // Export functions
    return {
        'init'                 : init,
        'set_options'          : set_options,
        'proper_log'           : properLog.proper_log,
        'proper_debug_console' : proper_debug_console,
        'proper_display'       : proper_display,
        'proper_render'        : proper_render,
        'logMatchingResponse'  : logMatchingResponse,
        'disableSlotRefresh'   : disableSlotRefresh,
        'getReportAdInfo'      : getReportAdInfo,
        'getAdSlots'           : getAdSlots,
        'refreshSlotByName'    : refreshSlotByName,
        'sendError'            : sendError,
        'spaNewPage'           : spaNewPage,
        'infScrollNewPage'     : infScrollNewPage,
        'buildSlots'           : buildSlots,
        'deleteSlot'           : deleteSlot,
        'destroyDfpSlot'       : destroyDfpSlot, 
        'getVideoPlayerOps'    : getVideoPlayerOps,
        'createVideoSlot'      : createVideoSlot,
        'runVideoAuction'      : runVideoAuction,
        'getVideoAd'           : getVideoAd,
        'destroyVideoPlayer'   : destroyVideoPlayer,
        'logVideoAdSuccess'    : logVideoAdSuccess,
        'logVideoUnfilled'     : logVideoUnfilled,
        'logVideoAdError'      : logVideoAdError, 
        'proper_remnant'       : proper_remnant
    }

})(window, document);

//make functions global
var proper_log            = ProperMedia.ad_project.proper_log;
var proper_debug_console  = ProperMedia.ad_project.proper_debug_console;
var proper_display        = ProperMedia.ad_project.proper_display;
var proper_render         = ProperMedia.ad_project.proper_render;
var disableSlotRefresh    = ProperMedia.ad_project.disableSlotRefresh;
var logMatchingResponse   = ProperMedia.ad_project.logMatchingResponse;
var properSpaNewPage      = ProperMedia.ad_project.spaNewPage;
var properInfNewPage      = ProperMedia.ad_project.infScrollNewPage;
var properBuildSlots      = ProperMedia.ad_project.buildSlots;
var properDeleteSlot      = ProperMedia.ad_project.deleteSlot;
var properDestroyDfpSlot  = ProperMedia.ad_project.destroyDfpSlot;
var proper_remnant        = ProperMedia.ad_project.proper_remnant;

ProperMedia.ad_project.init();